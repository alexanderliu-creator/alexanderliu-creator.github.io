

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/tuzi.png">
  <link rel="icon" href="/img/tuzi.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Alexander Liu">
  <meta name="keywords" content="åˆ†å¸ƒå¼ç³»ç»Ÿ,åç«¯ç ”å‘,æ•°æ®ååŒ">
  
    <meta name="description" content="This is a very important lesson which teaches you how to find the bugs in your concurrent program!">
<meta property="og:type" content="article">
<meta property="og:title" content="NJUOS-8-å¹¶å‘bugå’Œåº”å¯¹">
<meta property="og:url" content="http://example.com/2022/12/18/njuos-8-bing-fa-bug-he-ying-dui/index.html">
<meta property="og:site_name" content="å…”ã®åšå®¢">
<meta property="og:description" content="This is a very important lesson which teaches you how to find the bugs in your concurrent program!">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181003823.png">
<meta property="article:published_time" content="2022-12-18T02:02:58.000Z">
<meta property="article:modified_time" content="2022-12-18T05:40:15.871Z">
<meta property="article:author" content="Alexander Liu">
<meta property="article:tag" content="ç ”0è‡ªå­¦">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181003823.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>NJUOS-8-å¹¶å‘bugå’Œåº”å¯¹ - å…”ã®åšå®¢</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="å…”ã®åšå®¢" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>å…”çš„åšå®¢</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                å‹é“¾
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/background_drinkingbeer.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="NJUOS-8-å¹¶å‘bugå’Œåº”å¯¹"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Alexander Liu
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-12-18 10:02" pubdate>
          2022å¹´12æœˆ18æ—¥ ä¸Šåˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          67 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">NJUOS-8-å¹¶å‘bugå’Œåº”å¯¹</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š14 å¤©å‰
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>This is a very important lesson which teaches you how to find the bugs in your concurrent program!</p>
<span id="more"></span>



<h1 id="åº”å¯¹Bugçš„æ–¹æ³•"><a href="#åº”å¯¹Bugçš„æ–¹æ³•" class="headerlink" title="åº”å¯¹Bugçš„æ–¹æ³•"></a>åº”å¯¹Bugçš„æ–¹æ³•</h1><blockquote>
<p> åŸºæœ¬æ€è·¯ï¼šå¦å®šä½ è‡ªå·±ã€‚è™½ç„¶ä¸å¤ªæ„¿æ„æ‰¿è®¤ï¼Œä½†<strong>å§‹ç»ˆå‡è®¾è‡ªå·±çš„ä»£ç æ˜¯é”™çš„</strong>ã€‚ï¼ˆå…ˆå‡è®¾ï¼Œè‡ªå·±çš„ç¨‹åºæ˜¯é”™çš„ï¼‰</p>
</blockquote>
<ul>
<li><p>ç„¶åå‘¢ï¼Ÿ</p>
<ul>
<li><p>åšå¥½æµ‹è¯•</p>
</li>
<li><p>æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li><p>å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li><p>å†å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
<ul>
<li>(æŠŠä»»ä½•ä½ è®¤ä¸º â€œä¸å¯¹â€ çš„æƒ…å†µéƒ½æ£€æŸ¥ä¸€é)</li>
</ul>
</li>
</ul>
</li>
<li><p>Bugå¤šçš„æ ¹æœ¬åŸå› ï¼šç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·</p>
<ul>
<li>ç¼–ç¨‹è¯­è¨€åœ¨è¡¨è¾¾ç‰©ç†ä¸–ç•Œçš„æ—¶å€™ï¼Œæ˜¯â€œæœ‰æŸâ€çš„ï¼Œä¾‹å¦‚é‡‘é¢ä¸ºè´Ÿâ€¦è¿™å°±éš¾é¡¶orzâ€¦ã€‚ç¼–è¯‘å™¨åªç®¡ â€œç¿»è¯‘â€ ä»£ç ï¼Œä¸ç®¡å’Œå®é™…éœ€æ±‚ (è§„çº¦) æ˜¯å¦åŒ¹é…ï¼Œç¨‹åºå‘˜åŒ¹é…å°±å®¹æ˜“å‡ºé—®é¢˜å™»ï¼</li>
</ul>
</li>
<li><p>ä¸‰åå¹´åçš„ç¼–ç¨‹è¯­è¨€å’Œç¼–ç¨‹æ–¹æ³•ï¼Ÿ</p>
<ul>
<li><p>Annotation verifier (<a target="_blank" rel="noopener" href="https://dafny-lang.github.io/dafny/">Dafny</a>)</p>
</li>
<li><p>Specification mining (<a target="_blank" rel="noopener" href="http://plse.cs.washington.edu/daikon/">Daikon</a>)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dl.acm.org/doi/10.1145/113446.113468">Refinement types</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://link.springer.com/article/10.1007/s10009-012-0249-7">Program sketching</a>â€¦â€¦</p>
</li>
</ul>
</li>
</ul>
<h2 id="æ›´å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹"><a href="#æ›´å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹" class="headerlink" title="æ›´å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹"></a>æ›´å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹</h2><blockquote>
<p>æŠŠç¨‹åºéœ€è¦æ»¡è¶³çš„æ¡ä»¶ç”¨ assert è¡¨è¾¾å‡ºæ¥ã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181024643.png" srcset="/img/loading.gif" lazyload alt="image-20221218102422618"></p>
<ul>
<li>peterson-barrier.c: ä¾‹å¦‚åœ¨ä¸´ç•ŒåŒºé‡Œï¼Œå¯¹åº”çš„é€»è¾‘ä½ç½®ï¼ŒåŠ ä¸Šassertï¼Œè¿›è¡Œåˆ¤æ–­å’Œå¤„ç†å˜›ï¼ï¼ï¼</li>
<li>äºŒå‰æ ‘çš„æ—‹è½¬: ä¸ç®¡ä»£ç æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥å¯¹æ—‹è½¬åçš„ç»“æœè¿›è¡ŒéªŒè¯çš„æ˜‚ã€‚e.g. Assert(y.left == x &amp;&amp; y.right == c &amp;&amp; â€¦..)</li>
</ul>
<blockquote>
<p><strong>å°æŠ€å·§ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹ï¼Œå®ä¹ é¢è¯•å±•ç°ä¸€ä¸‹è¿™ä¸ªæƒ³æ³•ï¼Œéƒ½å¾ˆå¥½ç”¨æ˜‚ï¼ï¼ï¼</strong></p>
</blockquote>
<h3 id="é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘"><a href="#é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘" class="headerlink" title="é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘"></a>é˜²å¾¡æ€§ç¼–ç¨‹å’Œè§„çº¦ç»™æˆ‘ä»¬çš„å¯å‘</h3><p>ä½ çŸ¥é“å¾ˆå¤šå˜é‡çš„å«ä¹‰</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">#define <span class="hljs-constructor">CHECK_INT(<span class="hljs-params">x</span>, <span class="hljs-params">cond</span>)</span> \<br>  ({ panic<span class="hljs-constructor">_on(!((<span class="hljs-params">x</span>)</span> cond), <span class="hljs-string">"int check fail: "</span> #x <span class="hljs-string">" "</span> #cond); })<br>#define <span class="hljs-constructor">CHECK_HEAP(<span class="hljs-params">ptr</span>)</span> \<br>  ({ panic<span class="hljs-constructor">_on(!IN_RANGE((<span class="hljs-params">ptr</span>)</span>, heap)); })<br></code></pre></td></tr></tbody></table></figure>

<p>å˜é‡æœ‰ â€œtyped annotationâ€</p>
<ul>
<li><code>CHECK_INT(waitlist-&gt;count, &gt;= 0);</code></li>
<li><code>CHECK_INT(pid, &lt; MAX_PROCS);</code></li>
<li><code>CHECK_HEAP(ctx-&gt;rip); CHECK_HEAP(ctx-&gt;cr3);</code></li>
<li>å˜é‡å«ä¹‰æ”¹å˜ â†’ å‘ç”Ÿå¥‡æ€ªé—®é¢˜ (overflow, memory error, â€¦)<ul>
<li><strong>ä¸è¦å°çœ‹è¿™äº›æ£€æŸ¥</strong>ï¼Œå®ƒä»¬åœ¨åº•å±‚ç¼–ç¨‹ (M2, L1, â€¦) æ—¶éå¸¸å¸¸è§</li>
<li>åœ¨è™šæ‹Ÿæœºç¥ç§˜é‡å¯/å¡ä½/â€¦å‰å‘å‡ºè­¦æŠ¥</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>ä¸ä¸€å®šèƒ½è€ƒè™‘å‘¨å…¨ï¼Œä½†æ˜¯èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬ï¼Œå¿«é€Ÿæ‰¾åˆ°æŸç§ç±»å‹çš„bugæï¼æ¯”å¦‚è¯´ï¼Œåœ¨â€œæŒ‡é’ˆé£äº†â€çš„æƒ…å†µä¸‹ï¼Œå¸®åŠ©æˆ‘ä»¬åŠæ—¶æ‰¾åˆ°é—®é¢˜æ˜‚ï¼ˆCHECK_HEAPï¼‰ï¼ï¼ï¼</li>
</ul>
</blockquote>
<h2 id="å¹¶å‘Bug-Deadlock"><a href="#å¹¶å‘Bug-Deadlock" class="headerlink" title="å¹¶å‘Bug: Deadlock"></a>å¹¶å‘Bug: Deadlock</h2><blockquote>
<p>A deadlock is a state in which each member of a group is waiting for another member, including itself, to take action.</p>
</blockquote>
<h3 id="Deadlock-1-AA"><a href="#Deadlock-1-AA" class="headerlink" title="Deadlock 1: AA"></a>Deadlock 1: AA</h3><p>å‡è®¾ä½ çš„ spinlock ä¸å°å¿ƒå‘ç”Ÿäº†ä¸­æ–­</p>
<ul>
<li>åœ¨ä¸è¯¥æ‰“å¼€ä¸­æ–­çš„æ—¶å€™å¼€äº†ä¸­æ–­</li>
<li>åœ¨ä¸è¯¥åˆ‡æ¢çš„æ—¶å€™æ‰§è¡Œäº† <code>yield()</code></li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">os_run</span><span class="hljs-params">()</span> {<br>  spin_lock(&amp;list_lock);<br>  spin_lock(&amp;xxx);<br>  spin_unlock(&amp;xxx); <span class="hljs-comment">// ---------+</span><br>}                          <span class="hljs-comment">//    |</span><br>                           <span class="hljs-comment">//    |</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">on_interrupt</span><span class="hljs-params">()</span> {      <span class="hljs-comment">//    |</span><br>  spin_lock(&amp;list_lock);   <span class="hljs-comment">// &lt;--+</span><br>  spin_unlock(&amp;list_lock);<br>}<br></code></pre></td></tr></tbody></table></figure>

<blockquote>
<p>lockçš„æ—¶å€™å…³ä¸­æ–­ï¼Œunlockçš„æ—¶å€™å¼€ä¸­æ–­ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå‡ºç°çš„é—®é¢˜ï¼š</p>
<ol>
<li>ä¸Šäº†Lock A -&gt; å…³ä¸­æ–­</li>
<li>ä¸Šäº†Lock B -&gt; å…³ä¸­æ–­</li>
<li>é‡Šæ”¾äº†Lock B -&gt; å¼€ä¸­æ–­ï¼Ÿï¼Ÿï¼Ÿï¼ˆä¸è¡Œï¼Œè¿™é‡Œè¦ä¸ªè®¡æ•°å™¨ï¼Œå…¨éƒ¨é‡Šæ”¾äº†æ‰èƒ½å¼€ï¼Œä¸ç„¶æ‰‹ä¸Šæœ‰é”ä¸é‡Šæ”¾ï¼Œå°±æœ‰å¯èƒ½æ­»é”ï¼ï¼ï¼ï¼‰</li>
<li>å¼€äº†ä¸­æ–­ä¹‹åï¼Œå¦‚æœä¸­æ–­å¤„ç†ç¨‹åºä¹Ÿè¦è¿™æŠŠé”Aï¼Œæ‰èƒ½æ­£å¸¸æ‰§è¡Œã€‚ã€‚ã€‚ä¸èƒ½æˆåŠŸã€‚ã€‚ã€‚Aè¦é‡Šæ”¾ï¼Œå°±è¦ç­‰ä¸­æ–­è¿”å›ã€‚ä½†æ˜¯ä¸­æ–­ç¨‹åºè¦ç»§ç»­æ‰§è¡Œï¼Œéœ€è¦Açš„é‡Šæ”¾ã€‚è‡ªå·±ç­‰è‡ªå·±ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</li>
</ol>
</blockquote>
<ul>
<li>æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œç”šè‡³ä¸€ä¸ªçº¿ç¨‹å°±èƒ½æŠŠè‡ªå·±é”æ­»ã€‚ã€‚ã€‚</li>
</ul>
<h3 id="Deadlock-2-ABBA"><a href="#Deadlock-2-ABBA" class="headerlink" title="Deadlock 2: ABBA"></a>Deadlock 2: ABBA</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> {<br>  spin_lock(&amp;lock[i]);<br>  spin_lock(&amp;lock[j]);<br>  arr[i] = <span class="hljs-literal">NULL</span>;<br>  arr[j] = arr[i];<br>  spin_unlock(&amp;lock[j]);<br>  spin_unlock(&amp;lock[i]);<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>ä¸Šé”çš„é¡ºåºå¾ˆé‡è¦â€¦â€¦</p>
<ul>
<li><code>swap</code> æœ¬èº«çœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜: <ul>
<li><code>swap(1, 2)</code>; <code>swap(2, 3)</code>, <code>swap(3, 1)</code> â†’ æ­»é”</li>
<li>ä¸Šé¢è¿™ä¸ªå°±å’Œå“²å­¦å®¶åƒé¥­ä¸€æ ·çš„é—®é¢˜â€¦â€¦</li>
</ul>
</li>
</ul>
<h3 id="é¿å…æ­»é”"><a href="#é¿å…æ­»é”" class="headerlink" title="é¿å…æ­»é”"></a>é¿å…æ­»é”</h3><h4 id="æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶"><a href="#æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶" class="headerlink" title="æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶"></a>æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶</h4><ul>
<li><p>å››ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li><p>äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨</p>
</li>
<li><p>è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªè¿›ç¨‹è¯·æ±‚èµ„é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²è·å¾—çš„èµ„æº</p>
</li>
<li><p>ä¸å¯å‰¥å¤ºï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºä¸èƒ½å¼ºè¡Œå‰¥å¤º</p>
</li>
<li><p>å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆå¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>â€œç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚æ‰€ä»¥ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡ã€è¿›ç¨‹è°ƒåº¦ç­‰æ–¹é¢æ³¨æ„å¦‚ä½•ä¸è®©è¿™å››ä¸ªå¿…è¦æ¡ä»¶æˆç«‹ï¼Œå¦‚ä½•ç¡®å®šèµ„æºçš„åˆç†åˆ†é…ç®—æ³•ï¼Œé¿å…è¿›ç¨‹æ°¸ä¹…å æ®ç³»ç»Ÿèµ„æºã€‚æ­¤å¤–ï¼Œä¹Ÿè¦é˜²æ­¢è¿›ç¨‹åœ¨å¤„äºç­‰å¾…çŠ¶æ€çš„æƒ…å†µä¸‹å ç”¨èµ„æºã€‚å› æ­¤ï¼Œå¯¹èµ„æºçš„åˆ†é…è¦ç»™äºˆåˆç†çš„è§„åˆ’ã€‚â€ â€”â€”Bullshit.</p>
</blockquote>
<ul>
<li>å®é™…ä¸Šï¼Œè¿™å››ä¸ªæ¡ä»¶æƒ³è¦ç ´é™¤ï¼Œæ˜¯ç›¸å½“å›°éš¾çš„orz -&gt; æ¯ä¸ªæ¡ä»¶ç ´é™¤ä¼šæœ‰å¾ˆå¤šå½±å“â€¦</li>
</ul>
<h4 id="AA-Deadlock"><a href="#AA-Deadlock" class="headerlink" title="AA-Deadlock"></a>AA-Deadlock</h4><ul>
<li>AA å‹çš„æ­»é”å®¹æ˜“æ£€æµ‹ï¼ŒåŠæ—©æŠ¥å‘Šï¼ŒåŠæ—©ä¿®å¤</li>
<li>spinlock-xv6.cä¸­çš„å„ç§é˜²å¾¡æ€§ç¼–ç¨‹<ul>
<li><code>if (holding(lk)) panic();</code></li>
</ul>
</li>
</ul>
<h4 id="ABBA-Deadlock"><a href="#ABBA-Deadlock" class="headerlink" title="ABBA-Deadlock"></a>ABBA-Deadlock</h4><ul>
<li>ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„</li>
<li>ä¸¥æ ¼<strong>æŒ‰ç…§å›ºå®šçš„é¡ºåºè·å¾—æ‰€æœ‰é”</strong> (lock ordering; æ¶ˆé™¤ â€œ<strong>å¾ªç¯ç­‰å¾…</strong>â€)<ul>
<li>é‡äº‹ä¸å†³å¯è§†åŒ–ï¼š<a target="_blank" rel="noopener" href="http://jyywiki.cn/pages/OS/2022/demos/lock-ordering.py">lock-ordering.py</a></li>
<li>è¿›è€Œè¯æ˜ T1: A -&gt; B -&gt; C; T2: B -&gt; Cæ˜¯å®‰å…¨çš„<ul>
<li>åœ¨ä»»æ„æ—¶åˆ»ï¼Œæ€»æœ‰è·å¾—â€œæœ€é åâ€é”çš„å¯ä»¥ç»§ç»­æ‰§è¡Œ</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>æœ€å¸¸ç”¨ï¼ï¼ï¼ç ´é™¤â€œå¾ªç¯ç­‰å¾…â€ï¼ï¼ï¼æŒ‰ç…§åŒä¸€ä¸ªé¡ºåºæ¥è·å¾—é”ï¼ï¼ï¼</p>
</blockquote>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LockOrdering</span>:<br>    locks = [ <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span> ]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">tryacquire</span>(<span class="hljs-params">self, lk</span>):<br>        self.locks[lk], seen = <span class="hljs-string">'ğŸ”’'</span>, self.locks[lk]<br>        <span class="hljs-keyword">return</span> seen == <span class="hljs-string">''</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">release</span>(<span class="hljs-params">self, lk</span>):<br>        self.locks[lk] = <span class="hljs-string">''</span><br><br><span class="hljs-meta">    @thread</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">t1</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> self.tryacquire(<span class="hljs-number">0</span>): <span class="hljs-keyword">pass</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> self.tryacquire(<span class="hljs-number">1</span>): <span class="hljs-keyword">pass</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> self.tryacquire(<span class="hljs-number">2</span>): <span class="hljs-keyword">pass</span><br>            self.release(<span class="hljs-number">0</span>), self.release(<span class="hljs-number">1</span>), self.release(<span class="hljs-number">2</span>)<br><br><span class="hljs-meta">    @thread</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">t2</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> self.tryacquire(<span class="hljs-number">1</span>): <span class="hljs-keyword">pass</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> self.tryacquire(<span class="hljs-number">2</span>): <span class="hljs-keyword">pass</span><br>            self.release(<span class="hljs-number">1</span>), self.release(<span class="hljs-number">2</span>)<br><br><span class="hljs-meta">    @marker</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mark_negative</span>(<span class="hljs-params">self, state</span>):<br>        <span class="hljs-keyword">pass</span><br><br></code></pre></td></tr></tbody></table></figure>

<blockquote>
<p>python3 model-checker.py lock-ordering.py | python3 visualize.py &gt; tmp/a.html</p>
</blockquote>
<ul>
<li>çº¢è¾¹å’Œè“è¾¹ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªæŒ‡å‘è‡ªå·±çš„ï¼Œå°±æ˜¯å¯¹çš„æ˜‚ï¼ä¸Šé¢è¿™ç§æ–¹å¼ï¼Œä¸ä¼šæ­»é”ï¼ï¼ï¼</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181118128.png" srcset="/img/loading.gif" lazyload alt="image-20221218111826091"></p>
<blockquote>
<p>visualize.pyå’Œmodel-checker.pyçš„ä¸‹è½½æ–¹å¼æ”¾åœ¨Referencesé‡Œé¢å•¦ã€‚è‡ªå·±é…ç½®ä¸€ä¸‹æ˜¯çœŸçš„å¥½ç”¨å’Œéœ‡æ’¼ï¼ï¼ï¼</p>
</blockquote>
<ul>
<li><p>æ­»é”ä¹Ÿæ˜¯å¹¶å‘æœ€å®¹æ˜“æ‰¾åˆ°çš„bugï¼Œå¾ˆæ˜¾ç„¶ï¼Œç¨‹åºä¸ä¼šå†ç»§ç»­æ‰§è¡Œä¸‹å»äº†ï¼Œå°±æ˜¯æ­»é”äº†å‘€ï¼ï¼ï¼</p>
</li>
<li><p>Naive</p>
</li>
</ul>
<p>Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. <em>Practice will tell you that this approach doesnâ€™t scale</em>: when I create a new lock, I donâ€™t understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p>The best locks are <strong>encapsulated</strong>: they <em>never get exposed in headers</em>, and are <em>never held around calls to non-trivial functions outside the same file</em>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code donâ€™t even need to know you are using a lock.</p>
<h2 id="å¹¶å‘Bug-æ•°æ®ç«äº‰"><a href="#å¹¶å‘Bug-æ•°æ®ç«äº‰" class="headerlink" title="å¹¶å‘Bug: æ•°æ®ç«äº‰"></a>å¹¶å‘Bug: æ•°æ®ç«äº‰</h2><blockquote>
<p>ä¸åŒçš„çº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€æ®µå†…å­˜ï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™ã€‚ä¸¤ä¸ªå†…å­˜è®¿é—®åœ¨ â€œèµ›è·‘â€ï¼Œâ€œè·‘èµ¢â€ çš„æ“ä½œå…ˆæ‰§è¡Œã€‚ï¼ˆä¸ç¡®å®šæ€§ï¼‰</p>
</blockquote>
<ul>
<li><p>Peterson ç®—æ³•å‘Šè¯‰å¤§å®¶ï¼š</p>
<ul>
<li><p>ä½ ä»¬å†™ä¸å¯¹æ— é”çš„å¹¶å‘ç¨‹åº</p>
</li>
<li><p>æ‰€ä»¥äº‹æƒ…åè€Œç®€å•äº†</p>
</li>
</ul>
</li>
<li><p>ç”¨äº’æ–¥é”ä¿æŠ¤å¥½å…±äº«æ•°æ®ï¼Œæ¶ˆç­ä¸€åˆ‡æ•°æ®ç«äº‰ã€‚</p>
</li>
</ul>
<p>ä»¥ä¸‹ä»£ç æ¦‚æ‹¬äº†ä½ ä»¬é‡åˆ°æ•°æ®ç«äº‰çš„å¤§éƒ¨åˆ†æƒ…å†µ</p>
<ul>
<li>ä¸è¦ç¬‘ï¼Œä½ ä»¬çš„ bug å‡ ä¹éƒ½æ˜¯è¿™ä¸¤ç§æƒ…å†µçš„å˜ç§</li>
</ul>
<hr>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Case #1: ä¸Šé”™äº†é”</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread1</span><span class="hljs-params">()</span> { spin_lock(&amp;lk1); sum++; spin_unlock(&amp;lk1); }<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread2</span><span class="hljs-params">()</span> { spin_lock(&amp;lk2); sum++; spin_unlock(&amp;lk2); }<br></code></pre></td></tr></tbody></table></figure>

<hr>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Case #2: å¿˜è®°ä¸Šé”</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">thread1</span><span class="hljs-params">()</span> { spin_lock(&amp;lk1); sum++; spin_unlock(&amp;lk1); }<br><span class="hljs-type">void</span> <span class="hljs-title function_">thread2</span><span class="hljs-params">()</span> { sum++; }<br></code></pre></td></tr></tbody></table></figure>

<blockquote>
<p>å¾ˆå¤šå†…å­˜è®¿é—®ï¼Œæ¯ä¸€å¤„å†…å­˜ç«äº‰å†™çš„åœ°æ–¹ï¼Œä¸ŠæŠŠé”å°±è¡Œå“‡ï¼ï¼ï¼ -&gt; æ€»èƒ½æ¶ˆé™¤æ•°æ®ç«äº‰çš„æ˜‚ï¼ï¼ï¼</p>
<p>ä½†æ˜¯ç»ˆæé—®é¢˜æ²¡æœ‰è§£å†³ï¼šäººçš„æ€ç»´è¿˜æ˜¯å•çº¿ç¨‹ï¼Œè€Œä¸æ˜¯å¤šçº¿ç¨‹ï¼</p>
</blockquote>
<h2 id="æ›´å¤šç±»å‹çš„å¹¶å‘Bug"><a href="#æ›´å¤šç±»å‹çš„å¹¶å‘Bug" class="headerlink" title="æ›´å¤šç±»å‹çš„å¹¶å‘Bug"></a>æ›´å¤šç±»å‹çš„å¹¶å‘Bug</h2><p>å›é¡¾æˆ‘ä»¬å®ç°å¹¶å‘æ§åˆ¶çš„å·¥å…·</p>
<ul>
<li>äº’æ–¥é” (lock/unlock) - åŸå­æ€§</li>
<li>æ¡ä»¶å˜é‡ (wait/signal) - åŒæ­¥</li>
</ul>
<hr>
<p>å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿å (Atomicity Violation, AV)</p>
<p>å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿å (Order Violation, OV)</p>
<hr>
<p>Empirical study: åœ¨ 105 ä¸ªå¹¶å‘ bug ä¸­ (non-deadlock/deadlock)</p>
<ul>
<li>MySQL (14/9), Apache (13/4), Mozilla (41/16), OpenOffice (6/2)</li>
<li>97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯ AV æˆ– OVã€‚</li>
</ul>
<h3 id="åŸå­æ€§çš„è¿å"><a href="#åŸå­æ€§çš„è¿å" class="headerlink" title="åŸå­æ€§çš„è¿å"></a>åŸå­æ€§çš„è¿å</h3><ul>
<li>â€œABAâ€ï¼šæˆ‘ä»¥ä¸ºä¸€æ®µä»£ç æ²¡å•¥äº‹å‘¢ï¼Œä½†è¢«äººå¼ºåŠ¿æ’å…¥äº†</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181140892.png" srcset="/img/loading.gif" lazyload alt="image-20221218114051867"></p>
<ul>
<li>æœ‰æ—¶å€™ä¸Šé”ä¹Ÿä¸è§£å†³é—®é¢˜ï¼š</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181142779.png" srcset="/img/loading.gif" lazyload alt="image-20221218114203751"></p>
<h3 id="é¡ºåºè¿å"><a href="#é¡ºåºè¿å" class="headerlink" title="é¡ºåºè¿å"></a>é¡ºåºè¿å</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181145123.png" srcset="/img/loading.gif" lazyload alt="image-20221218114502088"></p>
<h2 id="åº”å¯¹å¹¶å‘Bugçš„æ–¹æ³•"><a href="#åº”å¯¹å¹¶å‘Bugçš„æ–¹æ³•" class="headerlink" title="åº”å¯¹å¹¶å‘Bugçš„æ–¹æ³•"></a>åº”å¯¹å¹¶å‘Bugçš„æ–¹æ³•</h2><blockquote>
<p>è¿˜æ˜¯å¾—å§‹ç»ˆå‡è®¾è‡ªå·±çš„ä»£ç æ˜¯é”™çš„ã€‚</p>
</blockquote>
<ul>
<li><p>ç„¶åå‘¢ï¼Ÿ</p>
<ul>
<li><p>åšå¥½æµ‹è¯•</p>
</li>
<li><p>æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li><p>å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
</li>
<li><p>å†å†æ£€æŸ¥å“ªé‡Œé”™äº†</p>
<ul>
<li>(æŠŠä»»ä½•ä½ è®¤ä¸º â€œä¸å¯¹â€ çš„æƒ…å†µéƒ½æ£€æŸ¥ä¸€é)</li>
</ul>
</li>
</ul>
</li>
<li><p>ä¾‹å¦‚ï¼šç”¨ lock ordering å½»åº•é¿å…æ­»é”ï¼Ÿ</p>
<ul>
<li>ä½ æƒ³å¤šäº†ï¼šå¹¶å‘é‚£ä¹ˆå¤æ‚ï¼Œç¨‹åºå‘˜å“ªèƒ½å……åˆ†æµ‹è¯•å•Š</li>
</ul>
</li>
</ul>
<h3 id="Lockdep-è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥"><a href="#Lockdep-è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥" class="headerlink" title="Lockdep: è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥"></a>Lockdep: è¿è¡Œæ—¶çš„æ­»é”æ£€æŸ¥</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181148276.png" srcset="/img/loading.gif" lazyload alt="image-20221218114803248"></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">lock</span> {</span><br>  <span class="hljs-type">int</span> locked;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *site;<br>} <span class="hljs-type">lock_t</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STRINGIFY(s) #s</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TOSTRING(s)  STRINGIFY(s)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCK_INIT() \</span><br><span class="hljs-meta">  ( (lock_t) { .locked = 0, .site = __FILE__ <span class="hljs-string">":"</span> TOSTRING(__LINE__), } )</span><br><br><span class="hljs-type">lock_t</span> lk1 = LOCK_INIT();<br><span class="hljs-type">lock_t</span> lk2 = LOCK_INIT();<br><br><span class="hljs-comment">// æŠŠä¸Šé”å’Œè§£é”çš„é¡ºåºæ‰“å°å‡ºæ¥å˜›ï¼ï¼ï¼</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">lock_t</span> *lk)</span> {<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"LOCK   %s\n"</span>, lk-&gt;site);<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(<span class="hljs-type">lock_t</span> *lk)</span> {<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"UNLOCK %s\n"</span>, lk-&gt;site);<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">some_object</span> {</span><br>  <span class="hljs-type">lock_t</span> lock;<br>  <span class="hljs-type">int</span> data;<br>};<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">object_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> some_object *obj)</span> {<br>  obj-&gt;lock = LOCK_INIT();<br>}<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {<br>  lock(&amp;lk1);<br>  lock(&amp;lk2);<br>  unlock(&amp;lk1);<br>  unlock(&amp;lk2);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">some_object</span> *<span class="hljs-title">obj</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> some_object));<br>  assert(obj);<br>  object_init(obj);<br>  lock(&amp;obj-&gt;lock);<br><br>  lock(&amp;lk2);<br>  lock(&amp;lk1);<br>}<br></code></pre></td></tr></tbody></table></figure>

<blockquote>
<p>æŠŠæ‰€æœ‰å¯èƒ½çš„ä¸Šé”å’Œè§£é”é¡ºåºéƒ½å¯ä»¥æ‰“å°å‡ºæ¥å‘€ï¼ï¼ï¼ç”šè‡³å¯ä»¥å¯¹äºlock-orderingè¿›è¡Œæ£€æŸ¥ï¼ï¼ï¼å¿…é¡»x -&gt; y -&gt; zï¼Œxä¸€å®šè¦åœ¨y, zå·¦è¾¹ï¼Œæˆ‘ä»¬<strong>å®é™…åœ¨åŠ¨æ€ç»´æŠ¤ä¸€ä¸ªå›¾æ˜‚</strong>ï¼Œx -&gt; y -&gt; zï¼Œç„¶åå†x -&gt; zï¼Œå°±æœ‰ä¸ªè¿™ä¸ªå›¾ï¼Œä¸åº”è¯¥å­˜åœ¨ç¯ï¼ï¼ï¼</p>
</blockquote>
<h3 id="ThreadSanitizer-è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥"><a href="#ThreadSanitizer-è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥" class="headerlink" title="ThreadSanitizer: è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥"></a>ThreadSanitizer: è¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥</h3><blockquote>
<p>åŒä¸€æŠŠé”æœ‰å…ˆåé¡ºåºçš„æ˜‚ï¼ï¼ï¼</p>
</blockquote>
<ul>
<li><p>ä¸ºæ‰€æœ‰äº‹ä»¶å»ºç«‹ happens-before å…³ç³»å›¾</p>
<ul>
<li><p>Program-order + release-acquire</p>
</li>
<li><p>å¯¹äºå‘ç”Ÿåœ¨ä¸åŒçº¿ç¨‹ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™çš„ x,y<em>x</em>,<em>y</em> æ£€æŸ¥</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181154902.png" srcset="/img/loading.gif" lazyload alt="image-20221218115433871"></p>
<blockquote>
<ul>
<li>ä¸Šé”ä¹‹é—´çš„happens-beforeï¼Œå¯ä»¥å»ºç«‹çº¿ç¨‹ä¹‹é—´çš„happens-beforeã€‚</li>
<li>åŒä¸€ä¸ªçº¿ç¨‹å†…çš„æ‰§è¡Œï¼Œä¹Ÿæœ‰happens-beforeã€‚</li>
</ul>
</blockquote>
<ul>
<li>ç„¶åæ•´ä½“åšä¸€ä¸ªä¼ é€’é—­åŒ…ï¼Œå¯ä»¥æ‰¾åˆ°äº‹ä»¶çš„é¡ºåºå…ˆåå…³ç³»ã€‚å¯ä»¥æŒ‰ç…§å›¾çš„æ–¹å¼ï¼Œæ¥è§£å†³ç›¸å…³çš„é—®é¢˜ã€‚ -&gt; ä¸€ä¸ªç‚¹åˆ°å¦å¤–ä¸€ä¸ªç‚¹ä¹‹é—´ï¼Œæ˜¯å¦å­˜åœ¨è·¯å¾„ï¼šæœ‰è·¯å¾„å°±æ˜¯æ²¡æœ‰æ•°æ®ç«äº‰ï¼Œæ²¡æœ‰è·¯å¾„å°±æ˜¯æ•°æ®ç«äº‰ï¼ï¼ï¼</li>
</ul>
<h3 id="æ›´å¤šçš„æ£€æŸ¥ï¼šåŠ¨æ€ç¨‹åºåˆ†æ"><a href="#æ›´å¤šçš„æ£€æŸ¥ï¼šåŠ¨æ€ç¨‹åºåˆ†æ" class="headerlink" title="æ›´å¤šçš„æ£€æŸ¥ï¼šåŠ¨æ€ç¨‹åºåˆ†æ"></a>æ›´å¤šçš„æ£€æŸ¥ï¼šåŠ¨æ€ç¨‹åºåˆ†æ</h3><blockquote>
<p>ä¸Šé¢ä¸¤ç§éƒ½æ˜¯åŠ¨æ€ç¨‹åºåˆ†æä¸‹çš„å·¥å…·</p>
</blockquote>
<ol>
<li><p>åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è®°å½•</p>
<ul>
<li><p>Lockdep: lock/unlock</p>
</li>
<li><p>ThreadSanitizer: å†…å­˜è®¿é—® + lock/unlock</p>
</li>
</ul>
</li>
</ol>
<hr>
<ol start="2">
<li>è§£æè®°å½•æ£€æŸ¥é—®é¢˜</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181158126.png" srcset="/img/loading.gif" lazyload alt="image-20221218115816095"></p>
<hr>
<ol start="3">
<li><p>ä»˜å‡ºçš„ä»£ä»·å’Œæƒè¡¡</p>
<ul>
<li><p>ç¨‹åºæ‰§è¡Œå˜æ…¢</p>
</li>
<li><p>ä½†æ›´å®¹æ˜“æ‰¾åˆ° bug (å› æ­¤åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¸¸ç”¨)</p>
</li>
</ul>
</li>
</ol>
<h2 id="åŠ¨æ€åˆ†æå·¥å…·ï¼šSantilizers"><a href="#åŠ¨æ€åˆ†æå·¥å…·ï¼šSantilizers" class="headerlink" title="åŠ¨æ€åˆ†æå·¥å…·ï¼šSantilizers"></a>åŠ¨æ€åˆ†æå·¥å…·ï¼šSantilizers</h2><blockquote>
<p>ç¼–è¯‘é€‰é¡¹ï¼Œè®¾ç½®æˆé»˜è®¤ï¼Œå°±éå¸¸æ–¹ä¾¿æˆ‘ä»¬æ‰¾åˆ°Bugä¹‹ç±»çš„æ˜‚ï¼ï¼ï¼</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181205601.png" srcset="/img/loading.gif" lazyload alt="image-20221218120244020"></p>
<blockquote>
<p>æ‰¾åˆ°ä¸Šé¢è¿™ç§Bugï¼Œå°±å¯ä»¥åŠ ä¸€äº›é»˜è®¤çš„ç¼–è¯‘é€‰é¡¹</p>
</blockquote>
<p>e.g. <strong>gcc -g uaf.c -fsanitize=address</strong>ï¼ˆå¯ä»¥æ‰¾åˆ°åœ°å€çš„ä¸æ­£å¸¸ä½¿ç”¨ï¼‰ || <strong>gcc -g uaf.c -fsanitize=address</strong>ï¼ˆå¯ä»¥æ‰¾åˆ°date raceç­‰ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181205428.png" srcset="/img/loading.gif" lazyload alt="image-20221218120537372"></p>
<blockquote>
<p>ä¸Šé¢è¿™äº›å·¥å…·éƒ½å¾ˆå¥½ç”¨ï¼ï¼ï¼å¯ä»¥é€šè¿‡ä¸åŒçš„fsanitizeï¼Œå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°ä¸åŒçš„å¹¶å‘bugã€‚</p>
</blockquote>
<p>æ²¡ç”¨è¿‡ lint/sanitizersï¼Ÿ</p>
<ul>
<li>AddressSanitizer(asan);(paper): éæ³•å†…å­˜è®¿é—®<ul>
<li>Buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, â€¦</li>
<li>Demo: <a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/2022/demos/uaf.c">uaf.c</a>; <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html">kasan</a></li>
</ul>
</li>
<li>ThreadSanitizer(tsan): æ•°æ®ç«äº‰<ul>
<li>Demo: <a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/2022/demos/fish.c">fish.c</a>, <a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/2022/demos/sum.c">sum.c</a>, <a target="_blank" rel="noopener" href="https://jyywiki.cn/pages/OS/2022/demos/peterson-barrier.c">peterson-barrier.c</a>; <a target="_blank" rel="noopener" href="https://github.com/google/ktsan">ktsan</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer</a> (msan): æœªåˆå§‹åŒ–çš„è¯»å–</li>
<li>UBSanitizer(ubsan): undefined behavior<ul>
<li>Misaligned pointer, signed integer overflow, â€¦</li>
<li>Kernel ä¼šå¸¦ç€ <code>-fwrapv</code> ç¼–è¯‘</li>
</ul>
</li>
</ul>
<blockquote>
<p>å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨å“‡ï¼ï¼ï¼ç¼–è¯‘å¸¦ä¸Šé€‰é¡¹å°±å¥½å•¦ï¼ï¼ï¼æœ¬è´¨æ— éå°±æ˜¯ï¼šé˜²å¾¡æ€§ç¼–ç¨‹ï¼Œæ‚„æ‚„å¸®æˆ‘ä»¬æŠŠæ£€æŸ¥éƒ½åšäº†æ˜‚ï¼ï¼ï¼</p>
</blockquote>
<h3 id="DIY-Santilizers"><a href="#DIY-Santilizers" class="headerlink" title="DIY Santilizers"></a>DIY Santilizers</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181215569.png" srcset="/img/loading.gif" lazyload alt="image-20221218121509514"></p>
<ul>
<li>ç”°å¿Œèµ›é©¬ï¼Ÿèˆä¸€ä¿ä¸€æ˜¯å§ã€‚ã€‚ã€‚Canaryçš„ä¾‹å­ï¼š</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAGIC 0x55555555</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BOTTOM (STK_SZ / sizeof(u32) - 1)</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stack</span> {</span> <span class="hljs-type">char</span> data[STK_SZ]; };<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">canary_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">stack</span> *s)</span> {<br>  u32 *ptr = (u32 *)s;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CANARY_SZ; i++)<br>    ptr[BOTTOM - i] = ptr[i] = MAGIC;<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">canary_check</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> <span class="hljs-built_in">stack</span> *s)</span> {<br>  u32 *ptr = (u32 *)s;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CANARY_SZ; i++) {<br>    panic_on(ptr[BOTTOM - i] != MAGIC, <span class="hljs-string">"underflow"</span>);<br>    panic_on(ptr[i] != MAGIC, <span class="hljs-string">"overflow"</span>);<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>

<blockquote>
<p>æ‰‹åŠ¨åœ¨æ ˆé¡¶å’Œæ ˆåº•é¢„ç•™äº†ä¸€äº›ç©ºé—´ï¼Œå¿«è¦å‘ç”Ÿæ ˆæº¢å‡ºçš„æ—¶å€™ï¼Œå°±èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬åŠæ—¶æŠ¥é”™ã€‚ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰</p>
</blockquote>
<ul>
<li>ç±»ä¼¼äºä¸Šé¢è¿™æ ·çš„Canary or é˜²å¾¡æ€§ç¼–ç¨‹å®é™…ä¾‹å­ï¼š</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181321410.png" srcset="/img/loading.gif" lazyload alt="image-20221218132105357"></p>
<blockquote>
<p>VSSutdioï¼Œå¦‚æœç¼“å†²åŒºæ²¡åšå¥½ï¼Œå¯èƒ½ä¼šæŠ¥çƒ«çƒ«çƒ«çƒ«çƒ«çƒ«ä¹‹ç±»çš„ã€‚ç¼–è¯‘å™¨è‡ªåŠ¨ä¼šæ ¹æ®å †ä¹‹ç±»çš„çŠ¶æ€ï¼Œä¸ºå…¶åœ¨ä½¿ç”¨ä¹‹å‰ or ä½¿ç”¨ä¹‹åä¹‹ç±»çš„æƒ…å†µï¼Œåˆ†é…ä¸€äº›åˆå§‹å€¼ï¼æ–¹ä¾¿æ£€æŸ¥ &amp; ä¿æŠ¤ï¼</p>
</blockquote>
<ul>
<li>ä½é…ç‰ˆLockdep</li>
</ul>
<blockquote>
<p>æ­»é”çš„ç‰¹å¾ï¼Ÿä¸€ç›´ä¸åœçš„å°è¯•ä¸Šé” -&gt; ä¸Šé”ç»™ä¸ªæ­£å¸¸ä¸å¯èƒ½çš„é™åˆ¶ï¼Œè®¾ç½®ä¸€ä¸ªè¾¹ç•Œï¼Œè¶…è¿‡å°±æŠ¥é”™ã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181330047.png" srcset="/img/loading.gif" lazyload alt="image-20221218133043016"></p>
<blockquote>
<p>å¾ˆå¤šç§å®ç°æ–¹å¼å•Šï¼Œä¸ä¸€å®šå°±ä¸€ç§ï¼Œæ‰¾åˆ°ç‰¹ç‚¹å®šåˆ¶åŒ–å°±è¡Œã€‚æŠŠä»–ä»¬çš„æ€æƒ³æ”¶çº³åˆ°é˜²å¾¡æ€§ç¼–ç¨‹ä¸­ï¼Œè€Œä¸”ï¼Œæ”¶ç›Šæå¤§ï¼ï¼ï¼</p>
</blockquote>
<ul>
<li>å…¶ä»–çš„ä¸œè¥¿ï¼š</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181333162.png" srcset="/img/loading.gif" lazyload alt="image-20221218133340130"></p>
<blockquote>
<p>å¾€å‰èµ°ä¸€å°æ­¥ï¼Œåšä¸€ç‚¹ç‚¹ï¼Œå°±ä¼šæœ‰å·¨å¤§çš„æ”¶ç›Šã€‚</p>
<ul>
<li>Mallocåˆ†é…çš„æ—¶å€™ï¼Œåˆ†é…çš„å†…å­˜å¯ä»¥å…¨éƒ¨éƒ½åˆ·ä¸Šä¸€ä¸ªé¢œè‰²ï¼ˆçº¢è‰²ï¼‰ã€‚freeå›æ”¶çš„æ—¶å€™ï¼Œå…¨éƒ¨åˆ·ä¸Šå¦å¤–ä¸€ä¸ªé¢œè‰²ï¼ˆè“è‰²ï¼‰ã€‚</li>
<li>å¦‚æœåœ¨åˆ†é…çš„æ—¶å€™ï¼Œå‘ç°äº†çº¢è‰²ï¼Œå°±ä¼šå‡ºé—®é¢˜ã€‚æŠŠåˆ«äººçš„ä¸œè¥¿ï¼Œæ‹¿æ¥ç”¨äº†ã€‚æˆ–è€…freeçš„æ—¶å€™ï¼Œå·²ç»æ˜¯è“è‰²äº†ã€‚ -&gt; è®¾ç½®äº†å¥½çš„è¾¹ç•Œï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œé˜²å¾¡æ€§ç¼–ç¨‹å’Œbugçš„æ‰¾å¯»ã€‚</li>
</ul>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202212181338319.png" srcset="/img/loading.gif" lazyload alt="image-20221218133807279"></p>
<blockquote>
<p>ä¸Šé¢è¿™äº›æ‰€æœ‰çš„åŠ¨æ€åˆ†æå·¥å…·ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥åšå‡ºä½é…ç‰ˆæ¥ï¼ï¼ï¼åšç®€å•çš„æ£€æŸ¥æ˜‚ï¼ï¼ï¼</p>
</blockquote>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ol>
<li><p>ç¬‘æ­»ï¼ŒJYYåè¨€è­¦å¥ï¼šæ‡‚Systemçš„äººçš„ç¼–ç¨‹ï¼Œåˆ°å¤„éƒ½æ˜¯é˜²å¾¡æ€§çš„ä»£ç å“ˆå“ˆå“ˆå“ˆã€‚</p>
</li>
<li><p>è¯¾ä»¶ä¸Šçš„æ–‡ä»¶æ€ä¹ˆä¸‹è½½ï¼Œä¾‹å¦‚visualization.py<code>ä»¥åŠ</code>model-checker.pyï¼š</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44310435/article/details/125132791">https://blog.csdn.net/weixin_44310435/article/details/125132791</a></p>
</li>
<li><pre><code class="shell">wget http://jyywiki.cn/pages/OS/2022/demos/model-checker.py 
wget http://jyywiki.cn/pages/OS/2022/demos/visualize.py
wget http://jyywiki.cn/pages/OS/2022/demos/lock-ordering.py
</code></pre>
</li>
<li><p>è¿˜è¦ä¸‹ä¸€äº›ä¾èµ–å’Œç¯å¢ƒï¼Œè‡ªå·±é…ç½®å¥½äº†ï¼Œæ˜¯çœŸçˆ½å‘ï½å¥½ç”¨å¥½ç”¨å¥½ç”¨ï¼ï¼ï¼</p>
</li>
<li><p>ç±»ä¼¼çš„ï¼Œå…¶ä»–çš„æ–‡ä»¶å’Œè¯¾ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸Šé¢è¿™ç§æ–¹å¼ï¼ŒæŠŠæœ€åçš„æ–‡ä»¶åæ”¹ä¸€ä¸‹ï¼Œé€šè¿‡wgetæ‹‰ä¸‹æ¥æ˜‚ï¼ï¼ï¼</p>
</li>
</ul>
</li>
<li><p>è§†é¢‘é“¾æ¥ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sR4y1V7T4/?spm_id_from=333.999.0.0&amp;vd_source=ff957cd8fbaeb55d52afc75fbcc87dfd">https://www.bilibili.com/video/BV1sR4y1V7T4/?spm_id_from=333.999.0.0&amp;vd_source=ff957cd8fbaeb55d52afc75fbcc87dfd</a></li>
</ul>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="category-chain-item">å—äº¬å¤§å­¦æ“ä½œç³»ç»Ÿ</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%A0%940%E8%87%AA%E5%AD%A6/">#ç ”0è‡ªå­¦</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NJUOS-8-å¹¶å‘bugå’Œåº”å¯¹</div>
      <div>http://example.com/2022/12/18/njuos-8-bing-fa-bug-he-ying-dui/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Alexander Liu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´12æœˆ18æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/12/18/she-ji-shu-ju-mi-ji-xing-ying-yong/" title="è®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">è®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/12/17/njuos-7-zhen-shi-shi-jie-de-bing-fa-bian-cheng/" title="7. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹">
                        <span class="hidden-mobile">7. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
