

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/tuzi.png">
  <link rel="icon" href="/img/tuzi.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Alexander Liu">
  <meta name="keywords" content="分布式系统,后端研发,数据协同">
  
    <meta name="description" content="对于深度学习问题，我们通常会先定义损失函数。一旦我们有了损失函数，我们就可以使用优化算法来尝试最小化损失。在优化中，损失函数通常被称为优化问题的目标函数。按照传统惯例，大多数优化算法都关注的是最小化。如果我们需要最大化目标，那么有一个简单的解决方案：在目标函数前加负号即可。">
<meta property="og:type" content="article">
<meta property="og:title" content="D2L-12-Optimization Algorithms">
<meta property="og:url" content="http://example.com/2023/08/18/d2l-12-optimization-algorithms/index.html">
<meta property="og:site_name" content="兔の博客">
<meta property="og:description" content="对于深度学习问题，我们通常会先定义损失函数。一旦我们有了损失函数，我们就可以使用优化算法来尝试最小化损失。在优化中，损失函数通常被称为优化问题的目标函数。按照传统惯例，大多数优化算法都关注的是最小化。如果我们需要最大化目标，那么有一个简单的解决方案：在目标函数前加负号即可。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202307231956594.jpg">
<meta property="article:published_time" content="2023-08-18T12:53:14.000Z">
<meta property="article:modified_time" content="2023-08-21T07:51:28.501Z">
<meta property="article:author" content="Alexander Liu">
<meta property="article:tag" content="研0自学">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202307231956594.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>D2L-12-Optimization Algorithms - 兔の博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="兔の博客" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>兔的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/background_post.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="D2L-12-Optimization Algorithms"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Alexander Liu
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-18 20:53" pubdate>
          2023年8月18日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          105 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">D2L-12-Optimization Algorithms</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2 天前
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>对于深度学习问题，我们通常会先定义<em>损失函数</em>。一旦我们有了损失函数，我们就可以使用优化算法来尝试最小化损失。在优化中，损失函数通常被称为优化问题的<em>目标函数</em>。按照传统惯例，大多数优化算法都关注的是<em>最小化</em>。如果我们需要最大化目标，那么有一个简单的解决方案：在目标函数前加负号即可。</p>
<span id="more"></span>

<h1 id="优化和深度学习"><a href="#优化和深度学习" class="headerlink" title="优化和深度学习"></a>优化和深度学习</h1><h2 id="优化的目标"><a href="#优化的目标" class="headerlink" title="优化的目标"></a>优化的目标</h2><ul>
<li>本质上，优化和深度学习的目标是根本不同的。前者主要关注的是最小化目标，后者则关注在给定有限数据量的情况下寻找合适的模型。</li>
<li>训练误差和泛化误差通常不同：由于优化算法的目标函数通常是基于训练数据集的损失函数，因此优化的目标是减少训练误差。但是，深度学习（或更广义地说，统计推断）的目标是减少泛化误差。为了实现后者，除了使用优化算法来减少训练误差之外，我们还需要注意过拟合。</li>
</ul>
<h2 id="深度学习中的优化挑战"><a href="#深度学习中的优化挑战" class="headerlink" title="深度学习中的优化挑战"></a>深度学习中的优化挑战</h2><ul>
<li>在深度学习中，大多数目标函数都很复杂，没有解析解。相反，我们必须使用数值优化算法。本章中的优化算法都属于此类别。深度学习优化存在许多挑战。其中最令人烦恼的是局部最小值、鞍点和梯度消失。</li>
</ul>
<h3 id="局部最小值"><a href="#局部最小值" class="headerlink" title="局部最小值"></a>局部最小值</h3><ul>
<li>对于任何目标函数$f(x)$，如果在x处对应的$f(x)$值小于在x附近任意其他点的$f(x)$值，那么$f(x)$可能是局部最小值。如果$f(x)$在x处的值是整个域中目标函数的最小值，那么$f(x)$是全局最小值。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182130979.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_optimization-intro_70d214_51_0.svg"></p>
<blockquote>
<p>深度学习模型的目标函数通常有许多局部最优解。当优化问题的数值解接近局部最优值时，随着目标函数解的梯度接近或变为零，通过最终迭代获得的数值解可能仅使目标函数<em>局部</em>最优，而不是<em>全局</em>最优。只有一定程度的噪声可能会使参数跳出局部最小值。事实上，这是小批量随机梯度下降的有利特性之一。在这种情况下，小批量上梯度的自然变化能够将参数从局部极小值中跳出。</p>
</blockquote>
<ul>
<li>通常情况下，都是局部最小值！</li>
</ul>
<blockquote>
<p>看看凸函数的性质第一条：凸函数的局部极小值是全局极小值。</p>
</blockquote>
<ul>
<li>我们学过的函数：<ul>
<li>只有线性回归和Softmax是凸函数</li>
<li>其他的都是非凸函数</li>
</ul>
</li>
</ul>
<blockquote>
<p>适用场景十分有限！！！</p>
</blockquote>
<h3 id="鞍点"><a href="#鞍点" class="headerlink" title="鞍点"></a>鞍点</h3><ul>
<li>除了局部最小值之外，鞍点是梯度消失的另一个原因。<em>鞍点</em>（saddle point）是指函数的所有梯度都消失但既不是全局最小值也不是局部最小值的任何位置。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182146231.png" srcset="/img/loading.gif" lazyload alt="image-20230818214621177"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182146790.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_optimization-intro_70d214_81_0.svg"></p>
<blockquote>
<p>较高维度的鞍点甚至更加隐蔽。</p>
</blockquote>
<h3 id="梯度消失"><a href="#梯度消失" class="headerlink" title="梯度消失"></a>梯度消失</h3><ul>
<li>可能遇到的最隐蔽问题是梯度消失。在我们取得进展之前，优化将会停滞很长一段时间。事实证明，这是在引入ReLU激活函数之前训练深度学习模型相当棘手的原因之一。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182148943.svg" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>正如我们所看到的那样，深度学习的优化充满挑战。幸运的是，有一系列强大的算法表现良好，即使对于初学者也很容易使用。此外，没有必要找到最优解。局部最优解或其近似解仍然非常有用。</p>
</blockquote>
<h1 id="凸性"><a href="#凸性" class="headerlink" title="凸性"></a>凸性</h1><ul>
<li><em>凸性</em>（convexity）在优化算法的设计中起到至关重要的作用， 这主要是由于在这种情况下对算法进行分析和测试要容易。 换言之，如果算法在凸性条件设定下的效果很差， 那通常我们很难在其他条件下看到好的结果。 此外，即使深度学习中的优化问题通常是非凸的， 它们也经常在局部极小值附近表现出一些凸性。 这可能会产生一些像 (<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_references/zreferences.html#id76">Izmailov <em>et al.</em>, 2018</a>)这样比较有意思的新优化变体。</li>
</ul>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><blockquote>
<p>我们需要定义<em>凸集</em>（convex sets）和<em>凸函数</em>（convex functions）。</p>
</blockquote>
<h3 id="凸集"><a href="#凸集" class="headerlink" title="凸集"></a>凸集</h3><ul>
<li><em>凸集</em>（convex set）是凸性的基础。 简单地说，如果对于任何$a, b \in \mathcal{X}$，连接a和b的线段也位于$\mathcal{X}$中，则向量空间中的一个集合$\mathcal{X}$是<em>凸</em>（convex）的。在数学术语上，这意味着对于所有$\lambda \in [0, 1]$，我们得到</li>
</ul>
<p>$$<br>\lambda  a + (1-\lambda)  b \in \mathcal{X} \text{ 当 } a, b \in \mathcal{X}.<br>$$</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182134670.svg" srcset="/img/loading.gif" lazyload alt="../_images/pacman.svg"></p>
<blockquote>
<p>第一组是非凸的，另外两组是凸的。</p>
</blockquote>
<ul>
<li>假设$\mathcal{X}$和$\mathcal{Y}$是凸集，那么$\mathcal {X} \cap \mathcal{Y}$也是凸的。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182135981.svg" srcset="/img/loading.gif" lazyload alt="../_images/convex-intersect.svg"></p>
<ul>
<li>假设$\mathcal{X}$和$\mathcal{Y}$是凸集，那么$\mathcal{X} \cup \mathcal{Y}$不一定是凸的，即<em>非凸</em>（nonconvex）的。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182137818.svg" srcset="/img/loading.gif" lazyload alt="../_images/nonconvex.svg"></p>
<h3 id="凸函数"><a href="#凸函数" class="headerlink" title="凸函数"></a>凸函数</h3><ul>
<li>现在我们有了凸集，我们可以引入<em>凸函数</em>（convex function）f。 给定一个凸集X，如果对于所有$x, x’ \in \mathcal{X}$和所有$\lambda \in [0, 1]$，函数$f: \mathcal{X} \to \mathbb{R}$是凸的，我们可以得到：</li>
</ul>
<p>$$<br>\lambda f(x) + (1-\lambda) f(x’) \geq f(\lambda x + (1-\lambda) x’).<br>$$</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182139817.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_convexity_94e148_18_1.svg"></p>
<blockquote>
<p>余弦函数为非凸的，而抛物线函数和指数函数为凸的。 </p>
</blockquote>
<h2 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h2><h3 id="局部极小值是全局极小值"><a href="#局部极小值是全局极小值" class="headerlink" title="局部极小值是全局极小值"></a>局部极小值是全局极小值</h3><ul>
<li>首先凸函数的局部极小值也是全局极小值。 -&gt; 反证法可以证明：<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/convexity.html#id8">反证法证明局部极小值是全局极小值</a></li>
</ul>
<h3 id="凸函数的下水平集是凸的"><a href="#凸函数的下水平集是凸的" class="headerlink" title="凸函数的下水平集是凸的"></a>凸函数的下水平集是凸的</h3><ul>
<li>我们可以方便地通过凸函数的<em>下水平集</em>（below sets）定义凸集。 具体来说，给定一个定义在凸集X上的凸函数f，其任意一个下水平集是凸的。 -&gt; 可以简单证明：<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/convexity.html#id9">证明下水平集是凸的</a></li>
</ul>
<p>$$<br>\mathcal{S}_b := {x | x \in \mathcal{X} \text{ and } f(x) \leq b}<br>$$</p>
<h3 id="凸性和二阶导数"><a href="#凸性和二阶导数" class="headerlink" title="凸性和二阶导数"></a>凸性和二阶导数</h3><ul>
<li><p>当一个函数的二阶导数$f: \mathbb{R}^n \rightarrow \mathbb{R}$存在时，我们很容易检查这个函数的凸性。 我们需要做的就是检查$\nabla^2f \succeq 0$， 即对于所有$\mathbf{x} \in \mathbb{R}^n$，$\mathbf{x}^\top \mathbf{H} \mathbf{x} \geq 0$. 例如，函数$f(\mathbf{x}) = \frac{1}{2} |\mathbf{x}|^2$是凸的，因为$\nabla^2 f = \mathbf{1}$，即其导数是单位矩阵。 -&gt; <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/convexity.html#id10">证明函数的凸性是容易检查的</a></p>
</li>
<li><p>利用上面的引理和一维情况的结果，我们可以证明多维情况： 多维函数$f:\mathbb{R}^n\rightarrow\mathbb{R}$是凸函数，当且仅当$g(z) \stackrel{\mathrm{def}}{=} f(z \mathbf{x} + (1-z) \mathbf{y})$是凸的，这里$z \in [0,1]$，$\mathbf{x}, \mathbf{y} \in \mathbb{R}^n$。 根据一维情况， 此条成立的条件为，当且仅当对于所有$\mathbf{x}, \mathbf{y} \in \mathbb{R}^n$， $g’’ = (\mathbf{x} - \mathbf{y})^\top \mathbf{H}(\mathbf{x} - \mathbf{y}) \geq 0\ \ \ \  (\mathbf{H} \stackrel{\mathrm{def}}{=} \nabla^2f)$。 这相当于根据半正定矩阵的定义，$\mathbf{H} \succeq 0$。</p>
</li>
</ul>
<h2 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h2><ul>
<li>凸优化的一个很好的特性是能够让我们有效地处理<em>约束</em>（constraints）。 即它使我们能够解决以下形式的<em>约束优化</em>（constrained optimization）问题：</li>
</ul>
<p>$$<br>\begin{split}\begin{aligned} \mathop{\mathrm{minimize~}}_{\mathbf{x}} &amp; f(\mathbf{x}) \<br>    \text{ subject to } &amp; c_i(\mathbf{x}) \leq 0 \text{ for all } i \in {1, \ldots, N}.<br>\end{aligned}\end{split}<br>$$</p>
<blockquote>
<p>这里$f$是目标函数，$c_i$是约束函数。</p>
</blockquote>
<h3 id="拉格朗日函数"><a href="#拉格朗日函数" class="headerlink" title="拉格朗日函数"></a>拉格朗日函数</h3><ul>
<li><p>求解一个有约束的优化问题是困难的，解决这个问题的一种方法来自物理中相当简单的直觉。 想象一个球在一个盒子里，球会滚到最低的地方，重力将与盒子两侧对球施加的力平衡。 简而言之，目标函数（即重力）的梯度将被约束函数的梯度所抵消（由于墙壁的“推回”作用，需要保持在盒子内）。 请注意，任何不起作用的约束（即球不接触壁）都将无法对球施加任何力。</p>
</li>
<li><p>这里我们简略拉格朗日函数$L$的推导，上述推理可以通过以下鞍点优化问题来表示：</p>
</li>
</ul>
<p>$$<br>L(\mathbf{x}, \alpha_1, \ldots, \alpha_n) = f(\mathbf{x}) + \sum_{i=1}^n \alpha_i c_i(\mathbf{x}) \text{ where } \alpha_i \geq 0.<br>$$</p>
<blockquote>
<p>这里的变量$\alpha_i(i=1,\ldots,n)$是所谓的<em>拉格朗日乘数</em>（Lagrange multipliers），它确保约束被正确地执行。 选择它们的大小足以确保所有i的$c_i(\mathbf{x}) \leq 0$。 例如，对于$c_i(\mathbf{x}) &lt; 0$中任意x，我们最终会选择$\alpha_i = 0$。 此外，这是一个<em>鞍点</em>（saddlepoint）优化问题。 在这个问题中，我们想要使$L$相对于$\alpha_i$<em>最大化</em>（maximize），同时使它相对于$x$<em>最小化</em>（minimize）。 有大量的文献解释如何得出函数$L(\mathbf{x}, \alpha_1, \ldots, \alpha_n)$。 我们这里只需要知道$L$的鞍点是原始约束优化问题的最优解就足够了。</p>
</blockquote>
<h3 id="惩罚"><a href="#惩罚" class="headerlink" title="惩罚"></a>惩罚</h3><ul>
<li>一种至少近似地满足约束优化问题的方法是采用拉格朗日函数$L$。除了满足$c_i(\mathbf{x}) \leq 0$之外，我们只需将$\alpha_i c_i(\mathbf{x})$添加到目标函数$f(x)$。 这样可以确保不会严重违反约束。</li>
<li>事实上，我们一直在使用这个技巧。 比如权重衰减 <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_multilayer-perceptrons/weight-decay.html#sec-weight-decay">4.5节</a>，在目标函数中加入$\frac{\lambda}{2} |\mathbf{w}|^2$，以确保$\mathbf{w}$不会增长太大。 使用约束优化的观点，我们可以看到，对于若干半径$r$，这将确保$|\mathbf{w}|^2 - r^2 \leq 0$。 通过调整$\lambda$的值，我们可以改变$\mathbf{w}$的大小。</li>
<li>通常，添加惩罚是确保近似满足约束的一种好方法。 在实践中，这被证明比精确的满意度更可靠。 此外，对于非凸问题，许多使精确方法在凸情况下的性质（例如，可求最优解）不再成立。</li>
</ul>
<h3 id="投影"><a href="#投影" class="headerlink" title="投影"></a>投影</h3><ul>
<li>满足约束条件的另一种策略是<em>投影</em>（projections）。 同样，我们之前也遇到过，例如在 <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_recurrent-neural-networks/rnn-scratch.html#sec-rnn-scratch">8.5节</a>中处理梯度截断时，我们通过</li>
</ul>
<p>$$<br>\mathbf{g} \leftarrow \mathbf{g} \cdot \mathrm{min}(1, \theta/|\mathbf{g}|),<br>$$</p>
<blockquote>
<p>确保梯度的长度以$\theta$为界限。</p>
</blockquote>
<ul>
<li>这就是g在半径为$\theta$的球上的<em>投影</em>（projection）。 更泛化地说，在凸集$\mathcal{X}$上的投影被定义为</li>
</ul>
<p>$$<br>\mathrm{Proj}<em>\mathcal{X}(\mathbf{x}) = \mathop{\mathrm{argmin}}</em>{\mathbf{x}’ \in \mathcal{X}} |\mathbf{x} - \mathbf{x}’|.<br>$$</p>
<blockquote>
<p>它是$\mathcal{X}$中离$\mathbf{X}$最近的点。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308211058507.svg" srcset="/img/loading.gif" lazyload alt="../_images/projections.svg"></p>
<blockquote>
<p>Convex Projections</p>
<ul>
<li><p>投影的数学定义听起来可能有点抽象，为了解释得更清楚一些，请看 <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/convexity.html#fig-projections">图11.2.4</a>。 图中有两个凸集，一个圆和一个菱形。 两个集合内的点（黄色）在投影期间保持不变。 两个集合（黑色）之外的点投影到集合中接近原始点（黑色）的点（红色）。 虽然对$L_2$的球面来说，方向保持不变，但一般情况下不需要这样。</p>
</li>
<li><p>凸投影的一个用途是计算稀疏权重向量。 在本例中，我们将权重向量投影到一个$L_1$的球上， 这是 <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/convexity.html#fig-projections">图11.2.4</a>中菱形例子的一个广义版本。</p>
</li>
</ul>
</blockquote>
<h1 id="梯度下降"><a href="#梯度下降" class="headerlink" title="梯度下降"></a>梯度下降</h1><ul>
<li>尽管<em>梯度下降</em>（gradient descent）很少直接用于深度学习， 但了解它是理解下一节随机梯度下降算法的关键。 例如，由于学习率过大，优化问题可能会发散，这种现象早已在梯度下降中出现。 同样地，<em>预处理</em>（preconditioning）是梯度下降中的一种常用技术， 还被沿用到更高级的算法中。</li>
<li>最简单的迭代求解方法</li>
<li>所有样本一起做梯度下降</li>
</ul>
<h2 id="一维梯度下降"><a href="#一维梯度下降" class="headerlink" title="一维梯度下降"></a>一维梯度下降</h2><ul>
<li>一维中的梯度下降给我们很好的启发。 考虑一类连续可微实值函数$f: \mathbb{R} \rightarrow \mathbb{R}$， 利用泰勒展开，我们可以得到</li>
</ul>
<p>$$<br>f(x + \epsilon) = f(x) + \epsilon f’(x) + \mathcal{O}(\epsilon^2).<br>$$</p>
<ul>
<li>即在一阶近似中，$f(x+\epsilon)$可通过x处的函数值$f(x)$和一阶导数$f’(x)$得出。 我们可以假设在负梯度方向上移动的$\epsilon$会减少$f$。 为了简单起见，我们选择固定步长$\eta &gt; 0$，然后取$\epsilon = -\eta f’(x)$。 将其代入泰勒展开式我们可以得到</li>
</ul>
<p>$$<br>f(x - \eta f’(x)) = f(x) - \eta f’^2(x) + \mathcal{O}(\eta^2 f’^2(x)).<br>$$</p>
<ul>
<li>如果其导数$f’(x) \neq 0$没有消失，我们就能继续展开，这是因为$\eta f’^2(x)&gt;0$。 此外，我们总是可以令$\eta$小到足以使高阶项变得不相关。 因此，有：</li>
</ul>
<p>$$<br>f(x - \eta f’(x)) \lessapprox f(x).<br>$$</p>
<ul>
<li>这意味着，如果我们使用</li>
</ul>
<p>$$<br>x \leftarrow x - \eta f’(x)<br>$$</p>
<blockquote>
<p>来迭代x，函数$f(x)$的值可能会下降。 因此，在梯度下降中，我们首先选择初始值$x$和常数$\eta &gt; 0$， 然后使用它们连续迭代x，直到停止条件达成。 例如，当梯度$|f’(x)|$的幅度足够小或迭代次数达到某个值时。</p>
<ul>
<li><strong>本质就是往梯度的反方向走了一步</strong></li>
</ul>
</blockquote>
<h3 id="学习率"><a href="#学习率" class="headerlink" title="学习率"></a>学习率</h3><ul>
<li><p><em>学习率</em>（learning rate）决定目标函数能否收敛到局部最小值，以及何时收敛到最小值。 学习率$\eta$可由算法设计者设置。 请注意，如果我们使用的学习率太小，将导致x的更新非常缓慢，需要更多的迭代。 </p>
</li>
<li><p>相反，如果我们使用过高的学习率，$\left|\eta f’(x)\right|$对于一阶泰勒展开式可能太大。 也就是说， <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/gd.html#equation-gd-taylor">(11.3.1)</a>中的$\mathcal{O}(\eta^2 f’^2(x))$可能变得显著了。 在这种情况下，x的迭代不能保证降低$f(x)$的值。</p>
</li>
</ul>
<h3 id="局部最小值-1"><a href="#局部最小值-1" class="headerlink" title="局部最小值"></a>局部最小值</h3><ul>
<li>为了演示非凸函数的梯度下降，考虑函数$f(x) = x \cdot \cos(cx)$，其中c为某常数。 这个函数有无穷多个局部最小值。 根据我们选择的学习率，我们最终可能只会得到许多解的一个。 下面的例子说明了（不切实际的）高学习率如何导致较差的局部最小值。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308211127582.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_gd_79c039_81_1.svg"></p>
<h2 id="多元梯度下降"><a href="#多元梯度下降" class="headerlink" title="多元梯度下降"></a>多元梯度下降</h2><ul>
<li>现在我们对单变量的情况有了更好的理解，让我们考虑一下$\mathbf{x} = [x_1, x_2, \ldots, x_d]^\top$的情况。 即目标函数$f: \mathbb{R}^d \to \mathbb{R}$将向量映射成标量。 相应地，它的梯度也是多元的，它是一个由d个偏导数组成的向量：</li>
</ul>
<p>$$<br>\nabla f(\mathbf{x}) = \bigg[\frac{\partial f(\mathbf{x})}{\partial x_1}, \frac{\partial f(\mathbf{x})}{\partial x_2}, \ldots, \frac{\partial f(\mathbf{x})}{\partial x_d}\bigg]^\top.<br>$$</p>
<ul>
<li>梯度中的每个偏导数元素$\partial f(\mathbf{x})/\partial x_i$代表了当输入$x_i$时f在x处的变化率。 和先前单变量的情况一样，我们可以对多变量函数使用相应的泰勒近似来思考。 具体来说，</li>
</ul>
<p>$$<br>f(\mathbf{x} + \boldsymbol{\epsilon}) = f(\mathbf{x}) + \mathbf{\boldsymbol{\epsilon}}^\top \nabla f(\mathbf{x}) + \mathcal{O}(|\boldsymbol{\epsilon}|^2).<br>$$</p>
<ul>
<li>换句话说，在$\boldsymbol{\epsilon}$的二阶项中， 最陡下降的方向由负梯度$-\nabla f(\mathbf{x})$得出。 选择合适的学习率$\eta &gt; 0$来生成典型的梯度下降算法：</li>
</ul>
<p>$$<br>\mathbf{x} \leftarrow \mathbf{x} - \eta \nabla f(\mathbf{x}).<br>$$</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/gd.html#id5">多元梯度下降例子</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308211132783.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_gd_79c039_111_1.svg"></p>
<h2 id="自适应方法"><a href="#自适应方法" class="headerlink" title="自适应方法"></a>自适应方法</h2><ul>
<li>选择“恰到好处”的学习率$\eta$是很棘手的。 如果我们把它选得太小，就没有什么进展；如果太大，得到的解就会振荡，甚至可能发散。 如果我们可以自动确定$\eta$，或者完全不必选择学习率，会怎么样？ 除了考虑目标函数的值和梯度、还考虑它的曲率的二阶方法可以帮我们解决这个问题。 虽然由于计算代价的原因，这些方法不能直接应用于深度学习，但它们为如何设计高级优化算法提供了有用的思维直觉，这些算法可以模拟下面概述的算法的许多理想特性。</li>
</ul>
<h3 id="牛顿法"><a href="#牛顿法" class="headerlink" title="牛顿法"></a>牛顿法</h3><ul>
<li>回顾一些函数$f: \mathbb{R}^d \rightarrow \mathbb{R}$的泰勒展开式，事实上我们可以把它写成</li>
</ul>
<p>$$<br>f(\mathbf{x} + \boldsymbol{\epsilon}) = f(\mathbf{x}) + \boldsymbol{\epsilon}^\top \nabla f(\mathbf{x}) + \frac{1}{2} \boldsymbol{\epsilon}^\top \nabla^2 f(\mathbf{x}) \boldsymbol{\epsilon} + \mathcal{O}(|\boldsymbol{\epsilon}|^3).<br>$$</p>
<blockquote>
<p>为了避免繁琐的符号，我们将$\mathbf{H} \stackrel{\mathrm{def}}{=} \nabla^2 f(\mathbf{x})$定义为f的Hessian，是d×d矩阵。 当d的值很小且问题很简单时，$\mathbf{H}$很容易计算。 但是对于深度神经网络而言，考虑到$\mathbf{H}$可能非常大，$\mathcal{O}(d^2)$个条目的存储代价会很高， 此外通过反向传播进行计算可能雪上加霜。 然而，我们姑且先忽略这些考量，看看会得到什么算法。</p>
</blockquote>
<ul>
<li>毕竟，f的最小值满足$\nabla f = 0$。 遵循 <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_preliminaries/calculus.html#sec-calculus">2.4节</a>中的微积分规则， 通过取$\boldsymbol{\epsilon}$对 <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/gd.html#equation-gd-hot-taylor">(11.3.8)</a>的导数， 再忽略不重要的高阶项，我们便得到</li>
</ul>
<p>$$<br>\nabla f(\mathbf{x}) + \mathbf{H} \boldsymbol{\epsilon} = 0 \text{ and hence }<br>\boldsymbol{\epsilon} = -\mathbf{H}^{-1} \nabla f(\mathbf{x}).<br>$$</p>
<blockquote>
<p>也就是说，作为优化问题的一部分，我们需要将Hessian矩阵$\mathbf{H}$求逆。 -&gt; <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/gd.html#id7">牛顿法</a></p>
</blockquote>
<h3 id="收敛性分析"><a href="#收敛性分析" class="headerlink" title="收敛性分析"></a>收敛性分析</h3><ul>
<li>以部分目标凸函数f为例，分析它们的牛顿法收敛速度。 这些目标凸函数三次可微，而且二阶导数不为零，即$f’’ &gt; 0$。 由于多变量情况下的证明是对以下一维参数情况证明的直接拓展，对我们理解这个问题不能提供更多帮助，因此我们省略了多变量情况的证明。</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/gd.html#id8">收敛性分析</a></p>
</blockquote>
<ul>
<li>优化研究人员称之为“线性”收敛，而将$\left|e^{(k+1)}\right| \leq \alpha \left|e^{(k)}\right|$这样的条件称为“恒定”收敛速度。 请注意，我们无法估计整体收敛的速度，但是一旦我们接近极小值，收敛将变得非常快。 另外，这种分析要求f在高阶导数上表现良好，即确保f在如何变化它的值方面没有任何“超常”的特性。</li>
</ul>
<h3 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h3><ul>
<li>计算和存储完整的Hessian非常昂贵，而改善这个问题的一种方法是“预处理”。 它回避了计算整个Hessian，而只计算“对角线”项，即如下的算法更新：</li>
</ul>
<p>$$<br>\mathbf{x} \leftarrow \mathbf{x} - \eta \mathrm{diag}(\mathbf{H})^{-1} \nabla f(\mathbf{x}).<br>$$</p>
<blockquote>
<p>虽然这不如完整的牛顿法精确，但它仍然比不使用要好得多。 为什么预处理有效呢？ 假设一个变量以毫米表示高度，另一个变量以公里表示高度的情况。 假设这两种自然尺度都以米为单位，那么我们的参数化就出现了严重的不匹配。 幸运的是，使用预处理可以消除这种情况。 梯度下降的有效预处理相当于为每个变量选择不同的学习率（矢量�的坐标）。 我们将在后面一节看到，预处理推动了随机梯度下降优化算法的一些创新。</p>
</blockquote>
<h3 id="梯度下降和线搜索"><a href="#梯度下降和线搜索" class="headerlink" title="梯度下降和线搜索"></a>梯度下降和线搜索</h3><ul>
<li>梯度下降的一个关键问题是我们可能会超过目标或进展不足， 解决这一问题的简单方法是结合使用线搜索和梯度下降。 也就是说，我们使用$\nabla f(\mathbf{x})$给出的方向， 然后进行二分搜索，以确定哪个学习率$\eta$使$f(\mathbf{x} - \eta \nabla f(\mathbf{x}))$取最小值。</li>
<li>有关分析和证明，此算法收敛迅速（请参见 (<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_references/zreferences.html#id15">Boyd and Vandenberghe, 2004</a>)）。 然而，对深度学习而言，这不太可行。 因为线搜索的每一步都需要评估整个数据集上的目标函数，实现它的方式太昂贵了。</li>
</ul>
<h1 id="随机梯度下降"><a href="#随机梯度下降" class="headerlink" title="随机梯度下降"></a>随机梯度下降</h1><ul>
<li>随机一次选择n个样本，算平均再下降就很慢！！！</li>
<li>SGD就是，从这些样本中抽取一个，作为整个batch的均值，进行梯度下降！！！（数学上是合理的，因为随机取的话，期望不变的昂！！！无偏估计？）</li>
</ul>
<h2 id="随机梯度更新"><a href="#随机梯度更新" class="headerlink" title="随机梯度更新"></a>随机梯度更新</h2><ul>
<li>在深度学习中，目标函数通常是训练数据集中每个样本的损失函数的平均值。给定n个样本的训练数据集，我们假设$f_i(\mathbf{x})$是关于索引i的训练样本的损失函数，其中$\mathbf{x}$是参数向量。然后我们得到目标函数</li>
</ul>
<p>$$<br>f(\mathbf{x}) = \frac{1}{n} \sum_{i = 1}^n f_i(\mathbf{x}).<br>$$</p>
<ul>
<li>x的目标函数的梯度计算为</li>
</ul>
<p>$$<br>\nabla f(\mathbf{x}) = \frac{1}{n} \sum_{i = 1}^n \nabla f_i(\mathbf{x}).<br>$$</p>
<blockquote>
<p>如果使用梯度下降法，则每个自变量迭代的计算代价为$\mathcal{O}(n)$，它随n线性增长。因此，当训练数据集较大时，每次迭代的梯度下降计算代价将较高。</p>
</blockquote>
<ul>
<li>随机梯度下降（SGD）可降低每次迭代时的计算代价。在随机梯度下降的每次迭代中，我们对数据样本随机均匀采样一个索引i，其中$i\in{1,\ldots, n}$，并计算梯度$\nabla f_i(\mathbf{x})$以更新x：</li>
</ul>
<p>$$<br>\mathbf{x} \leftarrow \mathbf{x} - \eta \nabla f_i(\mathbf{x}),<br>$$</p>
<ul>
<li>其中$\eta$是学习率。我们可以看到，每次迭代的计算代价从梯度下降的$\mathcal{O}(n)$降至常数$\mathcal{O}(1)$。此外，我们要强调，随机梯度$\nabla f_i(\mathbf{x})$是对完整梯度$\nabla f(\mathbf{x})$的无偏估计，因为：</li>
</ul>
<p>$$<br>\mathbb{E}<em>i \nabla f_i(\mathbf{x}) = \frac{1}{n} \sum</em>{i = 1}^n \nabla f_i(\mathbf{x}) = \nabla f(\mathbf{x}).<br>$$</p>
<blockquote>
<p>这意味着，平均而言，随机梯度是对梯度的良好估计。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308211508735.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_sgd_baca77_21_1.svg"></p>
<ul>
<li>正如我们所看到的，随机梯度下降中变量的轨迹比我们在 <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/gd.html#sec-gd">11.3节</a>中观察到的梯度下降中观察到的轨迹嘈杂得多。这是由于梯度的随机性质。也就是说，即使我们接近最小值，我们仍然受到通过$\eta \nabla f_i(\mathbf{x})$的瞬间梯度所注入的不确定性的影响。即使经过50次迭代，质量仍然不那么好。更糟糕的是，经过额外的步骤，它不会得到改善。这给我们留下了唯一的选择：改变学习率$\eta$。但是，如果我们选择的学习率太小，我们一开始就不会取得任何有意义的进展。另一方面，如果我们选择的学习率太大，我们将无法获得一个好的解决方案，如上所示。解决这些相互冲突的目标的唯一方法是在优化过程中<em>动态</em>降低学习率。</li>
<li>这也是在<code>sgd</code>步长函数中添加学习率函数<code>lr</code>的原因。在上面的示例中，学习率调度的任何功能都处于休眠状态，因为我们将相关的<code>lr</code>函数设置为常量。</li>
</ul>
<h2 id="动态学习率"><a href="#动态学习率" class="headerlink" title="动态学习率"></a>动态学习率</h2><ul>
<li>用与时间相关的学习率$\eta(t)$取代$\eta$增加了控制优化算法收敛的复杂性。特别是，我们需要弄清$\eta$的衰减速度。如果太快，我们将过早停止优化。如果减少的太慢，我们会在优化上浪费太多时间。以下是随着时间推移调整$\eta$时使用的一些基本策略（稍后我们将讨论更高级的策略）：</li>
</ul>
<p>$$<br>\begin{split}\begin{aligned}<br>    \eta(t) &amp; = \eta_i \text{ if } t_i \leq t \leq t_{i+1}  &amp;&amp; \text{分段常数} \<br>    \eta(t) &amp; = \eta_0 \cdot e^{-\lambda t} &amp;&amp; \text{指数衰减} \<br>    \eta(t) &amp; = \eta_0 \cdot (\beta t + 1)^{-\alpha} &amp;&amp; \text{多项式衰减}<br>\end{aligned}\end{split}<br>$$</p>
<ul>
<li><p>分段常数*（piecewise constant）场景中，我们会降低学习率，例如，每当优化进度停顿时。这是训练深度网络的常见策略。</p>
</li>
<li><p>或者，我们可以通过<em>指数衰减</em>（exponential decay）来更积极地减低它。不幸的是，这往往会导致算法收敛之前过早停止。一个受欢迎的选择是$\alpha = 0.5$的<em>多项式衰减</em>（polynomial decay）。在凸优化的情况下，有许多证据表明这种速率表现良好。</p>
</li>
<li><p>指数衰减在实践中是什么样子：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308211513708.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_sgd_baca77_36_1.svg"></p>
<blockquote>
<p>正如预期的那样，参数的方差大大减少。但是，这是以未能收敛到最优解$\mathbf{x} = (0, 0)$为代价的。即使经过1000个迭代步骤，我们仍然离最优解很远。事实上，该算法根本无法收敛。另一方面，如果我们使用多项式衰减，其中学习率随迭代次数的平方根倒数衰减，那么仅在50次迭代之后，收敛就会更好。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308211514984.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_sgd_baca77_51_1.svg"></p>
<blockquote>
<p>关于如何设置学习率，还有更多的选择。例如，我们可以从较小的学习率开始，然后使其迅速上涨，再让它降低，尽管这会更慢。我们甚至可以在较小和较大的学习率之间切换。现在，让我们专注于可以进行全面理论分析的学习率计划，即凸环境下的学习率。对一般的非凸问题，很难获得有意义的收敛保证，因为总的来说，最大限度地减少非线性非凸问题是NP困难的。有关的研究调查，请参阅例如2015年Tibshirani的优秀<a target="_blank" rel="noopener" href="https://www.stat.cmu.edu/~ryantibs/convexopt-F15/lectures/26-nonconvex.pdf">讲义笔记</a>。</p>
</blockquote>
<h2 id="凸目标的收敛性分析"><a href="#凸目标的收敛性分析" class="headerlink" title="凸目标的收敛性分析"></a>凸目标的收敛性分析</h2><blockquote>
<p>参考<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/sgd.html#id4">收敛性分析</a></p>
</blockquote>
<h2 id="随机梯度和有限样本"><a href="#随机梯度和有限样本" class="headerlink" title="随机梯度和有限样本"></a>随机梯度和有限样本</h2><ul>
<li>我们<em>有替换地</em>从离散分布中采样n个观测值。随机选择一个元素i的概率是1/n，因此选择它<em>至少</em>一次就是：</li>
</ul>
<p>$$<br>P(\mathrm{choose<del>} i) = 1 - P(\mathrm{omit</del>} i) = 1 - (1-1/n)^n \approx 1-e^{-1} \approx 0.63.<br>$$</p>
<ul>
<li>类似的推理表明，挑选一些样本（即训练示例）<em>恰好一次</em>的概率是</li>
</ul>
<p>$$<br>{n \choose 1} \frac{1}{n} \left(1-\frac{1}{n}\right)^{n-1} = \frac{n}{n-1} \left(1-\frac{1}{n}\right)^{n} \approx e^{-1} \approx 0.37.<br>$$</p>
<blockquote>
<p>这导致与<em>无替换</em>采样相比，方差增加并且数据效率降低。因此，在实践中我们执行后者（这是本书中的默认选择）。最后一点注意，重复采用训练数据集的时候，会以<em>不同的</em>随机顺序遍历它。</p>
</blockquote>
<h1 id="小批量随机梯度下降"><a href="#小批量随机梯度下降" class="headerlink" title="小批量随机梯度下降"></a>小批量随机梯度下降</h1><blockquote>
<p> <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/gd.html#sec-gd">11.3节</a>中使用完整数据集来计算梯度并更新参数， <a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/sgd.html#sec-sgd">11.4节</a>中一次处理一个训练样本来取得进展。 二者各有利弊：每当数据非常相似时，梯度下降并不是非常“数据高效”。 而由于CPU和GPU无法充分利用向量化，随机梯度下降并不特别“计算高效”。 这暗示了两者之间可能有折中方案，这便涉及到<em>小批量随机梯度下降</em>（minibatch gradient descent）。</p>
</blockquote>
<ul>
<li>计算单样本的梯度很难完全利用硬件资源！</li>
<li>随机采样一个批量大小为n的样本子集，算梯度，对于这个batch都算，然后均一下。充分利用资源！</li>
<li>无偏的近似，没有问题。但是降低了方差！（减少了抖动性）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182202925.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_minibatch-sgd_f4d60f_183_0.svg"></p>
<h2 id="向量化和缓存"><a href="#向量化和缓存" class="headerlink" title="向量化和缓存"></a>向量化和缓存</h2><ul>
<li>参考<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/minibatch-sgd.html#id2">向量化和缓存</a></li>
</ul>
<h2 id="小批量"><a href="#小批量" class="headerlink" title="小批量"></a>小批量</h2><ul>
<li>处理单个观测值需要我们执行许多单一矩阵-矢量（甚至矢量-矢量）乘法，这耗费相当大，而且对应深度学习框架也要巨大的开销。 这既适用于计算梯度以更新参数时，也适用于用神经网络预测。 也就是说，每当我们执行$\mathbf{w} \leftarrow \mathbf{w} - \eta_t \mathbf{g}_t$时，消耗巨大。其中</li>
</ul>
<p>$$<br>\mathbf{g}<em>t = \partial</em>{\mathbf{w}} f(\mathbf{x}_{t}, \mathbf{w}).<br>$$</p>
<ul>
<li>我们可以通过将其应用于一个小批量观测值来提高此操作的<em>计算</em>效率。 也就是说，我们将梯度$\mathbf{g}_t$替换为一个小批量而不是单个观测值</li>
</ul>
<p>$$<br>\mathbf{g}<em>t = \partial</em>{\mathbf{w}} \frac{1}{|\mathcal{B}<em>t|} \sum</em>{i \in \mathcal{B}<em>t} f(\mathbf{x}</em>{i}, \mathbf{w}).<br>$$</p>
<blockquote>
<p>我们看看这对$g_t$的统计属性有什么影响：由于$x_t$和小批量$B_t$的所有元素都是从训练集中随机抽出的，因此梯度的期望保持不变。 另一方面，方差显著降低。 由于小批量梯度由正在被平均计算的$b := |\mathcal{B}_t|$个独立梯度组成，其标准差降低了$b^{-\frac{1}{2}}$。 这本身就是一件好事，因为这意味着更新与完整的梯度更接近了。</p>
</blockquote>
<ul>
<li>直观来说，这表明选择大型的小批量$B_t$将是普遍可行的。 然而，经过一段时间后，与计算代价的线性增长相比，标准差的额外减少是微乎其微的。 在实践中我们选择一个足够大的小批量，它可以提供良好的计算效率同时仍适合GPU的内存。</li>
</ul>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><ul>
<li>请参考<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/minibatch-sgd.html#id5">diy小批量随机梯度下降</a></li>
</ul>
<h1 id="动量法（Momentum）"><a href="#动量法（Momentum）" class="headerlink" title="动量法（Momentum）"></a>动量法（Momentum）</h1><ul>
<li>使用平滑过的梯度进行更新，使得梯度更新的时候，抖动不要太大！（维护一个惯性，让方向不要改变的过快！）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/blog_img/img/202308182203862.svg" srcset="/img/loading.gif" lazyload alt="../_images/output_momentum_e3683f_3_1.svg"></p>
<blockquote>
<p>基本所有的SGD实现都实现了，使用的时候，指定Momentum这个参数的值就可以！！！</p>
<p><a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/momentum.html">momentum d2l</a></p>
</blockquote>
<h1 id="Adam算法"><a href="#Adam算法" class="headerlink" title="Adam算法"></a>Adam算法</h1><ul>
<li>非常非常非常平滑的SGD，对于学习率没有那么敏感！</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/adam.html">Adam d2l</a></p>
</blockquote>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ul>
<li>中间还有AdaGrad算法，RMSProp算法，Adadelta和学习率调节器，可以看看<a target="_blank" rel="noopener" href="https://zh-v2.d2l.ai/chapter_optimization/index.html">chapter optimization d2l</a></li>
</ul>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1bP4y1p7Gq/?vd_source=ff957cd8fbaeb55d52afc75fbcc87dfd">优化算法 D2L</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1bP4y1p7Gq?p=2&amp;vd_source=ff957cd8fbaeb55d52afc75fbcc87dfd">优化算法 Q&amp;A</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/AI/" class="category-chain-item">AI</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%A0%940%E8%87%AA%E5%AD%A6/">#研0自学</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>D2L-12-Optimization Algorithms</div>
      <div>http://example.com/2023/08/18/d2l-12-optimization-algorithms/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Alexander Liu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/08/20/d2l-summary-of-d2l-lession/" title="D2L-Summary of D2L Lession">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">D2L-Summary of D2L Lession</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/18/d2l-kaggle-mu-biao-jian-ce-niu-zi-chuan-dai/" title="D2L-Kaggle-目标检测（牛仔穿戴）">
                        <span class="hidden-mobile">D2L-Kaggle-目标检测（牛仔穿戴）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
