<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-使用kubeadm快速部署一个K8s集群" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/26/%E4%BD%BF%E7%94%A8kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AAK8s%E9%9B%86%E7%BE%A4/" class="article-date">
  <time class="dt-published" datetime="2021-08-26T07:23:44.000Z" itemprop="datePublished">2021-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/26/%E4%BD%BF%E7%94%A8kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AAK8s%E9%9B%86%E7%BE%A4/">使用kubeadm快速部署一个K8s集群</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="这是尚硅谷K8s部分环境配置的课件，快速部署一个K8s集群！！！"><a href="#这是尚硅谷K8s部分环境配置的课件，快速部署一个K8s集群！！！" class="headerlink" title="这是尚硅谷K8s部分环境配置的课件，快速部署一个K8s集群！！！"></a>这是尚硅谷K8s部分环境配置的课件，快速部署一个K8s集群！！！</h1><p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p>
<p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个 Master 节点</span><br><span class="line">$ kubeadm init</span><br><span class="line"></span><br><span class="line"># 将一个 Node 节点加入到当前集群中</span><br><span class="line">$ kubeadm join &lt;Master节点的IP和端口 &gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-安装要求"><a href="#1-安装要求" class="headerlink" title="1. 安装要求"></a>1. 安装要求</h2><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<h2 id="2-准备环境"><a href="#2-准备环境" class="headerlink" title="2. 准备环境"></a>2. 准备环境</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.1.11</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.1.12</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.1.13</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"># 关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"># 关闭selinux</span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # 永久</span><br><span class="line">setenforce 0  # 临时</span><br><span class="line"></span><br><span class="line"># 关闭swap</span><br><span class="line">swapoff -a  # 临时</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab    # 永久</span><br><span class="line"></span><br><span class="line"># 根据规划设置主机名</span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"># 在master添加hosts</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.44.146 k8smaster</span><br><span class="line">192.168.44.145 k8snode1</span><br><span class="line">192.168.44.144 k8snode2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 将桥接的IPv4流量传递到iptables的链</span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system  # 生效</span><br><span class="line"></span><br><span class="line"># 时间同步</span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>

<h2 id="3-所有节点安装Docker-x2F-kubeadm-x2F-kubelet"><a href="#3-所有节点安装Docker-x2F-kubeadm-x2F-kubelet" class="headerlink" title="3. 所有节点安装Docker&#x2F;kubeadm&#x2F;kubelet"></a>3. 所有节点安装Docker&#x2F;kubeadm&#x2F;kubelet</h2><p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h3 id="3-1-安装Docker"><a href="#3-1-安装Docker" class="headerlink" title="3.1 安装Docker"></a>3.1 安装Docker</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-2-添加阿里云YUM软件源"><a href="#3-2-添加阿里云YUM软件源" class="headerlink" title="3.2 添加阿里云YUM软件源"></a>3.2 添加阿里云YUM软件源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-3-安装kubeadm，kubelet和kubectl"><a href="#3-3-安装kubeadm，kubelet和kubectl" class="headerlink" title="3.3 安装kubeadm，kubelet和kubectl"></a>3.3 安装kubeadm，kubelet和kubectl</h3><p>由于版本更新频繁，这里指定版本号部署：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y kubelet-1.18.0 kubeadm-1.18.0 kubectl-1.18.0</span><br><span class="line">$ systemctl enable kubelet</span><br></pre></td></tr></table></figure>

<h2 id="4-部署Kubernetes-Master"><a href="#4-部署Kubernetes-Master" class="headerlink" title="4. 部署Kubernetes Master"></a>4. 部署Kubernetes Master</h2><p>在192.168.31.61（Master）执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init \</span><br><span class="line">  --apiserver-advertise-address=192.168.44.146 \</span><br><span class="line">  --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">  --kubernetes-version v1.18.0 \</span><br><span class="line">  --service-cidr=10.96.0.0/12 \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

<p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址。</p>
<p>使用kubectl工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ kubectl get nodes</span><br></pre></td></tr></table></figure>

<h2 id="5-加入Kubernetes-Node"><a href="#5-加入Kubernetes-Node" class="headerlink" title="5. 加入Kubernetes Node"></a>5. 加入Kubernetes Node</h2><p>在192.168.1.12&#x2F;13（Node）执行。</p>
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm join 192.168.1.11:6443 --token esce21.q6hetwm8si29qxwn \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:00603a05805807501d7181c3d60b478788408cfe6cedefedb1f97569708be9c5</span><br></pre></td></tr></table></figure>

<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<h2 id="6-部署CNI网络插件"><a href="#6-部署CNI网络插件" class="headerlink" title="6. 部署CNI网络插件"></a>6. 部署CNI网络插件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-amd64-2pc95   1/1     Running   0          72s</span><br></pre></td></tr></table></figure>

<h2 id="7-测试kubernetes集群"><a href="#7-测试kubernetes集群" class="headerlink" title="7. 测试kubernetes集群"></a>7. 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure>

<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/26/%E4%BD%BF%E7%94%A8kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%80%E4%B8%AAK8s%E9%9B%86%E7%BE%A4/" data-id="cl6gepmgg005ue0jq6mpm2anc" data-title="使用kubeadm快速部署一个K8s集群" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-使用kubeadm搭建高可用的K8s集群" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/26/%E4%BD%BF%E7%94%A8kubeadm%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84K8s%E9%9B%86%E7%BE%A4/" class="article-date">
  <time class="dt-published" datetime="2021-08-26T07:23:44.000Z" itemprop="datePublished">2021-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/26/%E4%BD%BF%E7%94%A8kubeadm%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84K8s%E9%9B%86%E7%BE%A4/">使用kubeadm搭建高可用的K8s集群</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="这是尚硅谷K8s部分环境配置的课件，搭建高可用的K8s集群！！！"><a href="#这是尚硅谷K8s部分环境配置的课件，搭建高可用的K8s集群！！！" class="headerlink" title="这是尚硅谷K8s部分环境配置的课件，搭建高可用的K8s集群！！！"></a>这是尚硅谷K8s部分环境配置的课件，搭建高可用的K8s集群！！！</h1><p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具。</p>
<p>这个工具能通过两条指令完成一个kubernetes集群的部署：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个 Master 节点</span><br><span class="line">$ kubeadm init</span><br><span class="line"></span><br><span class="line"># 将一个 Node 节点加入到当前集群中</span><br><span class="line">$ kubeadm join &lt;Master节点的IP和端口 &gt;</span><br></pre></td></tr></table></figure>

<h2 id="1-安装要求"><a href="#1-安装要求" class="headerlink" title="1. 安装要求"></a>1. 安装要求</h2><p>在开始之前，部署Kubernetes集群机器需要满足以下几个条件：</p>
<ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<h2 id="2-准备环境"><a href="#2-准备环境" class="headerlink" title="2. 准备环境"></a>2. 准备环境</h2><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master1</td>
<td>192.168.44.155</td>
</tr>
<tr>
<td>master2</td>
<td>192.168.44.156</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.44.157</td>
</tr>
<tr>
<td>VIP（虚拟ip）</td>
<td>192.168.44.158</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"># 关闭selinux</span><br><span class="line">sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # 永久</span><br><span class="line">setenforce 0  # 临时</span><br><span class="line"></span><br><span class="line"># 关闭swap</span><br><span class="line">swapoff -a  # 临时</span><br><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab    # 永久</span><br><span class="line"></span><br><span class="line"># 根据规划设置主机名</span><br><span class="line">hostnamectl set-hostname &lt;hostname&gt;</span><br><span class="line"></span><br><span class="line"># 在master添加hosts</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.44.158    master.k8s.io   k8s-vip</span><br><span class="line">192.168.44.155    master01.k8s.io master1</span><br><span class="line">192.168.44.156    master02.k8s.io master2</span><br><span class="line">192.168.44.157    node01.k8s.io   node1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 将桥接的IPv4流量传递到iptables的链</span><br><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sysctl --system  # 生效</span><br><span class="line"></span><br><span class="line"># 时间同步</span><br><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate time.windows.com</span><br></pre></td></tr></table></figure>



<h2 id="3-所有master节点部署keepalived"><a href="#3-所有master节点部署keepalived" class="headerlink" title="3. 所有master节点部署keepalived"></a>3. 所有master节点部署keepalived</h2><h3 id="3-1-安装相关包和keepalived"><a href="#3-1-安装相关包和keepalived" class="headerlink" title="3.1 安装相关包和keepalived"></a>3.1 安装相关包和keepalived</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y conntrack-tools libseccomp libtool-ltdl</span><br><span class="line"></span><br><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>

<h3 id="3-2配置master节点"><a href="#3-2配置master节点" class="headerlink" title="3.2配置master节点"></a>3.2配置master节点</h3><p>master1节点配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 250</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>master2节点配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt;EOF </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script &quot;killall -0 haproxy&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP </span><br><span class="line">    interface ens33 </span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 200</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ceb1b3ec013d66163d6ab</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.44.158</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="3-3-启动和检查"><a href="#3-3-启动和检查" class="headerlink" title="3.3 启动和检查"></a>3.3 启动和检查</h3><p>在两台master节点都执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 启动keepalived</span><br><span class="line">$ systemctl start keepalived.service</span><br><span class="line">设置开机启动</span><br><span class="line">$ systemctl enable keepalived.service</span><br><span class="line"># 查看启动状态</span><br><span class="line">$ systemctl status keepalived.service</span><br></pre></td></tr></table></figure>

<p>启动后查看master1的网卡信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip a s ens33</span><br></pre></td></tr></table></figure>



<h2 id="4-部署haproxy"><a href="#4-部署haproxy" class="headerlink" title="4. 部署haproxy"></a>4. 部署haproxy</h2><h3 id="4-1-安装"><a href="#4-1-安装" class="headerlink" title="4.1 安装"></a>4.1 安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></table></figure>

<h3 id="4-2-配置"><a href="#4-2-配置" class="headerlink" title="4.2 配置"></a>4.2 配置</h3><p>两台master节点的配置均相同，配置中声明了后端代理的两个master节点服务器，指定了haproxy运行的端口为16443等，因此16443端口为集群的入口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/haproxy/haproxy.cfg &lt;&lt; EOF</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Global settings</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">global</span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will</span><br><span class="line">    # need to:</span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done</span><br><span class="line">    #    by adding the &#x27;-r&#x27; option to the SYSLOGD_OPTIONS in</span><br><span class="line">    #    /etc/sysconfig/syslog</span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log</span><br><span class="line">    #   file. A line like the following can be added to</span><br><span class="line">    #   /etc/sysconfig/syslog</span><br><span class="line">    #</span><br><span class="line">    #    local2.*                       /var/log/haproxy.log</span><br><span class="line">    #</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    </span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon </span><br><span class="line">       </span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the &#x27;listen&#x27; and &#x27;backend&#x27; sections will</span><br><span class="line"># use if not designated in their block</span><br><span class="line">#---------------------------------------------------------------------  </span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># kubernetes apiserver frontend which proxys to the backends</span><br><span class="line">#--------------------------------------------------------------------- </span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    mode                 tcp</span><br><span class="line">    bind                 *:16443</span><br><span class="line">    option               tcplog</span><br><span class="line">    default_backend      kubernetes-apiserver    </span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># round robin balancing between the various backends</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode        tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      master01.k8s.io   192.168.44.155:6443 check</span><br><span class="line">    server      master02.k8s.io   192.168.44.156:6443 check</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># collection haproxy statistics message</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">listen stats</span><br><span class="line">    bind                 *:1080</span><br><span class="line">    stats auth           admin:awesomePassword</span><br><span class="line">    stats refresh        5s</span><br><span class="line">    stats realm          HAProxy\ Statistics</span><br><span class="line">    stats uri            /admin?stats</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-3-启动和检查"><a href="#4-3-启动和检查" class="headerlink" title="4.3 启动和检查"></a>4.3 启动和检查</h3><p>两台master都启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 设置开机启动</span><br><span class="line">$ systemctl enable haproxy</span><br><span class="line"># 开启haproxy</span><br><span class="line">$ systemctl start haproxy</span><br><span class="line"># 查看启动状态</span><br><span class="line">$ systemctl status haproxy</span><br></pre></td></tr></table></figure>

<p>检查端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -lntup|grep haproxy</span><br></pre></td></tr></table></figure>



<h2 id="5-所有节点安装Docker-x2F-kubeadm-x2F-kubelet"><a href="#5-所有节点安装Docker-x2F-kubeadm-x2F-kubelet" class="headerlink" title="5. 所有节点安装Docker&#x2F;kubeadm&#x2F;kubelet"></a>5. 所有节点安装Docker&#x2F;kubeadm&#x2F;kubelet</h2><p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h3 id="5-1-安装Docker"><a href="#5-1-安装Docker" class="headerlink" title="5.1 安装Docker"></a>5.1 安装Docker</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">$ yum -y install docker-ce-18.06.1.ce-3.el7</span><br><span class="line">$ systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line">$ docker --version</span><br><span class="line">Docker version 18.06.1-ce, build e68fc7a</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-2-添加阿里云YUM软件源"><a href="#5-2-添加阿里云YUM软件源" class="headerlink" title="5.2 添加阿里云YUM软件源"></a>5.2 添加阿里云YUM软件源</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-3-安装kubeadm，kubelet和kubectl"><a href="#5-3-安装kubeadm，kubelet和kubectl" class="headerlink" title="5.3 安装kubeadm，kubelet和kubectl"></a>5.3 安装kubeadm，kubelet和kubectl</h3><p>由于版本更新频繁，这里指定版本号部署：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y kubelet-1.16.3 kubeadm-1.16.3 kubectl-1.16.3</span><br><span class="line">$ systemctl enable kubelet</span><br></pre></td></tr></table></figure>



<h2 id="6-部署Kubernetes-Master"><a href="#6-部署Kubernetes-Master" class="headerlink" title="6. 部署Kubernetes Master"></a>6. 部署Kubernetes Master</h2><h3 id="6-1-创建kubeadm配置文件"><a href="#6-1-创建kubeadm配置文件" class="headerlink" title="6.1 创建kubeadm配置文件"></a>6.1 创建kubeadm配置文件</h3><p>在具有vip的master上操作，这里为master1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /usr/local/kubernetes/manifests -p</span><br><span class="line"></span><br><span class="line">$ cd /usr/local/kubernetes/manifests/</span><br><span class="line"></span><br><span class="line">$ vi kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">    - master1</span><br><span class="line">    - master2</span><br><span class="line">    - master.k8s.io</span><br><span class="line">    - 192.168.44.158</span><br><span class="line">    - 192.168.44.155</span><br><span class="line">    - 192.168.44.156</span><br><span class="line">    - 127.0.0.1</span><br><span class="line">  extraArgs:</span><br><span class="line">    authorization-mode: Node,RBAC</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controlPlaneEndpoint: &quot;master.k8s.io:16443&quot;</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns: </span><br><span class="line">  type: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  local:    </span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.3</span><br><span class="line">networking: </span><br><span class="line">  dnsDomain: cluster.local  </span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line">  serviceSubnet: 10.1.0.0/16</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-在master1节点执行"><a href="#6-2-在master1节点执行" class="headerlink" title="6.2 在master1节点执行"></a>6.2 在master1节点执行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure>



<p>按照提示配置环境变量，使用kubectl工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">$ kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>



<p><strong>按照提示保存以下内容，一会要使用：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> master.k8s.io:16443 --token jv5z7n.3y1zi95p952y9p65 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:403bca185c2f3a4791685013499e7ce58f9848e2213e27194b75a2e3293d8812 \</span><br><span class="line">    --control-plane </span><br></pre></td></tr></table></figure>

<p>查看集群状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>



<h2 id="7-安装集群网络"><a href="#7-安装集群网络" class="headerlink" title="7.安装集群网络"></a>7.安装集群网络</h2><p>从官方地址获取到flannel的yaml，在master1上执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> flannel</span><br><span class="line"><span class="built_in">cd</span> flannel</span><br><span class="line">wget -c https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>



<p>安装flannel网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml </span><br></pre></td></tr></table></figure>

<p>检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>



<h2 id="8、master2节点加入集群"><a href="#8、master2节点加入集群" class="headerlink" title="8、master2节点加入集群"></a>8、master2节点加入集群</h2><h3 id="8-1-复制密钥及相关文件"><a href="#8-1-复制密钥及相关文件" class="headerlink" title="8.1 复制密钥及相关文件"></a>8.1 复制密钥及相关文件</h3><p>从master1复制密钥及相关文件到master2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh root@192.168.44.156 mkdir -p /etc/kubernetes/pki/etcd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scp /etc/kubernetes/admin.conf root@192.168.44.156:/etc/kubernetes</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/&#123;ca.*,sa.*,front-proxy-ca.*&#125; root@192.168.44.156:/etc/kubernetes/pki</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># scp /etc/kubernetes/pki/etcd/ca.* root@192.168.44.156:/etc/kubernetes/pki/etcd</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-master2加入集群"><a href="#8-2-master2加入集群" class="headerlink" title="8.2 master2加入集群"></a>8.2 master2加入集群</h3><p>执行在master1上init后输出的join命令,需要带上参数<code>--control-plane</code>表示把master控制节点加入集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba --control-plane</span><br></pre></td></tr></table></figure>

<p>检查状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="5-加入Kubernetes-Node"><a href="#5-加入Kubernetes-Node" class="headerlink" title="5. 加入Kubernetes Node"></a>5. 加入Kubernetes Node</h2><p>在node1上执行</p>
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join master.k8s.io:16443 --token ckf7bs.30576l0okocepg8b     --discovery-token-ca-cert-hash sha256:19afac8b11182f61073e254fb57b9f19ab4d798b70501036fc69ebef46094aba</span><br></pre></td></tr></table></figure>

<p><strong>集群网络重新安装，因为添加了新的node节点</strong></p>
<p>检查状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br><span class="line"></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>

<h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h2 id="7-测试kubernetes集群"><a href="#7-测试kubernetes集群" class="headerlink" title="7. 测试kubernetes集群"></a>7. 测试kubernetes集群</h2><p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment nginx --image=nginx</span><br><span class="line">$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">$ kubectl get pod,svc</span><br></pre></td></tr></table></figure>

<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/26/%E4%BD%BF%E7%94%A8kubeadm%E6%90%AD%E5%BB%BA%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84K8s%E9%9B%86%E7%BE%A4/" data-id="cl6gepmgg005xe0jqagmq7bmj" data-title="使用kubeadm搭建高可用的K8s集群" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ElasticSearch学习" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/25/ElasticSearch%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time class="dt-published" datetime="2021-08-25T10:42:55.000Z" itemprop="datePublished">2021-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/25/ElasticSearch%E5%AD%A6%E4%B9%A0/">ElasticSearch学习</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="这是ElasticSearch技术的相关学习嗷！"><a href="#这是ElasticSearch技术的相关学习嗷！" class="headerlink" title="这是ElasticSearch技术的相关学习嗷！"></a>这是ElasticSearch技术的相关学习嗷！</h1>
        
          <p class="article-more-link">
            <a href="/2021/08/25/ElasticSearch%E5%AD%A6%E4%B9%A0/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/25/ElasticSearch%E5%AD%A6%E4%B9%A0/" data-id="cl6gepmfg000xe0jqf41d4l0i" data-title="ElasticSearch学习" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-MySQL数据库高级" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E7%BA%A7/" class="article-date">
  <time class="dt-published" datetime="2021-08-21T11:16:05.000Z" itemprop="datePublished">2021-08-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E7%BA%A7/">MySQL数据库高级</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Mysql优化先康康嗷，我裂开来，Docker看的脑阔疼，学完这个再去学K8S嗷！！！"><a href="#Mysql优化先康康嗷，我裂开来，Docker看的脑阔疼，学完这个再去学K8S嗷！！！" class="headerlink" title="Mysql优化先康康嗷，我裂开来，Docker看的脑阔疼，学完这个再去学K8S嗷！！！"></a>Mysql优化先康康嗷，我裂开来，Docker看的脑阔疼，学完这个再去学K8S嗷！！！</h1>
        
          <p class="article-more-link">
            <a href="/2021/08/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E7%BA%A7/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/21/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E9%AB%98%E7%BA%A7/" data-id="cl6gepmft002de0jq9sy56weu" data-title="MySQL数据库高级" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker进阶" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/19/Docker%E8%BF%9B%E9%98%B6/" class="article-date">
  <time class="dt-published" datetime="2021-08-19T12:48:48.000Z" itemprop="datePublished">2021-08-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/19/Docker%E8%BF%9B%E9%98%B6/">Docker进阶</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="B站狂神说docker教程，这是Docker进阶课程，衔接于K8S之前嗷！！！"><a href="#B站狂神说docker教程，这是Docker进阶课程，衔接于K8S之前嗷！！！" class="headerlink" title="B站狂神说docker教程，这是Docker进阶课程，衔接于K8S之前嗷！！！"></a>B站狂神说docker教程，这是Docker进阶课程，衔接于K8S之前嗷！！！</h1>
        
          <p class="article-more-link">
            <a href="/2021/08/19/Docker%E8%BF%9B%E9%98%B6/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/19/Docker%E8%BF%9B%E9%98%B6/" data-id="cl6gepmfe000re0jq9ngwexeh" data-title="Docker进阶" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Redis学习" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/16/Redis%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time class="dt-published" datetime="2021-08-16T11:30:45.000Z" itemprop="datePublished">2021-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/16/Redis%E5%AD%A6%E4%B9%A0/">Redis学习</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="This-is-the-course-of-Redis"><a href="#This-is-the-course-of-Redis" class="headerlink" title="This is the course of Redis"></a>This is the course of Redis</h1><h1 id="NoSQL是啥？"><a href="#NoSQL是啥？" class="headerlink" title="NoSQL是啥？"></a>NoSQL是啥？</h1><ul>
<li>技术的分类：<ol>
<li>解决功能性的问题：Java , Jsp , Tomcat , HTML , JDBC等</li>
<li>解决拓展性的问题：Spring , SpringMVC , Hibernate , Mybatis , Struts</li>
<li>解决性能的问题：NoSQL , Java线程 ， Nginx , MQ , ElasticSearch , Java线程等</li>
</ol>
</li>
<li>分布式遇到的问题：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817094039.png" alt="image-20210817094038766"></p>
<p>Session的问题，转发到不同的服务器，那Session咋办？？？ —&gt; Redis</p>
<p>而且Redis也可以做缓存，提高对于经常访问的数据的访问速度。</p>
<h2 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h2><ul>
<li>NoSQL , Not only sql .</li>
<li>问题：<ul>
<li>没有统一的SQL标准</li>
<li>不支持ACID</li>
<li>效率远高于SQL</li>
</ul>
</li>
</ul>
<h1 id="Redis环境配置："><a href="#Redis环境配置：" class="headerlink" title="Redis环境配置："></a>Redis环境配置：</h1><h2 id="Redis安装"><a href="#Redis安装" class="headerlink" title="Redis安装"></a>Redis安装</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://redis.io/">Redis官网</a></p>
</li>
<li><p>在Redis中间正下方有一个download，下载的就是.tar.gz</p>
</li>
<li><p>不考虑在windows中的使用，直接在Linux下安装即可，把安装包拖到Linux中去嗷。</p>
</li>
<li><p>环境配置：</p>
<ul>
<li>需要C语言的编译环境</li>
<li><code>yum install gcc</code></li>
<li>gcc安装完成之后，可以使用<code>gcc --version</code>来查看版本，要是能查到说明没啥问题。</li>
</ul>
</li>
<li><p>接下来：</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817095546.png" alt="image-20210817095545797"></li>
<li>make完成之后，使用make install命令把它安装</li>
<li>默认会安装到&#x2F;usr&#x2F;local&#x2F;bin这个目录下嗷！！！</li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Rv41177Af?p=4&spm_id_from=pageDriver">可能遇到的一些其他的问题回去看原视频or百度嗷！！！</a></li>
</ul>
</li>
<li><p>安装完成之后对应的安装目录下：</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-10-centos bin]# ls</span><br><span class="line">busybox-x86_64   redis-check-aof  redis-cli       redis-server</span><br><span class="line">redis-benchmark  redis-check-rdb  redis-sentinel</span><br></pre></td></tr></table></figure>

<p>最重要的是redis-server和redis-cli</p>
<h2 id="Redis启动："><a href="#Redis启动：" class="headerlink" title="Redis启动："></a>Redis启动：</h2><ul>
<li><p>启动方式：</p>
<ul>
<li><p>前台启动：</p>
<ul>
<li>直接在目录下输入redis-server就可以启动啦！！！</li>
<li>问题：当前窗口动不了了，一旦关掉了，Redis</li>
</ul>
</li>
<li><p>后台启动：</p>
<ul>
<li><p>关窗口还可以继续使用嗷！！！</p>
</li>
<li><p>如何操作呢？</p>
<ul>
<li><p>要先回到解压出来的redis的那个解压目录。</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817102932.png" alt="image-20210817102932363"></p>
<p>这个目录不一定要在etc下哈！！！</p>
</li>
<li><p>改etc中的redis.conf文件的配置</p>
</li>
<li><p>daemonize把no改成yes</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817103209.png" alt="image-20210817103208928"></p>
</li>
<li><p>回到redis的安装目录，<code>cd /usr/local/bin</code></p>
</li>
<li><p><code>redis-server /etc/redis.conf</code></p>
</li>
<li><p>启动完成之后，查看redis进程（这样启动之后，就算断了链接关闭窗口，都能够正常使用redis）：</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-10-centos bin]# ps -ef | grep redis</span><br><span class="line">root     27049     1  0 10:35 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class="line">root     27167 15067  0 10:36 pts/0    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>在安装目录使用<code>redis-cli</code>，就能够成功访问到我们的redis-server嗷：</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-10-centos bin]# redis-cli </span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure>

<h2 id="Redis关闭："><a href="#Redis关闭：" class="headerlink" title="Redis关闭："></a>Redis关闭：</h2><ol>
<li><p>在上述cli中输入shutdown</p>
<p>另外，cli中输入exit是退出cli</p>
</li>
<li><p>直接kill -9 redis-server的进程号也可以嗷！</p>
</li>
<li><p><code>redis-cli -p 6379 shutdown</code></p>
</li>
</ol>
<h2 id="Redis相关知识："><a href="#Redis相关知识：" class="headerlink" title="Redis相关知识："></a>Redis相关知识：</h2><ul>
<li><p>Merz就是刚好对应了6379，这个端口号的由来</p>
</li>
<li><p>默认16个数据库，初始默认使用0号库</p>
</li>
<li><p>&#96;&#96;&#96;shell<br>127.0.0.1:6379&gt; select 2<br>OK<br>127.0.0.1:6379[2]&gt; </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  上面这种就是切换数据库嗷，从0-15</span><br><span class="line"></span><br><span class="line">- 统一库管理，所有库的密码相同。</span><br><span class="line"></span><br><span class="line">- 单线程 + 多路IO复用：</span><br><span class="line"></span><br><span class="line">![image-20210817110551511](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817110551.png)</span><br><span class="line"></span><br><span class="line">黄牛去火车站单线程取票的时候，1，2，3号可以去干别的事儿。黄牛取完票之后，会通知1，2，3号过来取嗷！！！</span><br><span class="line"></span><br><span class="line"># Redis详细学习：</span><br><span class="line"></span><br><span class="line">## Key的基本操作：</span><br><span class="line"></span><br><span class="line">![image-20210817112637989](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817112638.png)</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; set k1 tuzi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 lele</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k3 QAQ</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k3&quot;</span><br><span class="line">2) &quot;k1&quot;</span><br><span class="line">3) &quot;k2&quot;</span><br><span class="line">127.0.0.1:6379&gt; exists k1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; exists k4</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; type k2</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; del k3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k1&quot;</span><br><span class="line">2) &quot;k2&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817113139.png" alt="image-20210817113139205"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817113215.png" alt="image-20210817113215574"></p>
<h2 id="数据库基本操作："><a href="#数据库基本操作：" class="headerlink" title="数据库基本操作："></a>数据库基本操作：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817113818.png" alt="image-20210817113817831"></p>
<h2 id="数据类型："><a href="#数据类型：" class="headerlink" title="数据类型："></a>数据类型：</h2><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><ul>
<li>最基本的类型，一个key对一个value</li>
<li>二进制安全，只要内容能够使用字符串表示，都可以存进去。意味着Redis的string可以包含任何数据，比如jpg图片或者序列化对象。</li>
<li>一个Redis中字符串value最多可以是512M</li>
<li>常用命令：<ul>
<li>set key value<ul>
<li>多次set key，以最后一次为准</li>
</ul>
</li>
<li>get key</li>
<li>append key value<ul>
<li>追加到原值的末尾</li>
<li>返回追加后总的字符串长度</li>
</ul>
</li>
<li>strlen key</li>
<li>setnx key value<ul>
<li>只有key不存在的时候，才能够设置key的值</li>
<li>返回值为0，说明设置失败。返回值为1，说明设置成功。</li>
</ul>
</li>
<li>incr key</li>
<li>decr key<ul>
<li>以上两个加一减一的操作，只有对于数字才有效嗷！！！</li>
</ul>
</li>
<li>incrby &#x2F; decrby key step<ul>
<li>自定义步长</li>
<li>加上或着减去对应的值</li>
</ul>
</li>
</ul>
</li>
<li>原子性：<ul>
<li>INCR key等</li>
<li>不会被线程调度操作打断的操作，因为redis操作时单线程操作，而不是多线程操作</li>
<li>原理是：单线程 + IO多路复用</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817115859.png" alt="image-20210817115858773"></p>
<p>不是，因为Java是多线程操作，可以允许多个线程并发操作嗷！！！</p>
<p>取值范围是2到200之间嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817123901.png" alt="image-20210817123901533"></p>
<p>就是硬生生卡位置呗orz</p>
<ul>
<li><p>常用命令补充：</p>
<ul>
<li>mset key1 value1 key2 value2…</li>
<li>mget key1 key2…</li>
<li>msetnx key1 value1 key2 value2…<ul>
<li>如果设置的key已经存在，设置是不会成功的嗷！！！</li>
<li>注意，这是一个原子性质的操作，如果有一个key存在的话，所有的赋值操作都会失败嗷！！！</li>
</ul>
</li>
<li>getrange key BeginPosition EndPostion<ul>
<li>字符串从Begin到End位置的字符串提取出来，包括起始位置和结束位置的值嗷</li>
</ul>
</li>
<li>setrange key BeginPosition value<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817131735.png" alt="image-20210817131735074"></li>
<li>从某个位置开始设置值</li>
</ul>
</li>
<li>setex key ttl value<ul>
<li>设置value的同时设置过期时间</li>
</ul>
</li>
<li>getset name value<ul>
<li>以新换旧，设置了新值的同时获取旧值。</li>
</ul>
</li>
</ul>
</li>
<li><p>底层数据结构：</p>
<ul>
<li>简单<strong>动态字符串</strong>SDS，采用预分配冗余空间的方式减少内存的频繁分配嗷！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817132447.png" alt="image-20210817132447485"></li>
</ul>
</li>
<li><p>小于1M和大于!M扩容策略不一样嗷！！！最大不超过512M嗷！！！</p>
</li>
<li><p>注意上面说的这个扩容方式是对于value的类型和范围嗷，不是key的嗷！！！</p>
</li>
</ul>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><ul>
<li>单键多值，简单的字符串列表，按照插入顺序排序，可以添加一个元素到列表的头部或者尾部。</li>
<li>底层上实际是个双向列表，对于两端的操作性能很高，通过索引下标的操作中间结点性能会比较差。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817153655.png" alt="image-20210817153655557"></p>
<ul>
<li><p>常用命令：</p>
<ul>
<li><p>lpush key v1 v2 v3</p>
<ul>
<li>从左边push进去</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush k1 v1 v2 v3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange k1 0 -1</span><br><span class="line">1) &quot;v3&quot;</span><br><span class="line">2) &quot;v2&quot;</span><br><span class="line">3) &quot;v1&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>rpush key v1 v2 v3</p>
<ul>
<li>从右边push进去</li>
</ul>
</li>
<li><p>lpop key</p>
</li>
<li><p>rpop key</p>
<ul>
<li>一次只吐出一个值哦！！！</li>
<li>和上面类似，从左边或者右边拿一个值出来。</li>
<li>键在值在，键亡值亡。</li>
</ul>
</li>
<li><p>rpoplpush k1 k2</p>
<ul>
<li>k1列表右边pop出一个值，push到k2列表左边嗷！！！</li>
<li>我咋感觉这个List和Python有点像呢？？？</li>
</ul>
</li>
<li><p>lrange key start end</p>
<ul>
<li>按照索引下标获得元素</li>
<li>0表示第一个</li>
<li>-1表示最后一个</li>
<li>0 -1代表所有</li>
</ul>
</li>
<li><p>lindex key index</p>
<ul>
<li>取得某个位置上的元素</li>
<li>从左到右来看的嗷！</li>
</ul>
</li>
<li><p>llen key</p>
<ul>
<li>获得列表的长度</li>
</ul>
</li>
<li><p>linsert key before&#x2F;after value newvalue</p>
<ul>
<li>在value的前面或后面插入newvalue</li>
</ul>
</li>
<li><p>lrem key n value</p>
<ul>
<li>从左边删掉n个value</li>
</ul>
</li>
<li><p>lset key index value</p>
<ul>
<li>设置某个位置的值为新值</li>
</ul>
</li>
</ul>
</li>
<li><p>底层数据结构：</p>
<ul>
<li>quickList</li>
<li>元素少的时候，连续的内存存储，这一块内存中的元素是压缩列表ziplist</li>
<li>将所有的元素一起存储，分配一块连续内存</li>
<li>数据量多的时候，才会构成quickList</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817155551.png" alt="image-20210817155550652"></p>
</li>
</ul>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><ul>
<li><p>String类型的无须集合，底层是一个value为null的hash表，所有添加，删除，查找的复杂度都是O(1)</p>
</li>
<li><p>常用命令：</p>
<ul>
<li>sadd k1 v1 v2 v3</li>
<li>smembers key<ul>
<li>取出集合所有值</li>
</ul>
</li>
<li>sisnumber k1 v1<ul>
<li>查找某个值是否在k1集合中</li>
</ul>
</li>
<li>scard key<ul>
<li>返回集合的元素个数</li>
</ul>
</li>
<li>srem key v1 v2 …<ul>
<li>删除集合中的某个元素</li>
</ul>
</li>
<li>spop key<ul>
<li>随机从集合中pop出一个值</li>
</ul>
</li>
<li>srandmember key n<ul>
<li>从key集合中随机取出n个值</li>
<li>注意，是取出，不会删除嗷！！！</li>
</ul>
</li>
<li>smove source destination value<ul>
<li>把一个值从一个集合移动到另外一个集合</li>
</ul>
</li>
<li>sinter k1 k2<ul>
<li>取两个集合的交集</li>
</ul>
</li>
<li>sunion k1 k2<ul>
<li>取两个集合的并集</li>
</ul>
</li>
<li>sdiff k1 k2<ul>
<li>返回两个集合的差集（key1中有的，不包含key2中的元素所构成的集合）</li>
</ul>
</li>
</ul>
</li>
<li><p>数据结构：</p>
<ul>
<li>dist字典，通过Hash表实现的</li>
<li>Java中HashSet内部使用的HashMap，只不过所有value都指向同一个对象。Redis的set结构也是一样，内部使用hash结构，所有的value都指向同一个内部值。</li>
</ul>
</li>
</ul>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><ul>
<li>键值对集合</li>
<li>类似于Java中的map结构，field和value的映射关系嗷！！！通过field对应value，Map&lt;String , Object&gt;</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817162855.png" alt="image-20210817162855094"></p>
<ul>
<li>常用命令：<ul>
<li>hset key field value<ul>
<li>hset user:1001 name zhangsan</li>
</ul>
</li>
<li>hget key field<ul>
<li>hget user:1001 name</li>
</ul>
</li>
<li>hmset key value key value<ul>
<li>hmset user:1002 name lisi age 30</li>
</ul>
</li>
<li>hexists key field<ul>
<li>查看对应的field是否存在</li>
</ul>
</li>
<li>hkeys key<ul>
<li>查看所有的fields</li>
</ul>
</li>
<li>hvals key<ul>
<li>查看所有的values</li>
</ul>
</li>
<li>hincrby key user:1002 age 2<ul>
<li>对应的filed加上增量</li>
</ul>
</li>
<li>hsetnx key field value<ul>
<li>将哈希表中的key中的filed设置为value，当field不存在的时候才能够添加嗷！！！</li>
</ul>
</li>
</ul>
</li>
<li>数据结构：<ul>
<li>短的话用ziplist，长度话用hashtable</li>
</ul>
</li>
</ul>
<h3 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h3><ul>
<li>和普通集合非常相似，没有重复元素</li>
<li>但是每一个成员有一个评分，评分用于按照最低到最高来排序。集合的成员唯一，评分可以重复。</li>
<li>常用操作：<ul>
<li>zadd key score1 value1 score2 value2<ul>
<li>将一个或多个元素存进去</li>
</ul>
</li>
<li>zrange key begin stop [withscores]<ul>
<li>返回有序集key，下标在begin和stop之间</li>
<li>withscores可选，让分数一起和值返回到结果集</li>
</ul>
</li>
<li>zrangebyscore key start stop [withscores]<ul>
<li>取score位于start和stop之间的元素</li>
</ul>
</li>
<li>zrevrangebyscore key start stop [withscores]<ul>
<li>从大到小的scores进行排序</li>
</ul>
</li>
<li>zincrby key score value<ul>
<li>为key中的某个value增加权重</li>
</ul>
</li>
<li>zrem key value</li>
<li>zcount key start stop<ul>
<li>统计score位于start和stop之间的value</li>
</ul>
</li>
<li>zcount key start stop<ul>
<li>返回区间内元素的个数</li>
</ul>
</li>
<li>zrank key value<ul>
<li>返回某个值在集合中的排名（从0开始）</li>
</ul>
</li>
</ul>
</li>
<li>数据结构：<ul>
<li>等价于Java的Map&lt;String , Double&gt;，可以给每一个元素value一个score，另一方面又类似于TreeSet，内部的元素会按照score进行排序，得到每个元素的名次，可以通过score的范围来获取元素的列表。</li>
<li>两个数据结构：<ul>
<li>hash，关联元素和权重score，保证value的唯一性，可以通过元素value来找到对应的score值。</li>
<li>跳跃表，给元素value排序，根据score的范围来获取元素列表嗷！！！</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>跳跃表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817171058.png" alt="image-20210817171058509"></p>
<p>典型的用空间换时间的做法嗷！！！</p>
<h1 id="Redis配置文件："><a href="#Redis配置文件：" class="headerlink" title="Redis配置文件："></a>Redis配置文件：</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817171306.png" alt="image-20210817171306164"></p>
<ul>
<li>如果要远程连接的话可以把这个配置给注释掉</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817171402.png" alt="image-20210817171402017"></p>
<ul>
<li><p>如果要远程连接的话可以把这个yes改为no，关闭保护模式</p>
</li>
<li><p>tcp-backlog：</p>
<ul>
<li>总和 &#x3D; 未完成三次握手的队列+已经完成三次握手的队列</li>
<li>本质上就是一个连接队列而已嗷！！！</li>
</ul>
</li>
<li><p>port：</p>
<ul>
<li>服务的端口</li>
</ul>
</li>
<li><p>timeout：</p>
<ul>
<li>默认为0，永不超时</li>
<li>可以设置为对应的值，单位是秒，这么多秒没有操作就会超时嗷！！！</li>
</ul>
</li>
<li><p>tcp-keepalive</p>
<ul>
<li>默认是300s</li>
<li>检测你的心跳，没心跳了就断掉连接嗷！！！</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817171843.png" alt="image-20210817171842816"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817171907.png" alt="image-20210817171907334"></p>
<ul>
<li><p>logfile：</p>
<ul>
<li>默认为空</li>
<li>日志文件的输出位置</li>
</ul>
</li>
<li><p>databases：</p>
<ul>
<li>默认为16，默认用的是0</li>
</ul>
</li>
<li><p>密码设置：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817172051.png" alt="image-20210817172051354"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817172117.png" alt="image-20210817172116889"></p>
<ul>
<li><p>LIMITS限制：</p>
<ul>
<li><p>maxclients：</p>
<ul>
<li>默认为10000个客户端</li>
<li>设置redis可以和多少客户端连接</li>
<li>达到限制就会拒绝连接请求，并且回应max number of clients reached。</li>
</ul>
</li>
<li><p><img src="C:\Users\Alexander\AppData\Roaming\Typora\typora-user-images\image-20210817172253896.png" alt="image-20210817172253896"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817172324.png" alt="image-20210817172324292"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817172347.png" alt="image-20210817172346962"></p>
</li>
</ul>
</li>
<li><p>还有一些持久化的操作</p>
</li>
<li><p>综上，如果要远程访问：</p>
<ul>
<li>bind给它注释掉</li>
<li>关闭保护模式</li>
</ul>
</li>
</ul>
<h1 id="发布和订阅："><a href="#发布和订阅：" class="headerlink" title="发布和订阅："></a>发布和订阅：</h1><ul>
<li>消息通信模式，pub发送消息，订阅者接受消息</li>
<li>Redis客户端可以订阅任意数量的频道</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817191037.png" alt="image-20210817191037613"></p>
<ol>
<li>客户端订阅channel：</li>
</ol>
<p><code>SUBSCRIBE channel1</code></p>
<ol start="2">
<li>向channel中发布消息：</li>
</ol>
<p><code>PUBLISH channel2 message</code></p>
<ul>
<li>tips: 启动两个连接，一个订阅，一个发送，可以通过这种方式来操作嗷！！！</li>
</ul>
<h1 id="Redis新的数据类型："><a href="#Redis新的数据类型：" class="headerlink" title="Redis新的数据类型："></a>Redis新的数据类型：</h1><h2 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h2><ul>
<li>本身不是一种数据类型，实际上它就是字符串嗷！！！但是它可以对于字符串的位进行操作嗷！！！</li>
<li>Bitmaps单独提供了一套命令，所以在Redis中使用Bitmaps的方法不一样嗷！！！每个单元只能存放0和1嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817192222.png" alt="image-20210817192222123"></p>
<p>上面这个实际上存储的是ascii码嗷！！！</p>
<ul>
<li><p>具体操作：</p>
<ul>
<li><p>setbit key offset value</p>
<ul>
<li><p>设置Bitmaps中某个偏移量的值（0或者1）</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817192428.png" alt="image-20210817192428034"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817192525.png" alt="image-20210817192525353"></p>
<p>缺点：偏移量大的时候，会执行慢，可能造成redis阻塞嗷！！！</p>
</li>
</ul>
</li>
<li><p>getbit key offset</p>
</li>
<li><p>bitcount key start end</p>
<ul>
<li>统计为1的位数的数量</li>
</ul>
</li>
<li><p>bitop and(or&#x2F;not&#x2F;xor) &lt;destkey&gt; [key…]</p>
<ul>
<li>and表示两个里面都取值</li>
<li>or表示或</li>
<li>xor表示异或</li>
<li>说白了就是对应位置的bit运算嘛！！！</li>
<li>返回值是符合条件的比特位个数。</li>
<li>可以用于统计是否登录啊之类的…</li>
</ul>
</li>
</ul>
</li>
<li><p>优点！！！</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817193414.png" alt="image-20210817193414148"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817193448.png" alt="image-20210817193448348"></p>
<p>用户比较少的时候，很多位置是0，就不是非常合适！</p>
<ul>
<li>本身并不是一种独立的数据类型，和Set相比，节约空间嗷（在用户量非常大的时候才适用嗷）！！！</li>
</ul>
<h2 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h2><ul>
<li>用于做基数统计的算法</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817193838.png" alt="image-20210817193838603"></p>
<ul>
<li><p>主要用于做基数的计算操作</p>
</li>
<li><p>常用命令：</p>
<ul>
<li>pfadd key element1 element2 …<ul>
<li>添加元素</li>
</ul>
</li>
<li>pfcount key<ul>
<li>返回所有元素的基数的数量</li>
</ul>
</li>
<li>pfmerge destkey sourcekey1 sourcekey2…<ul>
<li>合并多个key，为一个destkey</li>
<li>例如k1 , program如果都存在</li>
<li>pfmerge k100 k1 program</li>
<li>这样保证了k1和program不动的情况下，融合成一个全新的k100</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h2><ul>
<li>元素的二维坐标，用于地理位置的记录和操作</li>
<li>常用操作：<ul>
<li>geoadd key longtitde latitude member [longtitude latitude member…]<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817194829.png" alt="image-20210817194829643"></li>
<li>可以同时加入多个嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817194924.png" alt="image-20210817194923626"></li>
</ul>
</li>
<li>geopos key member<ul>
<li>这样就可以取到经纬度嗷！！！</li>
</ul>
</li>
<li>geodist key member1 member2 [m|km|ft|mi]<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817195129.png" alt="image-20210817195128895"></li>
<li>取出两个经纬度之间的直线距离嗷！！！</li>
</ul>
</li>
<li>georadius ley longtitude latitude radius m|km|ft|rt<ul>
<li>取出某个经纬度点，以它为中心，半径多哦少以内的所有元素嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210817195332.png" alt="image-20210817195332376"></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Java操作Redis："><a href="#Java操作Redis：" class="headerlink" title="Java操作Redis："></a>Java操作Redis：</h1><h2 id="准备项目："><a href="#准备项目：" class="headerlink" title="准备项目："></a>准备项目：</h2><ol>
<li>新建project</li>
<li>POM依赖：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>新建测试类（com.tuzi.jedis.JedisDemo1）:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisDemo1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//新建Jedis对象</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;www.liuyihao.work&quot;</span>,<span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测试</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> jedis.ping();</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果连接超时的话，很有可能是redis防火墙设置的问题嗷！！！</li>
<li>返回值就是一个PONG，说明连接上了嗷！！！</li>
</ul>
<h2 id="后续测试："><a href="#后续测试：" class="headerlink" title="后续测试："></a>后续测试：</h2><ul>
<li>每种数据类型都有自己的</li>
<li>上网直接查Jedis对应数据类型的操作方法就好了嗷！！！</li>
</ul>
<h2 id="实战演练："><a href="#实战演练：" class="headerlink" title="实战演练："></a>实战演练：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818104318.png" alt="image-20210818103917199"></p>
<ol>
<li>随机生成6位的数字码，2分钟内有效</li>
</ol>
<ul>
<li><p><strong>Random</strong></p>
</li>
<li><p>验证码放到Redis里面去，设置过期时间</p>
</li>
</ul>
<ol start="2">
<li>验证码是否相同？</li>
</ol>
<ul>
<li>从Redis中拿出来，和你的输入进行比对嗷</li>
</ul>
<ol start="3">
<li>每个手机号每天只能输入3次</li>
</ol>
<ul>
<li>incr每次发送之后+1</li>
<li>大于2的时候，提交就不能发送啦！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhoneCode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        verifyCode(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        getRedisCode(<span class="string">&quot;123456&quot;</span>,<span class="string">&quot;463733&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 生成六位数字验证码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getCode</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">rand</span> <span class="operator">=</span> random.nextInt(<span class="number">10</span>);</span><br><span class="line">            code += rand;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 让每个手机每天只能发送三次，设置过期时间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">verifyCode</span><span class="params">(String phone)</span>&#123;</span><br><span class="line">        <span class="comment">//连接redis</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;liuyihao.work&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;********&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拼接key</span></span><br><span class="line">        <span class="comment">//手机发送次数key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">countKey</span> <span class="operator">=</span> <span class="string">&quot;VerifyCode&quot;</span> + phone + <span class="string">&quot;:count&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//验证码key</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">codeKey</span> <span class="operator">=</span> <span class="string">&quot;VerifyCode&quot;</span> + phone + <span class="string">&quot;:code&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//每个手机每天只能取三次</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">count</span> <span class="operator">=</span> jedis.get(countKey);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//没有发送次数，第一次发送</span></span><br><span class="line">            <span class="comment">//设置发送次数位1</span></span><br><span class="line">            jedis.setex(countKey,<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(Integer.parseInt(count) &lt;= <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="comment">//发送次数+1</span></span><br><span class="line">            jedis.incr(countKey);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(Integer.parseInt(count)&gt;<span class="number">2</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;今天发送次数已经超过三次&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送验证码到redis里面</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">vcode</span> <span class="operator">=</span> getCode();</span><br><span class="line">        jedis.setex(codeKey,<span class="number">120</span>,vcode);</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.验证码校验</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getRedisCode</span><span class="params">(String phone , String code)</span>&#123;</span><br><span class="line">        <span class="comment">//从redis获取验证码</span></span><br><span class="line">        <span class="comment">//连接redis</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;liuyihao.work&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;********&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">codeKey</span> <span class="operator">=</span> <span class="string">&quot;VerifyCode&quot;</span> + phone + <span class="string">&quot;:code&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">redisCode</span> <span class="operator">=</span> jedis.get(codeKey);</span><br><span class="line">        <span class="comment">//判断</span></span><br><span class="line">        <span class="keyword">if</span> (redisCode.equals(code))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Boot整合redis："><a href="#Boot整合redis：" class="headerlink" title="Boot整合redis："></a>Boot整合redis：</h2><ol>
<li>新建一个Module</li>
<li>POM.xml：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.12.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Application.yml：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">liuyihao.work</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">********</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动</li>
<li>业务类：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> <span class="keyword">extends</span> <span class="title class_">CachingConfigurerSupport</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>();</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">jackson2JsonRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.WRAPPER_ARRAY);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line">        template.setKeySerializer(redisSerializer);</span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CacheManager <span class="title function_">cacheManager</span><span class="params">(RedisConnectionFactory factory)</span>&#123;</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="type">Jackson2JsonRedisSerializer</span> <span class="variable">jackson2JsonRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>(Object.class);</span><br><span class="line">        <span class="comment">//解决查询异常转换问题</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        <span class="comment">//配置序列化问题</span></span><br><span class="line">        <span class="type">RedisCacheConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .entryTtl(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))</span><br><span class="line">                .disableCachingNullValues();</span><br><span class="line">        <span class="type">RedisCacheManager</span> <span class="variable">cacheManager</span> <span class="operator">=</span> RedisCacheManager.builder(factory)</span><br><span class="line">                .cacheDefaults(config)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>引入web，要做测试嗷！！！</li>
<li>Controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/redisTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testRedis</span><span class="params">()</span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;Tuzi&quot;</span>);</span><br><span class="line">        <span class="comment">//从redis中获取值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String)redisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>测试：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818180016.png" alt="image-20210818180016559"></p>
<h1 id="事务操作："><a href="#事务操作：" class="headerlink" title="事务操作："></a>事务操作：</h1><ul>
<li>单独的隔离操作，所有命令都会序列化，按照顺序执行。事务执行过程中不会被打断嗷。</li>
<li><strong>串联多个命令</strong>（序列化）防止别的命令插队！！！</li>
</ul>
<h2 id="命令："><a href="#命令：" class="headerlink" title="命令："></a>命令：</h2><ul>
<li>Multi：类似于mysql中的start transaction，开启事务。</li>
<li>Exec：类似于mysql中的提交事务</li>
<li>Discard：类似于mysql中的回滚事务</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191123.png" alt="image-20210818191123464"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191319.png" alt="image-20210818191319320"></p>
<ul>
<li>演示：</li>
</ul>
<p>multi + exec</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191506.png" alt="image-20210818191506662"></p>
<p>multi + discard</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191550.png" alt="image-20210818191550730"></p>
<h2 id="事务出错处理："><a href="#事务出错处理：" class="headerlink" title="事务出错处理："></a>事务出错处理：</h2><ul>
<li>组队出错：<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191706.png" alt="image-20210818191706634"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191752.png" alt="image-20210818191752429"></li>
<li>组队有错，整个命令都不会执行嗷！！！</li>
</ul>
</li>
<li>执行出错：<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191842.png" alt="image-20210818191842002"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818191927.png" alt="image-20210818191927555"></li>
<li>组队成功，运行的时候哪个出错就错了，正确的正常执行。</li>
</ul>
</li>
</ul>
<h2 id="事务和锁机制："><a href="#事务和锁机制：" class="headerlink" title="事务和锁机制："></a>事务和锁机制：</h2><ul>
<li><p>悲观锁：加锁操作</p>
<ul>
<li>行锁，读锁，写锁，表锁等都是嗷！</li>
</ul>
</li>
<li><p>乐观锁：</p>
<ul>
<li>数据加上版本号</li>
<li>不锁死嗷！！！</li>
<li>所有人都能拿到数据，但是更新就不一定了嗷</li>
<li>写的少，读的多</li>
<li>抢票就是用乐观锁的嗷</li>
</ul>
</li>
<li><p>命令：</p>
<ul>
<li>使用watch key这种方式来实现嗷！！！</li>
<li>watch是加上了乐观锁嗷！！！</li>
<li>实验使用两个终端，watch同一个key，来进行实验嗷！</li>
<li>实验结果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818195716.png" alt="image-20210818195716428"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818195805.png" alt="image-20210818195805139"></p>
<p>前面的先操作了，后面的就执行不了了嗷！！！</p>
</li>
<li><p>事务三特性：</p>
<ul>
<li>单独的隔离操作（序列化顺序执行）</li>
<li>没有隔离级别的概念</li>
<li>不保证原子性（上面的执行失败了，其他成功的是不会回滚的嗷！！！）</li>
</ul>
</li>
</ul>
<h2 id="秒杀案例："><a href="#秒杀案例：" class="headerlink" title="秒杀案例："></a>秒杀案例：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210818200121.png" alt="image-20210818200121552"></p>
<ul>
<li>并发+多请求操作：<ul>
<li>ab测试工具（模拟高并发嗷！！！）</li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Rv41177Af?p=25&spm_id_from=pageDriver">并发实例学习！！！</a></li>
</ul>
</li>
<li>连接问题的解决：连接池</li>
<li>超卖问题的解决：乐观锁+multi组队的事务操作</li>
<li>乐观锁造成的库存遗留问题：<ul>
<li>改用悲观锁（Redis内部默认不支持悲观锁）</li>
<li>LUA脚本的问题</li>
</ul>
</li>
</ul>
<h1 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h1><h2 id="RDB："><a href="#RDB：" class="headerlink" title="RDB："></a>RDB：</h2><ul>
<li>指定的时间间隔中将内存中的数据集快照写入磁盘</li>
<li>默认生成dump.rdb文件，在当前文件夹下生成嗷！！！</li>
<li>配置文件中可以配置嗷，从理论上来说，key变得越快，更新dump.rdb的时间间隔就越短嗷！！！</li>
<li>配置文件中也有对应的配置嗷</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819083320.png" alt="image-20210819083319828"></p>
<p>注意哈，要把注释打开，然后需要做适当的时间调整哈！！！</p>
<ul>
<li>配置文件中还有save的配置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819083612.png" alt="image-20210819083611916"></p>
<p>第一个效率很低，提供不了服务（持久化的时候）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819083659.png" alt="image-20210819083659018"></p>
<ul>
<li>stop-writes-onbgsave-error：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819083823.png" alt="image-20210819083823678"></p>
<ul>
<li>rdbcompression：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819084045.png" alt="image-20210819084044780"></p>
<ul>
<li>rdbchechsum：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819084120.png" alt="image-20210819084120378"></p>
<ul>
<li>备份如何执行：<ul>
<li>单独创建一个fork子进程来进行持久化，将数据写入一个临时文件，临时文件写完了之后，再用临时文件去替换持久化文件就行了嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819084325.png" alt="image-20210819084325262"></li>
<li>缺点：最后一次持久化后的数据可能丢失嗷！（说白了就是还没满足条件，持久化还未激活，导致后面来的数据没有被持久化，自然就丢失了orz）</li>
<li>如果数据非常敏感不建议使用RDB，使用AOF就可以了嗷！</li>
</ul>
</li>
<li>原理：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819084903.png" alt="image-20210819084903138"></p>
<p>然后子进程就操作自己的那一份内容，操作完成再替换掉父进程中的内容。</p>
<ul>
<li>恢复：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819085029.png" alt="image-20210819085028908"></p>
<ul>
<li>优势：<ul>
<li>节约磁盘空间</li>
<li>更快一些</li>
<li>适合大规模的数据恢复</li>
<li>对于数据完整性和一致性要求不高更加适合使用</li>
</ul>
</li>
</ul>
<h2 id="AOF："><a href="#AOF：" class="headerlink" title="AOF："></a>AOF：</h2><ul>
<li>Append Only File</li>
<li>以日志的形式来记录每个写操作（不保存读记录）</li>
<li>记录所有指令，只允许追加文件不可以改写文件。</li>
<li>AOF默认不开启的嗷！！！配置文件中有一个appendonly</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819100051.png" alt="image-20210819100050855"></p>
<p>改成yes才算开启了AOF</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819100142.png" alt="image-20210819100141767"></p>
<p>生成的路径是一样的哦，和RDB是一样的，都是在当前目录下生成嗷！！！</p>
<ul>
<li><p>如果AOF和RDB都开启了的话，系统默认从AOF中去读取恢复数据嗷！！！（说白了就是RDB就像不存在了，使用AOF的机制来备份和恢复嗷！！！）</p>
</li>
<li><p>异常恢复：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819100612.png" alt="image-20210819100612713"></p>
<p>如果文件出现异常的话，会报以下的错误啊：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819100950.png" alt="image-20210819100950126"></p>
<p>这个时候就需要进行aof文件的恢复嗷！！！</p>
<ul>
<li><p>配置：</p>
<ul>
<li><p>同步频率设置：</p>
<ul>
<li>appendfsync always&#x2F;everysec&#x2F;no</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819101142.png" alt="image-20210819101142247"></li>
</ul>
</li>
<li><p>Rewrite压缩：</p>
<ul>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819101335.png" alt="image-20210819101334886"></p>
</li>
<li><p>这个也是通过fork子进程来实现的嗷！！！</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819101511.png" alt="image-20210819101510700"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819101537.png" alt="image-20210819101536615"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>持久化流程：</p>
<ul>
<li>请求写命令会被Append到AOF缓冲区内。</li>
<li>根据AOF持久化策略，将操作异步同步到磁盘的AOF文件中。</li>
<li>如果触发重写策略或者手动重写的时候，会对AOF文件rewrite重写，压缩AOF文件容量。</li>
<li>重启的时候，会加载AOF中的写操作达到数据恢复的目的。</li>
</ul>
</li>
<li><p>优点：</p>
<ul>
<li>备份机制文件，丢失数据概率低</li>
<li>可读的日志文本，通过操作AOF文件，处理错误的备份文件。</li>
</ul>
</li>
<li><p>劣势：</p>
<ul>
<li>记录操作，占用更多的空间</li>
<li>速度慢</li>
<li>每次同步，性能压力</li>
<li>恢复记录文件可能会造成问题</li>
</ul>
</li>
</ul>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><ul>
<li>官方推荐两个都启用</li>
<li>数据不敏感，RDB</li>
<li>不建议单独使用AOF，可能会有bug</li>
<li>只是做纯内存缓存，可以都不用</li>
</ul>
<h1 id="主从复制："><a href="#主从复制：" class="headerlink" title="主从复制："></a>主从复制：</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819103646.png" alt="image-20210819103645608"></p>
<ul>
<li>好处：<ul>
<li>读写分离</li>
<li>容灾的快速恢复</li>
</ul>
</li>
<li>一主多从！！！那主机挂了咋办？？？主机集群嗷！！！有备用的嗷！！！</li>
</ul>
<h2 id="一主两从示例："><a href="#一主两从示例：" class="headerlink" title="一主两从示例："></a>一主两从示例：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819105656.png" alt="image-20210819105649499"></p>
<ul>
<li>上面这里就是，每一台服务器都有自己的配置内容，配置到自己的配置文件中，然后引入公共的配置部分嗷！！！</li>
<li>然后启动三个Redis服务：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819110739.png" alt="image-20210819110739173"></p>
<p>没有主从的效果，因为我们没有进行过任何的主从配置嗷！！！</p>
<ul>
<li>如何配置主从关系呢？</li>
</ul>
<p>注意：配置从服务器，默认开启就是主服务器嗷！！！主服务器不用进行额外配置的嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819111244.png" alt="image-20210819111243976"></p>
<p>以上命令是在命令行中执行的嗷！！！</p>
<ul>
<li><p>info replication：</p>
<ul>
<li>也是在命令行中执行的嗷！！！</li>
<li>可以查看本机的状态：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819111541.png" alt="image-20210819111540893"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819111630.png" alt="image-20210819111630381"></p>
</li>
<li><p>测试：</p>
<ul>
<li>主机写入的内容，从机可以读！！！</li>
<li>从机不可以进行写操作！！！</li>
</ul>
</li>
</ul>
<h2 id="几个大问题："><a href="#几个大问题：" class="headerlink" title="几个大问题："></a>几个大问题：</h2><h3 id="一主两从："><a href="#一主两从：" class="headerlink" title="一主两从："></a>一主两从：</h3><ul>
<li>从机挂了：<ul>
<li>重启某个从服务器之后，它默认又是主服务器了orz</li>
<li>还需要重新设置为从服务器，然后会重新从头复制一遍主服务器的内容，保证数据的一致性嗷！！！</li>
</ul>
</li>
<li>主机挂了：<ul>
<li>知道大哥挂了，但是大哥就是大哥，我还认你这个大哥嗷！！！</li>
<li>大哥复活了，小弟们都还在嗷！！！（从服务器仍然是从服务器嗷！！！）</li>
</ul>
</li>
</ul>
<h3 id="薪火相传："><a href="#薪火相传：" class="headerlink" title="薪火相传："></a>薪火相传：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819115219.png" alt="image-20210819115218796"></p>
<p>层级模式，主服务器同步从服务器，服务器再帮忙给更多的从服务器扩散。</p>
<p>问题：如果第二层的服务器裂开了，第三层就失联了orz</p>
<ul>
<li>从服务器下面还能再挂从服务器嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819120142.png" alt="image-20210819120142267"></p>
<h3 id="反客为主："><a href="#反客为主：" class="headerlink" title="反客为主："></a>反客为主：</h3><ul>
<li>小弟当大哥嗷！！！</li>
<li>命令：slaveof no one</li>
<li>上面这个命令在cli里面输入嗷！！！就是相当于从slave模式切换回master模式嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819125937.png" alt="image-20210819125929530"></p>
<p>缺点：手动完成，不能够自动完成嗷！！！</p>
<ul>
<li>自动完成：<ul>
<li>哨兵模式—凡客为主自动版</li>
</ul>
</li>
</ul>
<h3 id="复制原理："><a href="#复制原理：" class="headerlink" title="复制原理："></a>复制原理：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819112651.png" alt="image-20210819112651758"></p>
<ul>
<li>前面的框中是从服务器主动做的，连接主服务器，要求同步的消息。</li>
<li>后面主服务器再收到写的消息的时候，就会主动把数据同步到从服务器嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819112827.png" alt="image-20210819112827263"></p>
<h1 id="哨兵模式："><a href="#哨兵模式：" class="headerlink" title="哨兵模式："></a>哨兵模式：</h1><ul>
<li>从机盯着主机，主机挂了，就立马通知从机变成主机。一主二仆模式。</li>
</ul>
<ol>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819154132.png" alt="image-20210819154123733"></li>
</ol>
<p>这个名字不能错哈！！！</p>
<ol start="2">
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819154509.png" alt="image-20210819154508808"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819154830.png" alt="image-20210819154830327"></p>
</li>
</ol>
<p>上述就成功完成了哨兵对于主机的监控嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819155139.png" alt="image-20210819155138820"></p>
<p>6380就是新的主机，6379变味了从机，就算它好了，它也是从机嗷！！！</p>
<ul>
<li>小缺点：<ul>
<li>复制延迟</li>
<li>从主机到从机的过程中，会有延迟嗷！！！</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819155450.png" alt="image-20210819155450521"></p>
<ul>
<li>选举规则：<ul>
<li>值越小，优先级越高</li>
<li>在redis.conf中配置嗷！！！</li>
<li>偏移量指的是和原主机数据的同步率，同步率越高，偏移量越大。</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819155708.png" alt="image-20210819155707977"></li>
</ul>
</li>
<li>配置文件中的位置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819155733.png" alt="image-20210819155733606"></p>
<ul>
<li>主从复制的Java实现：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819160851.png" alt="image-20210819160850945"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819160918.png" alt="image-20210819160918720"></p>
<h1 id="Redis集群："><a href="#Redis集群：" class="headerlink" title="Redis集群："></a>Redis集群：</h1><ul>
<li>集群解决的问题：<ul>
<li>Redis容量不够？</li>
<li>并发写操作，如何分摊？</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819161153.png" alt="image-20210819161153243"></p>
<ul>
<li>代理主机：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819161336.png" alt="image-20210819161336607"></p>
<p>紫色的都是集群后备机，预防出现的问题嗷！！！</p>
<ul>
<li>无中心化集群：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819161429.png" alt="image-20210819161428919"></p>
<p>任何一台Redis都可以作为集群的入口，相互联通，可以转交服务请求嗷！！！</p>
<ul>
<li>特点：<ul>
<li>实现了Redis集群的水平扩容，数据平均存储，每个节点存储总数据的1&#x2F;N</li>
<li>Redis通过分区提供一定程度的可用性，一部分出问题，其他部分还可以提供服务嗷！！！</li>
</ul>
</li>
</ul>
<h2 id="操作实例："><a href="#操作实例：" class="headerlink" title="操作实例："></a>操作实例：</h2><h3 id="集群搭建："><a href="#集群搭建：" class="headerlink" title="集群搭建："></a>集群搭建：</h3><ul>
<li>模仿上面的用户，订单，商品模块来搭建集群：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819161847.png" alt="image-20210819161847703"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819162211.png" alt="image-20210819162211072"></p>
<ul>
<li>替换小技巧：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819162430.png" alt="image-20210819162429964"></p>
<ul>
<li>将启动的六个结点编程一个集群嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819162609.png" alt="image-20210819162608821"></p>
<p>replicas后面加一个1，表示以最简单的方式创建集群嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819162824.png" alt="image-20210819162824723"></p>
<ul>
<li>创建集群完成之后，有如下效果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819163125.png" alt="image-20210819163125289"></p>
<ul>
<li>连接集群：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819163346.png" alt="image-20210819163346320"></p>
<p>-c 表示以集群的方式连接，连接这六台机器里面的任何一台都没问题嗷！！！都是连接到了这个集群中嗷！！！</p>
<h3 id="集群操作："><a href="#集群操作：" class="headerlink" title="集群操作："></a>集群操作：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819163631.png" alt="image-20210819163631485"></p>
<p>最后一句话是因为，尽量分开啊，如果主和从在同一台机器上，一起挂了，不久了吗orz</p>
<ul>
<li>插槽：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819164349.png" alt="image-20210819164348513"></p>
<p>插槽就是帮助我们，把压力分担到各台服务器上去嗷！！！</p>
<ul>
<li>插槽实例：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819164451.png" alt="image-20210819164450726"></p>
<p>set先会计算插槽，然后根据插槽所在的主机，切换集群中的主机，然后再执行set操作嗷！！！</p>
<ul>
<li>mset：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819164634.png" alt="image-20210819164633913"></p>
<p>失败了，那我如何实现多个值同时赋予呢？</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819164723.png" alt="image-20210819164723622"></p>
<p>设置一个组名，这个时候，计算插槽是用组名去计算的，就能够正常完成多个值的添加嗷！！！</p>
<ul>
<li>查询集群中的值：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819164826.png" alt="image-20210819164826701"></p>
<p>当你处于某一台服务器，你只能看自己这台服务器插槽的值，相应的插槽要到对应的服务器上去看嗷！！！</p>
<ul>
<li>故障恢复：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819165303.png" alt="image-20210819165302904"></p>
<p>和上面是一样的，之前的从机变成了现在的主机，挂掉的主机变成了从机嗷！！！</p>
<p>如果主从都挂掉了可以吗？？？这个要看配置嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819165447.png" alt="image-20210819165447225"></p>
<ul>
<li>Java操作Redis：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819165605.png" alt="image-20210819165605117"></p>
<h2 id="Java操作集群："><a href="#Java操作集群：" class="headerlink" title="Java操作集群："></a>Java操作集群：</h2><ul>
<li>入口很好写，任何一台机器都可以嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819172305.png" alt="image-20210819172304793"></p>
<ul>
<li>上面和上上面都可以的哦，可以写Set嗷！！！但是没必要，集群一个就可以嗷！！！</li>
<li>好处：<ul>
<li>扩容</li>
<li>分摊压力</li>
<li>无中心配置相对简单</li>
</ul>
</li>
<li>不足：<ul>
<li>多键操作不被支持</li>
<li>多键的Redis事务不被支持，lua脚本不被支持</li>
<li>Redis集群方案出现较晚</li>
</ul>
</li>
</ul>
<h1 id="Redis应用问题（面试高危）："><a href="#Redis应用问题（面试高危）：" class="headerlink" title="Redis应用问题（面试高危）："></a>Redis应用问题（面试高危）：</h1><h2 id="缓存穿透："><a href="#缓存穿透：" class="headerlink" title="缓存穿透："></a>缓存穿透：</h2><ul>
<li>应用服务器压力变大了</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819174253.png" alt="image-20210819174252937"></p>
<p>缓存帮SQL分担压力，但是当大量流量涌入的时候，缓存无能为力了，差不到了，流量全去找数据库了orz。把服务器搞崩了orz。</p>
<ul>
<li><p>redis平稳运行，但是缓存没有起到作用，继续去访问</p>
</li>
<li><p>出现的问题：</p>
<ul>
<li>redis查询不到数据库</li>
<li>出现很多非正常url服务（DDos攻击）</li>
</ul>
</li>
<li><p>解决：</p>
<ol>
<li>对空值做缓存，让过期时间变短</li>
<li>设置可访问的名单（白名单）：BitMaps</li>
<li>布隆过滤器：效率高的BitMaps</li>
<li>进行实时监控（例如黑名单）</li>
</ol>
</li>
</ul>
<h2 id="缓存击穿："><a href="#缓存击穿：" class="headerlink" title="缓存击穿："></a>缓存击穿：</h2><ul>
<li>现象：<ul>
<li>数据库访问压力突然增加</li>
<li>redis里面并没有出现大量key过期</li>
<li>redis正常运行</li>
</ul>
</li>
<li>原因：<ul>
<li>某个被大量访问的key（<strong>某个热门key</strong>）过期了</li>
<li>但是没有被黑客攻击哦！！！</li>
</ul>
</li>
<li>流程图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819180056.png" alt="image-20210819180056436"></p>
<ul>
<li>解决方案：<ul>
<li>预先设置热门数据，加大时长</li>
<li>实时调整：根据热门数据调整key的时长</li>
<li>加锁：效率低，但是能够解决嗷！！！</li>
</ul>
</li>
</ul>
<h2 id="雪崩问题："><a href="#雪崩问题：" class="headerlink" title="雪崩问题："></a>雪崩问题：</h2><ul>
<li>数据库压力变大，服务器崩溃！！！</li>
<li>问题：<ol>
<li>极少的时间段内，查询<strong>大量key</strong>的集中过期情况</li>
</ol>
</li>
<li>解决方案：<ol>
<li>构建多级缓存架构：nginx + redis + 其他缓存等</li>
<li>使用锁或者队列</li>
<li>设置过期标志，更新缓存</li>
<li>将缓存失效时间分散开来</li>
</ol>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819192340.png" alt="image-20210819192339879"></p>
<h1 id="分布式锁："><a href="#分布式锁：" class="headerlink" title="分布式锁："></a>分布式锁：</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819192454.png" alt="image-20210819192454434"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819192528.png" alt="image-20210819192527835"></p>
<ul>
<li>例如setnx就相当于加锁，del就相当于释放锁</li>
<li>你要拿了锁不释放呢？设置过期时间！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819193049.png" alt="image-20210819193049684"></p>
<ul>
<li>解决分布式锁问题：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819193108.png" alt="image-20210819193108433"></p>
<p>使用：set key value nx ex TTL来实现，nx表示上锁嗷！！！</p>
<h2 id="Java测试："><a href="#Java测试：" class="headerlink" title="Java测试："></a>Java测试：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819193737.png" alt="image-20210819193737491"></p>
<ul>
<li>没有问题，就是怕锁没办法释放就裂开来！！！比如运行中间出现了问题，锁加上了但是没释放，再次执行就执行不了了嗷！！！</li>
<li>else后面就是等待，上锁失败就要sleep一会儿，再次进行获取嗷！！！另外，上锁和解锁本身都是原子操作嗷！！！</li>
<li>那如何设置过期时间呢？</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819194022.png" alt="image-20210819194022400"></p>
<ul>
<li><p>还存在什么问题？？？</p>
<ul>
<li>锁乱啦！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819194242.png" alt="image-20210819194242039"></p>
<ul>
<li><p>如何解决？</p>
<ol>
<li>使用UUID防止误删。使用UUID来进行判断。</li>
</ol>
<p>释放锁的时候，先判断当前要释放锁的UUID和锁的UUID是否一样嗷！！！</p>
</li>
<li><p>上面仍然有问题嗷！！！删除缺乏原子性！！！</p>
<ul>
<li>即使有上面的判断，依然可能造成A删除了B的锁嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819201656.png" alt="image-20210819201656561"></li>
</ul>
</li>
<li><p>如何解决？</p>
<ul>
<li>LUA脚本嗷！！！具有原子性，所有的指令一次性完成嗷！！！</li>
<li>所以比较UUID和删除在脚本中一气呵成，别人是不能够干预的，A就没有释放B的锁的机会了嗷！！！释放锁成了一个整体嗷！！！</li>
</ul>
</li>
</ul>
</li>
<li><p>分布式锁至少要满足以下四个条件：</p>
<ul>
<li>互斥性，任何时刻，只有一个客户端能持有锁</li>
<li>不会发生死锁，即使有一个客户端在持有锁的期间没有主动解锁，也能保证其他客户端能够加锁嗷！！！</li>
<li>客户端不能够把别人加的锁给解了，解铃还须系铃人。</li>
<li>加锁和解锁的整个过程都要是原子操作嗷！！！</li>
</ul>
</li>
</ul>
<h1 id="Redis6-0开始的新功能"><a href="#Redis6-0开始的新功能" class="headerlink" title="Redis6.0开始的新功能"></a>Redis6.0开始的新功能</h1><h2 id="ACL"><a href="#ACL" class="headerlink" title="ACL:"></a>ACL:</h2><ul>
<li>acl list</li>
<li>acl cat</li>
<li>acl cat string&#x2F;……</li>
<li>acl setuser username</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819203311.png" alt="image-20210819203311312"></p>
<p>&gt; 后面的内容就是密码哈！！！</p>
<ul>
<li>acl whoami</li>
<li>auth username password</li>
</ul>
<h2 id="IO多线程："><a href="#IO多线程：" class="headerlink" title="IO多线程："></a>IO多线程：</h2><ul>
<li>本质执行命令还是单线程，单线程+多路IO复用。这个多路IO是针对于网络命令解析啊之类的开启的嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819203616.png" alt="image-20210819203616177"></li>
</ul>
<h2 id="工具支持Cluster："><a href="#工具支持Cluster：" class="headerlink" title="工具支持Cluster："></a>工具支持Cluster：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819203720.png" alt="image-20210819203720387"></p>
<h2 id="新功能关注："><a href="#新功能关注：" class="headerlink" title="新功能关注："></a>新功能关注：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210819203751.png" alt="image-20210819203751249"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/16/Redis%E5%AD%A6%E4%B9%A0/" data-id="cl6gepmfy0031e0jq4ey02d0t" data-title="Redis学习" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Nginx学习" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/12/Nginx%E5%AD%A6%E4%B9%A0/" class="article-date">
  <time class="dt-published" datetime="2021-08-12T13:02:20.000Z" itemprop="datePublished">2021-08-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/12/Nginx%E5%AD%A6%E4%B9%A0/">Nginx学习</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Cloud中Nginx知识补充"><a href="#Cloud中Nginx知识补充" class="headerlink" title="Cloud中Nginx知识补充"></a>Cloud中Nginx知识补充</h1><ul>
<li>Nginx基本概念：</li>
</ul>
<blockquote>
<ol>
<li>是啥，干啥</li>
<li>反向代理</li>
<li>负载均衡</li>
<li>动静分离</li>
</ol>
</blockquote>
<ul>
<li><p>Nginx学习大纲：</p>
<blockquote>
<ol>
<li>Linux安装</li>
<li>Nginx常用命令</li>
<li>配置文件</li>
</ol>
</blockquote>
</li>
<li><p>Nginx配置实例：</p>
</li>
</ul>
<blockquote>
<ol>
<li>反向代理</li>
<li>Nginx负载均衡</li>
<li>动静分离</li>
<li>配置高可用集群</li>
</ol>
</blockquote>
<ul>
<li>Nginx原理</li>
</ul>
<h1 id="Nginx简介："><a href="#Nginx简介：" class="headerlink" title="Nginx简介："></a>Nginx简介：</h1><ul>
<li>Nginx为高性能反向代理服务器，为了性能而开发了，十分注重效率，非常好用嗷！！！</li>
<li>可以热更新嗷！！！很快乐！！！高可用嗷！！！</li>
</ul>
<h2 id="正向代理："><a href="#正向代理：" class="headerlink" title="正向代理："></a>正向代理：</h2><ul>
<li>客户端用的代理服务器来访问Internet的过程就叫做正向代理哦！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812215139.png" alt="image-20210812215138818"></p>
<ul>
<li>客户端自己配置代理服务器，通过代理服务器进行资源访问。</li>
</ul>
<h2 id="反向代理："><a href="#反向代理：" class="headerlink" title="反向代理："></a>反向代理：</h2><ul>
<li>客户端不需要经过任何的配置就能够访问，我们只需要将请求发送到反向代理服务器，反向代理服务器帮助我们获取数据之后返回给客户端。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812215606.png" alt="image-20210812215605850"></p>
<ul>
<li><p>对于用户来说，它甚至不知道反向代理服务器的存在，它把右边当作整体，对外暴露的是9001端口，由反向代理服务器再去拿到资源返回给用户。</p>
</li>
<li><p>整体作为一整个服务器，但是实际上暴露的是代理服务器的地址，而隐藏了正式服务器的IP地址。</p>
</li>
<li><p>说白了正向代理是客户端的代理，反向代理是服务端的代理呗！！！</p>
</li>
</ul>
<h2 id="负载均衡："><a href="#负载均衡：" class="headerlink" title="负载均衡："></a>负载均衡：</h2><ul>
<li>增加服务器的数量，将请求分发到各个服务器上，将负载分发到不同的服务器上嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813083546.png" alt="image-20210813083546390"></p>
<h2 id="动静分离："><a href="#动静分离：" class="headerlink" title="动静分离："></a>动静分离：</h2><ul>
<li>加快网站解析速度，将动态页面和静态资源分开来，加快解析速度。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813083927.png" alt="image-20210813083927268"></p>
<h1 id="Nginx在Linux中的安装："><a href="#Nginx在Linux中的安装：" class="headerlink" title="Nginx在Linux中的安装："></a>Nginx在Linux中的安装：</h1><ol>
<li><p>XShell连接Nginx</p>
</li>
<li><p>安装方式选择：</p>
<ol>
<li>Windows下载对应的tar.gz包就好，Xshell中cd到对应的文件夹下，将下载的包拖进去嗷！！！</li>
<li>使用docker进行下载安装嗷！！！</li>
<li>使用Linux中默认的命令进行下载配置。</li>
</ol>
<p>第一种和第三种其实还需要好多其他的依赖的嗷！！！所以需要我们进一步进行配置等。</p>
</li>
</ol>
<ul>
<li><p>初探配置（这里采用Docker下的Nginx）：</p>
<ul>
<li><pre><code class="shell">[root@VM-12-10-centos usr]# docker exec -it nginx01 &quot;bin/bash&quot;
root@bf9a21cb4ccd:/# ls
bin   docker-entrypoint.d   home   media  proc	sbin  tmp
boot  docker-entrypoint.sh  lib    mnt	  root	srv   usr
dev   etc		    lib64  opt	  run	sys   var
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 然后进入了交互页面之后，在etc文件夹下的nginx目录，就有对应的内容嗷！！！</span><br><span class="line"></span><br><span class="line">- ```shell</span><br><span class="line">  root@bf9a21cb4ccd:/etc/nginx/conf.d# ls</span><br><span class="line">  default.conf</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>在如上目录中，即有default.conf，这个是Docker的默认配置文件嗷！！！</p>
</li>
</ul>
</li>
</ul>
<h1 id="Nginx操作的常用命令："><a href="#Nginx操作的常用命令：" class="headerlink" title="Nginx操作的常用命令："></a>Nginx操作的常用命令：</h1><ul>
<li>前提条件：进入到Nginx目录中才能够输入nginx的命令。正常情况下应该是nginx文件夹中的sbin目录中，但是docker是阉割版的，没有这个文件夹？？？</li>
<li>这里我们进入Nginx中都能够使用nginx的命令嗷！！！</li>
</ul>
<h2 id="nginx-v"><a href="#nginx-v" class="headerlink" title="nginx -v"></a>nginx -v</h2><ul>
<li>可以查看版本号</li>
<li>正常的nginx是 .&#x2F;nginx -v</li>
</ul>
<h2 id="nginx-s-stop"><a href="#nginx-s-stop" class="headerlink" title="nginx -s stop"></a>nginx -s stop</h2><ul>
<li>关闭Nginx</li>
<li>在docker中就是直接停止这个Nginx容器的运行嗷！</li>
<li>正常的nginx是 .&#x2F;nginx -s stop</li>
</ul>
<h2 id="x2F-nginx-docker-run-x2F-docker-restart-："><a href="#x2F-nginx-docker-run-x2F-docker-restart-：" class="headerlink" title=".&#x2F;nginx(docker  run &#x2F; docker restart)："></a>.&#x2F;nginx(docker  run &#x2F; docker restart)：</h2><ul>
<li><p>启动nginx服务（正常的nginx）</p>
</li>
<li><p>由于在正常的nginx中的sbin文件夹下是有nginx.exe这个东西的，上面这些命令其实都要在sbin文件夹下使用&#x2F;nginx + 命令才可以使用，只是在docker中直接使用nginx就可以使用罢了。</p>
</li>
<li><p>docker中没有严格意义上的nginx内部重启nginx服务，要启动nginx服务，只能在docker层面上，通过开启对应的image的方式来实现嗷！</p>
</li>
</ul>
<h2 id="nginx-s-reload："><a href="#nginx-s-reload：" class="headerlink" title="nginx -s reload："></a>nginx -s reload：</h2><ul>
<li>不暂停nginx服务，重新加载配置文件，使新的nginx配置生效。</li>
<li>正常的nginx是.&#x2F;nginx -s reload。</li>
</ul>
<h1 id="Nginx配置文件："><a href="#Nginx配置文件：" class="headerlink" title="Nginx配置文件："></a>Nginx配置文件：</h1><ul>
<li>Docker中所在位置：<code>/etc/nginx</code></li>
<li>Linux中所在位置：<code>/usr/local/nginx/conf</code></li>
</ul>
<h2 id="配置文件中的组成部分："><a href="#配置文件中的组成部分：" class="headerlink" title="配置文件中的组成部分："></a>配置文件中的组成部分：</h2><ol>
<li>全局块：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815191129.png" alt="image-20210815191122340"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815202512.png" alt="image-20210815202512279"></p>
<ol start="2">
<li>events块</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>像这里就是表示Nginx支持的最大连接数是多少，这部分配置对于Nginx的影响较大。</p>
<ol start="3">
<li>http块</li>
</ol>
<p>配置最频繁的部分，这里有细分为：</p>
<ul>
<li>Http全局块：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815191629.png" alt="image-20210815191629828"></p>
<ul>
<li>Server块：</li>
</ul>
<p>与虚拟主机有密切关系，每个Http可以有多个server块，每个server可以当作一台虚拟主机。每个server块分为全局server块，同时包含多个location块。</p>
<ol>
<li>全局server块：</li>
</ol>
<p>最常见的配置是本虚拟机主机的监听配置和本虚拟主机的名称或者ip配置。</p>
<ol start="2">
<li>location块：</li>
</ol>
<p>一个server又可以有多个location块。基于收到的字符串进行匹配，对于特定的请求进行处理。很多第三方模块配置（数据缓存啊，应答控制之类的），也在这里嗷！</p>
<h1 id="Nginx配置实例："><a href="#Nginx配置实例：" class="headerlink" title="Nginx配置实例："></a>Nginx配置实例：</h1><h2 id="反向代理：-1"><a href="#反向代理：-1" class="headerlink" title="反向代理："></a>反向代理：</h2><ol>
<li>实现效果：</li>
</ol>
<ul>
<li>打开浏览器，输入<a target="_blank" rel="noopener" href="http://www.123.com,跳转到linux系统中的tomcat主页面中/">www.123.com，跳转到linux系统中的Tomcat主页面中</a></li>
</ul>
<ol start="2">
<li>准备工作：</li>
</ol>
<ul>
<li>在Linux系统安装Tomcat，默认端口8080。我们这里启动一个tomcat镜像，使用本机的8080系统。</li>
<li>对外开放访问的端口</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=8080/tcp --permanent</span><br><span class="line">firewall-cmd -reload</span><br></pre></td></tr></table></figure>

<p>这里不用上面这种哈，直接用腾讯云的控制台开放对应的8080端口就好了嗷！！！</p>
<ol start="3">
<li>访问过程分析：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815201129.png" alt="image-20210815201129368"></p>
<p>网络访问原理：</p>
<p>首先浏览器先会去到Host文件中查找我们是否做过相应的配置，如果有相应的解析配置的话就用我们自己的解析配置。如果没有相应的配置的话，才会下一步去DNS服务器解析我们输入的域名嗷！！！</p>
<p>这里实验为了简单我就不配host中的域名和ip对应关系的配置嗷！！！本质上就是访问nginx嘛，多了一层映射而已，没啥区别。</p>
<p>Host文件的默认位置：C:\Windows\System32\etc\drivers\etc\HOSTS</p>
<p>前面的内容是ip地址，后面那个是域名。</p>
<ol start="4">
<li>实际操作</li>
</ol>
<h3 id="Docker容器之间反向代理"><a href="#Docker容器之间反向代理" class="headerlink" title="Docker容器之间反向代理"></a>Docker容器之间反向代理</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815202629.png" alt="image-20210815202629435"></p>
<p>本质上只需要修改nginx的映射规则就行了，这里就是修改我们的这个server就可以啦！</p>
<ul>
<li>Docker中的反向代理：<ul>
<li>首先docker中的反向代理涉及到了网关的概念。</li>
<li>例如我们使用本机3344映射Nginx，本机8080映射Tomcat，下面是Nginx转发请求到Tomcat的过程。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815212916.png" alt="image-20210815212916324"></p>
<ul>
<li>首先找到Tomcat的IP地址，Docker之前相互沟通本质上是通过网关进行的嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815213048.png" alt="image-20210815213048169"></p>
<ul>
<li>我们查看一下Nginx的Ip地址，发现它和Tomcat使用的本质上是同一个网关嗷，它可以通过172.17.0.2感知到Tomcat的Docker进程的存在。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815213317.png" alt="image-20210815213316906"></p>
<ul>
<li>然后我们在Nginx容器内部相应的转发代理的位置，添加对应的地址（注意，这里是容器与容器的沟通，没有到Linux服务器层面，所以这里的端口号就是容器本身的端口号，ip地址也是Tomcat容器的IP地址）。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dotnet261010/p/12596185.html">Nginx反向代理实例</a></p>
<h3 id="Docker为宿主机提供反向代理"><a href="#Docker为宿主机提供反向代理" class="headerlink" title="Docker为宿主机提供反向代理"></a>Docker为宿主机提供反向代理</h3><ul>
<li>同理，上面的所谓的gateway是由Linux宿主机提供的，要想代理宿主机的某个端口，就可以使用172.17.0.1来操作。</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815214427.png" alt="image-20210815214426914"></li>
<li>可以看到，我们这里反向代理的宿主机的80端口，而我早就在宿主机的80端口部署了我的博客，成功访问。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815214524.png" alt="image-20210815214523441"></p>
<h3 id="Docker为外网提供反向代理"><a href="#Docker为外网提供反向代理" class="headerlink" title="Docker为外网提供反向代理"></a>Docker为外网提供反向代理</h3><ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815215012.png" alt="image-20210815215012078"></li>
<li>直接代理到外网网址，完全不慌嗷！！！我来试试我自己的！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815215148.png" alt="image-20210815215148595"></p>
<p>也没有任何问题，成功访问到了我的博客首页，非常棒！！！</p>
<h3 id="Docker使用ip地址提供反向代理"><a href="#Docker使用ip地址提供反向代理" class="headerlink" title="Docker使用ip地址提供反向代理"></a>Docker使用ip地址提供反向代理</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210815215440.png" alt="image-20210815215440789"></p>
<ul>
<li>这里也没有任何问题嗷！！！注意一下一个坑，这里的话，一定要加上前面的Http！！！</li>
<li>综上，提供了代理不同情况下的端口的方法，后面学习会更加容易嗷！！！</li>
<li>每次更新了nginx配置文件之后，都要<code>nginx -s reload</code>才能够刷新nginx，重新读取配置文件嗷！！！</li>
</ul>
<h2 id="反向代理2："><a href="#反向代理2：" class="headerlink" title="反向代理2："></a>反向代理2：</h2><ol>
<li>根据访问的路径不同，转到不同的页面去嗷！！！例如<code>http://127.0.0.1:9001/edu/</code>和<code>http://127.0.0.1/vod/</code>这两个要跳转到不同的端口去。</li>
</ol>
<ul>
<li>课程使用的是部署了两个Tomcat，然后改了不同的Tomcat的端口号，并且在webapps下加入了对应的文件夹和定制化页面。</li>
<li>这里我们不那么复杂，我们就拿上次部署在8080端口的Tomcat和80端口我们的网页做一个测试就行嗷！</li>
</ul>
<ol start="2">
<li>实操：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816092307.png" alt="image-20210816092259367"></p>
<p>本质上就是使用正则表达式多加了两个映射功能，当路径含有blog和edu的话，就访问8080端口嗷！！！注意哈，有些东西是有问题的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816092422.png" alt="image-20210816092422414"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816092450.png" alt="image-20210816092450064"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816092624.png" alt="image-20210816092624459"></p>
<ul>
<li>前面表示路径，最后一个表示资源。所以上面的第一个里面，本质上是请求3344端口映射下的blog资源，那当然找不到哇。后面两个都是在访问&#x2F;blog路径下的资源，这才符合正则匹配的规则，成功引到了正确的页面。</li>
<li>注意！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816092916.png" alt="image-20210816092915828"></p>
<ul>
<li>并且还有一个大坑！！！</li>
</ul>
<p>反向代理的原理还待深入研究！！！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@8ff1a1258fb6:/usr/local/tomcat/webapps/edu# pwd</span><br><span class="line">/usr/local/tomcat/webapps/edu</span><br><span class="line">root@8ff1a1258fb6:/usr/local/tomcat/webapps/edu# cat a.html</span><br><span class="line">&lt;h1&gt;This is a test of the /edu/a.html path!!!&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>我在tomcat的webapps目录下，新建了一个edu文件夹，然后新建了a.html文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816100105.png" alt="image-20210816100105792"></p>
<p>在网页中我访问到了这个文件，这引发了我的思考，这个原理是什么呢？？？</p>
<p><strong>我得出的结论，这里的反向代理转发，本质上只是把前面的liuyihao.work:3344代理成了我的服务器对应的地址。然后把&#x2F;edu&#x2F;a.html转交给了Nginx所代理的服务器，就是说，这里的转发不是直接到那个代理的服务器。而是在规则匹配了之后，将我访问的路径，转交给了代理的服务器，由代理的服务器进行进一步的处理嗷！！！</strong></p>
<ul>
<li>并且我发现，如果是docker层之间的反向代理，是不受防火墙的约束的，例如我新启动了一个tomcat，服务监听8081，但是我的8081端口没有对外开放。我通过docker的网关，172那个，而不是从宿主机的端口进行访问，是可以成功的嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816101914.png" alt="image-20210816101914750"></p>
<h2 id="负载均衡：-1"><a href="#负载均衡：-1" class="headerlink" title="负载均衡："></a>负载均衡：</h2><ol>
<li>通过浏览器地址栏输入地址，负载均衡效果，平均到8080和8081端口中。现在就是访问3344端口，实现8080&#x2F;8081，实际上就是轮询两台Tomcat服务器嗷！！！</li>
<li>环境准备：</li>
</ol>
<ul>
<li>和上面一样的，完成Nginx对于两台Tomcat的访问（通过内部网关），&#x2F;edu&#x2F;a.html都要由嗷！！！</li>
</ul>
<ol start="3">
<li>实操：</li>
</ol>
<p>http块儿中加入upstream name {不同的server}</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816104144.png" alt="image-20210816104144668"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816104220.png" alt="image-20210816104220690"></p>
<ul>
<li>这个东西和我们学springcloud的时候，那个注册到nacos，然后用服务名实现负载均衡一个样样的嗷！！！</li>
<li>注意，上面那个include嗷，本质上就是把下面这个server引入到了总文件中，没啥区别。</li>
<li>还有就是，上面那个记得前面不用http嗷，因为下面的proxy_pass里面已经有http了嗷！！！</li>
<li>效果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816104419.png" alt="image-20210816104419220"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816104431.png" alt="image-20210816104431430"></p>
<p>刷新的时候，两个交互出现嗷！！！</p>
<p>此外，upstream那个地方，还可以配置每个server的权重哦，在后面可以加上一个weight参数来实现赋予权重嗷！！！</p>
<ol start="4">
<li>负载均衡策略：</li>
</ol>
<ul>
<li>轮询：默认的策略，逐一分配，如果后端服务器down了，可以自动剔除嗷！！！</li>
<li>weight：权重策略，默认为1。权重越高，被分配到的客户端越高（权重为大于等于一的整数嗷，小数没试过，不晓得，可以试试。）</li>
<li>Ip_Hash：每个请求按照访问ip的Hash结果分配，每个访客固定访问一个后端服务器，可以解决session的问题。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816105849.png" alt="image-20210816105849268"></p>
<p>注意哈，这里的ip_hash后面是有;的嗷！！！</p>
<p>可以解决Session共享的问题嗷！！！</p>
<ul>
<li>fair（第三方）：按照后端服务器的响应时间来分配，响应时间短的有效分配。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816110224.png" alt="image-20210816110224146"></p>
<p>fair后面是有个分号的嗷！！！</p>
<h2 id="动静分离：-1"><a href="#动静分离：-1" class="headerlink" title="动静分离："></a>动静分离：</h2><ol>
<li>什么是动静分离？</li>
</ol>
<p>Nginx把动态和静态请求分开，Nginx处理静态页面，Tomcat处理动态页面。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816110757.png" alt="image-20210816110757114"></p>
<ul>
<li>纯粹把静态资源单独提取出来，并且独立成单独的域名，放在独立的服务器上，是目前主流推崇的方案嗷！！！</li>
<li>还可以动态和静态混在一起，通过Nginx来分开，不过这种比较少。</li>
<li>expires参数设置可以设置浏览器缓存过期时间，减少与服务器之前的请求和流量。（和计算机网络学的一样，回去Last Modified，如果没有变化会返回304，如果由变化会返回200，并重新访问服务器获得新的缓存嗷！！！）</li>
</ul>
<ol start="2">
<li>准备工作：</li>
</ol>
<ul>
<li>&#x2F;文件夹下创建data文件夹，文件夹中创建www文件夹，并在www文件夹里面创建test.html文件。</li>
<li>想要我们的Nginx帮助我们访问到html文件嗷！！！</li>
</ul>
<ol start="3">
<li>实操：</li>
</ol>
<ul>
<li>配置文件中进行相应的配置嗷！！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816114105.png" alt="image-20210816114105497"></p>
<ul>
<li>这里配置的意思是，如果我们访问&#x2F;www&#x2F;，就会自动帮助我们加上前面的一个root，也就是根目录下的&#x2F;data文件夹。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816114207.png" alt="image-20210816114206901"></p>
<ul>
<li>实际上这里就是location中的配置，实际上帮助我们获得了&#x2F;data&#x2F;www&#x2F;test.html这个静态文件嗷！！！</li>
<li>我们访问的是liuyihao.work:3344下的www&#x2F;test.html资源，然后发现，&#x2F;www&#x2F;匹配，于是转到了Nginx中的&#x2F;data&#x2F;，加上www&#x2F;test.html，刚好构成了&#x2F;data&#x2F;www&#x2F;test.html路径，成功访问到了资源嗷！！！</li>
<li>此外，如果想显示出文件夹那种效果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816114335.png" alt="image-20210816114335077"></p>
<p>autoindex on，就能够帮助我们列出文件夹目录嗷！！！</p>
<h2 id="高可用："><a href="#高可用：" class="headerlink" title="高可用："></a>高可用：</h2><ul>
<li>为了解决Nginx宕机的效果</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816115456.png" alt="image-20210816115456765"></p>
<ul>
<li>解决方案：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816163314.png" alt="image-20210816163314471"></p>
<p>设置备份服务器嗷！！！</p>
<p>需要额外的软件keepalived，keepalived提供虚拟ip，将其绑定到不同的Nginx服务器，主服务器挂了，就将其绑定到从服务器，通过这种方式来实现高可用嗷！！！！这是一种主从模式嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816163619.png" alt="image-20210816163619355"></p>
<ol>
<li>需求：</li>
</ol>
<ul>
<li>两台Nginx</li>
<li>需要keepalived</li>
<li>需要虚拟ip</li>
</ul>
<ol start="2">
<li>实际准备：</li>
</ol>
<ul>
<li>两个带有Nginx的container</li>
<li>Linux宿主机安装keepalived</li>
<li>目前为止的端口号：<ul>
<li>3344: Nginx01</li>
<li>8080: Tomcat01</li>
<li>8081: Tomcat02</li>
<li>其中前两个是对外暴露了的嗷！！！</li>
</ul>
</li>
</ul>
<ol start="3">
<li>安装keepalived：</li>
</ol>
<ul>
<li>yum install keepalived -y</li>
<li>docker pull keepalived</li>
<li>由于端口号的原因，懒得再去开放了，直接使用Linux环境安装keepalived。配置文件处理<code>/etc/keepalived/keepalived.conf</code>位置嗷！！！</li>
</ul>
<ol start="4">
<li>实操：</li>
</ol>
<ul>
<li>本质就是修改conf这个配置文件嗷！！！</li>
<li>这里我不再演示，需要<strong>两台服务器</strong>，两个Nginx和两个keepalived，分别绑定各自的网卡到同一个ip地址上。然后通过设置的优先级不一样，提供服务嗷！！！</li>
<li>这里演示的话，就要新启动两个centos容器，然后配置各自的nginx和keepalived，最后进行实验。</li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jinjiangongzuoshi/p/9313438.html">高可用配置博客</a></li>
<li>采用的技术：Docker + Nginx + Keepalived</li>
</ul>
<ol start="5">
<li>配置解析：</li>
</ol>
<ul>
<li>global_dfs   全局配置</li>
<li>script   脚本配置（检测脚本配置）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816173426.png" alt="image-20210816173425888"></p>
<p>-20表示当脚本中的条件成立，就把此台服务器对应的权重降低20</p>
<ul>
<li>虚拟ip的配置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816173654.png" alt="image-20210816173654679"></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1zJ411w7SV?p=16&spm_id_from=pageDriver">Keepalived配置文件解析</a></p>
<h1 id="Nginx原理"><a href="#Nginx原理" class="headerlink" title="Nginx原理"></a>Nginx原理</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816173853.png" alt="image-20210816173852490"></p>
<ul>
<li><p>原理：</p>
<ul>
<li><p>线程分类：</p>
<ul>
<li>master</li>
<li>worker</li>
</ul>
</li>
<li><p>解析：</p>
<ul>
<li>master：</li>
</ul>
<ol>
<li>一个master，多个worker</li>
<li>Master管理，Worker实际工作。</li>
</ol>
<ul>
<li>worker如何工作：</li>
</ul>
<ol>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210816174048.png" alt="image-20210816174048362"></li>
<li>使用的是争抢的机制嗷！！！</li>
</ol>
</li>
</ul>
</li>
<li><p>好处？</p>
<ol>
<li>nginx -s reload命令？热加载&#x2F;热部署方式。</li>
</ol>
<p>有任务的worker不参与争抢，其他的worker重新加载嗷！！！利于Nginx进行热部署操作。</p>
<ol start="2">
<li>每个worker都是一个独立的进程，不需要加锁。同时，就算有worker挂了，其他的worker还可以进行正常的服务。不会造成服务的中断嗷！！！</li>
</ol>
</li>
<li><p>设置多少个worker合适？</p>
<ul>
<li>IO多路复用（Linux中才能够将服务器的性能发挥到极致嗷！！！）</li>
<li>让worker的数量和CPU数量相同是最合适的嗷！！！</li>
</ul>
</li>
<li><p>连接数work_connection</p>
<ul>
<li>发送一个请求，占用了worker的几个连接数？<ul>
<li>要么是两个，要么是四个<ul>
<li>两个：client -&gt; nginx , nginx -&gt; client（静态资源）</li>
<li>四个：client -&gt; nginx , nginx -&gt; tomcat , tomcat -&gt; nginx , nginx -&gt; client（动态资源）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Nginx有一个master，有四个worker，每一个worker的最大连接数是1024，支持最大的并发数是多少？</p>
<ul>
<li>就是最多能承受多少个请求？</li>
<li>所有worker支持的最大连接数：4 * 1024</li>
<li>最大并发：4 * 1024 &#x2F; 2</li>
<li>最小并发：4 * 1024 &#x2F; 4</li>
<li>结论：</li>
</ul>
<p><img src="C:\Users\Alexander\AppData\Roaming\Typora\typora-user-images\image-20210816190551708.png" alt="image-20210816190551708"></p>
</li>
</ul>
<h2 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h2><ul>
<li>对于Docker中的配置文件，可以采用挂载的形式进行修改嗷！！！</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34556414/article/details/108588203">Docker挂载实例</a></li>
<li>注意，所谓的挂载</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/12/Nginx%E5%AD%A6%E4%B9%A0/" data-id="cl6gepmfs002be0jq0ept45u8" data-title="Nginx学习" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Java大厂常问面试题" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/05/Java%E5%A4%A7%E5%8E%82%E5%B8%B8%E9%97%AE%E9%9D%A2%E8%AF%95%E9%A2%98/" class="article-date">
  <time class="dt-published" datetime="2021-08-05T13:38:05.000Z" itemprop="datePublished">2021-08-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/08/05/Java%E5%A4%A7%E5%8E%82%E5%B8%B8%E9%97%AE%E9%9D%A2%E8%AF%95%E9%A2%98/">Java常问面试题总结与提高</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Java高频考点"><a href="#Java高频考点" class="headerlink" title="Java高频考点"></a>Java高频考点</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805214421.png" alt="image-20210805214421596"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805214638.png" alt="image-20210805214638422"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805214700.png" alt="image-20210805214700114"></p>
<h1 id="1-局部变量表和计算栈"><a href="#1-局部变量表和计算栈" class="headerlink" title="1. 局部变量表和计算栈"></a>1. 局部变量表和计算栈</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210829092913.png" alt="image-20210829092912831"></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/happy_bigqiang/article/details/90414541">非常有意思的一道题目嗷！！！</a></p>
<ul>
<li>知识点在于栈，局部变量表等东西的操作嗷，类似于Println和符号运算这样的操作。本质上，都是先把操作数放在栈里面，然后对于栈里面的数字进行操作的。</li>
<li>然后就是++这样的操作，在前在后，对于局部变量表操作和栈操作的顺序是不一样的嗷！！！</li>
</ul>
<h1 id="2-Singleton示例"><a href="#2-Singleton示例" class="headerlink" title="2. Singleton示例"></a>2. Singleton示例</h1><ul>
<li><p>单例，系统中只有一个实例对象可以被获取和使用的代码模式。例如JVM运行环境中的Runtime类</p>
</li>
<li><p>要点：</p>
<ul>
<li><p>某个类只能由一个实例</p>
<ul>
<li>构造器私有化</li>
</ul>
</li>
<li><p>必须自行创建这个实例</p>
<ul>
<li>静态变量来保证实例唯一</li>
</ul>
</li>
<li><p>必须向整个系统提供这个实例</p>
<ul>
<li>向整个系统提供这个实例：</li>
</ul>
<ol>
<li>直接暴露</li>
<li>静态变量的get方法获取</li>
</ol>
</li>
</ul>
</li>
<li><p>创建类型：</p>
<ol>
<li>饿汉式：</li>
</ol>
<ul>
<li>直接实例化饿汉式</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210829163721.png" alt="image-20210829163713857"></p>
<p>获取这个对象：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210829164100.png" alt="image-20210829164100868"></p>
<ol start="2">
<li>JDK1.5之后，枚举类型：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210829163830.png" alt="image-20210829163830867"></p>
<p>获取这个对象：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210829164212.png" alt="image-20210829164212855"></p>
<p>枚举类型会帮助我们重写String方法嗷！</p>
<ol start="3">
<li>静态代码块的方式：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210901222143.png" alt="image-20210901222143617"></p>
<p>类初始化的时候new处对象，保证对象只在初始化的时候创建一次嗷！！！</p>
<ol start="2">
<li>懒汉式：</li>
</ol>
</li>
</ul>
<h1 id="3-volatile"><a href="#3-volatile" class="headerlink" title="3. volatile:"></a>3. volatile:</h1><p>volatile是什么</p>
<ul>
<li>轻量级的同步机制</li>
<li>特性：<ul>
<li>保证可见性</li>
<li>不保证原子性</li>
<li>禁止指令重排</li>
</ul>
</li>
</ul>
<h2 id="JMM："><a href="#JMM：" class="headerlink" title="JMM："></a>JMM：</h2><ul>
<li>JVM（Java虚拟机）</li>
<li>JMM（Java内存模型）：<ul>
<li>并不真实存在，描述的是一组规则或规范</li>
</ul>
</li>
<li>几个概念：<ul>
<li>主内存：<ul>
<li><strong>共享</strong>内存区域，所有线程都可以访问嗷！</li>
</ul>
</li>
<li>工作内存：<ul>
<li>每个线程私有的工作内存空间</li>
</ul>
</li>
</ul>
</li>
<li>各自线程的工作内存会拷贝主内存中对应的数据，然后各自对于数据进行修改，修改完成之后，才会尝试将数据<strong>写回</strong>主物理内存。</li>
<li>只有在工作内存才能够对于变量进行修改嗷！！！不同的线程是不能够访问对方的工作内存嗷！！！工作内存的结果需要写回主内存之后，才能够真正的生效嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808083346.png" alt="image-20210808083346242"></p>
<h3 id="可见性定义："><a href="#可见性定义：" class="headerlink" title="可见性定义："></a>可见性定义：</h3><ul>
<li>一个线程对于数据进行了修改并且写回了主内存之后，其他的线程要马上能够知道嗷！！！只要有变动，大家都要立马知道嗷！！！</li>
<li>第一时间通知到所有线程的过程，这个就叫做可见性。</li>
</ul>
<h3 id="原子性："><a href="#原子性：" class="headerlink" title="原子性："></a>原子性：</h3><h2 id="Volatile特性："><a href="#Volatile特性：" class="headerlink" title="Volatile特性："></a>Volatile特性：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913190045.png" alt="image-20210913190044888"></p>
<h3 id="可见性："><a href="#可见性：" class="headerlink" title="可见性："></a>可见性：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyData</span>()&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTo60</span><span class="params">()</span>&#123;</span><br><span class="line">    	<span class="built_in">this</span>.number = <span class="number">60</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">MyData</span> <span class="variable">myData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyData</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">&quot;\t come in&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;TimeUnit.SECONDS.sleep(<span class="number">3</span>);&#125;<span class="keyword">catch</span>&#123;...&#125;; <span class="comment">//模拟线程处理过程</span></span><br><span class="line">        myData.addTo60();</span><br><span class="line">    &#125;,<span class="string">&quot;AAA&quot;</span>).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(myData.number == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="comment">//main线程就一直在这里等待嗷！！！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;number变成了60啦！！！&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>没有volatile就没有多线程的可见性嗷！！！</li>
<li>然后你发现不得行！！！主线程仍然是卡住的，因为没有任何线程来通知主线程，这个值发生了改变，主线程自己的工作空间中的值，是没有变化的嗷！！！（默认是没有可见性的嗷！！！）</li>
<li>如何实现可见性呢？Volatile！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyData</span>()&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTo60</span><span class="params">()</span>&#123;</span><br><span class="line">    	<span class="built_in">this</span>.number = <span class="number">60</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试和上面的代码是一样的嗷！！！然后发现，volatile其实就是起到了及时通知main线程，某个变量发生了改变的作用。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808083024.png" alt="image-20210808083024568"></p>
<h3 id="不保证原子性："><a href="#不保证原子性：" class="headerlink" title="不保证原子性："></a>不保证原子性：</h3><ul>
<li>原子性是什么？<ul>
<li>不可分割，完整性，也即某个线程不能被分割，要整体完成，要么同时成功，要么同时失败。</li>
</ul>
</li>
<li>例子：</li>
</ul>
<p><code>valatile i</code></p>
<p><code>public methodPlus()&#123;i++&#125;</code></p>
<p>然后启动多个线程来同时操作（也就是常见的i++的例子）</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913192205.png" alt="image-20210913192205069"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913192013.png" alt="image-20210913192012747"></p>
<p>结果不是20000嗷！！！</p>
<ul>
<li>原理解释：<ul>
<li>可以在方法上加上sychronized吗？<ul>
<li>可以，可以保证20000</li>
<li>但是不好，效率消耗太大了嗷！！！</li>
</ul>
</li>
</ul>
</li>
<li>为啥会&lt;2000呀！！！</li>
</ul>
<p>多线程的调度出问题了嗷！！！</p>
<p>A和B同时读入了0，同时加1。A写入1，还没来得及通知别的线程，B就再次被调度写入了1，这就出问题了orz，就会导致这种情况的出现嗷！！！</p>
<ul>
<li>字节码：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913192921.png" alt="image-20210913192921349"></p>
<ul>
<li><p>如何解决原子性：</p>
<ol>
<li>加入sync，太重了，不用这个</li>
<li><code>AutomicInteger automicInteger = new AutomicInteger();</code></li>
</ol>
<p>用法的话，建议去看看官方文档中怎么写的嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913193550.png" alt="image-20210913193550094"></p>
<p>说白了底层为CAS，比起volatile来说，还是加了个轻量级锁orz。</p>
</li>
</ul>
<h3 id="禁止指令重排："><a href="#禁止指令重排：" class="headerlink" title="禁止指令重排："></a>禁止指令重排：</h3><ul>
<li>多线程：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914182640.png" alt="image-20210914182640288"></p>
<ul>
<li>重排：</li>
</ul>
<p><img src="C:\Users\Alexander\AppData\Roaming\Typora\typora-user-images\image-20210913194820605.png" alt="image-20210913194820605"></p>
<ul>
<li>处理器在进行重排序的时候必须要考虑指令之间的<strong>数据依赖性</strong></li>
<li>由于数据依赖性，指令重排也要考虑数据依赖性哈！！！volatile来决定嗷！！！</li>
<li>指令重排多线程下出现，这个重排是客观存在的，两个线程中使用的变量能够保证一致性嗷！！！避免指令重排优化，从而避免多线程环境下程序出现乱序执行的情况。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913200926.png" alt="image-20210913200926447"></p>
<ul>
<li>指令屏障（保证禁止指令重排嗷！！！）：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913201109.png" alt="image-20210913201108269"></p>
<p>禁止指令重排嗷！！！保证了安全性嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210913201109.png" alt="指令重排"></p>
<ul>
<li>volatile的特点：<ul>
<li>可见性（强制刷出各种CPU的缓存数据嗷！！！）</li>
<li>禁止指令重排</li>
</ul>
</li>
</ul>
<h2 id="什么时候用Volatile："><a href="#什么时候用Volatile：" class="headerlink" title="什么时候用Volatile："></a>什么时候用Volatile：</h2><h3 id="单例模式："><a href="#单例模式：" class="headerlink" title="单例模式："></a>单例模式：</h3><ul>
<li>单例模式！！！本来是不用volatile的，但是当单线程 -&gt; 多线程的时候，就会出问题了嗷orz</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914183439.png" alt="image-20210914183438141"></p>
<ul>
<li>解决方法：<ul>
<li>getInstance方法前面加上synchronized，没有问题嗷！！！可以正常执行嗷！！！</li>
<li>但是太重了orz</li>
</ul>
</li>
</ul>
<h3 id="DCL模式："><a href="#DCL模式：" class="headerlink" title="DCL模式："></a>DCL模式：</h3><ul>
<li>Double Check Lock，双端检锁机制。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914183722.png" alt="image-20210914183722408"></p>
<p>对吗？不对！！！多线程，为了指令的效果，会指令重排！！！</p>
<ul>
<li>DCL不一定安全，指令重排！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914184250.png" alt="image-20210914184249691"></p>
<p>这个时候就可能取到null嗷！！！</p>
<ul>
<li>指令重排只保证单线程情况下的指令一致性，多线程则不保证嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914184532.png" alt="image-20210914184531643"></p>
<ul>
<li>禁止指令重排：<code>public static volatile SingletonDemo instance = null;</code></li>
</ul>
<h1 id="4-CAS："><a href="#4-CAS：" class="headerlink" title="4. CAS："></a>4. CAS：</h1><ul>
<li>Compare And Set，比较并且交换</li>
<li>Synchronized太重了，CAS就比synchronized轻量哦！！！</li>
<li>例如AutomicInteger , <code>compareAndSet(expect , update)</code></li>
</ul>
<h2 id="底层原理："><a href="#底层原理：" class="headerlink" title="底层原理："></a>底层原理：</h2><ul>
<li>why CAS not Synchronized？底层原理：<ul>
<li>自旋锁</li>
<li>Unsafe</li>
</ul>
</li>
<li>getAndIncrement底层实现：<ul>
<li>调用的JDK自带的unsafe类嗷！！！（都是底层的Native方法嗷！！！）</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914190803.png" alt="image-20210914190803601"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914190825.png" alt="image-20210914190825087"></p>
<ul>
<li>Unsafe类：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914191644.png" alt="image-20210914191643821"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914191909.png" alt="image-20210914191909041"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914192042.png" alt="image-20210914192041067"></p>
<ul>
<li>getAndAddInt</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914192335.png" alt="image-20210914192335325"></p>
<p>关键是底层的CAS的靠的是CPU的原子操作来实现的嗷！！！因此这样能够保证原子性嗷！！！读取，比较和设置一气呵成。不存在中间有线程特判比较的这种情况出现嗷！！！</p>
<ul>
<li>getAndIncrement：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914215818.png" alt="image-20210914215818159"></p>
<ul>
<li>原理：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914220153.png" alt="image-20210914220153739"></p>
<p><strong>Unsafe类+CAS思想（自旋）</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914220305.png" alt="image-20210914220305279"></p>
<h2 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h2><ol>
<li>循环时间长，CPU开销大</li>
<li>只能保证一个变量的原子性操作，如果要一段代码，那就要synchronized嗷！！！</li>
<li>引出了ABA问题。</li>
</ol>
<h1 id="5-AtomicInteger的ABA问题："><a href="#5-AtomicInteger的ABA问题：" class="headerlink" title="5. AtomicInteger的ABA问题："></a>5. AtomicInteger的ABA问题：</h1><ul>
<li>原子引用更新 —&gt;&gt;&gt; 如何规避ABA问题</li>
<li>狸猫换太子：<ul>
<li>就是快速反复横跳，把值该到了，欸嘿，我又改回来了，吐了，慢的根本不知道嗷orz。</li>
</ul>
</li>
</ul>
<h2 id="AutomicReference："><a href="#AutomicReference：" class="headerlink" title="AutomicReference："></a>AutomicReference：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210914221952.png" alt="image-20210914221952711"></p>
<p>对于我们需要的类进行原子包装嗷！！！</p>
<h2 id="时间戳的原子引用："><a href="#时间戳的原子引用：" class="headerlink" title="时间戳的原子引用："></a>时间戳的原子引用：</h2><ul>
<li>规避ABA问题：时间戳的原子引用</li>
</ul>
<h3 id="AtomicStampedReference"><a href="#AtomicStampedReference" class="headerlink" title="AtomicStampedReference"></a>AtomicStampedReference</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915200923.png" alt="image-20210915200908489"></p>
<p><code>atomicStampedReference.compareAndSet(expectedReference , newReference , expectedStamp , newStamp)</code></p>
<p>常用用法：</p>
<p><code>boolean result = atomicStampedReference.compareAndSet(100 , 101 , automicStampedReference.getStamp() , automicStampedReference.getStamp()+1);</code></p>
<p><code>int stamp = atomicStampedReference.getStamp();</code></p>
<p><code>int result = atomicStampedReference.getReference();</code></p>
<p>相当于现在比较两个值了而已嘛，本质没啥区别</p>
<h1 id="6-ArrayList线程不安全："><a href="#6-ArrayList线程不安全：" class="headerlink" title="6. ArrayList线程不安全："></a>6. ArrayList线程不安全：</h1><ul>
<li>这里的名字不准确，应该是Collection类普遍不安全嗷！！！</li>
</ul>
<h2 id="写时复制："><a href="#写时复制：" class="headerlink" title="写时复制："></a>写时复制：</h2><ul>
<li>扩容：默认的capacity是10，超过10了要扩容</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915203909.png" alt="image-20210915203909547"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915204001.png" alt="image-20210915204001207"></p>
<ul>
<li>线程不安全！！！</li>
</ul>
<p>ArrayList的add方法为了保证并发性和效率，没有加锁嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915204430.png" alt="image-20210915204429858"></p>
<ol>
<li>故障现象：</li>
</ol>
<p>java.util.ConcurrentModificationException</p>
<ol start="2">
<li>导致原因：</li>
</ol>
<p>并发争抢修改导致，两个进程抢着写的时候，造成了数据不一致的情况嗷！！！</p>
<p>CopyOnWrite , OnWrite的时候才Copy</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915210514.png" alt="image-20210915210514393"></p>
<ol start="3">
<li>解决方案：</li>
</ol>
<ul>
<li>加锁！！！可以吗？不可以，JDK源码你加个锤子的锁？？？</li>
<li>3.1：用Vector类！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915204815.png" alt="image-20210915204814766"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915204846.png" alt="image-20210915204845542"></p>
<p>好使！！！但是太重了orz，而且Vector用的少orz，并发性低嗷orz。牺牲了安全性，提高了性能嗷！！！</p>
<ul>
<li><p>3.2：Collection接口和Collections类！！！注意嗷，后面那个是类！！！Collections就是帮助我们来解决这个问题的嗷！！！<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915205140.png" alt="image-20210915205139824"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915205210.png" alt="image-20210915205210076"></p>
</li>
</ul>
<p>你设想一下，这里竟然有这么多Map , List , Set之类的，说明这些东西都是线程不安全的嗷！！！</p>
<ul>
<li>3.3：CopyOnWriteArrayList</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915210029.png" alt="image-20210915210029661"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915210105.png" alt="image-20210915210105142"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>老版本的copy出来，然后把自己的信息写进去，再让系统中的引用编程现在这个数组嗷！！！</li>
</ul>
<ol start="4">
<li>优化建议：</li>
</ol>
<h2 id="HashSet线程不安全："><a href="#HashSet线程不安全：" class="headerlink" title="HashSet线程不安全："></a>HashSet线程不安全：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915210928.png" alt="image-20210915210926940"></p>
<p>也是一样的问题嗷！！！</p>
<ul>
<li>解决方法：<ol>
<li><code>Collections.synchronizedSet(new HashSet&lt;&gt;());</code></li>
<li>JUC中的<code>CopyOnWriteSet&lt;&gt;()</code></li>
</ol>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915211451.png" alt="image-20210915211450931"></p>
<ul>
<li>HashSet底层数据结构就是HashMap&lt;&gt;()</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915211620.png" alt="image-20210915211620437"></p>
<ul>
<li>HashSet底层如果是HashMap，那为啥add方法只有一个参数捏？？？</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915211826.png" alt="image-20210915211825796"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915211803.png" alt="image-20210915211802866"></p>
<p>value是个恒定的值哦！！！</p>
<h2 id="HashMap线程不安全："><a href="#HashMap线程不安全：" class="headerlink" title="HashMap线程不安全："></a>HashMap线程不安全：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915212240.png" alt="image-20210915212239707"></p>
<ul>
<li>解决方法：<ol>
<li><code>ConcurrentHashMap</code></li>
<li><code>Collections.synchronizedMap</code></li>
</ol>
</li>
</ul>
<h1 id="7-TransferValue醒脑："><a href="#7-TransferValue醒脑：" class="headerlink" title="7. TransferValue醒脑："></a>7. TransferValue醒脑：</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915215803.png" alt="image-20210915215802972"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915215840.png" alt="image-20210915215840582"></p>
<p>String比较特殊嗷！！！它是final，赋予了地址之后，这个地址是不会变动的。String str &#x3D; “abc”，String指向了常量池中的地址。而str &#x3D; “XXX”，确实找到了常量池中的”XXX”，如下右图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915220409.png" alt="image-20210915220409692"></p>
<p>说白了就是传进去就是一个地址，方法中参数的str本质上也是一个拷贝，一个指向这个地址的指针的拷贝，这里的赋值，无非是把拷贝指针的指向变了，改变不了原指针的指向嗷！！！</p>
<h1 id="8-Java中的锁们："><a href="#8-Java中的锁们：" class="headerlink" title="8. Java中的锁们："></a>8. Java中的锁们：</h1><h2 id="公平锁和非公平锁："><a href="#公平锁和非公平锁：" class="headerlink" title="公平锁和非公平锁："></a>公平锁和非公平锁：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915220950.png" alt="image-20210915220949873"></p>
<p>这里不传参数等于传入了false参数嗷！！！天生这个即使非公平锁嗷！！！公平锁就是先来后到，非公平就是允许某些线程能够“不公平竞争”，能够加塞！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915221301.png" alt="image-20210915221300727"></p>
<h3 id="ReentrantLock："><a href="#ReentrantLock：" class="headerlink" title="ReentrantLock："></a>ReentrantLock：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210915221459.png" alt="image-20210915221458845"></p>
<p>默认为非公平锁，非公平锁的有点在于吞吐量比公平锁大嗷！！！说白了又是体现了优先级呗！！！优先级高的能被响应，吞吐量就会大嗷！！！</p>
<ul>
<li>Synchronized而言，也是一种非公平锁哦！！！</li>
</ul>
<h2 id="可重入锁（递归锁）："><a href="#可重入锁（递归锁）：" class="headerlink" title="可重入锁（递归锁）："></a>可重入锁（递归锁）：</h2><ul>
<li>ReentrantLock就是可重入锁哦！！！</li>
<li>可重入锁就是递归锁</li>
<li>指的是统一线程外层函数获得锁之后，内层递归函数仍然能获取该锁的代码！在同一个线程在外层方法能够获取锁的时候，在进入内层方法会自动获取锁嗷！！！（也就是说：线程可以进入任何一个<strong>它已经拥有的锁所同步着的代码块</strong>！！！）</li>
<li><strong>线程可以进入任何一个它已经拥有的锁所同步的代码块。</strong></li>
<li>ReentrantLock&#x2F;Synchronized就是典型的非公平可重入锁嗷！！！</li>
<li><strong>最大作用：避免死锁</strong></li>
<li>代码：</li>
</ul>
<h4 id="Case1："><a href="#Case1：" class="headerlink" title="Case1："></a>Case1：</h4><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210916201751.png" alt="image-20210916201750895"></p>
<p>这个就是例子：sendSMS()调用了sendEmail，进入sendSMS中执行sendEmail的时候会自动获取锁并进入这个代码块执行嗷！！！</p>
<h4 id="Case2："><a href="#Case2：" class="headerlink" title="Case2："></a>Case2：</h4><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210916202040.png" alt="image-20210916202040755"></p>
<ul>
<li>运行结果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210916202204.png" alt="image-20210916202204510"></p>
<ul>
<li>思考：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210916202314.png" alt="image-20210916202314495"></p>
<p>只要锁配对正确，加几把锁都没问题嗷！！！可以正确运行嗷！！！！</p>
<h2 id="自旋锁："><a href="#自旋锁：" class="headerlink" title="自旋锁："></a>自旋锁：</h2><ul>
<li>spinlock：尝试获取锁的线程不会立即阻塞，而是采用循环的方式尝试去获取锁。好处是减少了上下文切换的消耗，缺点是循环会消耗CPU嗷！！！</li>
</ul>
<h3 id="手写自旋锁："><a href="#手写自旋锁：" class="headerlink" title="手写自旋锁："></a>手写自旋锁：</h3><ul>
<li>本质：while + compareAndSet()方法</li>
</ul>
<p>本质上利用一个拥有compareAndSet()方法的变量来帮助我们实现就行嗷！！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">AtomicReference&lt;Thread&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AutomicReference</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//加锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myLock</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    System.out.println(thread.currentThread().getName + <span class="string">&quot;\t come in O(n_n)&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(!atomicReference.compareAndSet(<span class="literal">null</span> , thread))&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果成功进入，根本就不进入while循环，直接执行下面的业务代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解锁</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myUnLock</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    System.out.println(thread.currentThread().getName + <span class="string">&quot;\t come out O(n_n)~~&quot;</span>);</span><br><span class="line">    automicReference.compareAndSet(thread , <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上面这些统一放到一个类中就可以了嗷(叫做SpinLockDemo)！！！</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">SpinLockDemo</span> <span class="variable">spinLockDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpinLockDemo</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        spinLockDemo.myLock();</span><br><span class="line">        <span class="comment">//执行业务逻辑，例如sleep等待</span></span><br><span class="line">        spinLockDemo.myUnLock();</span><br><span class="line">    &#125;,<span class="string">&quot;AA&quot;</span>).start();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        spinLockDemo.myLock();</span><br><span class="line">        <span class="comment">//执行业务逻辑，例如sleep等待</span></span><br><span class="line">        spinLockDemo.myUnLock();</span><br><span class="line">    &#125;,<span class="string">&quot;BB&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里非常有技巧性，这里的AtomicReference的泛型就可以拥有compareAndSet方法，但是为了让每个线程都可以“独立的拥有一些特征来获得自旋锁”，我们采用了线程作为泛型对象进行操作嗷！！！</li>
<li><code>thread.currentThread()</code>就能够获得当前的线程，不同线程的这个值肯定不一样嗷！！！这样就比较好一些嗷！！！</li>
</ul>
<h2 id="独占锁（写锁）-x2F-共享锁（读锁）-x2F-互斥锁"><a href="#独占锁（写锁）-x2F-共享锁（读锁）-x2F-互斥锁" class="headerlink" title="独占锁（写锁）&#x2F; 共享锁（读锁）&#x2F; 互斥锁"></a>独占锁（写锁）&#x2F; 共享锁（读锁）&#x2F; 互斥锁</h2><h3 id="独占锁（写锁）"><a href="#独占锁（写锁）" class="headerlink" title="独占锁（写锁）"></a>独占锁（写锁）</h3><ul>
<li><p>指该锁一次只能被一个线程所持有。</p>
</li>
<li><p>对于ReentrantLock和Synchronized而言都是独占锁。</p>
</li>
<li><p>发展历程：<code>sync ---&gt; lock ---&gt; ReentrantReadWriteLock</code></p>
</li>
<li><p>读写锁提高了并发效率嗷！！！从保证原子性到提高效率嗷！！！</p>
</li>
<li><p>规则：</p>
<ul>
<li>读-读可以共存</li>
<li>读-写不能共存</li>
<li>写-写不能共存</li>
</ul>
</li>
<li><p>实例代码：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917110338.png" alt="image-20210917110337741"></p>
<p>写操作：必须原子 + 独占（写锁）</p>
<p>这里模拟的时候，底层都是要用volatile的，保证可见性非常重要！！！缓存的可见性和及时性非常重要！！！</p>
<ul>
<li>ReentrantReadWriteLock读写同体，对于不同的方法要调用不同的方法适配嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantReadWriteLock</span> <span class="variable">rwlock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//这里也很简单，直接根据不同情况获取不同的锁就成</span></span><br><span class="line">    rwlock.readLock().lock();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>加写锁例子：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917112125.png"></p>
<ul>
<li>加读锁例子：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917112154.png" alt="image-20210917112154108"></p>
<ul>
<li>以上两者对比：</li>
</ul>
<h3 id="共享锁（读锁）："><a href="#共享锁（读锁）：" class="headerlink" title="共享锁（读锁）："></a>共享锁（读锁）：</h3><ul>
<li>该锁可以被多个线程所持有</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917112350.png" alt="image-20210917112350047"></p>
<h1 id="9-CountDownLatch-x2F-CyclicBarrier-x2F-Semaphore"><a href="#9-CountDownLatch-x2F-CyclicBarrier-x2F-Semaphore" class="headerlink" title="9. CountDownLatch &#x2F; CyclicBarrier &#x2F; Semaphore"></a>9. CountDownLatch &#x2F; CyclicBarrier &#x2F; Semaphore</h1><h2 id="CountDownLatch："><a href="#CountDownLatch：" class="headerlink" title="CountDownLatch："></a>CountDownLatch：</h2><ul>
<li><p>有点像Linux中那个等待子线程结束（waitpid &#x2F; pthread_join），主线程才能够最后退出的函数方法。</p>
</li>
<li><p>Demo：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917113302.png" alt="image-20210917113301833"></p>
<ul>
<li>可谓是非常像了，这个玩意儿就是卡在这里，等所有线程的东西执行完了，才会继续往下执行嗷！！！</li>
</ul>
<h3 id="枚举："><a href="#枚举：" class="headerlink" title="枚举："></a>枚举：</h3><ul>
<li>可以当作小数据库来用嗷？？？还有这种操作？？？</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917114858.png" alt="image-20210917114857319"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917115028.png" alt="image-20210917115028480"></p>
<ul>
<li>原来的代码的修改：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917115117.png" alt="image-20210917115116832"></p>
<p>程序耦合度急剧降低，只要修改枚举中的元素，处处生效嗷！！！</p>
<ul>
<li>枚举中元素的读取：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917115228.png" alt="image-20210917115227796"></p>
<p>第一个相当于行的名字，第二三行相当于读取这一行某个元素的值嗷！！！</p>
<ul>
<li>非常实用嗷！！！</li>
</ul>
<h2 id="CyclicBarrier："><a href="#CyclicBarrier：" class="headerlink" title="CyclicBarrier："></a>CyclicBarrier：</h2><ul>
<li>增加到多少就能够发生某件事，和上面相反，这个是做甲方。</li>
<li>等人齐了，才能够开会~。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917144338.png" alt="image-20210917144338011"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917144706.png" alt="image-20210917144706100"></p>
<h2 id="Semaphore："><a href="#Semaphore：" class="headerlink" title="Semaphore："></a>Semaphore：</h2><ul>
<li>多个资源抢多份资源怎么控制哇？</li>
<li>这个就是信号量，一个是用于多个共享资源的互斥实用，另外一个适用于并发线程控制嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917145654.png" alt="image-20210917145653800"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917145712.png" alt="image-20210917145712432"></p>
<ul>
<li>这个和操作系统中的没啥区别，都是信号量嗷！！！一个信号量可以当作锁来用嗷！！！</li>
</ul>
<h1 id="10-阻塞队列"><a href="#10-阻塞队列" class="headerlink" title="10. 阻塞队列"></a>10. 阻塞队列</h1><h2 id="阻塞队列："><a href="#阻塞队列：" class="headerlink" title="阻塞队列："></a>阻塞队列：</h2><ul>
<li>阻塞队列有好的一面。</li>
<li>不得不阻塞，如何管理？</li>
</ul>
<h3 id="队列-阻塞队列以及其api："><a href="#队列-阻塞队列以及其api：" class="headerlink" title="队列+阻塞队列以及其api："></a>队列+阻塞队列以及其api：</h3><ul>
<li>就是生产者和消费者问题的Java版本而已</li>
<li>空的队列拿元素，阻塞。满的队列添加元素，阻塞。</li>
<li>why BlockingQueue？不需要关心什么时候阻塞和唤醒线程，BlockingQueue给我们一手包办了嗷！！！这个效率非常高嗷！！！（手动挡变成了自动挡嗷！！！）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917192349.png" alt="image-20210917192349179"></p>
<ul>
<li>有好多实现类嗷！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917192442.png" alt="image-20210917192442233"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917192507.png" alt="image-20210917192506647"></p>
<p>红色的是重点，这三个就是线程池的底层嗷！！！</p>
<p>最后一个是Deque嗷！！！双端队列，和上面的Queue是有区别的嗷！！！</p>
<p>SynchronousQueue专属定制版，就一个嗷！！！</p>
<ul>
<li>常用情况（抛出异常）：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917192913.png" alt="image-20210917192913651"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917213941.png" alt="image-20210917213941158"></p>
<p>像这个Queue，符合先进先出的概念，element就是检查第一个元素嗷！！！add和remove还有element就是有这样的一个特点：如果对应的操作失败，就会抛出异常嗷！！！</p>
<ul>
<li>常用情况（特殊值）：</li>
</ul>
<p>操作成功返回true，操作失败返回false嗷！！！</p>
<p>取出来的时候，取得到就是对应的元素，取不到就是NULL</p>
<ul>
<li>常用情况（阻塞）：</li>
</ul>
<p>如果操作失败的话，默认会进行阻塞，等待嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917214504.png" alt="image-20210917214504234"></p>
<ul>
<li>常用情况（超时）：</li>
</ul>
<p>不要那么猛，折中的一种做法嗷！！！我可以等，但是过时不候，如果超时了我线程就自己退出了嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917214652.png" alt="image-20210917214652384"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210917214711.png" alt="image-20210917214711162"></p>
<h2 id="SynchronousQueue："><a href="#SynchronousQueue：" class="headerlink" title="SynchronousQueue："></a>SynchronousQueue：</h2><ul>
<li>本质上是一个不存储元素的BlockingQueue，每一个put都要等待一个take嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">SynchronousQueue&lt;String&gt; blockingQueue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t put 1&quot;</span>);</span><br><span class="line">        blockingQueue.put(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t put 2&quot;</span>);</span><br><span class="line">        blockingQueue.put(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t put 3&quot;</span>);</span><br><span class="line">        blockingQueue.put(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;,<span class="string">&quot;Producer1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t put 4&quot;</span>);</span><br><span class="line">        blockingQueue.put(<span class="string">&quot;4&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t put 5&quot;</span>);</span><br><span class="line">        blockingQueue.put(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t put 6&quot;</span>);</span><br><span class="line">        blockingQueue.put(<span class="string">&quot;6&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;Producer2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        System.out.println(blockingQueue.take());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        System.out.println(blockingQueue.take());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        System.out.println(blockingQueue.take());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        System.out.println(blockingQueue.take());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        System.out.println(blockingQueue.take());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        System.out.println(blockingQueue.take());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="string">&quot;Consumer1&quot;</span>).start();</span><br></pre></td></tr></table></figure>



<h2 id="用在哪里？"><a href="#用在哪里？" class="headerlink" title="用在哪里？"></a>用在哪里？</h2><h3 id="生产者消费者模式（老版）"><a href="#生产者消费者模式（老版）" class="headerlink" title="生产者消费者模式（老版）"></a>生产者消费者模式（老版）</h3><ul>
<li><p><code>ProdConsumer_TraditionDemo</code></p>
</li>
<li><p><code>ProdConsumer_BlockQueueDemo</code></p>
</li>
<li><p>传统版：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210918202929.png" alt="image-20210918202929146"></p>
<p>老版sync向新版lock的转换：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210918203703.png" alt="image-20210918203703145"></p>
<ul>
<li>代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProdConsumer_TraditionDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ShareData</span> <span class="variable">shareData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShareData</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    shareData.increment();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;Thread A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    shareData.decrement();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;Thread B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShareData</span> <span class="comment">// 资源类</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1. 判断</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//判断</span></span><br><span class="line">            <span class="keyword">while</span> (number != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">//等待，不能生产</span></span><br><span class="line">                condition.await();;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//干活</span></span><br><span class="line">            number ++ ;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t&quot;</span> + number);</span><br><span class="line">            <span class="comment">//通知唤醒</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1. 判断</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//判断</span></span><br><span class="line">            <span class="keyword">while</span> (number == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">//等待，不能生产</span></span><br><span class="line">                condition.await();;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//干活</span></span><br><span class="line">            number -- ;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t&quot;</span> + number);</span><br><span class="line">            <span class="comment">//通知唤醒</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>多线程判断都要用while</strong>，不要用if，if就有可能出现问题嗷！！！</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Thread A	1</span><br><span class="line">Thread B	0</span><br><span class="line">Thread A	1</span><br><span class="line">Thread B	0</span><br><span class="line">Thread A	1</span><br><span class="line">Thread B	0</span><br><span class="line">Thread A	1</span><br><span class="line">Thread B	0</span><br><span class="line">Thread A	1</span><br><span class="line">Thread B	0</span><br></pre></td></tr></table></figure>



<h3 id="synchronized和lock的区别"><a href="#synchronized和lock的区别" class="headerlink" title="synchronized和lock的区别"></a>synchronized和lock的区别</h3><ol>
<li>原始构成</li>
</ol>
<ul>
<li>synchronized是Java关键字，lock是java5以后出现的一个类。</li>
<li>synchronized是属于JVM层面的，monitorenter和monitorexit，底层是通过monitor对象来完成的，其实wait &#x2F; notify等方法也是依赖于monitor对象，只有在同步块或同步方法中才能调用wait &#x2F; notify等方法。</li>
<li>Lock是具体类，JUC中，是api层面的锁嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210918210748.png" alt="image-20210918210748451"></p>
<ol start="2">
<li>使用方法</li>
</ol>
<ul>
<li>synchronized不需要用户去手动释放锁，当synchronized代码执行完成后系统会自动让线程释放对于锁的占用嗷！！！</li>
<li>ReentrantLock需要用户手动释放锁，如果用户没有主动释放锁，那么就有可能会出现死锁现象嗷！！！需要lock ， unlock方法配合try &#x2F; finally语句块来完成嗷！！！</li>
</ul>
<ol start="3">
<li>判断是否可以中断</li>
</ol>
<ul>
<li>等待是否可以中断，synchronized不可中断，除非抛出异常或者正常运行完成。ReentrantLock可中断：<ol>
<li>设置超时方法 trylock（long timeout , TimeUnit unit）</li>
<li>LockInterruptibly()放代码块中，调用interrupt方法可以中断</li>
</ol>
</li>
</ul>
<ol start="4">
<li>加锁是否公平</li>
</ol>
<ul>
<li>synchronized非公平锁</li>
<li>ReentrantLock两者都可以，默认非公平锁，构造方法可以传入boolean值，true为公平锁，false为非公平锁。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210918212212.png" alt="image-20210918212212308"></p>
<ol start="5">
<li>锁绑定多个条件的Condition</li>
</ol>
<p>ReentrantLock可以实现分组唤醒需要唤醒的线程们，可以<strong>精确唤醒</strong>，而不是像synchronized要么随机唤醒一个要么唤醒全部线程嗷！！！</p>
<ul>
<li>例如A唤醒B，B唤醒C：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210918213531.png" alt="image-20210918213531894"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShareResource</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">//A:1 , B:2 , C:3</span></span><br><span class="line">    <span class="type">private</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">c1</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">c2</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">c3</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print5</span><span class="params">()</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//1. 判断</span></span><br><span class="line">            <span class="keyword">while</span>(number != <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                c1.await();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2. 干活</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> ; i &lt;= <span class="number">5</span> ; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                sout(Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+i);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            	lock.unlock();</span><br><span class="line">        	&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3. 通知</span></span><br><span class="line">            number = <span class="number">2</span>;</span><br><span class="line">            c2.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print10</span><span class="params">()</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//1. 判断</span></span><br><span class="line">            <span class="keyword">while</span>(number != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                c2.await();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2. 干活</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> ; i &lt;= <span class="number">10</span> ; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                sout(Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3. 通知</span></span><br><span class="line">            number = <span class="number">3</span>;</span><br><span class="line">            c3.signal();</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print15</span><span class="params">()</span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//1. 判断</span></span><br><span class="line">            <span class="keyword">while</span>(number != <span class="number">3</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                c3.await();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2. 干活</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> ; i &lt;= <span class="number">15</span> ; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                sout(Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+i);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            	lock.unlock();</span><br><span class="line">        	&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//3. 通知</span></span><br><span class="line">            number = <span class="number">1</span>;</span><br><span class="line">            c1.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="生产者消费者模式（阻塞队列）"><a href="#生产者消费者模式（阻塞队列）" class="headerlink" title="生产者消费者模式（阻塞队列）"></a>生产者消费者模式（阻塞队列）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyResource</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">FLAG</span> <span class="operator">=</span> <span class="literal">true</span>;<span class="comment">//默认开启，进行生产+消费</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AutomicInteger</span> <span class="variable">automicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutomicInteger</span>();</span><br><span class="line">    </span><br><span class="line">    BlockingQuere&lt;String&gt; blockingQueue = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyResource</span><span class="params">(BlockingQueue&lt;String&gt; blockingQueue)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.blockingQueue = blockingQueue;</span><br><span class="line">        sout(blockingQueue.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myProducer</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">boolean</span> retValue;</span><br><span class="line">        <span class="keyword">while</span>(FLAG)</span><br><span class="line">        &#123;</span><br><span class="line">            data = automicInteger.incrementAndGet()+<span class="string">&quot;&quot;</span>;</span><br><span class="line">            retValue = blockingQueue.offer(data,<span class="number">2L</span>,TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span>(retValue)&#123;</span><br><span class="line">                sout(Thread.currentThread().getName()+<span class="string">&quot;\t 插入队列&quot;</span> + data + <span class="string">&quot;成功&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                sout(Thread.currentThread().getName()+<span class="string">&quot;\t 插入队列&quot;</span> + data + <span class="string">&quot;失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sout(Thread.currentThread().getName()+<span class="string">&quot;\t 停下来了嗷！！！&quot;</span> + <span class="string">&quot;表示FLAG=false，生产动作结束！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">myProducer</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span>(FLAG)</span><br><span class="line">        &#123;</span><br><span class="line">            result = blockingQueue.poll(<span class="number">2L</span>,TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == result || result.equalIgnoreCase(<span class="string">&quot;&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                FLAG = <span class="literal">false</span>;</span><br><span class="line">                sout(Thread.currentThread().getName()+<span class="string">&quot;\t 超过两秒没有取到产品，消费退出&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sout(Thread.currentThread().getName()+<span class="string">&quot;\t 消费队列&quot;</span> + result + <span class="string">&quot;成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        sout(Thread.currentThread().getName()+<span class="string">&quot;\t 停下来了嗷！！！&quot;</span> + <span class="string">&quot;表示FLAG=false，生产动作结束！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>main代码块中的一些代码：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920151235.png" alt="image-20210920151235614"></p>
<h2 id="Callable接口（第三种多线程方式）："><a href="#Callable接口（第三种多线程方式）：" class="headerlink" title="Callable接口（第三种多线程方式）："></a>Callable接口（第三种多线程方式）：</h2><ul>
<li>两个接口：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920151426.png" alt="image-20210920151425701"></p>
<p>区别：</p>
<ol>
<li>Runnable没有返回值，Callable有返回值</li>
<li>Callable会抛出异常</li>
<li>接口需要实现的接口不一样嗷！！！</li>
</ol>
<ul>
<li><p>中间层同时适配了Callable和Runnable接口嗷！！FutureTask这个类同时实现了Callable接口和Runnable接口，是按了适配嗷！！！！</p>
</li>
<li><p>背景？为什么会出现呢？</p>
</li>
</ul>
<p>并发，异步导致。高并发最牛逼的控制嗷！！！初衷就是：麻烦的事儿交给别的线程去处理，实现高并发需要使用的嗷！！！</p>
<p>兔兔想法：实现更高程度的并行嗷！！！（分支合并操作嗷！！！）</p>
<ul>
<li>小建议：<ul>
<li>把get方法放在最后哦！！！get如果没有获取到值的话，会阻塞在这里嗷！！！</li>
<li>等它算完了再去取就会比较方便嗷！！！所以我们尽量放在后面取。</li>
<li>当然如果某一步就要结果，又不想阻塞的话，我们就可以类似于自旋锁，通过<code>futureTask.isDone()</code>来实现哦！！！</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920154316.png" alt="image-20210920154316590"></p>
<p>提高了并行性嗷！！！</p>
<ul>
<li>如果启动了多个线程来抢着执行同一个任务呢？<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920154710.png" alt="image-20210920154709812"></li>
<li>不好意思，只执行了一次嗷！！！同样的动作就应该复用嗷！！！如果你真的想走两遍的话，再自己多去做一个FutureTask嗷！！！</li>
</ul>
</li>
</ul>
<h2 id="线程池使用以及优势（第四种多线程方式）："><a href="#线程池使用以及优势（第四种多线程方式）：" class="headerlink" title="线程池使用以及优势（第四种多线程方式）："></a>线程池使用以及优势（第四种多线程方式）：</h2><h3 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h3><ul>
<li>查看电脑CPU核数量：</li>
</ul>
<p><code>Runtime.getRuntime().availableProcessors()</code>可以获得硬件中可用的CPU的核数嗷！！！</p>
<ul>
<li>从new对象到IoC的反转，依赖注入 -&gt; 全都给你准备好，你直接复用我准备好的就成嗷！！！</li>
<li>底层就是阻塞队列嗷！！！</li>
<li>底层是<code>ThreadPoolExecutor ThreadPoolExecutor ThreadPoolExecutor</code>这个类嗷！！！Executor这个接口就对应了Executors这个工具类嗷！！！（和Array，Arrays一样的嗷！！！）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920163453.png" alt="image-20210920163453304"></p>
<ul>
<li>了解：<ul>
<li><code>Executors.newScheduledThreadPool()</code>时间参数用于调度的</li>
<li><code>Executors.newWorkStealingPool(int)</code>可用的处理器作为它的并行级别</li>
</ul>
</li>
<li>重点：<ul>
<li><code>Executors.newFixedThreadPool(int)</code></li>
<li><code>Executors.newSingleThreadPool()</code></li>
<li><code>Executors.newCachedThreadPool(int)</code></li>
</ul>
</li>
</ul>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h3><h4 id="newFixedThreadPool："><a href="#newFixedThreadPool：" class="headerlink" title="newFixedThreadPool："></a>newFixedThreadPool：</h4><ul>
<li><p>固定数目线程池，处理线程数目固定哦！！！</p>
</li>
<li><p>模拟十个用户用五个请求来进行处理嗷！！！</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920162740.png" alt="image-20210920162739367"></p>
<p>处理结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920162759.png" alt="image-20210920162759410"></p>
<ul>
<li>关闭比使用更加重要嗷！！！</li>
</ul>
<h4 id="newSingleThreadExecutor："><a href="#newSingleThreadExecutor：" class="headerlink" title="newSingleThreadExecutor："></a>newSingleThreadExecutor：</h4><ul>
<li>固定单个数目线程池</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920162925.png" alt="image-20210920162925543"></p>
<h4 id="newCachedThreadPool："><a href="#newCachedThreadPool：" class="headerlink" title="newCachedThreadPool："></a>newCachedThreadPool：</h4><ul>
<li>线程池数目不固定，够用就好嗷！！！如果线程不够的话，还会自动扩容嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920163118.png" alt="image-20210920163117475"></p>
<ul>
<li>核心思想：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920163153.png" alt="image-20210920163152856"></p>
<p>我尽力办，我办的完的话，就ok。我要是办不完，我就摇人了嗷！！！</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><ul>
<li>发现上面这三个玩意儿，底层都是<code>return new ThreadPoolExecutor(...)</code>！！！所以ThreadPoolExecutor如此重要嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920163734.png" alt="image-20210920163734036"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920163752.png" alt="image-20210920163751881"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920163820.png" alt="image-20210920163820239"></p>
<ul>
<li><p>底层源码重点：</p>
<ul>
<li>ThreadPoolExecutor这个类很重要！！！</li>
<li>底层的阻塞队列也很重要嗷！！！！</li>
</ul>
</li>
<li><p>使用方法：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920164039.png" alt="image-20210920164038942"></p>
<h3 id="七大参数简介："><a href="#七大参数简介：" class="headerlink" title="七大参数简介："></a>七大参数简介：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920203544.png" alt="image-20210920203543898"></p>
<ol>
<li>corePoolSize：常驻核心线程数</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920203809.png" alt="image-20210920203809064"></p>
<ol start="2">
<li>maximumPoolSize：</li>
</ol>
<p>物理上线程池能够容纳的同时执行的最大线程数，此值必须大于等于1嗷！！！</p>
<ol start="3">
<li>keepAliveTime：</li>
</ol>
<p>多余的空闲线程的存活时间，当线程池数量超过CorePoolSize的时候，空闲时间达到keepAliveTime的值的时候，多余的空闲线程会被销毁直到只剩下corePoolSize个线程为止嗷！！！</p>
<p>没有业务了，“加班”的人会慢慢回退嗷！！！</p>
<ol start="4">
<li><p>unit：keepAliveTime的单位</p>
</li>
<li><p>workQueue：任务队列，被提交了，但是由于核心线程都被占用而无法执行，处于等待状态的任务嗷！！！</p>
</li>
</ol>
<p>类似于银行中的候客区</p>
<ol start="6">
<li><p>threadFactory：生成线程池中线程的线程工厂，用于创建线程，一般用默认的就可以了嗷！！！</p>
</li>
<li><p>handler：拒绝策略，如果线程池满了，阻塞队列都满了，那就……只能够采取一些操作了orz</p>
</li>
</ol>
<p>类似于银行网点，上班的人都在服务（但是还有多的空位），等待的人爆了，银行紧急通知其他休假的人赶紧赶回来上班嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920204832.png" alt="image-20210920204832709"></p>
<p>当所有人都在上班了（物理线程池被占满了），候客区也满了，不好意思。我银行已经尽力的，多来的请求我就不收了。</p>
<h3 id="底层工作原理："><a href="#底层工作原理：" class="headerlink" title="底层工作原理："></a>底层工作原理：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920210510.png" alt="image-20210920210509956"></p>
<p>这幅图就是上面的银行网点那幅图嗷！！！</p>
<ul>
<li>主要处理流程：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920211449.png" alt="image-20210920211449576"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920211539.png" alt="image-20210920211539142"></p>
<h3 id="四种拒绝理论："><a href="#四种拒绝理论：" class="headerlink" title="四种拒绝理论："></a>四种拒绝理论：</h3><h4 id="大坑："><a href="#大坑：" class="headerlink" title="大坑："></a>大坑：</h4><ul>
<li>上面学的三种，实际开发中，<strong>一个都不用嗷！！！（超级大坑！！！）</strong></li>
<li>阿里开发手册：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920212314.png" alt="image-20210920212314139"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920212414.png" alt="image-20210920212414735"></p>
<p>就是这里说的，由于底层是链表，没有最大长度，默认是Integer.MAX_VALUE。这就一个非常大的问题，就是如果我一直往阻塞队列里面加请求，加满了，你的Linux也就爆了orz。</p>
<h4 id="自定义线程池："><a href="#自定义线程池：" class="headerlink" title="自定义线程池："></a>自定义线程池：</h4><p><code>ExecutorService threadPool = new ThreadPoolExecutor(2,5,1L,TimeUnit.SECONDS,new LinkedBlockingQueue&lt;Runnable&gt;(3),Executors.defaultThreadFactory(),new ThreadExecutor.AbortPolicy());</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920213917.png" alt="image-20210920213917146"></p>
<ul>
<li>测试什么时候出问题呢？</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920214035.png" alt="image-20210920214035505"></p>
<p>最大承载量 &#x3D; maximumPoolSize + 阻塞队列最大长度，因此来9个时候可能出现这个问题嗷！！！</p>
<h4 id="AbortPolicy："><a href="#AbortPolicy：" class="headerlink" title="AbortPolicy："></a>AbortPolicy：</h4><ul>
<li>概念：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920211802.png" alt="image-20210920211801937"></p>
<ul>
<li>种类：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920211826.png" alt="image-20210920211826013"></p>
<ul>
<li>如上图所示，出了问题直接报错嗷，程序运行终止。</li>
</ul>
<h4 id="CallerRunsPolicy："><a href="#CallerRunsPolicy：" class="headerlink" title="CallerRunsPolicy："></a>CallerRunsPolicy：</h4><ul>
<li>调用者运行的一种调节机制，不会抛弃任务也不会抛出异常，而是将一些任务<strong>回退给调用者进行处理</strong>，从而降低流量嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920214706.png" alt="image-20210920214706006"></p>
<p>这里就会退给main来处理了嗷！！！</p>
<h4 id="DiscardOldestPolicy："><a href="#DiscardOldestPolicy：" class="headerlink" title="DiscardOldestPolicy："></a>DiscardOldestPolicy：</h4><ul>
<li>抛弃等待最久的，将最新的加入到队列中再次尝试提交嗷！！！</li>
</ul>
<h4 id="DiscardPolicy："><a href="#DiscardPolicy：" class="headerlink" title="DiscardPolicy："></a>DiscardPolicy：</h4><ul>
<li>多来的直接就给了扔掉了嗷！！！</li>
</ul>
<h3 id="配置合理线程数："><a href="#配置合理线程数：" class="headerlink" title="配置合理线程数："></a>配置合理线程数：</h3><ul>
<li><p>熟悉硬件：</p>
<ol>
<li>CPU密集型</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920215354.png" alt="image-20210920215354656"></p>
<ol start="2">
<li>IO密集型</li>
</ol>
<ul>
<li>I&#x2F;O密集型任务线程并不是一直在执行任务，配置尽可能多的线程，如CPU核数*2</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920215528.png" alt="image-20210920215528181"></li>
</ul>
</li>
</ul>
<h2 id="死锁编码及定位分析："><a href="#死锁编码及定位分析：" class="headerlink" title="死锁编码及定位分析："></a>死锁编码及定位分析：</h2><ul>
<li>两个火柴人拿枪指着对方orz，好家伙orz。</li>
</ul>
<h3 id="写个死锁呗："><a href="#写个死锁呗：" class="headerlink" title="写个死锁呗："></a>写个死锁呗：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920220626.png" alt="image-20210920220626213"></p>
<p>run没有写全，写全的版本在下面嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920220647.png" alt="image-20210920220647467"></p>
<ul>
<li>main函数：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920221006.png" alt="image-20210920221006854"></p>
<h3 id="小介绍："><a href="#小介绍：" class="headerlink" title="小介绍："></a>小介绍：</h3><ol>
<li>jps</li>
</ol>
<p>linux中<code>ps -ef | grep xxx</code></p>
<p>windows下的java运行程序捏？也有类似于ps查看进程的命令，但是目前我们需要查看的只是java的程序嗷！！</p>
<p>jps &#x3D; java ps嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920222052.png" alt="image-20210920222052258"></p>
<ol start="2">
<li>jstack</li>
</ol>
<p>jstack + <code>进程号</code></p>
<p>结合上面的jps一起使用，找到对应的线程编号，再查看线程的错误信息嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920222340.png" alt="image-20210920222340886"></p>
<ul>
<li>summary：<ol>
<li>jsp命令定位进程号</li>
<li>jstack找到死锁查看</li>
</ol>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210920222637.png" alt="image-20210920222637114"></p>
<h1 id="11-JVM-GC"><a href="#11-JVM-GC" class="headerlink" title="11. JVM+GC"></a>11. JVM+GC</h1><h2 id="复习串讲："><a href="#复习串讲：" class="headerlink" title="复习串讲："></a>复习串讲：</h2><ul>
<li>JVM内存结构：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922204116.png" alt="image-20210922204101050"></p>
<ul>
<li>GC作用域：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922204138.png" alt="image-20210922204137849"></p>
<ul>
<li><p>常见垃圾回收算法：</p>
<ol>
<li>引用计数：</li>
</ol>
<p>有对象应用+1，没对象-1，到0就回收。<strong>较难解决循环引用问题</strong>，因此JVM不采用这种方式。</p>
<ol start="2">
<li>复制算法：</li>
</ol>
<p>复制算法在年轻代中用</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922205326.png" alt="image-20210922205325740"></p>
<p>名言：复制之后有交换，谁空谁是To</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922204836.png" alt="image-20210922204816262"></p>
<p>缺点就是复制大对象耗时，浪费空间嗷！！！</p>
<ol start="3">
<li>标记清除：</li>
</ol>
<p>Mark-Sweep，分为标记清除两个阶段。先标记出要回收的对象，然后统一回收这些对象。</p>
<p>好处：不用复制，耗时少了。</p>
<p>坏处：出现了内存碎片</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922205103.png" alt="image-20210922205102880"></p>
<ol start="4">
<li>标记清除整理：</li>
</ol>
<p>Mark-Compact</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922205201.png" alt="image-20210922205200495"></p>
<p>移动过程中，耗时比较多嗷！！！</p>
</li>
</ul>
<h2 id="如何确定垃圾-GCRoot："><a href="#如何确定垃圾-GCRoot：" class="headerlink" title="如何确定垃圾+GCRoot："></a>如何确定垃圾+GCRoot：</h2><ul>
<li><p>内存中不再被使用的空间就是垃圾</p>
</li>
<li><p>如何判断一个对象是否是垃圾？</p>
<ol>
<li>引用计数法：简单，但是循环引用解决不了</li>
<li>枚举根结点做可达性分析：</li>
</ol>
<p>复制，标记清除，标记压缩都要用GCRoots来判断哪些是垃圾嗷！！！</p>
</li>
<li><p>GCRoots：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922205724.png" alt="image-20210922205724103"></p>
<p>从GC对象进行扫描，看是否可达。</p>
<ul>
<li>哪些对象可以作为GC Roots对象：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922205901.png" alt="image-20210922205901103"></p>
<ul>
<li>可以作为GCRoot的根呢？</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922210038.png" alt="image-20210922210038211"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922210553.png" alt="image-20210922210552919"></p>
<h2 id="JVM的参数介绍和调整："><a href="#JVM的参数介绍和调整：" class="headerlink" title="JVM的参数介绍和调整："></a>JVM的参数介绍和调整：</h2><h3 id="查看参数："><a href="#查看参数：" class="headerlink" title="查看参数："></a>查看参数：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922215608.png" alt="image-20210922215607756"></p>
<ul>
<li><p><code>-Xms和-Xmx</code>尽量调成一致，防止GC频繁收集，忽高忽低。</p>
</li>
<li><p>参数类型：</p>
<ol>
<li><p>标配参数：</p>
<ul>
<li>随着java变更，基本不会动的参数，没有大的变化。</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922210932.png" alt="image-20210922210931972"></li>
</ul>
</li>
<li><p>X参数：</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922211038.png" alt="image-20210922211037799"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922211115.png" alt="image-20210922211114713"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922211133.png" alt="image-20210922211132961"></li>
</ul>
</li>
<li><p>XX参数：</p>
</li>
</ol>
</li>
<li><p>Boolean类型：</p>
<pre><code> - ![image-20210922211322130](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922211322.png)
</code></pre>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922211556.png" alt="image-20210922211556106"></p>
<ul>
<li>先让一个程序空转，比如<code>sleep(Integer.MAX_VALUE)</code>：<ul>
<li><p>查看线程情况：</p>
<p><code>jps -l</code>和<code>jinfo</code>，这个jinfo是显示当前正在运行的线程的信息嗷！！！</p>
<ul>
<li>查看某个线程的情况：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922212646.png" alt="image-20210922212646075"></p>
<ul>
<li>编辑参数：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922211446.png" alt="image-20210922211446165"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922212743.png" alt="image-20210922212743398"></p>
<p>开启参数之后再测试：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922212834.png" alt="image-20210922212834155"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>KV设值类型：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922213125.png" alt="image-20210922213125480"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922213147.png" alt="image-20210922213146784"></p>
<p>查出某个进程的Metaspace的默认设置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922213252.png" alt="image-20210922213251833"></p>
<p>设置对应的值：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922213407.png" alt="image-20210922213406757"></p>
<p>例如这个MaxTenuringThreshold就是young区的对象进入老年区所需要的年纪嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922213709.png" alt="image-20210922213708933"></p>
<p>所以这里就可以看出来默认的一些配置嗷！！！</p>
<ul>
<li>jinfo的配置使用：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922213921.png" alt="image-20210922213920863"></p>
<p>-flags：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922214035.png" alt="image-20210922214035429"></p>
<p>这个东西是要求得到运行中的线程的id，再去flags才能看得到的嗷！！！</p>
<p><code>Non-default</code>是系统干的，帮我们自动配置好的。</p>
<p><code>Command line</code>是我们自己配置的嗷！！！</p>
<ul>
<li>题外话，坑题（-Xms和-Xmx如何解释？）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922214901.png" alt="image-20210922214901303"></p>
<p>这两个参数也是一样样的，本质上就是-XX参数，用的多。这两个不属于<code>X</code>参数哈，还是属于<code>XX</code>参数嗷！！！只是用到多，单独提出来方便使用而已嗷！！！这两个值一般都是配置成一样的嗷！！！这样才能保证GC尽可能少哦！！！</p>
<h3 id="查看参数二："><a href="#查看参数二：" class="headerlink" title="查看参数二："></a>查看参数二：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922215640.png" alt="image-20210922215639580"></p>
<ul>
<li>方式：</li>
</ul>
<ol>
<li><code>-XX:+PrintFlagsInitial</code>查看初始参数值</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922215725.png" alt="image-20210922215725094"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922215803.png" alt="image-20210922215802398"></p>
<ol start="2">
<li><code>-XX:+PrintFlagsFinal</code>查看修改更新的参数值</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922220037.png" alt="image-20210922220037254"></p>
<ul>
<li><code>=和:=</code><ul>
<li>等于是没有被改过的初始值</li>
<li><code>:=</code>是我们人为改过的或者是JVM加载的时候修改过的参数值嗷！！！</li>
</ul>
</li>
<li>-version的话，只是在最后多打出了JVM的版本号而已嗷！！！</li>
<li>命令行修改：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922220932.png" alt="image-20210922220932163"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922220945.png" alt="image-20210922220945294"></p>
<p>修改之后，运行T之后，可以看出来元空间的值发生了变化嗷！！！</p>
<ol start="3">
<li><code>-XX:+PrintCommandLineFlags</code>打印命令行参数</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210922221211.png" alt="image-20210922221211484"></p>
<p>这个命令最方便就是看最后一个参数！！！垃圾回收器的种类和默认参数嗷！！！</p>
<h2 id="JVM基本配置："><a href="#JVM基本配置：" class="headerlink" title="JVM基本配置："></a>JVM基本配置：</h2><h3 id="Java8调整："><a href="#Java8调整：" class="headerlink" title="Java8调整："></a>Java8调整：</h3><ul>
<li>Java的MetaSpace：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923085939.png" alt="image-20210923085939278"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923090428.png" alt="image-20210923090428487"></p>
<ul>
<li>通过程序获得初始内存大小和最大的堆内存大小：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923090141.png" alt="image-20210923090141078"></p>
<h3 id="通用参数："><a href="#通用参数：" class="headerlink" title="通用参数："></a>通用参数：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923090542.png" alt="image-20210923090542706"></p>
<ol>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923090615.png" alt="image-20210923090615310"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923091333.png" alt="image-20210923091332550"></li>
</ol>
<ul>
<li>如何配置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923091427.png" alt="image-20210923091426848"></p>
<p>注意：<strong>栈管运行，堆管存储</strong>嗷！！！！这个栈是线程运行的时候所拥有的栈的大小</p>
<p>当我们不配置-Xss参数的时候，出现了神奇的问题：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923091541.png" alt="image-20210923091541472"></p>
<p>它默认值为0</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923091733.png" alt="image-20210923091733044"></p>
<p>这里为0其实上表示采用系统的默认值，默认值又是多少呢？上图实际上告诉我们了嗷！！！（这个东西在Java的官方文档中都有嗷！！！）</p>
<ol start="3">
<li><code>-Xmn</code>：设置年轻代的大小嗷！！！</li>
</ol>
<ul>
<li>一般自己不用调，采用系统默认的</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923092140.png" alt="image-20210923092139544"></p>
<ol start="4">
<li><code>-XX:MetaspaceSize</code></li>
</ol>
<h4 id="典型参数设置案例："><a href="#典型参数设置案例：" class="headerlink" title="典型参数设置案例："></a>典型参数设置案例：</h4><ul>
<li>设置元空间大小：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923092248.png" alt="image-20210923092247567"></p>
<ul>
<li>坑：</li>
</ul>
<p>虽然说着元空间有这么多可以用，但是元空间自己取的少啊orz，就有可能报<code>OOM:Metaspace</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923092536.png" alt="image-20210923092536820"></p>
<p>这里默认值就20多M而已啊orz，我内存16个G呢orz。</p>
<ul>
<li>为了保证不会出现OOM：</li>
</ul>
<p>参数配置实例：</p>
<p>下面是我们要手动配置的参数：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923092916.png" alt="image-20210923092916447"></p>
<p><code>-XX:+UserSerialGC</code>是串行垃圾回收器嗷！！！</p>
<p>默认设置也可以瞅一眼哦：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923093114.png" alt="image-20210923093113771"></p>
<p>运行结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923093152.png" alt="image-20210923093152554"></p>
<p>查看默认参数：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923093223.png" alt="image-20210923093223512"></p>
<p>可以看到默认是这些，我们修改之后再康康嗷！！！</p>
<p>我们配置一下上面最开始提到的参数：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923093335.png" alt="image-20210923093334904"></p>
<p>参数设置后的结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923093511.png" alt="image-20210923093511004"></p>
<p>完全按照我们的配置来启动了嗷！！！</p>
<ol start="5">
<li><code>-XX:+PrintGCDetails</code></li>
</ol>
<ul>
<li>输出GC的详细收集日志信息</li>
<li>可以通过限定堆的大小，然后人为new一个贼大的对象来构造GC的错误嗷，这个过程中会产生GC嗷！！！</li>
</ul>
<p>上下是对应的嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923182346.png" alt="image-20210923182346063"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923182405.png" alt="image-20210923182404627"></p>
<p>规律：<code>[名称： GC前内存占用 -&gt; GC后内存占用(该区总内存大小)]</code></p>
<ol start="6">
<li><code>SurvivorRatio</code></li>
</ol>
<ul>
<li>设置新生代中eden区和S0&#x2F;S1空间的比例。</li>
<li>默认：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923182945.png" alt="image-20210923182944953"></p>
<ul>
<li>查看默认参数：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923183152.png" alt="image-20210923183152525"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923183235.png" alt="image-20210923183235580"></p>
<p>改了之后再打印就是我们修改之后的值了嗷！！！</p>
<ol start="7">
<li><code>-XX:NewRatio</code></li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923185443.png" alt="image-20210923185442895"></p>
<p>设置老年代占比，剩下1给新生代</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923185749.png" alt="image-20210923185749201"></p>
<p>默认就是1：2嗷！！！</p>
<ol start="8">
<li><code>-XX:MaxTenuringThreshold</code></li>
</ol>
<ul>
<li>设置垃圾的最大年龄，超过这个年龄就从年轻代进入老年代嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923185951.png" alt="image-20210923185951515"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923190031.png" alt="image-20210923190031165"></p>
<p>通过这个参数就可以设置垃圾的最大年龄嗷！！！</p>
<h2 id="四种引用："><a href="#四种引用：" class="headerlink" title="四种引用："></a>四种引用：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923190412.png" alt="image-20210923190412091"></p>
<ol>
<li>强引用（默认支持模式）</li>
</ol>
<p><code>Book book = new Book(&quot;兔子姐姐的小窝&quot;)</code></p>
<ul>
<li>当内存不足，JVM开始垃圾回收，对于强引用的对象，<strong>就算是出现了OOM也不会对于这个对象进行回收</strong>嗷！！！死都不收！！！</li>
</ul>
<ol start="2">
<li>软引用</li>
</ol>
<ul>
<li>内存足够的前提下我不收（就算手动GC也不回收哦，我够用嘛！！！），内存不够的情况收了你，来保证尽量不要出现OOM嗷！！！</li>
<li>软引用是相对强引用弱化了一些的引用，需要用<code>java.lang.ref.SoftReference</code>类来实现，可以让对象豁免一些垃圾回收。</li>
<li>通常用到对于内存敏感的程序中，高速缓存中就有用到嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923190911.png" alt="image-20210923190911406"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923191004.png" alt="image-20210923191004767"></p>
<p>注意上面这里哈，实际上告诉了我们获得软引用的方式嗷！！！</p>
<ul>
<li>故意整活：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923191149.png" alt="image-20210923191149341"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923191208.png" alt="image-20210923191208008"></p>
<p>5M的小内存，分配了30M的对象，必垃圾回收嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923191308.png" alt="image-20210923191308316"></p>
<ul>
<li>使用场景：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923192051.png" alt="image-20210923192050793"></p>
<p><code>Map&lt;String,SoftReference&lt;Bitmap&gt;&gt; imageCache = new Hashmap&lt;String,SoftReference&lt;Bitmap&gt;&gt;();</code></p>
<p>在保证我程序正常运行的情况下，把空间给你多存一点照片，提高你的效率，这是好事儿。但是如果我都不够用了，那我就不客气了，把你收了嗷，保证不OOM最重要嗷！！！</p>
<ol start="3">
<li>弱应用</li>
</ol>
<ul>
<li>不管够不够用，垃圾回收一律都收掉嗷！！！不管啥情况，回收我就收了你！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923191526.png" alt="image-20210923191525848"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923191539.png" alt="image-20210923191539510"></p>
<ul>
<li>使用场景：</li>
</ul>
<p><code>WeakHashMap</code></p>
<p>key是弱key，如果被垃圾回收了的话，这个entry就会被自动移除嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923194114.png" alt="image-20210923194113847"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    Node(<span class="type">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="built_in">this</span>.hash = hash;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">        <span class="built_in">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">getKey</span><span class="params">()</span>        &#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">getValue</span><span class="params">()</span>      &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">toString</span><span class="params">()</span> &#123; <span class="keyword">return</span> key + <span class="string">&quot;=&quot;</span> + value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> V <span class="title function_">setValue</span><span class="params">(V newValue)</span> &#123;</span><br><span class="line">        <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> value;</span><br><span class="line">        value = newValue;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>底层本质是一个Node的数据结构，实现了Map的Entry，比如上面，本质上put的时候，map底层新建立了一个Node，Node中的key的引用就是传入的Integer的应用，因此如果你修改的是key的话，实际上对于对应位置的引用没有任何的改变，因此这个打印出来的结果还是上面那个结果嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923194648.png" alt="image-20210923194648193"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923194711.png" alt="image-20210923194711738"></p>
<p>这个key不会阻止垃圾回收嗷，如果key失效了，就会被remove嗷！！！</p>
<p>适用于对于内存敏感的使用嗷！！！</p>
<ol start="4">
<li>虚引用：</li>
</ol>
<ul>
<li>又被称为幽灵引用</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923194905.png" alt="image-20210923194905029"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923194930.png" alt="image-20210923194930822"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923195019.png" alt="image-20210923195019141"></p>
<ul>
<li>回收之前需要被引用队列保存一下嗷！！！</li>
<li>弱引用队列的例子：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923200814.png" alt="image-20210923200814571"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923200755.png" alt="image-20210923200754945"></p>
<ul>
<li>虚引用队列的例子：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923201325.png" alt="image-20210923201325447"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923201500.png" alt="image-20210923201500175"></p>
<p>重点就是后续操作，可以做一些通知之类的嗷！！！</p>
<h2 id="GCRoots-四大引用小总结："><a href="#GCRoots-四大引用小总结：" class="headerlink" title="GCRoots + 四大引用小总结："></a>GCRoots + 四大引用小总结：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210923201825.png" alt="image-20210923201825458"></p>
<ul>
<li>Java中可以作为GC Roots的对象：<ul>
<li>虚拟机栈（栈帧中的局部变量区，也叫做局部变量表）。</li>
<li>方法区中的类静态属性引用的对象。</li>
<li>方法区中常量引用的对象。</li>
<li>本地方法栈中JNI（Native方法）引用的对象</li>
</ul>
</li>
</ul>
<h1 id="12-SOFE"><a href="#12-SOFE" class="headerlink" title="12. SOFE"></a>12. SOFE</h1><h2 id="各种异常分类："><a href="#各种异常分类：" class="headerlink" title="各种异常分类："></a>各种异常分类：</h2><p><strong>栈管运行，堆管存储。</strong></p>
<ol>
<li>StackOverflowError</li>
</ol>
<p>这里的栈就是程序运行时对应的栈，由于内存不大，在调用方法的时候就会压栈，我们可以人为构造循环调用方法来制造SOFE：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924203911.png" alt="image-20210924203910628"></p>
<p>这个是错误，不是异常嗷！！！异常是Exception，错误是Error：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43698561/article/details/104382643">下面这个就是Error和Exception的解释嗷！！！</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924204413.png" alt="image-20210924204413080"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924204613.png" alt="image-20210924204613291"></p>
<p>栈爆了。</p>
<ol start="2">
<li>OOM：java heap space</li>
</ol>
<p>先把heap的大小调小：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924204801.png" alt="image-20210924204800557"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924204859.png" alt="image-20210924204858781">不断新建对象，这样就可以了嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924204932.png" alt="image-20210924204932664"></p>
<p>上面这样也行，直接new一个80M的数组，上面调过堆内存只有10M，这个对象远远大于10M。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924205022.png" alt="image-20210924205021400"></p>
<p>这个也是个Error嗷！！！堆爆了。</p>
<ol start="3">
<li>OOM：GC overhead limit exceeded</li>
</ol>
<ul>
<li>程序特别诡异，Java内存急剧上升，大量对象被装载被创建出来。启动GC之后，超过最高警戒了。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924205328.png" alt="image-20210924205327339"></p>
<ul>
<li>GC反复执行，恶行循环，执行存在非常大的问题嗷！！！</li>
<li>实例：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924210445.png" alt="image-20210924210445570"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924210625.png" alt="image-20210924210624990"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924210648.png" alt="image-20210924210647590"></p>
<ol start="4">
<li>OOM：Direct buffer memory</li>
</ol>
<ul>
<li>是由于底层NIO引起的嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924211359.png" alt="image-20210924211358960"></p>
<p>里面够用，外面用满了orz。默认堆外可用内存是总内存的1&#x2F;4嗷！！！</p>
<ul>
<li>示例代码：</li>
</ul>
<p>查看本地可用的JVM内存：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924211557.png" alt="image-20210924211557162"></p>
<p>内存的图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924213350.png" alt="image-20210924213349784"></p>
<p>内存：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924213444.png" alt="image-20210924213444653"></p>
<ul>
<li>下面是示例哈，把外部内存的可用参数调成5M之后，在内存中new一个6M的对象，就会出现上面的问题嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924213507.png" alt="image-20210924213507575"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924214305.png" alt="image-20210924214304637"></p>
<p>这个问题就是由于NIO所引出的哦，面试的时候就有可能问你这个<code>Direct buffer memory</code>的问题，来刺探你是否使用过NIO嗷！！！</p>
<ol start="5">
<li>OOM：unable to create new native thread</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924215151.png" alt="image-20210924215151360"></p>
<ul>
<li>准确的讲，该native thread异常与对应的平台有关。说白了就是：创建的线程的数量超过了系统允许的最大值嗷，导致出现了这个异常嗷！！！！！</li>
<li>示例：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924220700.png" alt="image-20210924220700427"></p>
<p>Linux中默认允许单个进程可以创建的线程数是1024嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210924221132.png"></p>
<ul>
<li><p>解决方案：</p>
<ol>
<li>减少跑起来的线程数</li>
<li>扩大底层机器允许的最大线程数</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925150440.png" alt="image-20210925150439766"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925150525.png" alt="image-20210925150524905"></p>
<p>注意，linux下的root用户对于线程是没有上限的，其他用户默认一个进程最多创建的线程数就是1024，修改：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925150621.png" alt="image-20210925150621473"></p>
</li>
</ul>
<ol start="6">
<li>OOM：Metaspace</li>
</ol>
<ul>
<li>元空间是方法区，方法区装类的模板，常量池啊之类的东东。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925150910.png" alt="image-20210925150909936"></p>
<ul>
<li>元空间与持久代的最大区别：Metaspace并不在虚拟机内存中，而是使用本地内存。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925151016.png" alt="image-20210925151015937"></p>
<ul>
<li>示例：</li>
</ul>
<p>设置元空间的大小为8M：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925151905.png" alt="image-20210925151904788"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925151930.png" alt="image-20210925151929884"></p>
<h2 id="GC垃圾回收器的理解："><a href="#GC垃圾回收器的理解：" class="headerlink" title="GC垃圾回收器的理解："></a>GC垃圾回收器的理解：</h2><ul>
<li>GC有四种垃圾回收算法（引用计数&#x2F;复制&#x2F;标记清除&#x2F;标记整理），垃圾收集器本质上就是这些算法的落地实现。</li>
<li>没有完美的垃圾收集器，都有具体的使用场景嗷！！！</li>
<li>四种垃圾收集器</li>
</ul>
<h3 id="垃圾收集器策略："><a href="#垃圾收集器策略：" class="headerlink" title="垃圾收集器策略："></a>垃圾收集器策略：</h3><h4 id="Serial"><a href="#Serial" class="headerlink" title="Serial"></a>Serial</h4><ul>
<li>串行</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925152550.png" alt="image-20210925152550265"></p>
<ul>
<li>为单线程环境设计，只使用一个线程进行回收，并且会<strong>暂停全部的用户线程</strong>，不适用于服务器环境。（中间业务线程被打断了orz）</li>
</ul>
<h4 id="Parallel"><a href="#Parallel" class="headerlink" title="Parallel"></a>Parallel</h4><ul>
<li>并行</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925152745.png" alt="image-20210925152745385"></p>
<ul>
<li>多个垃圾收集线程并行工作，此时用户线程是暂停的，适用于科学计算 &#x2F; 大数据处理等弱前台交互系统。</li>
<li>停顿回收垃圾的时间回比串行少，但是仍然和前面一样的，需要把所有的用户线程<strong>停下来</strong>！！！</li>
</ul>
<h4 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h4><ul>
<li>并发垃圾回收器（并发标记垃圾清除）</li>
<li>用户线程和垃圾回收线程同时执行（不一定是并行，有可能交替执行），不需要停顿用户线程。互联网公司大多都用CMS，它适用于对于<strong>响应时间有要求的场景</strong>。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925153059.png" alt="image-20210925153058844"></p>
<h4 id="小总结："><a href="#小总结：" class="headerlink" title="小总结："></a>小总结：</h4><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925153238.png" alt="image-20210925153237964"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925153256.png" alt="image-20210925153256070"></p>
<h4 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h4><ul>
<li>将堆内存分割为不同的区域，然后并发对于不同的区域进行垃圾回收嗷！！！</li>
</ul>
<h4 id="ZGC"><a href="#ZGC" class="headerlink" title="ZGC"></a>ZGC</h4><ul>
<li><p>G1的升级版本</p>
</li>
<li><p>比较新，Java12之后才出现的，需要自己下去看看嗷！</p>
</li>
</ul>
<h2 id="服务器默认垃圾收集器查看："><a href="#服务器默认垃圾收集器查看：" class="headerlink" title="服务器默认垃圾收集器查看："></a>服务器默认垃圾收集器查看：</h2><ul>
<li>GC深透明细，思想：四大垃圾回收算法 —&gt;&gt;&gt; 落地实现</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925153851.png" alt="image-20210925153851252"></p>
<ul>
<li>打印出垃圾收集器：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925153935.png" alt="image-20210925153934881"></p>
<p>默认使用的是并行垃圾回收器</p>
<ul>
<li>设置垃圾收集器：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925154143.png" alt="image-20210925154143267"></p>
<h2 id="默认垃圾收集器有哪些？"><a href="#默认垃圾收集器有哪些？" class="headerlink" title="默认垃圾收集器有哪些？"></a>默认垃圾收集器有哪些？</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925154304.png" alt="image-20210925154304571"></p>
<ul>
<li>CMS（ConcMarkSystem）</li>
<li>总共理论上有七种的，UseSerialOldGC和引用计数一样，已经被这个时代废除了，源码中也看不到了，但是它曾经存在过嗷！！！</li>
<li>查看某个运行中的进程的垃圾回收器：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925155113.png" alt="image-20210925155113074"></p>
<h2 id="七种垃圾收集器："><a href="#七种垃圾收集器：" class="headerlink" title="七种垃圾收集器："></a>七种垃圾收集器：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925155942.png" alt="image-20210925155941812"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925160146.png" alt="image-20210925160145418"></p>
<ul>
<li>年轻代更多使用复制算法，老年代我们更多使用标记清除或者标记整理算法。</li>
</ul>
<h3 id="部分参数说明-x2F-C-x2F-S模式有什么区别"><a href="#部分参数说明-x2F-C-x2F-S模式有什么区别" class="headerlink" title="部分参数说明 &#x2F; C&#x2F;S模式有什么区别"></a>部分参数说明 &#x2F; C&#x2F;S模式有什么区别</h3><ul>
<li><p>参数：</p>
<ul>
<li>DefNew - Default New Generation</li>
<li>Tenured - Old</li>
<li>ParNew - Parallel New Generation</li>
<li>PSYoungGen - Parallel Scanvenge Young Generation</li>
<li>ParOldGen - Parallel Old Generation</li>
</ul>
</li>
<li><p>C&#x2F;S模式：</p>
<ul>
<li>只需要掌握Server模式即可，Client模式基本不会用</li>
<li>操作系统：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925160643.png" alt="image-20210925160642642"></p>
</li>
</ul>
<h3 id="新生代："><a href="#新生代：" class="headerlink" title="新生代："></a>新生代：</h3><ul>
<li>Young和Old的垃圾收集器是搭配使用的嗷，注意上面那张图图捏！！！新生代的指定了，老年代的基本上就确定了嗷！！！</li>
</ul>
<h4 id="Serial-x2F-Serial-Copying："><a href="#Serial-x2F-Serial-Copying：" class="headerlink" title="Serial &#x2F; Serial Copying："></a>Serial &#x2F; Serial Copying：</h4><ul>
<li>串行+串行</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925161602.png" alt="image-20210925161602019"></p>
<p>简单高效，没有线程交互的开销，可以获得最高的单线程垃圾收集效率，因此Serial垃圾收集器依然是Java虚拟机运行在Clinet模式下默认的垃圾收集器</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925161807.png" alt="image-20210925161807280"></p>
<ul>
<li>Y和O都是Serial回收，只是回收过程中，采取的回收算法不一样而已嗷！！！</li>
</ul>
<h4 id="ParNew："><a href="#ParNew：" class="headerlink" title="ParNew："></a>ParNew：</h4><ul>
<li>并行+串行</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925162131.png" alt="image-20210925162130287"></p>
<ul>
<li>年轻代的ParNew是搭配老年代的CMS使用的嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925162840.png" alt="image-20210925162839624"></p>
<h4 id="ParallelScanvenge："><a href="#ParallelScanvenge：" class="headerlink" title="ParallelScanvenge："></a>ParallelScanvenge：</h4><ul>
<li>并行+并行</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925163018.png" alt="image-20210925163017590"></p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925163201.png" alt="image-20210925163200837"></li>
</ul>
<p>串行收集器在新生代和老年代的并行化</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925163326.png" alt="image-20210925163325742"></p>
<ul>
<li>配置这个模式：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925163434.png" alt="image-20210925163433318"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925163508.png" alt="image-20210925163508148"></p>
<h3 id="老年代："><a href="#老年代：" class="headerlink" title="老年代："></a>老年代：</h3><h4 id="Serial-Old-x2F-Serial-MSC："><a href="#Serial-Old-x2F-Serial-MSC：" class="headerlink" title="Serial Old &#x2F; Serial MSC："></a>Serial Old &#x2F; Serial MSC：</h4><ul>
<li>老年代的串行收集器</li>
<li>单线程+标记整理算法，这个收集器也是主要运行在Client默认的java虚拟机默认的老年代垃圾收集器。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925172206.png" alt="image-20210925172206379"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925172228.png" alt="image-20210925172227843"></p>
<ul>
<li>已经优化掉了，都不用了都orz</li>
</ul>
<h4 id="Parallel-Old："><a href="#Parallel-Old：" class="headerlink" title="Parallel Old："></a>Parallel Old：</h4><ul>
<li><p>并行+并行</p>
</li>
<li><p>Parallel Scavenge的老年代版本，使用多线程的标记-整理算法，Parallel Old收集器在1.6才开始使用嗷！！！</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925163901.png" alt="image-20210925163901411"></p>
<ul>
<li>不加的话默认使用的是<code>UseParrellelGC</code>，就在上面，所以老年代默认的也是使用Parallel Old嗷！！！</li>
</ul>
<h4 id="CMS："><a href="#CMS：" class="headerlink" title="CMS："></a>CMS：</h4><ul>
<li>并发标记清除GC（CMS）</li>
<li>好处：解决空间和时间，坏处：内存碎片</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925170643.png" alt="image-20210925170642985"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925170707.png" alt="image-20210925170707008"></p>
<ul>
<li>过程：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925170740.png" alt="image-20210925170740207"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925171346.png" alt="image-20210925171345757"></p>
<p>1，3要停，2，4不要停：</p>
<p>重新标记：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925171053.png" alt="image-20210925171053270"></p>
<p>并发清除：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925171123.png" alt="image-20210925171123242"></p>
<p>标记和清除这两个最耗时的操作，可以并发执行嗷！！！</p>
<ul>
<li>优缺点：<ul>
<li>优点：并发收集低停顿</li>
<li>缺点：并发执行，CMS在收集与应用线程会同时增减对于堆内存的占用，CPU的压力比较大！！！CMS必须在老年代堆内存用尽之前完成垃圾回收，否则就会回收失败，触发担保机制。串行老年代收集器将会以STW的方式进行一次GC，从而造成较大停顿时间。此外，标记清除算法会导致大量碎片嗷！！！</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925171815.png" alt="image-20210925171814442"></p>
<ul>
<li>同时配置多个垃圾收集器：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925172417.png" alt="image-20210925172416956"></p>
<p>关联激活，完全没有必要这么去写嗷！！！</p>
<h2 id="选择合适的垃圾收集器："><a href="#选择合适的垃圾收集器：" class="headerlink" title="选择合适的垃圾收集器："></a>选择合适的垃圾收集器：</h2><ul>
<li>适用场景：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925172835.png" alt="image-20210925172835478"></p>
<ul>
<li>对应关系：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210925173108.png" alt="image-20210925173107600"></p>
<h2 id="G1垃圾回收器："><a href="#G1垃圾回收器：" class="headerlink" title="G1垃圾回收器："></a>G1垃圾回收器：</h2><ul>
<li>G1又被称为<code>Garbage-First</code>嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926191656.png" alt="image-20210926191553163"></p>
<ul>
<li>打印结果显示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926191729.png" alt="image-20210926191630759"></p>
<p>别的都有两个区哦这里，G1只有一个garbage-first heap，这就是上面所提到过的，G1横跨两个区哦！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926191942.png" alt="image-20210926191942141"></p>
<p>G1是一种服务端的垃圾收集器，应用在<strong>多处理器和大容量内存环境</strong>中，实现高吞吐量的同时，尽可能满足垃圾收集暂停时间的要求。</p>
<ul>
<li><p>特性：</p>
<ol>
<li>像CMS一样，能与应用程序并发执行</li>
<li>整理空闲时间空间更快</li>
<li>需要更多的时间来预测GC停顿时间</li>
<li>不希望牺牲大量的吞吐性能</li>
<li>不需要更大的Java Heap</li>
</ol>
</li>
<li><p>G1就是为了取代CMS而被设计的，不会产生很多内存碎片，而且添加了预测机制，用户可以指定期望停顿时间嗷！！！</p>
</li>
<li><p>Eden和Survivor和Tenured等区域不再是连续的，而是变成了一个个大小一样的region。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926192932.png" alt="image-20210926192932201"></p>
<p>Java9开始就作为默认的垃圾收集器了嗷！！！</p>
<ul>
<li>特点：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926193156.png" alt="image-20210926193155568"></p>
<h3 id="底层原理：-1"><a href="#底层原理：-1" class="headerlink" title="底层原理："></a>底层原理：</h3><ul>
<li><p>Region区域化垃圾收集器，化整为零，避免全内存扫描，只需要按照区域进行内存扫描嗷！！！</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926193424.png" alt="image-20210926193423711"></p>
</li>
<li><p>G1的改变：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926193704.png" alt="image-20210926193703956"></p>
<p>化整为零，避免了全内存扫描嗷！！！相当于把垃圾回收的基本单位变小了orz，粒度小了，并发度就高了嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926194304.png" alt="image-20210926193946667"></p>
<p>大的对象，也可以通过紧凑的方法来腾出空间，边清理，边内存整理，当然效率高哇！！！</p>
<ul>
<li><p>G1分为了四个区嗷：</p>
<ul>
<li>Eden区</li>
<li>Survivor区</li>
<li>Old区</li>
<li>Humongou大对象区</li>
</ul>
</li>
<li><p>垃圾回收流程：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926194412.png" alt="image-20210926194411751"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926194432.png" alt="image-20210926194432326"></p>
<p>G1中的内存处于一个动态变化的过程中嗷！！！有点像分页算法？？？？？？？这种熟悉的感觉，emmmmmm</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926194520.png" alt="image-20210926194519537"></p>
<p>回收步骤倒是和CMS一模一样，这不就和HashTable和ConcurrentHashMap一样嘛orz，对于每一个小块，采用的都是同样的CMS算法嗷！！！</p>
<ul>
<li>好多参数嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926195230.png" alt="image-20210926195229637"></p>
<p>这些都可以尝试着看一下哈！！！一般都是用默认值的嗷！！！</p>
<h3 id="G1和CMS相比的优势"><a href="#G1和CMS相比的优势" class="headerlink" title="G1和CMS相比的优势"></a>G1和CMS相比的优势</h3><ol>
<li>G1没有内存碎片嗷！！！</li>
<li>G1可以精确控制停顿嗷！！！</li>
</ol>
<h2 id="JVMGC-SpringBoot微服务部署"><a href="#JVMGC-SpringBoot微服务部署" class="headerlink" title="JVMGC + SpringBoot微服务部署"></a>JVMGC + SpringBoot微服务部署</h2><ul>
<li><p>JVMGC –&gt; 调优 –&gt; 应用于微服务</p>
</li>
<li><p>步骤：</p>
<ol>
<li>IDEA开发完成微服务工程</li>
<li>maven进行clean和package</li>
<li>微服务启动的时候，同时配置我们JVM &#x2F; GC的调优参数：<ul>
<li>内</li>
<li>外 &#x3D;&gt; 中带你</li>
</ul>
</li>
<li>公式：<code>java -server jvm的各种参数 -jar jar/war包的名字</code></li>
</ol>
</li>
<li><p>示例：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926200212.png" alt="image-20210926200212372"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926200313.png" alt="image-20210926200313040"></p>
<h1 id="13-Linux相关"><a href="#13-Linux相关" class="headerlink" title="13. Linux相关"></a>13. Linux相关</h1><h2 id="生产环境服务器变慢了"><a href="#生产环境服务器变慢了" class="headerlink" title="生产环境服务器变慢了"></a>生产环境服务器变慢了</h2><h3 id="top："><a href="#top：" class="headerlink" title="top："></a>top：</h3><ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926201513.png" alt="image-20210926201513031"></li>
<li>在top的情况下，按下<code>1</code>，就会显示所有的CPU的占用情况嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926202106.png" alt="image-20210926202105515"></p>
<p>可以看到每个CPU的各种参数的使用情况嗷！！！</p>
<h3 id="uptime："><a href="#uptime：" class="headerlink" title="uptime："></a>uptime：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926202244.png" alt="image-20210926202244709"></p>
<p>精简版的ps，uptime你值得拥有</p>
<h3 id="vmstat："><a href="#vmstat：" class="headerlink" title="vmstat："></a>vmstat：</h3><p><code>vmstat -n 2 3</code></p>
<ul>
<li>主要用于查看CPU，但是包含不限于嗷！！！</li>
<li>每2秒采样一次，共计采样3次</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-12-10-centos ~]# vmstat -n 2 3</span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class="line"> 3  1      0  76776 139660 1405012    0    0     0    29    2   12  1  0 99  0  0</span><br><span class="line"> 0  0      0  76272 139660 1405044    0    0     0    48 1145 2390  3  3 94  0  0</span><br><span class="line"> 1  0      0  76256 139660 1405060    0    0     0     0 1093 2187  0  0 100  0  0</span><br></pre></td></tr></table></figure>

<ul>
<li>头和尾的两个比较重要嗷！！！</li>
<li>r是run , b是block。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926202753.png" alt="image-20210926202752052"></p>
<h3 id="mpstat："><a href="#mpstat：" class="headerlink" title="mpstat："></a>mpstat：</h3><ul>
<li><code>mpstat -P ALL 2</code></li>
</ul>
<p>每两秒采样一次，查看所有CPU的核信息：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926203030.png" alt="image-20210926203029814"></p>
<p>查看每个进程使用CPU的用量分解信息：</p>
<p><code>pidstat -u 1 -p 进程编号</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926203218.png" alt="image-20210926203218298"></p>
<h3 id="free："><a href="#free：" class="headerlink" title="free："></a>free：</h3><ul>
<li><p>查看程序可用内存数</p>
</li>
<li><p><code>free -m</code>按照M来看，系统内存的可用数量</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926203425.png" alt="image-20210926203425023"></p>
<ul>
<li><code>pidstat -p 进程号 -r 采样间隔秒数</code></li>
</ul>
<h3 id="df："><a href="#df：" class="headerlink" title="df："></a>df：</h3><ul>
<li><p>disk free，查看磁盘剩余空间数</p>
</li>
<li><p><code>df -h</code> 用人类看得懂的方式来告诉我们，可用的磁盘空间大小</p>
</li>
</ul>
<h3 id="ioStat："><a href="#ioStat：" class="headerlink" title="ioStat："></a>ioStat：</h3><ul>
<li><code>iostat</code>，查看磁盘IO，磁盘I&#x2F;O性能评估</li>
<li><code>iostat -xdk 2 3</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926204128.png" alt="image-20210926204127348"></p>
<ul>
<li><code>pidstat -d 时间间隔 -p 进程号</code></li>
</ul>
<h3 id="ifstat："><a href="#ifstat：" class="headerlink" title="ifstat："></a>ifstat：</h3><ul>
<li>默认本地没有，要下载的嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926204426.png" alt="image-20210926204425422"></p>
<h2 id="CPU占用过高，分析-定位？"><a href="#CPU占用过高，分析-定位？" class="headerlink" title="CPU占用过高，分析+定位？"></a>CPU占用过高，分析+定位？</h2><ul>
<li><p>Linux加上JDK共同分析</p>
</li>
<li><p>步骤：</p>
<ol>
<li>top命令找出惹事儿的Java程序，记录它的id</li>
<li>ps -ef | grep 进程号或者 jps 进一步定位，得知怎样的后台程序在惹事儿</li>
<li>定位到具体的<strong>线程</strong>或者<strong>代码：</strong></li>
</ol>
<p><strong><code>ps -mp 进程 -o THREAD,tid,time</code></strong></p>
<p>tid是哪一个线程，time是某个线程已经耗费的时间</p>
<p>参数解释：</p>
<ul>
<li>-m显示所有的线程</li>
<li>-p pid进程使用cpu的时间</li>
<li>-o 该参数后面是用户自定义格式</li>
</ul>
<ol start="4">
<li>将需要的<strong>线程ID</strong>转换为<strong>16进制格式</strong>（英文小写格式）</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926205055.png" alt="image-20210926205054790"></p>
<p>或者手动算或用计算机算也成嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926205131.png" alt="image-20210926205130839"></p>
<p>注意哈，机器内存里面全是小写嗷！！！</p>
<ol start="5">
<li><code>jstack 进程ID | grep tid（16进制线程id小写英文）-A60</code></li>
</ol>
<p>-A60是打印出前60行嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210926205849.png" alt="image-20210926205848429"></p>
</li>
</ul>
<h1 id="14-Github骚操作"><a href="#14-Github骚操作" class="headerlink" title="14. Github骚操作"></a>14. Github骚操作</h1><h2 id="常用词："><a href="#常用词：" class="headerlink" title="常用词："></a>常用词：</h2><ul>
<li>watch：持续获得某个项目更新的通知嗷</li>
<li>fork：复制某个项目到自己的仓库中</li>
<li>star：项目点赞数</li>
<li>clone：把项目下载到你本地</li>
<li>follow：关注感兴趣的作者，会收到他们的动态</li>
</ul>
<h2 id="具体骚操作："><a href="#具体骚操作：" class="headerlink" title="具体骚操作："></a>具体骚操作：</h2><h3 id="In关键词限制搜索范围："><a href="#In关键词限制搜索范围：" class="headerlink" title="In关键词限制搜索范围："></a>In关键词限制搜索范围：</h3><ul>
<li><p>公式：<code>xxx关键词 in:name 或 description 或 readme</code></p>
</li>
<li><p>例如<code>seckill in:name</code>，项目的名字中必须有seckill这个关键字嗷！！！</p>
</li>
<li><p>组合使用：<code>seckill in:name,description</code></p>
</li>
</ul>
<h3 id="stars或fork项目查找项目："><a href="#stars或fork项目查找项目：" class="headerlink" title="stars或fork项目查找项目："></a>stars或fork项目查找项目：</h3><ul>
<li>公式：<code>xxx关键字 stars 通配符</code><ul>
<li>例如<code>:&gt; 或者 :&gt;=</code></li>
<li>区间范围数字：<code>数字1...数字2</code></li>
</ul>
</li>
<li>例如：<code>springboot stars:&gt;=5000</code></li>
<li>例如：<code>springboot forks:&gt;=500</code></li>
<li>组合使用：<code>springboot forks:100..200 stars:2000..4000</code></li>
</ul>
<h3 id="awesome加强搜索："><a href="#awesome加强搜索：" class="headerlink" title="awesome加强搜索："></a>awesome加强搜索：</h3><ul>
<li>awesome系列一般是用来收集</li>
<li>查找官方收集的学习，工具，书籍类相关的项目</li>
<li>公式：<code>awesome 项目名字</code></li>
<li>例如：<code>awesome redis</code></li>
</ul>
<h3 id="高亮显示代码："><a href="#高亮显示代码：" class="headerlink" title="高亮显示代码："></a>高亮显示代码：</h3><ul>
<li><p>给别人指出关键代码的行数或者行号</p>
</li>
<li><p>公式：<code>项目对应代码的URL + #L + 数字</code></p>
</li>
<li><p>例如：<code>https://github.com/coding/.../killDao.java#L13</code></p>
</li>
<li><p>范围高亮：</p>
<p><code>项目对应代码的URL + #L + 数字 + - + L + 数字</code></p>
<p>例如：<code>https://github.com/coding/.../killDao.java#L13-L23</code></p>
</li>
</ul>
<h3 id="T搜索："><a href="#T搜索：" class="headerlink" title="T搜索："></a>T搜索：</h3><ul>
<li>项目内搜索</li>
<li>在项目主页按下小写字母t，这个快捷键就是项目中搜索嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210927102201.png" alt="image-20210927102153357"></li>
<li>进入列表显示和搜索栏，可以列出项目中全部的文件，方便我们查找和检索阅读嗷！！！</li>
<li>还有好多好多快捷键嗷！！！</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.github.com/en/get-started/using-github/keyboard-shortcuts">github官网快捷键嗷！！！</a></p>
<h3 id="搜索某个地区的大佬："><a href="#搜索某个地区的大佬：" class="headerlink" title="搜索某个地区的大佬："></a>搜索某个地区的大佬：</h3><ul>
<li>公式：搜索栏中<code>location:beijing language:java</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210927102957.png" alt="image-20210927102956944"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/05/Java%E5%A4%A7%E5%8E%82%E5%B8%B8%E9%97%AE%E9%9D%A2%E8%AF%95%E9%A2%98/" data-id="cl6gepmfm001le0jqbr9zcl51" data-title="Java常问面试题总结与提高" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%A7%E4%B8%89%E8%87%AA%E5%AD%A6/" rel="tag">大三自学</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring-Cloud-Spring-Cloud-Alibaba" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/24/Spring-Cloud-Spring-Cloud-Alibaba/" class="article-date">
  <time class="dt-published" datetime="2021-07-24T08:23:19.000Z" itemprop="datePublished">2021-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/24/Spring-Cloud-Spring-Cloud-Alibaba/">Spring Cloud + Spring Cloud Alibaba</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="这是继Boot之后，对于SpringCloud-Alibaba分布式框架的学习"><a href="#这是继Boot之后，对于SpringCloud-Alibaba分布式框架的学习" class="headerlink" title="这是继Boot之后，对于SpringCloud+Alibaba分布式框架的学习"></a>这是继Boot之后，对于SpringCloud+Alibaba分布式框架的学习</h1><h1 id="Cloud概述"><a href="#Cloud概述" class="headerlink" title="Cloud概述"></a>Cloud概述</h1><ul>
<li>什么是微服务：<ul>
<li>Martin Fowler</li>
</ul>
</li>
<li>分布式架构强就强在一个整体的性能特别棒嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724164643.png" alt="image-20210724164643053"></p>
<p>SpringCloud &#x3D; 分布式微服务架构的一站式解决方案，是多种微服务架构落地技术的集合体，俗称为微服务全家桶。</p>
<ul>
<li>优质项目推荐：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724165218.png" alt="image-20210724165218435"></p>
<ul>
<li><p>Cloud和Boot的选型：</p>
<ul>
<li>Boot2.X版和Cloud H版</li>
<li>Boot和Cloud的版本选择是有约束，有依赖的。在官网中的Cloud的Overview中，是有对应的说明的嗷！！！</li>
</ul>
</li>
</ul>
<h2 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h2><p>  <img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724170443.png" alt="image-20210724170443790"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://start.spring.io/actuator/info">更加详细的版本说明</a></li>
</ul>
<p>  <img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724171310.png" alt="image-20210724171310522"></p>
<ul>
<li>具体最好的推荐版本，进入你要使用的Cloud的参考文档中，都有对应的说明的哈！！！</li>
</ul>
<p>  <img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724172343.png" alt="image-20210724172343094"></p>
<ul>
<li>这里我们使用和网课一样的框架嗷！！！方便后面的学习和深入：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724185921.png" alt="image-20210724185921087"></p>
<h2 id="技术迭代："><a href="#技术迭代：" class="headerlink" title="技术迭代："></a>技术迭代：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724185450.png" alt="image-20210724185450373"></p>
<ul>
<li>可以看出来，Nacos是新的技术中的重中之重。许多老的技术已经被新的技术淘汰掉了。</li>
</ul>
<h1 id="支付模块微服务实操"><a href="#支付模块微服务实操" class="headerlink" title="支付模块微服务实操"></a>支付模块微服务实操</h1><h2 id="父工程Project配置："><a href="#父工程Project配置：" class="headerlink" title="父工程Project配置："></a>父工程Project配置：</h2><ul>
<li><p>环境部分：</p>
<ul>
<li>约定 &gt; 配置 &gt; 编码</li>
<li>IDEA中的创建流程：<ul>
<li>Project：<ul>
<li>Module1 - 例如：订单模块</li>
<li>Module2 - 例如：支付模块</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li>创建过程：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724191000.png" alt="image-20210724190959986"></p>
</li>
<li><p>Project的创建：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724191213.png" alt="image-20210724191213484"></p>
<ul>
<li>字符编码：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724194208.png" alt="image-20210724194208127"></p>
<ul>
<li>支持注解设置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724194621.png" alt="image-20210724194621731"></p>
<ul>
<li>Java编译版本设置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724194852.png" alt="image-20210724194852269"></p>
<ul>
<li>FIle Type过滤：<ul>
<li>比如不显示iml文件等，这个是可以配置的嗷！！！</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724195142.png" alt="image-20210724195142387"></p>
<h2 id="父工程POM："><a href="#父工程POM：" class="headerlink" title="父工程POM："></a>父工程POM：</h2><ul>
<li>指明为POM</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724195343.png" alt="image-20210724195343393"></p>
<ul>
<li>删掉src，只做版本管理的话不用src文件夹嗷！！！</li>
<li>POM中做好版本依赖管理：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- FIXME change it to the project&#x27;s website --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">inceptionYear</span>&gt;</span>2001<span class="tag">&lt;/<span class="name">inceptionYear</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">site</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>website<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>scp://webhost.company.com/www/website<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">site</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>12<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>12<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.18<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.1.16<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mybatis.spring.boot.version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">mybatis.spring.boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring boot 2.2.2--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- druid--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--junit--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--log4j--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span><span class="comment">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-site-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">locales</span>&gt;</span>en,fr<span class="tag">&lt;/<span class="name">locales</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">reporting</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">reporting</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面是pom中的代码</p>
<ul>
<li>dependencyManagement和dependencies的区别：<ul>
<li>第一个能让所有子项目中引入一个依赖而不需要显示给出版本号，Maven会自动沿着父子层次往上走，知道找到一个拥有此元素的项目，它就会使用这个dependencyManagement元素中指定的版本号嗷！！！</li>
<li>第一个只是声明依赖，并不实现引入嗷，因此子项目需要显示的声明需要的依赖，version和scope都会继承父工程的版本号嗷！！！</li>
</ul>
</li>
<li>禁用test可以节约时间嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724204148.png" alt="image-20210724204148101"></p>
<ul>
<li>clean + install可以将我们自己的项目打包安装到我们的Maven仓库中嗷！！！发布到仓库中之后才方便子工程继承嗷！！！</li>
</ul>
<h2 id="支付模块构建："><a href="#支付模块构建：" class="headerlink" title="支付模块构建："></a>支付模块构建：</h2><h3 id="最简单的提供服务功能-Provider-："><a href="#最简单的提供服务功能-Provider-：" class="headerlink" title="最简单的提供服务功能(Provider)："></a>最简单的提供服务功能(Provider)：</h3><ul>
<li>始终：约定 &gt; 配置 &gt; 编码。最简单的功能的约定如下所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724204456.png" alt="image-20210724204456499"></p>
<ul>
<li>如何构建微服务模块：<ol>
<li>建module</li>
<li>改pom</li>
<li>写yml</li>
<li>主启动</li>
<li>业务类</li>
</ol>
</li>
<li>建module：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724204819.png" alt="image-20210724204819838"></p>
<ul>
<li>改pom：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        坐标监控的时候十分重要，这两者一般都是一起出现的嗷！！！--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        下面是数据库--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        mysql-connector-java--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        jdbc--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>写yml：<ul>
<li>最少都要配置端口号和服务名称嗷！！！</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/cloud-payment?serverTimezone=GMT</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">******</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.tuzi.cloud.entities</span></span><br></pre></td></tr></table></figure>

<ul>
<li>主启动：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725094345.png" alt="image-20210725094338249"></p>
<ul>
<li>业务类：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725094759.png" alt="image-20210725094759209"></p>
<ol>
<li>建表SQL：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `payment`(  </span><br><span class="line">    `id` <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">    `serial` <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> &quot;&quot;,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY(`id`)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>




<ol start="2">
<li>entities实体类：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725101756.png" alt="image-20210725101756502"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.entities;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payment</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String serial;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里注意一下，BIGINT和这里的Long是对应的。要实现<strong>序列化</strong>，这样后面才能做分布式部署嗷！！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.entities;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonResult</span>&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//404 not_found</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonResult</span><span class="params">(Integer code,String message)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>(code,message,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CommonResult是用来传递返回的结果(JSON)给前端的时候用的嗷！！！所有还用到了泛型，用于接受不同类型的参数，并且同一返回嗷！！！。</p>
<ol start="3">
<li>dao层：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentDao</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>持久层一般都是接口，而且使用@Mapper注解就足够用了嗷！！！</p>
<ul>
<li>定义完接口之后，我们还要写对应的实现xml嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725102608.png" alt="image-20210725102607967"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725103726.png" alt="image-20210725103726002"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.tuzi.cloud.dao.PaymentDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;create&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;Payment&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        insert into payment(serial) values(#&#123;serial&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.tuzi.cloud.entities.Payment&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;BIGINT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">property</span>=<span class="string">&quot;serial&quot;</span> <span class="attr">jdbcType</span>=<span class="string">&quot;VARCHAR&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getPaymentById&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;BaseResultMap&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;long&quot;</span>&gt;</span></span><br><span class="line">        select * from payment where id=#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>首先，插件非常方便，只要绑定了NameSpace之后，插件就会自动给没有映射的方法爆红，然后提示帮你在xml中生成对应的方法。</li>
<li>推荐使用resultMap作为映射，当表的数据很多，而且命名不规范的时候，ResultMap能够很好的规定我们的数据元素和数据库中的元素之间的映射关系嗷！！！</li>
</ul>
<ol start="4">
<li>service接口：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725105342.png" alt="image-20210725105342521"></p>
<ul>
<li>Service理论上是实现业务逻辑，并且调用dao层的，我们这里直接将service接口中的方法设置为和Dao层中一致，可以少些代码嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> <span class="type">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>有了接口也要熟练去写实现类嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.dao.PaymentDao;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.service.PaymentService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">PaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentDao paymentDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">create</span><span class="params">(Payment payment)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentDao.create(payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Payment <span class="title function_">getPaymentById</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentDao.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里注意一下，Impl肌肉记忆去写@Service，这里的@Resource注解的作用和@Autowired一样，起到了自动注入的作用嗷！！！这个类的目的就是根据我们规定的方法，调用我们的Dao层，完成功能的具体实现。最终需要将这个实现类加入到容器中，这样才能供我们后续使用嗷！！！</p>
<ol start="5">
<li>controller</li>
</ol>
<ul>
<li>Controller -&gt; Service -&gt; Dao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.entities.CommonResult;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.cloud.service.PaymentService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写操作用Post</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/payment/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">create</span><span class="params">(Payment payment)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.create(payment);</span><br><span class="line">        log.info(<span class="string">&quot;*****插入结果为：&quot;</span>+result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(result &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>,<span class="string">&quot;插入数据库成功&quot;</span>,result);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>,<span class="string">&quot;插入数据库失败&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读操作用Get</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">long</span> id)</span>&#123;</span><br><span class="line">        <span class="type">Payment</span> <span class="variable">payment</span> <span class="operator">=</span> paymentService.getPaymentById(id);</span><br><span class="line">        log.info(<span class="string">&quot;*****查询结果为：&quot;</span>+payment);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(payment != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>,<span class="string">&quot;查询数据库成功&quot;</span>,payment);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>,<span class="string">&quot;没有对应记录，查询ID: &quot;</span>+id,<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>写操作一般通过表单来操作的，所有用Post，查询操作一般Get就可以，CommonResult相当于返回JSON的一个同一的数据模板，我们封装之后就可以把它返回了。</p>
</li>
<li><p>注意，Controller能够调用的，只有Service，它是不能够调用Dao的嗷！！！</p>
</li>
<li><p>下面要对于我们编写的内容进行测试：</p>
<ul>
<li>遇到的坑：有些地方，例如project structure里面，项目默认的编译版本为Java12, 会报错嗷！！！</li>
<li>对于Post请求做测试，在我们没有写前端的Post表单的情况下，我们可以直接使用POSTMAN对于Post请求做测试嗷，这样很方便嗷！！！</li>
<li>自测通过才行嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725112625.png" alt="image-20210725112625240"></li>
</ul>
</li>
<li><p>小总结：就是上面那五点就可以实现后端的功能嗷！！！</p>
</li>
</ul>
<h3 id="最简单的提供服务功能-Consumer-："><a href="#最简单的提供服务功能-Consumer-：" class="headerlink" title="最简单的提供服务功能(Consumer)："></a>最简单的提供服务功能(Consumer)：</h3><ul>
<li>前面微服务的流程：新建module , 修改pom文件 ， application.yml ， 启动类的配置和之前都差不多，不再赘述，值得一提的是这里的application.yml中的配置为：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>默认为80，因为80为默认的网络接口，所以我们这里必须设置为80端口嗷！！！</p>
<ul>
<li>下面这里介绍的就是Consumer的业务类：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725161657.png" alt="image-20210725161657175"></p>
<p>Consumer只需要去调用Provider提供的服务，为啥要Dao 和 Service呢？？？</p>
<ul>
<li>实体类还是要的嗷，这里我们直接拷贝Provider中的实体类到Consumer中嗷！！！</li>
<li>编写我们的Controller：<ul>
<li>Controller的存在就是为了调用Provider提供的服务嗷！！！</li>
<li>使用RestTemplate可以完成接口的调用，使用方法如下：</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725161756.png" alt="image-20210725161756124"></li>
</ul>
</li>
<li>由于需要使用restTemplate，我们需要编写对应的配置类将其注入到我们的容器中来嗷！！！（要用的东西都可以通过@Configuration配置类中的@Bean来添加到容器中来嗷！！！）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725162128.png" alt="image-20210725162128770"></p>
<ul>
<li>两个都可以跑起来，测试结果如下：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725164203.png" alt="image-20210725164203858"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725164220.png" alt="image-20210725164220164"></p>
<ul>
<li>注意点，编译的时候的版本很阴间，总是用的是12，为了解决这个问题，我们在父工程中引入了Maven编译和运行的插件来限定语言编译的级别和版本为8：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="测试中消费者插入功能失败："><a href="#测试中消费者插入功能失败：" class="headerlink" title="测试中消费者插入功能失败："></a>测试中消费者插入功能失败：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725171613.png" alt="image-20210725171613632"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725171621.png" alt="image-20210725171559335"></p>
<ul>
<li>上传成功数据库中却没有？？？</li>
<li>因为少了@RequestBody注解嗷！！！客户端封装好的payment对象处于请求体中，再次调用服务端的功能，这个时候服务端就不是和以前一样自己从请求头中封装数据了，而是需要从请求体中获取数据，因此需要在参数前加上@RequestBody！！！好大的天坑呜呜呜。</li>
<li>service（老版本的run dashboard出不来咋办？）<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725172442.png" alt="image-20210725172442474"></li>
</ul>
<h2 id="工程重构："><a href="#工程重构：" class="headerlink" title="工程重构："></a>工程重构：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725182620.png" alt="image-20210725182619979"></p>
<ul>
<li>以上两个子工程的entities文件夹是一样哒！！！有没有什么办法将他们合并呢？ —- 工程重构（减少重复代码）</li>
<li>新建一个工程：cloud-api-commons</li>
</ul>
<p>pom中多引入一个东西：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>将相同的entities放在cloud-api-commons的相同位置上。</p>
</li>
<li><p>做好了cloud-api-commons之后，clean并且install安装到仓库中去，供其他两个工程调用。</p>
</li>
<li><p>改造80和8001：</p>
<ul>
<li>删掉entities</li>
<li>引入我们自定义的jar包：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>引入了上面的依赖之后，IDEA不再爆红，证明依赖引入成功。</p>
</li>
</ul>
<h1 id="热部署Devtools："><a href="#热部署Devtools：" class="headerlink" title="热部署Devtools："></a>热部署Devtools：</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725142522.png" alt="image-20210725142522278"></p>
<ul>
<li>devtools依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>加入父类的plugin</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725143413.png" alt="image-20210725143413525"></p>
<ul>
<li>ADBC打勾：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725144740.png" alt="image-20210725144738950"></p>
<ul>
<li>resgistry的设置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725144846.png" alt="image-20210725144846898"></p>
<p>registry中对应位置打勾设置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725145312.png" alt="image-20210725145159899"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725145255.png" alt="image-20210725145255410"></p>
<ul>
<li>设置完成之后，重启IDEA即可嗷！！！<ul>
<li>效果好像不是特别好，老方法<code>Ctrl + F9</code>也可以使用嘛！！！</li>
</ul>
</li>
<li>只能在开发的环境中使用，生产环境中不能够使用嗷！！！</li>
</ul>
<h1 id="Eureka技术："><a href="#Eureka技术：" class="headerlink" title="Eureka技术："></a>Eureka技术：</h1><ul>
<li><p>虽然停更了，但是思想还是十分重要的嗷！！！</p>
</li>
<li><p>概念：</p>
<ul>
<li>服务治理，管理服务域服务之间依赖关系</li>
<li>实现服务调用，负载均衡，容错等</li>
</ul>
</li>
<li><p>服务架构：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725210150.png" alt="image-20210725210150177"></p>
<p>Server提供服务注册服务，Client会通过注册中心进行访问。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725210810.png" alt="image-20210725210810903"></p>
<h2 id="将Eureka整合进支付模块中："><a href="#将Eureka整合进支付模块中：" class="headerlink" title="将Eureka整合进支付模块中："></a>将Eureka整合进支付模块中：</h2><ul>
<li>不同版本：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725212348.png" alt="image-20210725212348036"></p>
<ul>
<li>还是那几个步骤：<ul>
<li>新建module</li>
<li>改pom</li>
<li>application.yml</li>
<li>主启动</li>
<li>业务类</li>
</ul>
</li>
<li>pom：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-eureka-server7001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--        坐标监控的时候十分重要，这两者一般都是一起出现的嗷！！！--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        eureka相关配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>application.yml：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#false表示不向服务中心注册自己</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#false表示自己就是注册中心，负责维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">      <span class="comment">#设置域Eureka Server交互的地址查询和注册服务都需要依赖这个地址</span></span><br></pre></td></tr></table></figure>

<ul>
<li>主启动：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaMain7001</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//这是注册中心的主启动类</span></span><br><span class="line">      SpringApplication.run(EurekaMain7001.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725214319.png" alt="image-20210725214319330"></p>
<ul>
<li><p>将支付功能入驻进Eureka：</p>
<ul>
<li>引入客户端的依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        eureka相关配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>改配置：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 表示自己注册为Eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer中抓取出已有的注册信息，默认为true，单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ul>
<li>主启动：</li>
</ul>
<p>加上<code>@EnableEurekaClient</code>注解</p>
<ul>
<li>再次查看页面：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210725220616.png" alt="image-20210725220616118"></p>
</li>
<li><p>添加order模块是一样的嗷！！！只是配置上有一点不一样：</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 表示自己注册为Eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer中抓取出已有的注册信息，默认为true，单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726110811.png" alt="image-20210726110810875"></p>
<p>如果registry-with-eureka改为false，即为取消注册到Eureka。</p>
<h2 id="Eureka集群部署："><a href="#Eureka集群部署：" class="headerlink" title="Eureka集群部署："></a>Eureka集群部署：</h2><ul>
<li>集群原理：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726111815.png" alt="image-20210726111814974"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726112206.png" alt="image-20210726112206889"></p>
<ul>
<li>一个哥们要注册集群中其他所有的哥们</li>
</ul>
<h3 id="集群实操："><a href="#集群实操：" class="headerlink" title="集群实操："></a>集群实操：</h3><ul>
<li><p>新建一个cloud-eureka-server7002的module</p>
</li>
<li><p>pom依赖是完全一样的</p>
</li>
<li><p>application.yml中实现相互注册，互相守望：</p>
<ul>
<li>由于本机只有一个localhost，为了模拟集群的效果，我们要修改对应的配置文件：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726114945.png" alt="image-20210726114945368"></p>
<p>修改之后方便模拟两个不同的主机嗷！！！</p>
<ul>
<li>相互注册，互相守望：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726115338.png" alt="image-20210726115338597"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726115400.png" alt="image-20210726115400473"></p>
<ul>
<li>效果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726132634.png" alt="image-20210726132634280"></p>
</li>
</ul>
<h2 id="发布我们的服务到集群中："><a href="#发布我们的服务到集群中：" class="headerlink" title="发布我们的服务到集群中："></a>发布我们的服务到集群中：</h2><ul>
<li>代码其实不用修改，关键是要调整我们的Yaml文件</li>
<li>配置集群版：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们需要把服务部署到集群中去嗷！！！</li>
<li>测试流程：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726151832.png" alt="image-20210726151832578"></p>
<h2 id="支付服务提供者8001集群环境构建："><a href="#支付服务提供者8001集群环境构建：" class="headerlink" title="支付服务提供者8001集群环境构建："></a>支付服务提供者8001集群环境构建：</h2><ul>
<li>建立module（名字为8002）</li>
<li>修改pom（和8001POM中依赖一致即可）</li>
<li>写YML</li>
<li>主启动和业务类都是一样的嗷！！！</li>
<li>修改Controller：<ul>
<li><p>注意哈，这里对外提供的服务的名字都是一样的哈，因为yml是差不多的嘛（除了端口）</p>
</li>
<li><p>这个时候就引入了负载均衡的概念：</p>
<ul>
<li>首先先要加入对应的server.port的打印：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726151743.png" alt="image-20210726151736623"></p>
<ul>
<li>改order的原程序，不能够只访问8001端口哇，不然就没意义了，要访问集群哇！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYMENT_URL</span> <span class="operator">=</span> <span class="string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>改完还是错的，因为在这里修改了之后，默认还是调用的主机，然后这个主机和我们的eureka根本联系补上，就比较痛苦。</p>
<ul>
<li>为了让二者建立联系，我们需要配置负载均衡注解。(在Order80文件中)：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置完成之后，我们发现测试中，8001和8002可以交替提供负载，即负载分配成功嗷！！！</p>
</li>
<li><p>summary：</p>
<ul>
<li>相当于将具体的ip地址抽象为了提供的服务名，而具体由哪台机子来提供服务，则是由eureka动态负载分配来决定的嗷！！！</li>
<li>只要将eureka集群搭建好，将对应的服务端和客户端都注册好，就能够自动实现以上的功能嗷！！！</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="微服务信息完善："><a href="#微服务信息完善：" class="headerlink" title="微服务信息完善："></a>微服务信息完善：</h2><h3 id="主机名称：服务名称的修改："><a href="#主机名称：服务名称的修改：" class="headerlink" title="主机名称：服务名称的修改："></a>主机名称：服务名称的修改：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">instance:</span></span><br><span class="line">  <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br></pre></td></tr></table></figure>

<h3 id="访问信息有IP信息显示："><a href="#访问信息有IP信息显示：" class="headerlink" title="访问信息有IP信息显示："></a>访问信息有IP信息显示：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">instance:</span></span><br><span class="line">  <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">  <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>方便我们线上的debug，找到对应的主机和其端口嗷！！！</li>
</ul>
<h2 id="服务发现（Discovery）："><a href="#服务发现（Discovery）：" class="headerlink" title="服务发现（Discovery）："></a>服务发现（Discovery）：</h2><ul>
<li>本质就是一个注解标签：<code>@EnableDiscovery</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726202906.png" alt="image-20210726202905914"></p>
<ul>
<li>自动注入discoveryClient：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726204248.png" alt="image-20210726204241115"></p>
<ul>
<li>对于注入的discoveryClient的一些操作：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/payment/discovery&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">discovery</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    <span class="keyword">for</span>(String element: services)&#123;</span><br><span class="line">        log.info(<span class="string">&quot;*****element: &quot;</span>+element);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (ServiceInstance instance:instances)&#123;</span><br><span class="line">        log.info(instance.getServiceId()+<span class="string">&quot;\t&quot;</span>+instance.getHost()+<span class="string">&quot;\t&quot;</span>+instance.getPort()+<span class="string">&quot;\t&quot;</span>+instance.getUri());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.discoveryClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>主启动类多一个注解：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8001</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对于功能进行测试：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726204616.png" alt="image-20210726204616698"></p>
<ul>
<li>运行测试结果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726205047.png" alt="image-20210726205047066"></p>
<p>之所以先启动Eureka，是因为我们的Payment有一个注册的操作，因此有先后的启动顺序嗷！！！</p>
<h2 id="自我保护机制："><a href="#自我保护机制：" class="headerlink" title="自我保护机制："></a>自我保护机制：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726205241.png" alt="image-20210726205240957"></p>
<ul>
<li>一句话：某时刻某一个微服务不可用了，Eureka不会立即清理，依旧会对于该微服务的信息进行保护。CAP理论里面的AP思想。（高可用的设计思想）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726205645.png" alt="image-20210726205645312"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726210112.png" alt="image-20210726210112686"></p>
<p>宁可保留错误的服务注册信息，也不盲目注销任何可能健康的实例。</p>
<h3 id="关闭自我保护："><a href="#关闭自我保护：" class="headerlink" title="关闭自我保护："></a>关闭自我保护：</h3><ul>
<li>首先，这个实验比较麻烦，需要将集群改为单个点。将8001和7001配对使用。（切换回单例模式）</li>
</ul>
<p>7001：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726214310.png" alt="image-20210726214310817"></p>
<p>8001：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726214456.png" alt="image-20210726214455814"></p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726212728.png" alt="image-20210726212728103"></li>
<li>关闭自我保护模式需要同时修改eureka的server和client嗷！！！</li>
</ul>
<p>对于eureka服务端的添加：</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726212932.png" alt="image-20210726212932136"></li>
</ul>
<p>对于提供服务的客户端的添加：</p>
<ul>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726213623.png" alt="image-20210726213615865"></p>
</li>
<li><p>测试流程和结果：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726214118.png" alt="image-20210726214117931"></p>
<h1 id="Zookeeper技术："><a href="#Zookeeper技术：" class="headerlink" title="Zookeeper技术："></a>Zookeeper技术：</h1><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726220132.png" alt="image-20210726220132822"></p>
<p>无非就是将eureka换成了zookeeper而已哦！！！</p>
<h2 id="注册中心Zookeeper："><a href="#注册中心Zookeeper：" class="headerlink" title="注册中心Zookeeper："></a>注册中心Zookeeper：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726220251.png" alt="image-20210726220251839"></p>
<ul>
<li>zookeeper部署在3344端口上嗷！！！</li>
</ul>
<h2 id="服务提供者："><a href="#服务提供者：" class="headerlink" title="服务提供者："></a>服务提供者：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210726220819.png" alt="image-20210726220819182"></p>
<ul>
<li><p>zookeeper在linux上需要安装（配置linux服务器）：</p>
<ul>
<li>阿sir，Linux上安装还有配置防火墙啊，下载对应的Zookeeper啊（配置ZooKeeper），有点乱啊orz。</li>
<li>docker就是yyds，<a target="_blank" rel="noopener" href="https://www.cnblogs.com/caoweixiong/p/12325410.html">在自己的云服务上使用docker来安装并启用zookeeper</a>。</li>
</ul>
</li>
<li><p>配置过程：</p>
</li>
</ul>
<ol>
<li><p>新建module</p>
</li>
<li><p>pom：</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-payment8004<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        boot整合zookeeper客户端--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>主配置：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-payment</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">xxx.xxx.xxx.xxx:2181</span></span><br></pre></td></tr></table></figure>

<p>下面这个就是提供zookeeper服务的端口号</p>
<ol start="4">
<li>主启动：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8004</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">      SpringApplication.run(PaymentMain8004.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不用eureka的话，就只用上面这两个注解就行，后面和Boot应用打交道一般都是用下面这个@EnableDiscoveryClient</li>
</ul>
<ol start="5">
<li>业务类：</li>
</ol>
<ul>
<li>Controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentMain8004</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//这个就是主类</span></span><br><span class="line">      SpringApplication.run(PaymentMain8004.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果注册zookeeper不成功会报错的嗷，如果没有报错说明没啥大问题嗷，注意，教学视频中可能出现我们cloud中的jar包，不符合服务器的版本。由于docker拉取的是最新的zookeeper，我这里并没有报错嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210727175612.png" alt="image-20210727175612005"></p>
<ul>
<li><p>Jar包如果出了问题的话，就把zookeeper中默认包含的Jar给exclude排除掉，然后再引入我们需要的对应版本的jar包就可以了嗷！！！</p>
</li>
<li><p>这里回想当时学狂神的docker内容，如何在我们和docker正确建立联系之后，在docker中查询到这个节点的信息，还需要我们进一步的复习和学习嗷！！！</p>
</li>
</ul>
<h2 id="临时还是永久节点："><a href="#临时还是永久节点：" class="headerlink" title="临时还是永久节点："></a>临时还是永久节点：</h2><ul>
<li>零时的嗷！！！</li>
<li>我们发现重新启动之后，又注册上了嗷！！！硬汉风格，我检测到你我就加你，我检测不到你的心跳我直接删了你嗷！！！</li>
</ul>
<h2 id="服务消费者："><a href="#服务消费者：" class="headerlink" title="服务消费者："></a>服务消费者：</h2><ol>
<li><p>建立module</p>
</li>
<li><p>修改pom：参加上面8004服务提供者的pom。</p>
</li>
<li><p>application.yml：参加上面8004服务提供者的application.yml。</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-consumer-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">zookeeper:</span></span><br><span class="line">      <span class="attr">connect-string:</span> <span class="string">xxx.xxx.xxx.xxx:2181</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>主启动类</p>
</li>
<li><p>业务类：</p>
</li>
</ol>
<p>加入对应的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入RestTemplate，方便调用。</p>
<p>主启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderZKController</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INVOKE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://cloud-provider-payment&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/zk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(INVOKE_URL+<span class="string">&quot;/payment/zk&quot;</span>,String.class);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是对于Controller的配置。</p>
<h1 id="Consul技术："><a href="#Consul技术：" class="headerlink" title="Consul技术："></a>Consul技术：</h1><ul>
<li>简介：<ul>
<li>go语言开发的</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210804195652.png" alt="image-20210804195645580"></li>
<li><a target="_blank" rel="noopener" href="https://www.springcloud.cc/spring-cloud-consul.html">Consul的中文文档</a></li>
<li>去Consul官方网文档中下载Consul。</li>
</ul>
</li>
<li>Consul下载文件夹中对应exe文件所在的目录：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用consul --version来查看版本</span></span><br><span class="line">Consul v1.10.1</span><br><span class="line">Revision db839f18b</span><br><span class="line">Protocol 2 spoken by default, understands 2 to 3 (agent will automatically use protocol &gt;2 when speaking to compatible agents)</span><br></pre></td></tr></table></figure>



<h2 id="安装并运行Consul："><a href="#安装并运行Consul：" class="headerlink" title="安装并运行Consul："></a>安装并运行Consul：</h2><ul>
<li><code>consul agent -dev</code>可以启动consul</li>
<li>启动了consul之后，在8500端口就可以监控到consul的控制台嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210804212950.png" alt="image-20210804212943249"></p>
<h2 id="注册服务提供者："><a href="#注册服务提供者：" class="headerlink" title="注册服务提供者："></a>注册服务提供者：</h2><ol>
<li>新建module</li>
<li>POM：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-providerconsul-payment8006<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        整合web组件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        日常jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>YAML：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-provider-payment</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#consul注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p>主启动：</p>
</li>
<li><p>业务类Controller</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/payment/consul&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentConsul</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;SpringCloud with consul: &quot;</span>+serverPort+<span class="string">&quot;\t&quot;</span>+ UUID.randomUUID().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>验证测试：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210804224328.png" alt="image-20210804224328179"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210804224437.png" alt="image-20210804224437015"></p>
<h2 id="注册服务消费者："><a href="#注册服务消费者：" class="headerlink" title="注册服务消费者："></a>注册服务消费者：</h2><ol>
<li>新建module</li>
<li>POM文件配置：</li>
</ol>
<p>和上面是一样的嗷！！！</p>
<ol start="3">
<li>application.yml：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">consul-consumer-order</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#consul注册中心地址</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动：</li>
</ol>
<p>和上面是一样的嗷！！！</p>
<ol start="5">
<li>配置业务类：</li>
</ol>
<ul>
<li>添加config文件夹，加入那个操作小工具RestTemplate，用于简化返回JSON的操作嗷！！！：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderConsulController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INVOKE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://consul-provider-payment&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/consul&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(INVOKE_URL+<span class="string">&quot;/payment/consul&quot;</span>,String.class);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805170847.png" alt="image-20210805170840324"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805170904.png" alt="image-20210805170904325"></p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805171407.png" alt="image-20210805171407613"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805171442.png" alt="image-20210805171442249"></p>
<ul>
<li>思想都是差不多一样的嗷！！！</li>
<li>eureka , zookeeper , consul的本质都是一样的，服务注册中心，用法也都是一样的嗷！！！无非是创建对应的模块，注册到服务中心嗷！！！</li>
<li>CAP中，P一定要保证，因此不是AP就是CP嗷！！！</li>
<li>AP是Eureka , CP是ZooKeeper和Consul。CAP关注的是数据而不是整体的策略嗷！！！例如淘宝这种高并发的，A就很重要，你可以由于数据不一致得罪一些消费者（例如我们经常看到的，还有产品但是秒杀不到），但是绝对不允许整个网站垮了用不了。马爸爸可能会刀了你嗷！！！</li>
</ul>
<h1 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h1><ul>
<li>Ribbon是基于<strong>客户端</strong>软负载均衡的工具。</li>
<li>已经进入了维护模式，但是有强大的声明力。</li>
<li>作用：<ul>
<li><strong>LoadBalance</strong>：<ul>
<li>集中式（服务端）</li>
<li>进程内（本地，Ribbon就是属于这种，继承于消费方进程，通过它获取到服务提供方的地址嗷！！！）</li>
</ul>
</li>
<li>例如80通过轮询访问8001&#x2F;8002</li>
<li>一句话：<strong>LB + RestTemplate调用</strong></li>
</ul>
</li>
<li>开始前，先恢复我们的项目如下所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805193425.png" alt="image-20210805193418204"></p>
<ul>
<li>Ribbon逻辑架构图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805193654.png" alt="image-20210805193654507"></p>
<p>工作步骤：</p>
<ol>
<li>选择EurekaServer，优先选择负载较少的server</li>
<li>根据用户指定的策略，在server取到的服务注册列表中选择一个地址嗷！！！</li>
</ol>
<ul>
<li>问题？为啥我们之前没有引入ribbon都能够实现负载均衡？？？   —&gt;   我们引入的netflix-eureka-client中自带了ribbon了嗷！！！</li>
</ul>
<h2 id="RestTemplate的使用："><a href="#RestTemplate的使用：" class="headerlink" title="RestTemplate的使用："></a>RestTemplate的使用：</h2><ol>
<li>getForObject和getForEntity</li>
<li>postForObject和postForEntity</li>
<li>GET请求方法</li>
<li>POST请求方法</li>
</ol>
<ul>
<li>getForObject和getForEntity区别：<ul>
<li>getForObject返回的结果基本上可以理解为Json</li>
<li>getForEntity返回的结果为ResponseEntity对象，包含了响应中的一些重要的信息。</li>
</ul>
</li>
<li>postForEntity：<ul>
<li>使用方法更加复杂嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805200602.png" alt="image-20210805200601833"></li>
</ul>
</li>
<li>推荐使用ForObject直接安抚你会JSON而不是ResponseEntity嗷！！！</li>
</ul>
<h2 id="深入理解-面试常问："><a href="#深入理解-面试常问：" class="headerlink" title="深入理解+面试常问："></a>深入理解+面试常问：</h2><ul>
<li><p>负载均衡算法：</p>
<ul>
<li>轮询</li>
<li>lRule：根据特定算法从服务列表中选取一个要访问的服务。</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805204525.png" alt="image-20210805204525541"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805204613.png" alt="image-20210805204613614"></li>
</ul>
<p>默认就是轮询嗷！！！</p>
</li>
<li><p>如何替换算法：</p>
<ul>
<li>修改cloud-consumer-order80</li>
<li>配置细节</li>
<li>新建package -&gt; com.tuzi.myrule</li>
<li>上面包下新建MySelfRule规则类</li>
<li>主启动类添加@RibbonClient</li>
<li>测试</li>
</ul>
</li>
<li><p>替换细节：</p>
<ul>
<li>配置细节如下所示：<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805205006.png" alt="image-20210805205006582"></li>
</ul>
<p>ComponentScan这个注解在SpringBootApplication这个注解的下面嗷！！！</p>
<p>因此需要放在com.tuzi.cloud这个包的外面嗷！！！</p>
<ul>
<li><p>新建包以及MySelfRule内容如下：<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805205412.png" alt="image-20210805205412865"></p>
</li>
<li><p>&#96;&#96;&#96;java<br>@SpringBootApplication<br>@EnableEurekaClient<br>@RibbonClient(name &#x3D; “CLOUD-PAYMENT-SERVICE”,configuration &#x3D; MySelfRule.class)<br>public class OrderMain80<br>{<br>  public static void main(String[] args) {<br>  &#x2F;&#x2F;主启动类配置<br>  SpringApplication.run(OrderMain80.class,args);<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line">    - 测试结果就很棒！！！</span><br><span class="line">  </span><br><span class="line">- 负载均衡算法深入理解：</span><br><span class="line"></span><br><span class="line">  - 轮询原理：</span><br><span class="line">    - ![image-20210805210333357](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805210333.png)</span><br><span class="line">    - ![image-20210805210305221](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210805210305.png)</span><br><span class="line">    - 轮询重启的话，重新从1开始嗷！！！</span><br><span class="line">    </span><br><span class="line">  - 轮询算法源码解析：</span><br><span class="line">    - Ctrl + Alt + B可以查看IRULE这个接口的实现类嗷！！！</span><br><span class="line">    - 然后可以查看轮询算法的源码，重点在于choose方法这个部分嗷！！！</span><br><span class="line">    </span><br><span class="line">  - 手写负载算法：</span><br><span class="line"></span><br><span class="line">    - 原理+JUC（CAS+自旋锁的复习）</span><br><span class="line">    - ![image-20210806093635672](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806093642.png)</span><br><span class="line">    - 改造：</span><br><span class="line"></span><br><span class="line">    Controller中多加入一个功能嗷！！！</span><br><span class="line"></span><br><span class="line">    ```java</span><br><span class="line">    @GetMapping(value = &quot;/payment/lb&quot;)</span><br><span class="line">    public String getPaymentLB()&#123;</span><br><span class="line">        return serverPort;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>80订单微服务改造：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806095702.png" alt="image-20210806095701845"></p>
<ol>
<li>去掉**@LoadBalanced**，这个就是加入的那个配置类，去掉LoadBalancer，不使用默认的。</li>
<li><strong>LoadBalancer接口</strong>：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoadBalancer</span></span><br><span class="line">&#123;</span><br><span class="line">    ServiceInstance <span class="title function_">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>MyLB</strong>：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLB</span> <span class="keyword">implements</span> <span class="title class_">LoadBalancer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> current;</span><br><span class="line">        <span class="type">int</span> next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            current = <span class="built_in">this</span>.atomicInteger.get();</span><br><span class="line">            next = current &gt;= <span class="number">2147483647</span> ? <span class="number">0</span> : current + <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">while</span>(!<span class="built_in">this</span>.atomicInteger.compareAndSet(current,next));</span><br><span class="line">        System.out.println(<span class="string">&quot;*****第几次访问，次数next: &quot;</span>+next);</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServiceInstance <span class="title function_">instances</span><span class="params">(List&lt;ServiceInstance&gt; serviceInstances)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> getAndIncrement() % serviceInstances.size();</span><br><span class="line">        <span class="keyword">return</span> serviceInstances.get(index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>OrderController</strong>：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//    public static final String PAYMENT_URL = &quot;http://localhost:8001&quot;;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYMENT_URL</span> <span class="operator">=</span> <span class="string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancer loadBalancer;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">create</span><span class="params">(Payment payment)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.postForObject(PAYMENT_URL+<span class="string">&quot;/payment/create&quot;</span>,payment,CommonResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">long</span> id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(PAYMENT_URL+<span class="string">&quot;/payment/get/&quot;</span>+id,CommonResult.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/getForEntity/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPayment2</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">long</span> id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ResponseEntity&lt;CommonResult&gt; entity = restTemplate.getForEntity(PAYMENT_URL+<span class="string">&quot;/payment/get/&quot;</span>+id,CommonResult.class);</span><br><span class="line">        <span class="keyword">if</span> (entity.getStatusCode().is2xxSuccessful())&#123;</span><br><span class="line">            <span class="keyword">return</span> entity.getBody();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>&lt;&gt;(<span class="number">444</span>,<span class="string">&quot;操作失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/lb&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPaymentLB</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(instances == <span class="literal">null</span> || instances.size() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> loadBalancer.instances(instances);</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> serviceInstance.getUri();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(uri+<span class="string">&quot;/payment/lb&quot;</span>,String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806113351.png" alt="image-20210806113351561"></p>
</li>
</ul>
</li>
</ul>
<h1 id="OpenFeign服务调用："><a href="#OpenFeign服务调用：" class="headerlink" title="OpenFeign服务调用："></a>OpenFeign服务调用：</h1><ul>
<li>让编写<strong>客户端</strong>更加容易嗷！！！只需要创建一个接口上添加注解锁。Ribbon+RestTemplate -&gt; 封装为Feign。简化了使用Ribbon的时候，客户端。</li>
<li>Feign对于服务端的接口和客户端的接口进行一对一绑定。创建一个微服务接口，并在接口上添加注解即可。（微服务调用接口+@FeignClient）</li>
</ul>
<h2 id="使用步骤："><a href="#使用步骤：" class="headerlink" title="使用步骤："></a>使用步骤：</h2><ol>
<li><p>新建Module</p>
</li>
<li><p>POM</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-consumer-feign-order80<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        整合web组件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        日常jar包配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>application.yml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeign80</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">  		SpringApplication.run(OrderFeign80.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>业务类</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806125041.png" alt="image-20210806125041185"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806131806.png" alt="image-20210806131806776"></p>
<ul>
<li>需要一个service：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PAYMENT-SERVICE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/get/&#123;id&#125;&quot;)</span> <span class="comment">//这个方法是服务端拥有的，我们通过@FeignClient将其对应起来。</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>控制台Controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806132254.png" alt="image-20210806132254785"></p>
<p>相当于自己定义的接口，加上Feign之后，指定了对应服务的方法嗷！！！</p>
<ol start="6">
<li>测试</li>
</ol>
<p>总结：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806133000.png" alt="image-20210806132959659"></p>
<ul>
<li>原来用RestTemplate进行调用，和我们的编程习惯不太一样。我们习惯于使用xxxController调用xxxService，feign相当于在客户端定义了服务端提供的服务的方法，供客户端调用嗷！！！</li>
</ul>
<h2 id="超时控制："><a href="#超时控制：" class="headerlink" title="超时控制："></a>超时控制：</h2><ul>
<li><p>服务端加上对应的sleep方法</p>
</li>
<li><p>客户端去调用服务端的方法，注意，feign默认的超时设置是1秒钟嗷！！！如果客户端一秒钟之后没有返回结果就会报错嗷！！！</p>
</li>
<li><p>设置Feign客户端的超时时间：</p>
<ul>
<li><p>本质是由底层的ribbon来进行设置的嗷！！！</p>
</li>
<li><p>&#96;&#96;&#96;yaml<br>ribbon:<br>  ReadTimeout: 5000<br>  ConnectTimeout: 5000</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">  - 上面这个一个是连接的超时设置，还有一个是建立连接后读取资源的超时设置嗷！！！！</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 日志打印功能：</span><br><span class="line"></span><br><span class="line">![image-20210806175818714](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806175825.png)</span><br><span class="line"></span><br><span class="line">- 需要一个配置的日志Bean：</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">package com.tuzi.cloud.config;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class FeignConfig</span><br><span class="line">&#123;</span><br><span class="line">    @Bean</span><br><span class="line">    Logger.Level feignLoggerLevel()&#123;</span><br><span class="line">        return Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Yaml文件中开启日志的Feign客户端：</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.tuzi.cloud.service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>



<h1 id="Hystrix服务降级："><a href="#Hystrix服务降级：" class="headerlink" title="Hystrix服务降级："></a>Hystrix服务降级：</h1><ul>
<li>服务熔断的理念：避免整个服务的雪崩嗷！！！</li>
<li>作用：<ul>
<li>服务降级</li>
<li>服务熔断</li>
<li>接近实时的监控</li>
<li>…</li>
</ul>
</li>
<li>停更了已经</li>
</ul>
<h2 id="重要概念："><a href="#重要概念：" class="headerlink" title="重要概念："></a>重要概念：</h2><ul>
<li><p>服务降级：</p>
<ul>
<li>fallback</li>
<li>假设对方系统不可以用了，需要兜底的方式来进行处理。例如：卡死了，给一个友好提示，例如：出问题了，请稍后再试</li>
<li>出现情况：<ul>
<li>程序运行异常</li>
<li>超时</li>
<li>服务熔断除法服务降级</li>
<li>线程池&#x2F;信号量打满</li>
</ul>
</li>
<li>服务的降级 -&gt; 服务的熔断 -&gt; 恢复调用链路</li>
</ul>
</li>
<li><p>服务熔断：</p>
<ul>
<li>break</li>
<li>就像家里的保险丝，会跳闸的</li>
<li>类似于服务达到最大访问量了，这个使用它会自动调用服务降级的方法并返回友好提示。</li>
</ul>
</li>
<li><p>服务限流：</p>
<ul>
<li>flowlimit</li>
<li>秒杀等高并发的操作，严禁一窝蜂的拥挤，大家排队一个N个，这样来嗷！！！服务器的保安。</li>
</ul>
</li>
</ul>
<h2 id="案例编码："><a href="#案例编码：" class="headerlink" title="案例编码："></a>案例编码：</h2><ul>
<li>用于处理分布式系统的延迟和容错的开源库，许多依赖不可避免会调用失败，提高分布式系统的弹性。</li>
<li>断路器本身是一种开关装置，某个服务单元故障之后，通过断路器的故障监控，返回一个符合预期的，可处理的备选响应，而不是长时间的等待或者抛出调用方无法处理的异常。</li>
</ul>
<h3 id="构建平台："><a href="#构建平台：" class="headerlink" title="构建平台："></a>构建平台：</h3><ul>
<li>这里我们不使用eureka集群了，将7001的application.yml中的相应配置指向自己。使用7001 , 8001 , 8002 , 80</li>
</ul>
<h3 id="步骤（8001）："><a href="#步骤（8001）：" class="headerlink" title="步骤（8001）："></a>步骤（8001）：</h3><ol>
<li>新建module:</li>
</ol>
<p>cloud-provider-hystrix-payment8001</p>
<ol start="2">
<li>pom.xml：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-provider-hystrix-payment8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--  hystrix  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        坐标监控的时候十分重要，这两者一般都是一起出现的嗷！！！--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        下面是数据库--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        mysql-connector-java--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        jdbc--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--        eureka相关配置--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>application.yml：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-hystrix-payment</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意一下哈，如果这里使用集群的话，这里的defaultZone对应的内容应该是集群中的每一个服务器嗷！！！</li>
</ul>
<ol start="4">
<li>主启动：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentHystrixMain8001</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">      SpringApplication.run(PaymentHystrixMain8001.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="5">
<li>业务类：</li>
</ol>
<ul>
<li>service方法（为了简洁，这里没有采用定义接口，写实现类的方式嗷！！！）：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//正常访问，肯定OK</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池： &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;paymentInfo_OK , id： &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(n_n)O哈哈~&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//睡3秒，</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">timeNumber</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池： &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;paymentInfo_OK , id： &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(n_n)O哈哈~&quot;</span>+<span class="string">&quot; 耗时(秒钟)： &quot;</span>+timeNumber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentInfo_OK(id);</span><br><span class="line">        log.info(<span class="string">&quot;*****result: &quot;</span>+result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentInfo_TimeOut(id);</span><br><span class="line">        log.info(<span class="string">&quot;*****result: &quot;</span>+result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>以上述为平台，从正确 -&gt; 错误 -&gt; 降级熔断 -&gt; 恢复</li>
</ul>
<h2 id="JMeter压力测试："><a href="#JMeter压力测试：" class="headerlink" title="JMeter压力测试："></a>JMeter压力测试：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806202844.png" alt="image-20210806202843820"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806202901.png" alt="image-20210806202901697"></p>
<ul>
<li>高并发会导致ok被timeout拖慢了orz，就很大问题嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210806203222.png" alt="image-20210806203222602"></p>
<ul>
<li>这就演示了高并发情况下，系统的处理能力变弱，甚至可能直接卡死的情况嗷！！！</li>
</ul>
<h3 id="80加入（80）："><a href="#80加入（80）：" class="headerlink" title="80加入（80）："></a>80加入（80）：</h3><ol>
<li><p>新建module</p>
</li>
<li><p>pom.xml</p>
</li>
<li><p>application.yml</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderHystrixMain80</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//主启动类</span></span><br><span class="line">      SpringApplication.run(OrderHystrixMain80.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>业务类：</li>
</ol>
<ul>
<li>这里也使用了Feign，需要编写对应的Service：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentHytrixService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>我们编写对应的Controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderHystrixController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentHytrixService paymentHytrixService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentHytrixService.paymentInfo_OK(id);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentHytrixService.paymentInfo_TimeOut(id);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>压测，太难了呜呜，更加慢了。这个时候，可以从客户端和服务端两方面来解决问题嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807083808.png" alt="image-20210807083807531"></p>
<ul>
<li><p>解决的要求：</p>
<ul>
<li>超时导致服务器变慢（转圈） -&gt; 超时不再等待</li>
<li>出错（宕机或程序运行出错） -&gt; 出错要有兜底</li>
<li>解决：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807083946.png" alt="image-20210807083945884"></p>
</li>
</ul>
<h2 id="服务降级（fallback）："><a href="#服务降级（fallback）：" class="headerlink" title="服务降级（fallback）："></a>服务降级（fallback）：</h2><ul>
<li>降级的配置：<ul>
<li>@HystrixCommand</li>
<li>8001自身：设置超时时间的峰值，峰值内可以正常运行。超时了的话需要有兜底的方法处理，作服务降级fallback。</li>
</ul>
</li>
</ul>
<h3 id="8001的服务降级："><a href="#8001的服务降级：" class="headerlink" title="8001的服务降级："></a>8001的服务降级：</h3><p>对于Service的修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//下面是服务降级嗷！！！</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeOutHandler&quot; , commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span> <span class="comment">//确定了服务正常的时间是3秒钟，3秒如果过了（超时错误），就采用paymentInfo_TimeOutHandler兜底</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">timeNumber</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;线程池： &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;paymentInfo_TimeOut , id： &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(n_n)O哈哈~&quot;</span> + <span class="string">&quot; 耗时(秒钟)： &quot;</span>+timeNumber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOutHandler</span><span class="params">(Integer id)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;线程池： &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;paymentInfo_TimeOutHandler , id： &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(QAQ)O服务失败了呜呜~&quot;</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主启动类对于这个注解的激活：</p>
<p>主启动类添加@EnableCircuitBreaker注解嗷！！！</p>
<ul>
<li>测试：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807085709.png" alt="image-20210807085709345"></p>
<ul>
<li>结论：<ul>
<li>那如果例如10&#x2F;0这种异常，能不能够处理呢？结论是能够处理的嗷！！！</li>
<li>服务只要不可用了，兜底方案都是paymentInfo_TimeOutHandler。后面的Properties无非是加入了一些条件限制而已嗷！！！</li>
<li>实际上就是我们对于两种错误：限时控制和出错处理，都能够找到兜底的解决方案。实际上是8001对于自身服务器的一种保护机制。</li>
</ul>
</li>
</ul>
<h3 id="80的服务降级："><a href="#80的服务降级：" class="headerlink" title="80的服务降级："></a>80的服务降级：</h3><ul>
<li>客户端对于自己的保护，既可以放在客户端，也可以放在服务端。一般常用于客户端。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807090720.png" alt="image-20210807090720815"></p>
<ul>
<li><p>步骤：</p>
<ul>
<li>&#96;&#96;&#96;yaml<br>feign:<br>  hystrix:<br>enabled: true<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 主启动加上`@EnableHystrix`</span><br><span class="line">- 和8001一样的，在Service中，写上兜底的方法嗷！！！</span><br><span class="line">- 修改Controller：</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span><br><span class="line">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeOutHandler&quot; , commandProperties = &#123;</span><br><span class="line">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;1500&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">public String paymentInfo_TimeOut(Integer id)</span><br><span class="line">&#123;</span><br><span class="line">    String result = paymentHytrixService.paymentInfo_TimeOut(id);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public String paymentInfo_TimeOutHandler(Integer id)</span><br><span class="line">&#123;</span><br><span class="line">    return &quot;我是消费者80，支付系统繁忙嗷，请稍后再试呢~&quot; ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="上述处理过程问题："><a href="#上述处理过程问题：" class="headerlink" title="上述处理过程问题："></a>上述处理过程问题：</h3><ol>
<li>业务逻辑方法和兜底方法混在一起，每个业务方法对应一个兜底的方法，代码膨胀。</li>
<li>同一定义和自定义的代码分开（有没有全局的处理方法呢？）</li>
</ol>
<h3 id="代码膨胀问题："><a href="#代码膨胀问题：" class="headerlink" title="代码膨胀问题："></a>代码膨胀问题：</h3><ul>
<li><p><code>@DefaultProperties(defaultFallback=&quot;&quot;)</code></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807102038.png" alt="image-20210807102038131"></p>
</li>
<li><p>把通用的方法标注在最外面，通用的和独享的分开。</p>
</li>
<li><p>注意哈，@HystrixCommand还是要有的嗷！！！如果没有那就是不兜底！！！有@HystrixCommand的情况下，如果不指定就是用默认，如果指定就是用指定的嗷！！！</p>
</li>
</ul>
<h3 id="代码混乱问题："><a href="#代码混乱问题：" class="headerlink" title="代码混乱问题："></a>代码混乱问题：</h3><ul>
<li><p>抓主要矛盾，由于方法处于Controller（客户端）中，导致处理方法和业务方法混杂在一起。我们发现，Controller中实际调用的Service方法，都来自于Service接口，因此我们要看看Service接口有没有什么可以操作的嗷！！！</p>
</li>
<li><p>最狠的情况：调用服务的时候，服务端关闭或者宕机了。服务的降级处理这时候和服务端没有任何关系，都是在客户端完成的嗷！！！</p>
</li>
<li><p>解决方法：定义降级处理的实现类就可以实现解耦嗷！！！相当于把我们的业务方法和兜底方法给区分开为两个类，这样就很清晰哇！！！</p>
</li>
<li><p>解决方法：</p>
<ul>
<li>定义降级处理的实现Service抽象类，专门用于实现降级处理：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title class_">PaymentHytrixService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----PaymentFallbackService fall back paymentInfo_OK&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-----PaymentFallbackService fall back paymentInfo_TimeOut&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yaml：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接口上配置上这个类嗷：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot; , fallback = PaymentFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentHytrixService</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这个时候如果服务端裂开了，也就是CLOUD-PAYMENT-HYSTRIX-PAYMENT裂开了，ok这个时候没有注解，也没有做任何处理，这个时候默认会调用我们的兜底类中的方法进行处理嗷！！</li>
</ul>
</li>
</ul>
<h2 id="服务熔断（break）："><a href="#服务熔断（break）：" class="headerlink" title="服务熔断（break）："></a>服务熔断（break）：</h2><ul>
<li>保险丝，出现问题及时报错。服务调用正常之后，恢复调用链路。</li>
<li>还是<code>@HystrixCommand</code>，连续多次调用失败之后，就有会熔断。<strong>调用响应正常之后，可以自动恢复链路嗷。</strong></li>
</ul>
<h3 id="实操："><a href="#实操：" class="headerlink" title="实操："></a>实操：</h3><ul>
<li>8001的PaymentService的修改嗷：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//=====服务熔断</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;),//是否开启断路器</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),//请求次数</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;),//时间窗口期</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;),//失败率达到多少后跳闸</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;******id 不能为负数嗷&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">serialNumber</span> <span class="operator">=</span> IdUtil.simpleUUID();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Thread.currentThread().getName() + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;调用成功！！！流水号： &quot;</span> + serialNumber;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker_fallback</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;id不能够为负数，请稍后再试。/(ToT)/~~   id： &quot;</span> + id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Controller添加熔断相关的测试内容：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//====服务熔断</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/circuit/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentCircuitBreaker(id);</span><br><span class="line">    log.info(<span class="string">&quot;****result: &quot;</span>+result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试后发现：<ul>
<li>如果狂点负数，那后面就算有正数，也用不了。要一段时间之后，才能慢慢恢复。</li>
<li>这就是断路器跳闸了，不可以用了，慢慢才可以使用嗷！！！Open -&gt; Half Open -&gt; Close</li>
</ul>
</li>
</ul>
<h3 id="总结：-1"><a href="#总结：-1" class="headerlink" title="总结："></a>总结：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807120021.png" alt="image-20210807120020749"></p>
<ul>
<li>断路器三个重要参数：<ul>
<li>快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，统计的时间范围是快照时间窗，默认是最近的10s。</li>
<li>请求总数阈值：快照时间内，必须满足请求总数阈值才有资格熔断。默认为20，意味着在10s内，如果该hystrix命令调用次数不足20次。即使所有的请求都超时或其他原因失败，断路器都不会打开。</li>
<li>错误百分比阈值：当请求总数在快照窗口内超过了阈值，比如发生了30此调用，如果在这30此调用中，有15次发生了超时异常，也就是50%的错误百分比，在默认设定50%阈值的情况下，这时候就会将断路器打开嗷！！！</li>
</ul>
</li>
<li>断路器开始或结束的条件：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807155625.png" alt="image-20210807155624797"></p>
<ul>
<li>一些小问题：<ul>
<li>再有请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback，通过断路器，实现了自动发现错误并将降级逻辑切换为主逻辑，减少响应延迟的效果。</li>
<li>原来的主逻辑如何恢复呢？熔断之后，会有一个休眠时间窗，这个时间段内，降级逻辑是临时的成为了主逻辑。当休眠时间窗到期，断路器进入半开状态，释放一次请求到原来的主逻辑上。如果这次请求正常返回，那么断路器会继续闭合，主逻辑恢复。如果请求依然有问题，断路器会继续进入打开状态，休眠窗口重新计时。</li>
<li>还有很多花活，看Properties里面啊之类的，或者百度，都可以看到服务熔断相关的其他一些属性嗷！！！</li>
</ul>
</li>
</ul>
<h2 id="服务限流（FlowLimit）："><a href="#服务限流（FlowLimit）：" class="headerlink" title="服务限流（FlowLimit）："></a>服务限流（FlowLimit）：</h2><ul>
<li>后续讲alibaba的Sentinel的时候说明。</li>
</ul>
<h2 id="工作流程："><a href="#工作流程：" class="headerlink" title="工作流程："></a>工作流程：</h2><ul>
<li>hystrix官网中有讲嗷！！！</li>
<li>还挺复杂的，可以上github官网去康康嗷，原理倒不是很难，就是有一点点复杂嗷！！！</li>
</ul>
<h2 id="Hystrix-Dashboard："><a href="#Hystrix-Dashboard：" class="headerlink" title="Hystrix Dashboard："></a>Hystrix Dashboard：</h2><ol>
<li>新建module</li>
<li>POM</li>
<li>application.yml：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: <span class="number">9001</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixDashboardMain9001</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">      SpringApplication.run(HystrixDashboardMain9001.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>直接让hystrix跑起来，访问localhost:9001&#x2F;hystrix就能够访问到Dashboard页面：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807162455.png" alt="image-20210807162455359"></p>
<p>监控的前提是我们必须配置了actuator才行嗷（Dashboard和你监控的对象都需要嗷！）！！！</p>
<ol start="6">
<li>具体监控配置实例（以监控8001为例子嗷！！！）：</li>
</ol>
<ul>
<li><p>actuator一定要有嗷！！！</p>
</li>
<li><p>大坑：需要对应的配置：</p>
<ul>
<li>主启动类中，对于服务监控的配置，是Cloud升级之后遇到的坑。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentHystrixMain8001</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">  SpringApplication.run(PaymentHystrixMain8001.class, args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> ServletRegistrationBean <span class="title function_">getServlet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">HystrixMetricsStreamServlet</span> <span class="variable">streamServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HystrixMetricsStreamServlet</span>();</span><br><span class="line">    <span class="type">ServletRegistrationBean</span> <span class="variable">registrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>(streamServlet);</span><br><span class="line">    registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    registrationBean.addUrlMappings(<span class="string">&quot;/hystrix.stream&quot;</span>);</span><br><span class="line">    registrationBean.setName(<span class="string">&quot;HystrixMetricsStreamServlet&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类上要加上注解：<code>@EnableCircuitBreaker</code></p>
</li>
</ul>
<ol start="7">
<li>监控：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807163345.png" alt="image-20210807163345145"></p>
<ul>
<li>9001监控8001的地址为：<code>http://localhost:8001/hystrix.stream</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807163542.png" alt="image-20210807163542137"></p>
<ul>
<li>监控图表的查看：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807164355.png" alt="image-20210807164355392"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807164601.png" alt="image-20210807164601475"></p>
<h1 id="Gateway网关："><a href="#Gateway网关：" class="headerlink" title="Gateway网关："></a>Gateway网关：</h1><ul>
<li>一般的企业架构：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807170139.png" alt="image-20210807170138920"></p>
<ul>
<li>gateway最牛逼牛逼在异步非阻塞嗷！！！</li>
<li>三大核心概念：<ul>
<li>路由</li>
<li>断言</li>
<li>过滤</li>
</ul>
</li>
</ul>
<h2 id="实践："><a href="#实践：" class="headerlink" title="实践："></a>实践：</h2><ol>
<li>新建module</li>
<li>POM：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-gateway-gateway9527<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这里是大坑啊兄弟！！！这里由于gateway是基于webflux而不是mvc架构的，要移除webmvc相关的依赖。这里注意，这里的api-commons里面是带有mvc的，还有额外将其移除掉才能够正常启动嗷！！！</li>
</ul>
<ol start="3">
<li>application.yml：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GateWayMain9527</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//主启动类</span></span><br><span class="line">      SpringApplication.run(GateWayMain9527.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>网关配置：</li>
</ol>
<ul>
<li>例如和我们计算机网络学的一样，我们不想暴露8001端口，我们希望在8001外面套上一层9527。</li>
<li>application中做额外的配置嗷！！！</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span>   <span class="comment">#payment_routes</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span>   <span class="comment">#payment_routes</span></span><br><span class="line">            <span class="attr">uri:</span> <span class="string">http://localhost:8001</span></span><br><span class="line">            <span class="attr">predicates:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807194157.png" alt="image-20210807194157012"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807201233.png" alt="image-20210807201233727"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807201425.png" alt="image-20210807201425312"></p>
<p>9527现在也能够访问微服务端口了嗷！！！</p>
<ul>
<li><p>网关配置的两种方法：</p>
<ul>
<li>yml配置</li>
<li>通过@Bean添加组件配置</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210807201616.png" alt="image-20210807201616154"></p>
</li>
</ul>
<p>配置类编写的实例：</p>
<p>例如通过9527去访问百度新闻等：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GateWayConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouteLocator <span class="title function_">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span>&#123;</span><br><span class="line">        RouteLocatorBuilder.<span class="type">Builder</span> <span class="variable">routes</span> <span class="operator">=</span> builder.routes();</span><br><span class="line">        routes.route(<span class="string">&quot;path_route_tuzi&quot;</span>,</span><br><span class="line">                r -&gt; r.path(<span class="string">&quot;/guonei&quot;</span>).uri(<span class="string">&quot;http://news.baidu.com/guonei&quot;</span>)).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> routes.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>新建config包，并且在里面添加配置类。</li>
</ul>
<h2 id="网关实现负载均衡："><a href="#网关实现负载均衡：" class="headerlink" title="网关实现负载均衡："></a>网关实现负载均衡：</h2><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808085404.png" alt="image-20210808085404686"></p>
<ul>
<li>从网关处实现负载均衡。</li>
<li>环境：7001+8001+8002</li>
<li>操作：对于application.yml的配置：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>    <span class="comment">#开启从服务中心动态创建路由的功能，利用微服务名进行路由</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span>   <span class="comment">#payment_routes</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span>   <span class="comment">#payment_routes</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面这样就可以实现负载均衡了嗷！！！</li>
</ul>
<h2 id="RoutePredicateFactory："><a href="#RoutePredicateFactory：" class="headerlink" title="RoutePredicateFactory："></a>RoutePredicateFactory：</h2><ul>
<li><p>常用：</p>
<ul>
<li><p>After Route Predicate：</p>
<ul>
<li>得到当前时间：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808092352.png" alt="image-20210808092351159"></p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808092513.png" alt="image-20210808092512971"></li>
</ul>
<p>在某个时间结点之后，才能够正常访问，网管？？？</p>
</li>
<li><p>Before Route Predicate</p>
</li>
<li><p>Between Route Predicate</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808092748.png" alt="image-20210808092747828"></p>
<p>上面两个和After一样的，在某个时间结点之前和在两个时间结点之间嗷！！！</p>
<ul>
<li><p>Cookie Route Predicate：</p>
<ul>
<li>调试常用：<ul>
<li>jmeter</li>
<li>postman</li>
<li>curl：<ul>
<li>命令行就可以使用</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808093422.png" alt="image-20210808093421928"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808094410.png"></li>
<li>可以通过–cookie这种方式来用curl带上cookie访问，十分方便嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808095207.png" alt="image-20210808095207417"></li>
<li>可以通过-H这种方式来用curl带上Header访问，十分方便嗷！！！</li>
</ul>
</li>
</ul>
</li>
<li><code>- Cookie=key,value</code></li>
<li>可以限制符合条件的Cookie访问嗷！！！</li>
</ul>
</li>
<li><p>Header Route Predicate：</p>
<ul>
<li><code>- Header=X-Request-Id, \d+</code></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808095803.png" alt="image-20210808095802974"></li>
</ul>
</li>
<li><p>Host Route Predicate：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808095923.png" alt="image-20210808095923720"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808100056.png" alt="image-20210808100056575"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808100140.png" alt="image-20210808100140548"></p>
<ul>
<li>Method Route Predicate：</li>
</ul>
<p><code>- Method=GET</code></p>
<ul>
<li>Path Route Predicate</li>
</ul>
<p><code>- Path=/payment/lb/**</code></p>
<ul>
<li>Query Route Predicate</li>
</ul>
<p>带有参数条件的，这个就是有对于参数的匹配嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808100321.png" alt="image-20210808100320887"></p>
</li>
</ul>
<h2 id="Filter："><a href="#Filter：" class="headerlink" title="Filter："></a>Filter：</h2><ul>
<li>生命周期：pre , post</li>
<li>种类：GatewayFilter , GlobalFilter</li>
</ul>
<h3 id="自定义Filter："><a href="#自定义Filter：" class="headerlink" title="自定义Filter："></a>自定义Filter：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.cloud.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogGatewayFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;*********come in MyLogGatewayFilter&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">String</span> <span class="variable">uname</span> <span class="operator">=</span> exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(uname == <span class="literal">null</span>)&#123;</span><br><span class="line">            log.info(<span class="string">&quot;你就是奸细？？？？？&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>order是用来控制顺序的嗷！！！这里就是判断有木有uname，如果没有为null的话就会报错。如果有的话，就往下走。（非常像是request和response嗷！！！）</li>
<li>7001 + 8001 + 8002 + 9527测试：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808104838.png" alt="image-20210808104831639"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808104845.png" alt="image-20210808104845632"></p>
<ul>
<li>自定义全局才是最常用的嗷！！！</li>
</ul>
<h1 id="Config分布式配置中心："><a href="#Config分布式配置中心：" class="headerlink" title="Config分布式配置中心："></a>Config分布式配置中心：</h1><ul>
<li>随着项目增多，配置(application)越来越多，需要一套集中式的，动态的配置中心。</li>
<li>提供集中化的外部配置支持，配置服务器为多个不同微服务应用的所有中心化的<strong>外部配置</strong>。（类似于git和github）。提取出公有的配置信息放在共享的外部配置嗷！！！（例如Mysql的配置）</li>
<li>需要服务端和客户端两个部分来使用嗷！！！</li>
<li>能干吗？</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808105627.png" alt="image-20210808105626921"></p>
<ul>
<li>与github和git整合配置嗷！</li>
<li>原理图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809162116.png" alt="image-20210809162116676"></p>
<h2 id="Config服务端配置："><a href="#Config服务端配置：" class="headerlink" title="Config服务端配置："></a>Config服务端配置：</h2><ol>
<li>github上新建一个springcloud-config仓库，并且拉到本机D盘的springcloud-config文件夹</li>
<li>项目中新建Module3344</li>
<li>pom.xml：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-config-center-3344<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>application.yml</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-center</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">******</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">******</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">用官网给的https的那个嗷！！！</span></span><br><span class="line">          <span class="attr">skip-ssl-validation:</span> <span class="literal">true</span></span><br><span class="line">          <span class="comment">####搜索目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">springcloud-config</span></span><br><span class="line">        <span class="comment">####读取分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#spring:</span></span><br><span class="line"><span class="comment">#  application:</span></span><br><span class="line"><span class="comment">#    name: cloud-config-center</span></span><br><span class="line"><span class="comment">#  cloud:</span></span><br><span class="line"><span class="comment">#    config:</span></span><br><span class="line"><span class="comment">#      server:</span></span><br><span class="line"><span class="comment">#        git:</span></span><br><span class="line"><span class="comment">#          uri: 用官网给的https的那个嗷！！！</span></span><br><span class="line"><span class="comment">#          skip-ssl-validation: true</span></span><br><span class="line"><span class="comment">#          ####搜索目录</span></span><br><span class="line"><span class="comment">#          search-paths:</span></span><br><span class="line"><span class="comment">#            - springcloud-config</span></span><br><span class="line"><span class="comment">#          username: ******</span></span><br><span class="line"><span class="comment">#          password: ******</span></span><br><span class="line"><span class="comment">#        ####读取分支</span></span><br><span class="line"><span class="comment">#      label: master</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#服务注册到eureka地址</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>主启动：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainAppConfigCenter3344</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">      SpringApplication.run(MainAppConfigCenter3344.class,args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>本机host增加映射：</li>
</ol>
<p><code>127.0.0.1    config-3344.com</code></p>
<ol start="7">
<li>测试通过config微服务是否可以从github上获取配置内容：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808154208.png" alt="image-20210808154200972"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808154842.png" alt="image-20210808154842200"></p>
<ul>
<li>获取某个分支的内容：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808154737.png" alt="image-20210808154736784"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808154912.png" alt="image-20210808154912451"></p>
<ul>
<li><p>上面这一种默认读出来就是master&#x2F;main分支的内容嗷！！！说白了，默认的就是master&#x2F;main分支，可以通过label去配置嗷！！！</p>
</li>
<li><p>如果访问的资源文件不存的话，返回的就是空啊或其他一些奇奇怪怪的东西嗷！！！</p>
</li>
<li><p>顺着读取和逆着读取结果不一样嗷，如下所示：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808155213.png" alt="image-20210808155213113"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808155248.png" alt="image-20210808155248407"></p>
<p>推荐还是下面这一种嗷！！！</p>
<h2 id="Config客户端配置："><a href="#Config客户端配置：" class="headerlink" title="Config客户端配置："></a>Config客户端配置：</h2><ul>
<li><p>命名规则最好就是符合，config-prod.yml这种形式来哈！！！</p>
</li>
<li><p>创建过程：</p>
<ol>
<li><p>新建module</p>
</li>
<li><p>pom：</p>
<ul>
<li><p>注解和3344基本一样嗷！！！</p>
</li>
<li><p>&#96;&#96;&#96;xml</p>
<?xml version="1.0" encoding="UTF-8"?>
<p><project xmlns="http://maven.apache.org/POM/4.0.0"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"><br><parent><br><artifactId>cloud</artifactId><br>    <groupId>com.atguigu.springcloud</groupId><br>  <version>1.0-SNAPSHOT</version><br></parent><br>  <modelVersion>4.0.0</modelVersion></p>
<pre><code>&lt;artifactId&gt;cloud-config-client-3355&lt;/artifactId&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;
        &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;optional&gt;true&lt;/optional&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;optional&gt;true&lt;/optional&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
        &lt;version&gt;3.0.0&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
</project>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">     </span><br><span class="line">   - 上面这个依赖不是server啦，其他都是一样的嗷！！！</span><br><span class="line"></span><br><span class="line">3. yaml文件：</span><br><span class="line"></span><br><span class="line">![image-20210808161052589](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808161053.png)</span><br><span class="line"></span><br><span class="line">这里遇到了一个非常大的坑，bookstrap.yml被IDEA识别不到。该怎么办：</span><br><span class="line"></span><br><span class="line">![image-20210808174249486](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210808174256.png)</span><br><span class="line"></span><br><span class="line">上图这个位置可以添加，但是注意哦！这个绿叶叶一开始没有，**一定要有主启动类，并且标注了@SpringBootApplication之后，这个绿叶叶才会被激活，才可以添加bootstrap.yml。**</span><br><span class="line"></span><br><span class="line">```yaml</span><br><span class="line">server:</span><br><span class="line">  port: 3355</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: config-client</span><br><span class="line">  cloud:</span><br><span class="line">    config:</span><br><span class="line">      label: master   #分支名称</span><br><span class="line">      name: config    #配置文件名称</span><br><span class="line">      profile: dev    #读取后缀名称</span><br><span class="line">      #上面三个结合，就是master分支下的config-dev.yml的配置文件</span><br><span class="line">      uri: http://localhost:3344 #配置中心的地址</span><br><span class="line"></span><br><span class="line">#服务注册到eureka地址</span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http://localhost:7001/eureka</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>主启动类：</p>
</li>
</ol>
<p>理论上来说应该先配置主启动类的，因为bookstrap.yml识别不到嗷。</p>
<ol start="5">
<li>业务类：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/configInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>测试：</li>
</ol>
<p>7001 + 3344 + 3355：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809160945.png" alt="image-20210809160937672"></p>
<ol start="7">
<li>踩过的大坑：首先，要引入多一个依赖，bootstrap的依赖。其次，yml文件的名字是bootstrap不是bookstrap。这个非常坑！！！<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809161054.png" alt="image-20210809161054660">注意，左下角是云，不是电源嗷！！！</li>
</ol>
</li>
<li><p>云端更新了之后，3344立即变了，3355有缓存，没有及时发生改变！！！3355无法动态刷新嗷！！！</p>
</li>
</ul>
<h3 id="客户端手动版动态刷新："><a href="#客户端手动版动态刷新：" class="headerlink" title="客户端手动版动态刷新："></a>客户端手动版动态刷新：</h3><ul>
<li>3355引入actuator依赖</li>
<li>yaml添加配置暴露监控端点：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>Controller上添加@RefreshScope</p>
</li>
<li><p>测试：</p>
<ul>
<li>github –&gt; 3344 –&gt; 3355</li>
<li>配置没有生效？？？裂开来，3355还是不能动态更新！！！</li>
</ul>
</li>
<li><p>How？运维工程师发送Post请求刷新3355</p>
<ul>
<li><code>curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;</code></li>
<li>结果：<code>[&quot;config.client.version&quot;,&quot;config.info&quot;]</code></li>
<li>再次刷新3355（3355并未重新启动）：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809165829.png" alt="image-20210809165829065"></p>
</li>
<li><p>配置工程师：</p>
<ul>
<li>改配置。</li>
<li>发信息通知3355，避免了重启。</li>
</ul>
</li>
</ul>
<h3 id="客户端自动版动态刷新："><a href="#客户端自动版动态刷新：" class="headerlink" title="客户端自动版动态刷新："></a>客户端自动版动态刷新：</h3><ul>
<li>广播，一次通知，处处生效。实现定点打击，差异化的处理，该通知的通知，该处理的处理。（for循环）</li>
<li>现在还做不到，那咋办？消息总线Bus，请听下回分解。</li>
</ul>
<h1 id="消息总线-RabbitMQ："><a href="#消息总线-RabbitMQ：" class="headerlink" title="消息总线+RabbitMQ："></a>消息总线+RabbitMQ：</h1><ul>
<li>搭配config一起使用，一般这种情况下消息中间件是躲不掉的~例如RabbitMQ等。</li>
<li>Bus + Config 实现自动更新。</li>
<li>Bus支持两种消息代理：RabbitMQ和Kafka。</li>
<li>就相当于订阅公众号一样的嗷！！！</li>
<li>原理图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809165753.png" alt="image-20210809165753432"></p>
<h2 id="RabbitMQ环境配置："><a href="#RabbitMQ环境配置：" class="headerlink" title="RabbitMQ环境配置："></a>RabbitMQ环境配置：</h2><ol>
<li>安装Erlang</li>
<li>安装RabbitMQ</li>
<li>进入RabbitMQ安装目录下的sbin目录</li>
<li>输入一下命令启动管理功能：<ul>
<li><code>rabbitmq-plugins enable rabbitmq_management</code></li>
<li>可视化插件</li>
</ul>
</li>
<li>查看是否安装成功</li>
<li>输入账号密码登录：guest   guest</li>
</ol>
<ul>
<li><p>具体安装细节：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/which-erlang.html">erlang的版本和RabbitMQ版本对照</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/lu1005287365/article/details/52315786">RabbitMQ安装教程</a></li>
</ul>
</li>
<li><p>安装完成测试：</p>
<ol>
<li>使用工具中的start：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809190347.png" alt="image-20210809190347362"></p>
<ol start="2">
<li><img src="C:\Users\Alexander\AppData\Roaming\Typora\typora-user-images\image-20210809190433786.png" alt="image-20210809190433786"></li>
<li>默认账号和密码为guest和guest，登录尝试：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809190533.png" alt="image-20210809190533279"></p>
</li>
</ul>
<h2 id="广播实践："><a href="#广播实践：" class="headerlink" title="广播实践："></a>广播实践：</h2><ul>
<li>为了演示效果，以3355为模板再去制作一个3366</li>
<li>除了端口，所有都类似的嗷！！！</li>
</ul>
<h3 id="设计思想（技术选型）："><a href="#设计思想（技术选型）：" class="headerlink" title="设计思想（技术选型）："></a>设计思想（技术选型）：</h3><ul>
<li><p>广播的两种设计思想：</p>
<ul>
<li>利用bus触发一个客户端&#x2F;bus&#x2F;refresh，刷新所有客户端的配置</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809191620.png" alt="image-20210809191620185"></p>
<ul>
<li>利用消息总线触发一个服务端ConfigServer的&#x2F;bus&#x2F;refresh端点，从而刷新所有客户端的配置。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809191705.png" alt="image-20210809191704885"></p>
</li>
<li><p>图二的架构更加适合嗷（推荐）！！！图一的局限性：</p>
<ul>
<li>微服务职责的单一性</li>
<li>破坏了结点对等性</li>
<li>有一定的局限性：微服务迁移的时候，网络地址常常会发生变化嗷！！！</li>
</ul>
</li>
</ul>
<h3 id="实践：-1"><a href="#实践：-1" class="headerlink" title="实践："></a>实践：</h3><ul>
<li><p>3344来通知3355和3366</p>
</li>
<li><p>3344：</p>
<ul>
<li>引入RabbitMQ的依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>引入了上面的依赖之后MQ和Bus都有了</p>
<ul>
<li>yaml添加MQ相应的配置嗷！！！</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rabbitmq相关的配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#rabbitmq相关配置，暴露bus刷新配置的端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span> <span class="comment">#暴露bus刷新配置的端点</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;bus-refresh&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>3355 &#x2F; 3366：</p>
<ul>
<li>POM：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>YML：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rabbitmq相关配置，15672是管理界面的窗口，5672是MQ访问的端口</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试（7001 , 3344 , 3355 , 3366）：</p>
<ul>
<li><pre><code>更改github上的文件
</code></pre>
</li>
<li><pre><code>广播通知3344：
</code></pre>
</li>
</ul>
<p>注意这里向3344发的哈！！！<code>curl -X POST &quot;http://localhost:3344/actuator/bus-refresh&quot;</code></p>
<ul>
<li><pre><code>观察3355和3366是否也会跟着发生改变：
</code></pre>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809200644.png" alt="image-20210809200644418"></p>
<p>芜湖出来了出来了嗷！！！！！！</p>
</li>
<li><p>基本原理：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809201029.png" alt="image-20210809201028920"></p>
<h2 id="动态刷新定点通知："><a href="#动态刷新定点通知：" class="headerlink" title="动态刷新定点通知："></a>动态刷新定点通知：</h2><ul>
<li><p>精确打击，定点清除。</p>
</li>
<li><p>例如只通知3355，不通知3366：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809201430.png" alt="image-20210809201429725"></p>
</li>
<li><p>注意后面那个config-client:3355哈，这个是微服务名字加上端口号嗷！！！</p>
</li>
<li><p>下面这一就是整体的流程和原理嗷！！！</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809202219.png" alt="image-20210809202219257"></p>
<h1 id="Stream消息驱动："><a href="#Stream消息驱动：" class="headerlink" title="Stream消息驱动："></a>Stream消息驱动：</h1><ul>
<li><p>不关注具体MQ的细节，用一种适配绑定的方式，自动给我们在各种MQ内切换。</p>
</li>
<li><p>目的：屏蔽底层消息中间件的差异，降低切换成本，统一消息的编程模型。</p>
</li>
<li><p>Binder（屏蔽了底层的技术细节），我们只需要使用Binder，Binder帮助我们实际上去操作底层的消息中间件。</p>
</li>
<li><p>设计思想：</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809203946.png" alt="image-20210809203946168"></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809205708.png" alt="image-20210809205708038"></li>
<li>采用的是发布-订阅模式嗷！！！</li>
</ul>
</li>
<li><p>常用注解和api：</p>
<ul>
<li>套路示意图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809205914.png" alt="image-20210809205913620"></p>
<ul>
<li>重要组成部分：<ul>
<li>Binder：很方便连接中间件，屏蔽差异</li>
<li>Channel：通道，Queue的一种抽象，实现存储和转发的媒介，通过Channel对队列进行配置。</li>
</ul>
</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809210412.png" alt="image-20210809210411672"></li>
</ul>
</li>
</ul>
<h2 id="实践：-2"><a href="#实践：-2" class="headerlink" title="实践："></a>实践：</h2><ul>
<li>新建8801：生产者，8802和8803：消费者。</li>
</ul>
<h3 id="生产者："><a href="#生产者：" class="headerlink" title="生产者："></a>生产者：</h3><ol>
<li>新建module（cloud-stream-rabbitmq-provider8801）</li>
<li>Pom：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-stream-rabbitmq-provider8801<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Yaml：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span> <span class="comment"># 在此处配置要绑定的rabbitmq的服务信息；</span></span><br><span class="line">        <span class="attr">defaultRabbit:</span> <span class="comment"># 表示定义的名称，用于于binding整合</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">environment:</span> <span class="comment"># 设置rabbitmq的相关的环境配置</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">      <span class="attr">bindings:</span> <span class="comment"># 服务的整合处理</span></span><br><span class="line">        <span class="attr">output:</span> <span class="comment"># 这个名字是一个通道的名称</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span> <span class="comment"># 表示要使用的Exchange名称定义</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">application/json</span> <span class="comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">defaultRabbit</span>  <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span> <span class="comment"># 客户端进行Eureka注册的配置</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span> <span class="comment"># 设置心跳的时间间隔（默认是30秒）</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span> <span class="comment"># 如果现在超过了5秒的间隔（默认是90秒）</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">send-8801.com</span>  <span class="comment"># 在信息列表时显示主机名称</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span>     <span class="comment"># 访问的路径变为IP地址</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>主启动</li>
<li>业务类：</li>
</ol>
<ul>
<li>service接口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IMessageProvider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现类：</li>
</ul>
<p>引入的Source为<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809213043.png" alt="image-20210809213043359"></p>
<p>这个Source就是上面套路示意图中的那个Source嗷！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以不用@Service，业务逻辑不是传统的业务逻辑被调用了，是被用于和Binder打交道啦</span></span><br><span class="line"><span class="meta">@EnableBinding(Source.class)</span> <span class="comment">//定义消息的推送管道</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IMessageProviderImpl</span> <span class="keyword">implements</span> <span class="title class_">IMessageProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageChannel output; <span class="comment">//消息推送管道</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">send</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serial</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        output.send(MessageBuilder.withPayload(serial).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;******** serial: &quot;</span> + serial);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用这个Service是用于和Binder打交道，所以和我们以往的Service不一样嗷！！！</p>
<ol start="6">
<li>测试：</li>
</ol>
<ul>
<li>启动7001</li>
<li>启动rabbitmq</li>
<li>启动8801</li>
<li>访问</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809215215.png" alt="image-20210809215215097"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809215232.png" alt="image-20210809215232209"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210809215317.png" alt="image-20210809215317783"></p>
<h3 id="消费者："><a href="#消费者：" class="headerlink" title="消费者："></a>消费者：</h3><ol>
<li>新建module：</li>
</ol>
<p>cloud-stream-rabbitmq-consumer8802</p>
<ol start="2">
<li>POM.xml：</li>
</ol>
<p>同8801</p>
<ol start="3">
<li>Yaml：</li>
</ol>
<p>和上面几乎一样，一点小区别：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810090653.png" alt="image-20210810090652724"></p>
<p>下面还有一个instance-id，也要把8801改成8802嗷！</p>
<ol start="4">
<li><p>主启动</p>
</li>
<li><p>业务类</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableBinding(Sink.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReceiveMessageListenerController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener(Sink.INPUT)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">input</span><span class="params">(Message&lt;String&gt; message)</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者一号获得的信息为：message.getPayload() = &quot;</span> + message.getPayload() + <span class="string">&quot;\t port: &quot;</span>+serverPort);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>测试：</li>
</ol>
<ul>
<li>7001+8801+8802</li>
<li>测试8801向8802发送消息</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810093714.png" alt="image-20210810093713693"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810093741.png" alt="image-20210810093741447"></p>
<ul>
<li>感觉有点像管道的感觉。生产者放入管道，消费者就会等待生产者的消息，接受到消息之后，会及时进行处理。</li>
</ul>
<h3 id="分组消费与持久化："><a href="#分组消费与持久化：" class="headerlink" title="分组消费与持久化："></a>分组消费与持久化：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810094530.png" alt="image-20210810094530024"></p>
<ul>
<li>依照8802复制出一份8803嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810094805.png" alt="image-20210810094805089"></p>
<ul>
<li>问题：<ul>
<li>有重复消费问题</li>
<li>消息持久化问题</li>
</ul>
</li>
<li>用分组的方式来解决：<ul>
<li>重复消费会导致数据错误，多个消费者是<strong>竞争关系</strong>，应该保证其中的一个应用消费一次。</li>
</ul>
</li>
</ul>
<h4 id="自定义Group分组配置："><a href="#自定义Group分组配置：" class="headerlink" title="自定义Group分组配置："></a>自定义Group分组配置：</h4><ul>
<li><p>自定义配置为同一个组，保证消息只会被其中一个应用消费一次。不同的组是可以消费的，同一个组内会发生竞争关系，只有其中一个可以消费。</p>
</li>
<li><p>如何分组？</p>
<ul>
<li>分为：tuziA , tuziB</li>
<li>配置方法：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810174530.png" alt="image-20210810174529772"></p>
<ul>
<li>配置完成效果：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810174622.png" alt="image-20210810174622362"></p>
<p>不同的组之间是可以重复消费的，默认就是分为不同的组，所以会产生重复消费的问题。</p>
</li>
<li><p>解决重复消费：</p>
<ul>
<li>8802和8803设置为同一个组嗷！！！</li>
<li>默认是轮询消费，就是生产者放入的信息，会由同一个组中的不同消费者轮询消费嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810175002.png" alt="image-20210810175002099"></p>
<p>测试可知确实是轮询消费的嗷！！！</p>
</li>
</ul>
<h4 id="持久化演示和配置："><a href="#持久化演示和配置：" class="headerlink" title="持久化演示和配置："></a>持久化演示和配置：</h4><ul>
<li>8803的分组不动，8802的分组注释掉，做一个对比。</li>
<li>8802和8803都关机，在关机期间，8801发送四条消息。</li>
<li>8802拿不到它关机期间的消息，但是8803却会主动从MQ中拿出它关机期间的消息。说白了就是消息丢失了。</li>
<li>所以其实，加上了group分组，就实现了消息的持久化嗷！！！</li>
</ul>
<h1 id="Sleuth链路监控："><a href="#Sleuth链路监控：" class="headerlink" title="Sleuth链路监控："></a>Sleuth链路监控：</h1><ul>
<li><p>用于监控链路</p>
</li>
<li><p>可以结合Zipkin使用，Zipkin是用于展示的嗷！！！</p>
</li>
<li><p>Zipkin下载：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://guide.wangjubao.com/15_monitor_invoke/content.html#zipkin_download">Zipkin下载</a></li>
<li>新版本的zipkin，下载完成之后，使用java -jar命令就很方便的运行起来了嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810192314.png" alt="image-20210810192314480"></li>
</ul>
</li>
<li><p>Zipkin主页面打开：<code>http://localhost:9411/zipkin/</code></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810192827.png" alt="image-20210810192827660"></p>
</li>
</ul>
<h2 id="监控展示："><a href="#监控展示：" class="headerlink" title="监控展示："></a>监控展示：</h2><ul>
<li>7001 ， 8001 ， 80</li>
<li>8001要引入POM：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>8001的yaml要变更嗷！！！</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment">#采样值介于0到1之间，1表示全部采集</span></span><br></pre></td></tr></table></figure>

<p>监控的数据和图标要打到9411上</p>
<p>sleuth的采样率为0到1，一般0.5也够用了，1最全嗷！！！</p>
<ul>
<li>多加上一个请求嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/zipkin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentZipkin</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hi , i&#x27;m paymentZipkin server all back, welcome to 兔子的小窝&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>80也要改嗷！！！</p>
<ul>
<li>加上依赖</li>
<li>Yaml和上面一样修改</li>
<li>业务类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/zipkin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">paymentZipkin</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8001&quot;</span>+<span class="string">&quot;/payment/zipkin&quot;</span>,String.class);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>依次启动7001 ， 8001 ， 80。80调用几次8001测试一下嗷！！！</p>
</li>
<li><p>查看9411端口的主界面：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810201431.png" alt="image-20210810201430895"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810201603.png" alt="image-20210810201603118"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210810201625.png" alt="image-20210810201625710"></p>
<h1 id="SpringCloud-Alibaba："><a href="#SpringCloud-Alibaba：" class="headerlink" title="SpringCloud Alibaba："></a>SpringCloud Alibaba：</h1><ul>
<li>参考资料：<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">Alibaba中文文档</a></li>
<li>Spring官网上其实也有相应的内容嗷！！！</li>
</ul>
</li>
</ul>
<h1 id="Nacos服务注册和配置中心："><a href="#Nacos服务注册和配置中心：" class="headerlink" title="Nacos服务注册和配置中心："></a>Nacos服务注册和配置中心：</h1><ul>
<li><strong>Na</strong>ming + <strong>co</strong>figuration + <strong>s</strong>ervice</li>
<li>Nacos就是注册中心+配置中心的整合：Nacos + Config + Bus</li>
<li>作用：<ul>
<li>替代Eureka做服务注册中心</li>
<li>替代Config做服务配置中心</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/">Nacos官网</a></li>
<li>下载的话，从官网进去，主页面下面有个对应的版本说明，点进去找对应的版本下载即可嗷！！！</li>
</ul>
<h2 id="下载安装："><a href="#下载安装：" class="headerlink" title="下载安装："></a>下载安装：</h2><ul>
<li>windows对应的是zip文件，不是tar.gz嗷，下载下来就可以啦！！！</li>
<li>版本选择1.1.4，全新版本的Nacos好像有一些不一样嗷！！！还需要康康呢！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811093720.png" alt="image-20210811093712676"></p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811093831.png" alt="image-20210811093830577"></li>
<li>默认用户名密码都是nacos，能登录进去就可以用嗷！！！</li>
</ul>
<h2 id="实践操作："><a href="#实践操作：" class="headerlink" title="实践操作："></a>实践操作：</h2><ul>
<li>alibaba依赖在父pom里面已经添加了，不需要添加额外的依赖了嗷！！！</li>
</ul>
<h3 id="服务注册中心："><a href="#服务注册中心：" class="headerlink" title="服务注册中心："></a>服务注册中心：</h3><h4 id="生产者：-1"><a href="#生产者：-1" class="headerlink" title="生产者："></a>生产者：</h4><ul>
<li><p>服务提供者：</p>
<ul>
<li><p>这里的老五步，复杂的我就不写了嗷！！！</p>
</li>
<li><pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
&lt;/dependency&gt;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- Yaml：</span><br><span class="line"></span><br><span class="line">- ```yaml</span><br><span class="line">  server:</span><br><span class="line">    port: 9001</span><br><span class="line">  </span><br><span class="line">  spring:</span><br><span class="line">    application:</span><br><span class="line">      name: nacos-payment-provider</span><br><span class="line">    cloud:</span><br><span class="line">      nacos:</span><br><span class="line">        discovery:</span><br><span class="line">          server-addr: localhost:8848 #配置nacos注册的地址</span><br><span class="line">  </span><br><span class="line">  management:</span><br><span class="line">    endpoints:</span><br><span class="line">      web:</span><br><span class="line">        exposure:</span><br><span class="line">          include: &#x27;*&#x27;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>主启动：</p>
</li>
<li><pre><code class="java">@SpringBootApplication
@EnableDiscoveryClient
public class PaymentMain9001
&#123;
  public static void main(String[] args) &#123;
    //主启动类
      SpringApplication.run(PaymentMain9001.class,args);
  &#125;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 业务类：</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  @RestController</span><br><span class="line">  public class PaymentController</span><br><span class="line">  &#123;</span><br><span class="line">      @Value(&quot;$&#123;server.port&#125;&quot;)</span><br><span class="line">      private String serverPort;</span><br><span class="line">  </span><br><span class="line">      @GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;)</span><br><span class="line">      public String getPayment(@PathVariable(&quot;id&quot;) Integer id)&#123;</span><br><span class="line">          return &quot;nacos registry, serverPort: &quot; + serverPort + &quot;\t id: &quot;+id;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>查看：</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811100135.png" alt="image-20210811100135222"></p>
</li>
<li><p>投机取巧，迅速启动一个配置相同的服务：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811100347.png" alt="image-20210811100347018"></p>
<ul>
<li>再新建一个9002和上面几乎是一样的嗷，就是端口不一样而已。</li>
</ul>
</li>
</ul>
<h4 id="消费者：-1"><a href="#消费者：-1" class="headerlink" title="消费者："></a>消费者：</h4><ul>
<li>yaml：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure>

<p>注意下面这里使用服务名字哈，nacos本身就整合了ribbon，可以实现负载均衡，这个就是一个测试嗷！！！</p>
<ul>
<li>有ribbon就自带RestTemplate，还需要注入到容器中才可以使用嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextConfig</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>业务类：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNacosController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serviceURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(serviceURL+<span class="string">&quot;/payment/nacos/&quot;</span>+id,String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试的时候，默认实现轮询，因为Nacos默认整合了Ribbon</li>
</ul>
<h4 id="对比："><a href="#对比：" class="headerlink" title="对比："></a>对比：</h4><ul>
<li>Nacos同时支持AP或CP</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811105133.png" alt="image-20210811105133578"></p>
<ul>
<li>Nacos切换AP和CP模式：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811105330.png" alt="image-20210811105329516"></p>
<h3 id="服务配置中心："><a href="#服务配置中心：" class="headerlink" title="服务配置中心："></a>服务配置中心：</h3><h4 id="基础配置："><a href="#基础配置：" class="headerlink" title="基础配置："></a>基础配置：</h4><ul>
<li>新建3377配置项目，需要的额外配置：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--nacos-discovery 注册中心-服务发现与注册--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>yaml：</li>
</ul>
<p>bootstrap.yml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#全局配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#注册到nacos服务注册中心</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos作为配置中心</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#指定yaml格式的配置</span></span><br><span class="line">        </span><br></pre></td></tr></table></figure>

<p>application.yml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment">#表示开发环境</span></span><br></pre></td></tr></table></figure>

<p>上面两个配置分开，就可以通过切换本地的active去切换本个module的配置，十分好用嗷！！！</p>
<p>Controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span> <span class="comment">//Nacos也支持动态刷新功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigClientController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/config/info&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getConfigInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重要的配置！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811112015.png" alt="image-20210811112015207"></p>
<p>最后公式：</p>
<p><code>$&#123;spring.application.name&#125;-$&#123;spring.profiles.active&#125;.$&#123;spring.cloud.nacos.config.file-extension&#125;</code></p>
<p>上面这些值都是从配置文件中摘出来的嗷！！！</p>
<p>nacos-config-client-dev.yaml，这个文件名（公用的配置文件）的名字就去欸的那个了嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811112403.png" alt="image-20210811112402300"></p>
<p>上面这个yaml中，<strong>config后面一定要有一个空格！！！</strong></p>
<ul>
<li><p>小总结：<img src="C:\Users\Alexander\AppData\Roaming\Typora\typora-user-images\image-20210811112638422.png" alt="image-20210811112638422"></p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811112656.png" alt="image-20210811112655365"></p>
</li>
<li><p>报错了，文件名字后面没有对上！！！记住哈，这里文件后缀要求是yaml嗷！！！这是个很大的bug嗷！！！</p>
</li>
<li><p>此外，动态刷新。没有上面的config那么痛苦，直接改Nacos里面的文件，动态刷新就会自动生效嗷！！！</p>
</li>
</ul>
<h4 id="分组配置："><a href="#分组配置：" class="headerlink" title="分组配置："></a>分组配置：</h4><ul>
<li>Config + Bus</li>
<li>问题：<ul>
<li>通常一个系统会准备多个环境，如何保证指定环境启动的时候能够读取到相应环境的配置文件呢？</li>
<li>大型分布式项目，会有很多子项目。每个微服务项目都会有相应的开发环境，测试环境，预发环境，正式环境。如何进行配置管理？</li>
</ul>
</li>
<li>图形化管理界面：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811123933.png" alt="image-20210811123933242"></p>
<p>Namespace + Group + Data ID三者的关系设计</p>
<p>类似于Java里面的包名和类名</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811124450.png" alt="image-20210811124450061"></p>
<p>开发，测试，生产就可以创建三个NameSpace</p>
<h5 id="DataID"><a href="#DataID" class="headerlink" title="DataID"></a>DataID</h5><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811160117.png" alt="image-20210811160117549"></p>
<ul>
<li>DataID：<ul>
<li>指定spring.profile.active和配置文件的DataID来使不同环境下读取不同的配置。</li>
<li>默认空间+默认分组+新建dev和test两个DataID</li>
</ul>
</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811155447.png" alt="image-20210811155440009"></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811155552.png" alt="image-20210811155552778"></p>
<ul>
<li>灵活切换，默认空间和默认分组+DataID的不同，就能够实现不同环境之间的切换。</li>
<li><code>active: </code>的修改，修改完成之后重启就能够实现环境的夏欢嗷！！！</li>
</ul>
<h5 id="GroupID"><a href="#GroupID" class="headerlink" title="GroupID"></a>GroupID</h5><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811160217.png" alt="image-20210811160216987"></p>
<ul>
<li>新建两个分组，一个test分组和一个dev分组嗷！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811160611.png" alt="image-20210811160611235"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811160852.png" alt="image-20210811160851892"></p>
<p>分组了怎么用呢？</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811160914.png" alt="image-20210811160914283"></li>
</ul>
<p>多加一条关于分组的配置即可嗷！！！</p>
<p>TEST和DEV分别切换，可以查看到不同环境中的同名文件嗷！！！</p>
<p>感觉粒度大，可以实现整个开发环境配置的切换。DataID值能够实现，某个具体的环境中，某个配置文件的切换嗷！！！</p>
<h5 id="NameSpace"><a href="#NameSpace" class="headerlink" title="NameSpace"></a>NameSpace</h5><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811161925.png" alt="image-20210811161925634"></p>
<p>新增完成之后，配置列表也会发生一些改变了嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811164433.png" alt="image-20210811164432866"></p>
<ul>
<li>以dev来做一个例子嗷！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811164534.png" alt="image-20210811164534464"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811165154.png" alt="image-20210811165145741"></p>
<p>配置的时候，需要加上对应的Namespace来进行配置嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811165656.png" alt="image-20210811165656351"></p>
<ul>
<li>实现了类似于三级目录区分这样的功能嗷！！！</li>
</ul>
<h2 id="Nacos集群和持久化配置（重要）："><a href="#Nacos集群和持久化配置（重要）：" class="headerlink" title="Nacos集群和持久化配置（重要）："></a>Nacos集群和持久化配置（重要）：</h2><ul>
<li><p>解决问题：</p>
<ul>
<li>搭建集群</li>
<li>持久化配置</li>
<li>Linux版本Nacos + MYSQL生产环境配置</li>
</ul>
</li>
<li><p>架构图：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811170207.png" alt="image-20210811170206828"></p>
<p>真实情况：Linux + Nginx + 高可用Mysql集群</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811170333.png" alt="image-20210811170300387"></p>
<p>Nacos如果不配置高可用的Mysql集群，使用默认的自带数据库，每一个Nacos带一个，自然会有不一致的问题。所以我们采用集中式存储的方法来支持集群化部署，目前只支持MySQL的存储。</p>
<ul>
<li>Nacos支持的三种部署模式：<ul>
<li>单级：测试和单机使用</li>
<li>集群：生产环境，确保高可用</li>
<li>多集群：多数据中心场景</li>
</ul>
</li>
</ul>
<h3 id="持久化配置："><a href="#持久化配置：" class="headerlink" title="持久化配置："></a>持久化配置：</h3><ul>
<li><p>Nacos默认自带的是嵌入式数据库derby</p>
</li>
<li><p>切换derby到mysql：</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811171118.png" alt="image-20210811171118190"></li>
</ul>
<p>下载的nacos里面自带了mysql的脚本，把它执行一下嗷！！！</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811171416.png" alt="image-20210811171415670"></li>
<li>官网部署教程，<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/deployment.html">Nacos部署官网，相应的mysql部署配置</a></li>
<li>配置完成之后，需要重启Nacos才能够生效嗷！！！注意，由于我的电脑版本的关系，我的电脑不支持Mysql5.x，对于8.x以上的版本可能还需要额外的解决方案，我在尝试换Nacos的版本嗷！！！</li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/leslen/p/15128180.html">Nacos2.0.3安装启动（实操可行）</a>，注意哈，这里的application中对于mysql要加上时区。然后就是启动2.0.3的时候，默认是集群，要单例启动的话：<code>startup.cmd -m standalone</code></li>
</ul>
</li>
<li><p>使用2.0.3，我们同样对于mysql进行配置，然后新建了一个配置管理，查看数据库中相应的结果：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811212143.png" alt="image-20210811212136035"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210811212229.png" alt="image-20210811212228785"></p>
<p>Nacos中的数据成功持久化存储到了mysql数据库中嗷！！！</p>
<h3 id="Nacos生产环境配置："><a href="#Nacos生产环境配置：" class="headerlink" title="Nacos生产环境配置："></a>Nacos生产环境配置：</h3><ul>
<li>一个Nginx + 3个Nacos注册中心 + 1个mysql</li>
<li>Nginx集群和Mysql主从复制还要下去自学嗷！！！</li>
<li>有点复杂，建议回去看教程嗷！！！个人觉着，Linux的水太深了orz，后面还要复习，要多学嗷！！！</li>
</ul>
<h1 id="Sentinel流量控制和熔断组件："><a href="#Sentinel流量控制和熔断组件：" class="headerlink" title="Sentinel流量控制和熔断组件："></a>Sentinel流量控制和熔断组件：</h1><ul>
<li>Hystrix问题：<ul>
<li>自己手工搭建监控平台</li>
<li>没有web界面可以给我们更加细粒化的配置来流控，速率控制，服务熔断，服务降级。</li>
</ul>
</li>
<li>Sentinel：<ul>
<li>单独一个组件，可以独立出来</li>
<li>直接界面化的细粒度统一控制。</li>
</ul>
</li>
</ul>
<h2 id="下载安装：-1"><a href="#下载安装：-1" class="headerlink" title="下载安装："></a>下载安装：</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">Sentinel下载</a>，下载的是默认的一个jar包，java -jar就可以运行嗷！！！8848端口就可以访问到仪表盘，登录的用户名和密码都是sentinel，正常登录就说明没问题嗷！！！</li>
</ul>
<h2 id="实践操作：-1"><a href="#实践操作：-1" class="headerlink" title="实践操作："></a>实践操作：</h2><ul>
<li>这里要用Nacos + Sentinel</li>
<li>Nacos:8848和Sentinel:8080都要先开启嗷！！！</li>
<li>8401微服务能够成功注册进8848Nacos并且能够被8080Sentinel保护着。</li>
<li>yaml：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloudalibaba-sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#Nacos服务注册中心地址</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span> <span class="comment">#配置Sentinel dashboard地址</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8719</span></span><br><span class="line"><span class="comment">#      datasource:</span></span><br><span class="line"><span class="comment">#        ds1:</span></span><br><span class="line"><span class="comment">#          nacos:</span></span><br><span class="line"><span class="comment">#            server-addr: localhost:8848</span></span><br><span class="line"><span class="comment">#            dataId: $&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="comment">#            groupId: DEFAULT_GROUP</span></span><br><span class="line"><span class="comment">#            data-type: json</span></span><br><span class="line"><span class="comment">#            rule-type: flow</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlowLimitController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testA&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testA</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;------testA&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testB&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testB</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;-------testB&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>开启项目之后，sentinel中没有任何的反应orz。因为sentinel懒加载，必须要访问一个网页之后，才能够监控的到嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812095128.png" alt="image-20210812095127814"></p>
<p>果然访问了一次之后，就可以监控到啦！！！</p>
<h3 id="实时监控："><a href="#实时监控：" class="headerlink" title="实时监控："></a>实时监控：</h3><ul>
<li><p>最近一段时间的访问情况嗷！！！</p>
</li>
<li><p>第一次访问触发监控，不会被计入在内。后面的访问才会被监控到嗷！！！</p>
</li>
</ul>
<h3 id="簇点链路："><a href="#簇点链路：" class="headerlink" title="簇点链路："></a>簇点链路：</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812095627.png" alt="image-20210812095627448"></p>
<p>可以用于监控调用次数和调用情况</p>
<p>后面的四个东西还有用嗷，类似于熔断之类的。</p>
<h3 id="流控规则："><a href="#流控规则：" class="headerlink" title="流控规则："></a>流控规则：</h3><ul>
<li>流控的两个入口：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812100257.png" alt="image-20210812100257031"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812100326.png" alt="image-20210812100326440"></p>
<p>注意这里的&#x2F;testA之类的时唯一的，类似于访问的资源名字</p>
<ul>
<li>配置实例：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812100436.png" alt="image-20210812100436331"></p>
<p>&#x2F;testA这个资源路径的每秒请求数大于1这个阈值的时候，就会直接快速失败。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812100631.png" alt="image-20210812100631293"></p>
<p>系统默认的保护嗷！！！</p>
<ul>
<li>Sentinal中的Dashboard流控模式思考：</li>
</ul>
<p>现配现用，立即生效，不用重启！！</p>
<p>思考？我们想自定义兜底方法呢？如何自定义？别人帮我们做好了，最大的问题就是，我们的自定义？？？</p>
<p>以后思考的维度：1. 默认有无 ， 2. 可否自定义。</p>
<ul>
<li>配置实例2：<ul>
<li>QPS：每秒请求数量达到阈值限流</li>
<li>线程数：请求线程数达到阈值限流</li>
</ul>
</li>
</ul>
<p>线程数的效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812102059.png" alt="image-20210812102059585"></p>
<p>一个是在外面就限流了，另外一个是将线程放进来了，但是我只能处理一个线程，其他的线程排好队，一个一个来。这就是QPS和线程的不同嗷！！！（说白了就是同时访问的线程数的限制呗！！！）</p>
<h4 id="流控模式："><a href="#流控模式：" class="headerlink" title="流控模式："></a>流控模式：</h4><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812102358.png" alt="image-20210812102358132"></p>
<h5 id="直接："><a href="#直接：" class="headerlink" title="直接："></a>直接：</h5><p>自己停用自己，自己满足一定条件就把自己换掉嗷！！！</p>
<h5 id="关联："><a href="#关联：" class="headerlink" title="关联："></a>关联：</h5><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812102452.png" alt="image-20210812102451986"></p>
<p>作用：类似于支付订单到阈值的时候，就限流下订单的接口，防止连坐的效应。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812102618.png" alt="image-20210812102617824"></p>
<p>这里是对于资源A设置的限流，B如果超过了单机阈值，就会限流A嗷！！！</p>
<p>这里可以使用Postman来进行模拟嗷！！！用Postman密集访问B，看是否A能够访问。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812110626.png" alt="image-20210812110625882"></p>
<p>Postman中，要新建一个Collection并且把对应的GET请求设置好，才能够批量进行测试嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812110928.png" alt="image-20210812110928075"></p>
<p>20个线程，每间隔0.3秒去访问一次。然后在运行过程中去访问A嗷，就出不来了orz。</p>
<h5 id="链路："><a href="#链路：" class="headerlink" title="链路："></a>链路：</h5><ul>
<li>限制当前两个服务之间的流量，一个爆了，另外一个也会跟着爆了orz。</li>
</ul>
<h4 id="流控效果："><a href="#流控效果：" class="headerlink" title="流控效果："></a>流控效果：</h4><h5 id="快速失败："><a href="#快速失败：" class="headerlink" title="快速失败："></a>快速失败：</h5><ul>
<li>快速失败，默认的流控处理就是这个。直接上来就是阈值，难顶啊！！！</li>
</ul>
<h5 id="预热："><a href="#预热：" class="headerlink" title="预热："></a>预热：</h5><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812111658.png" alt="image-20210812111658394"></p>
<ul>
<li><p>没有预热，从0直接到阈值，系统可能会裂开哦orz。</p>
</li>
<li><p>阈值&#x2F;coldFactor(默认为3)，经过预热时长后才会达到阈值。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812111843.png" alt="image-20210812111843371"></p>
<p>阈值是10，因子为3，要3.x秒，我给了你5s的时间，多让系统缓缓嗷！！！阈值开始为3，5s的时间慢慢增加到10嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812112104.png" alt="image-20210812112104081"></p>
<p>冷加载因子是在源码中写了的嗷！！！</p>
<p>刚开始不顺，后面越来越快嗷！！！秒杀系统中也经常用嗷！！！</p>
<h5 id="排队等待："><a href="#排队等待：" class="headerlink" title="排队等待："></a>排队等待：</h5><p>匀速排队通过</p>
<ul>
<li>另外，排队等待这个只适配QPS嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812112459.png" alt="image-20210812112459626"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812112550.png" alt="image-20210812112549693"></p>
<p>这个十分好用嗷，处于双赢的地位。你发了请求，排队处理，一个接一个。</p>
<h3 id="降级规则："><a href="#降级规则：" class="headerlink" title="降级规则："></a>降级规则：</h3><h4 id="RT："><a href="#RT：" class="headerlink" title="RT："></a>RT：</h4><p>原理：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812123159.png" alt="image-20210812123159699"></p>
<p>操作界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812113129.png" alt="image-20210812113129339"></p>
<ul>
<li>RT，平均响应时间（秒级）</li>
</ul>
<p>平均响应时间超出阈值或在窗口时间内通过的请求&gt;&#x3D;5，两个条件同时满足才能够触发降级。</p>
<p>RT最大时4900，更大需要-Dcsp.sentinel.statistic.max.rt&#x3D;XXXX才能够生效。</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812113749.png" alt="image-20210812113749692"></p>
<p>Sentinel熔断器是没有半开状态的嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812122726.png" alt="image-20210812122725824"></p>
<p>RT为平均响应时间，单位为毫秒，在1s内，如果无法保证平均响应时间小于200ms，就熔断啦！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812123104.png" alt="image-20210812123104022"></p>
<ul>
<li>降级策略：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812123611.png" alt="image-20210812123611564"></p>
<h4 id="异常比例："><a href="#异常比例：" class="headerlink" title="异常比例："></a>异常比例：</h4><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812123524.png" alt="image-20210812123524086"></p>
<ul>
<li>降级策略：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812123709.png" alt="image-20210812123709418"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812123918.png" alt="image-20210812123917728"></p>
<h4 id="异常数："><a href="#异常数：" class="headerlink" title="异常数："></a>异常数：</h4><ul>
<li>时间窗口一定要大于等于60秒嗷！！！这个东西是按照分钟来进行统计的嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812124142.png" alt="image-20210812124142283"></li>
</ul>
<p>61s内，异常数大于5次之后，就会产生熔断嗷！！！</p>
<h3 id="热点规则："><a href="#热点规则：" class="headerlink" title="热点规则："></a>热点规则：</h3><ul>
<li>非常重要嗷！！！</li>
<li>用于热点参数限流嗷！！！（对于某一个参数进行更加精确的打击和限流嗷！！！）</li>
</ul>
<h4 id="SentinelResource："><a href="#SentinelResource：" class="headerlink" title="@SentinelResource："></a>@SentinelResource：</h4><ul>
<li>新增的测试controller：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> p1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> p2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testHotKey&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;testHotKey&quot;, blockHandler = &quot;deal_testHotKey&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testHotKey</span><span class="params">(<span class="meta">@RequestParam(value = &quot;p1&quot;, required = false)</span> String p1,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(value = &quot;p2&quot;, required = false)</span> String p2)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------testHotKey&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">deal_testHotKey</span><span class="params">(String p1, String p2, BlockException exception)</span> &#123;</span><br><span class="line">    <span class="comment">//sentinel系统默认的提示：Blocked by Sentinel (flow limiting)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;------deal_testHotKey,o(╥﹏╥)o&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@SentinelResource的用法：</li>
</ul>
<p>注意，SentinelResource后面的value的值只要是唯一的就行嗷，建议和getMapping保持一致（少个&#x2F;），方便区分和规范，下面的这个是兜底方法嗷！！！用法和@HystrixCommand没啥区别嗷！！！</p>
<ul>
<li>下面例如，我们对于p1这个参数进行拦截：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812162530.png" alt="image-20210812162529887"></p>
<p>这里设置下来的就是指的是参数p1哈，p1和p2是完全独立的，p2随便取啥都无所谓嗷！！！注意一下这里的资源名，资源名是你@SentinelResource中给的value值嗷！！！</p>
<p>当请求参数带有p1并且请求的频率高于1秒1次的时候，就采用了服务降级的方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812163121.png" alt="image-20210812163121337"></p>
<ul>
<li>如果SentinelResource后面那个blockHandler的参数去掉了，那就没用了呀orz。超过p1限定的频率之后，会直接报errorPage，就很不友好嗷QAQ！！！</li>
</ul>
<h4 id="参数例外项："><a href="#参数例外项：" class="headerlink" title="参数例外项："></a>参数例外项：</h4><ul>
<li><p>参数例外项：</p>
<ul>
<li>我们希望当p1的值为某些特定值的时候，不限流！！！（更加灵活）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812165235.png" alt="image-20210812165235415"></p>
<ul>
<li>这个下半部分就是对于特殊值的设定嗷，当参数的值取特定的值的时候，限流阈值会不一样嗷！！！所以这个才叫作参数例外项哇~</li>
</ul>
</li>
<li><p>手动添加错误试试看？</p>
<ul>
<li>Java运行时的错误老子不管哦</li>
<li>我只管运行时的限流，我不管你运行的返回是啥哦！！！</li>
<li>主管配置出错，运行出错不归我管，该走异常走异常。</li>
</ul>
</li>
<li><p>那发生了错误不友好怎么办啊？@SentinelResource中有一个属性叫做fallback，也可以和之前一样指定方法，如果出错了该怎么处理嗷！！！</p>
</li>
</ul>
<h4 id="系统规则："><a href="#系统规则：" class="headerlink" title="系统规则："></a>系统规则：</h4><ul>
<li><p>这个是对于整个系统的大粒度的控制嗷！！！总包总揽，入口级别的控制嗷，整体控制！！！</p>
</li>
<li><p>自适应系统规则，在整个系统的最外层多包了一层嗷！！！但是粒度有点大，不是特别方便嗷！！！</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812173537.png" alt="image-20210812173536871"></p>
<p>例如入口QPS，设置为2，每秒最多2个，再多的就不行了！！！再多的无论你调用系统中的什么服务都进不来了嗷！！！</p>
<h3 id="SentinelResource：-1"><a href="#SentinelResource：-1" class="headerlink" title="@SentinelResource："></a>@SentinelResource：</h3><h4 id="按资源名称限流-后续处理："><a href="#按资源名称限流-后续处理：" class="headerlink" title="按资源名称限流+后续处理："></a>按资源名称限流+后续处理：</h4><ul>
<li><p>按照@Sentinel中的资源名限流，如果有自定义的兜底，用自定义的。如果没有，用系统默认的。</p>
</li>
<li><p>第一个Controller中的方法：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/byResource&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;byResource&quot;, blockHandler = &quot;handleException&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">byResource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;按资源名称限流测试OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, <span class="string">&quot;serial001&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">handleException</span><span class="params">(BlockException exception)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">444</span>, exception.getClass().getCanonicalName() + <span class="string">&quot;\t 服务不可用&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出来，兜底方法中的参数嗷！！！和上面的放一起看，就知道传参的规则是啥了嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812174639.png" alt="image-20210812174639060"></p>
<p>注意这里的资源名称哈，配置的时候的资源名用的是@SentinelResource中的资源名嗷！！！（如果用GetMapping也不是不行，但是那样就用不了我们自定义的到底规则嗷！！！）</p>
<ul>
<li>额外问题：关闭服务8401看看？<ul>
<li>Sentinel流控规则消失，说明流控规则的配置是零时的配置嗷！！！</li>
</ul>
</li>
</ul>
<h4 id="按Url地址限流-后续处理："><a href="#按Url地址限流-后续处理：" class="headerlink" title="按Url地址限流+后续处理："></a>按Url地址限流+后续处理：</h4><ul>
<li>按照@GetMapping中的地址限流，使用Sentinel默认的兜底规则进行处理。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/rateLimit/byUrl&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;byUrl&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">byUrl</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;按url限流测试OK&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, <span class="string">&quot;serial002&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="兜底方案面临的问题："><a href="#兜底方案面临的问题：" class="headerlink" title="兜底方案面临的问题："></a>兜底方案面临的问题：</h4><ul>
<li>和前面一样的，兜底方案和代码耦合</li>
<li>兜底方案太多太杂</li>
<li>代码膨胀</li>
<li>没有全局统一处理方法</li>
</ul>
<h4 id="以上问题的解决："><a href="#以上问题的解决：" class="headerlink" title="以上问题的解决："></a>以上问题的解决：</h4><ul>
<li>和Hystrix一样的，单独建立一个类来存储降级方案：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerBlockHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title function_">handlerException</span><span class="params">(BlockException exception)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">4444</span>, <span class="string">&quot;按客戶自定义,global handlerException----1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CommonResult <span class="title function_">handlerException2</span><span class="params">(BlockException exception)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">4444</span>, <span class="string">&quot;按客戶自定义,global handlerException----2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/rateLimit/customerBlockHandler&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;customerBlockHandler&quot;,</span></span><br><span class="line"><span class="meta">        blockHandlerClass = CustomerBlockHandler.class,</span></span><br><span class="line"><span class="meta">        blockHandler = &quot;handlerException2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CommonResult <span class="title function_">customerBlockHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CommonResult</span>(<span class="number">200</span>, <span class="string">&quot;按客戶自定义&quot;</span>, <span class="keyword">new</span> <span class="title class_">Payment</span>(<span class="number">2020L</span>, <span class="string">&quot;serial003&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相当于多了一个参数来引入对应的类而已嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812192927.png" alt="image-20210812192927117"></p>
<h4 id="代码配置："><a href="#代码配置：" class="headerlink" title="代码配置："></a>代码配置：</h4><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812193303.png" alt="image-20210812193303536"></p>
<p>不推荐嗷，有一点复杂呢。有GUI不是用起来配置更加舒服咩？</p>
<ul>
<li>注解是不支持private的方法嗷！！！</li>
<li>三个核心API：<ul>
<li>SphU定义资源</li>
<li>Tracer定义统计</li>
<li>ContextUtil定义上下文</li>
</ul>
</li>
</ul>
<h3 id="服务熔断："><a href="#服务熔断：" class="headerlink" title="服务熔断："></a>服务熔断：</h3><ul>
<li>sentinel整合ribbon + openFeign + fallback</li>
</ul>
<h4 id="Ribbon系列："><a href="#Ribbon系列：" class="headerlink" title="Ribbon系列："></a>Ribbon系列：</h4><ul>
<li>84 ， 9003 ， 9004</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210812202449.png" alt="image-20210812202448414"></li>
<li>正常调用访问没有任何问题嗷！！！</li>
<li>Sentinel只对于84客户端进行监控嗷（为了实验方便呀！！！）</li>
<li>SentinelResource中的其他参数详解：<ul>
<li>fallback：这个参数指定了Java运行时异常时的处理方法，相当于Hystrix中的服务降级！！！</li>
<li>blockHandler：这个参数只负责sentinel控制台配置违规的降级处理嗷！！！</li>
<li>上面两个都有的时候，Java异常处理也是属于流水哦！！！当同时满足blockHandler和fallback的时候，blockHandler更猛！！！（本质Java异常处理也算一次流水，我直接截停你的流水，把你拦在门外，那你当然连错都不可能犯嗷！！！）</li>
<li>exceptionsToIgnore：忽略某个Java异常，在Java运行异常时正常抛出这个异常，不用兜底方法处理，让它自生自灭嗷！！！</li>
</ul>
</li>
<li>综上，功能十分强大，参数都配上，功能和性能都十分强大啊！！！</li>
</ul>
<h4 id="Feign系列："><a href="#Feign系列：" class="headerlink" title="Feign系列："></a>Feign系列：</h4><ul>
<li>Feign除了引入依赖之外，还要激活Sentinel对于Feign的支持嗷：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span> </span><br><span class="line">	<span class="attr">sentinel:</span></span><br><span class="line">		<span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>客户端主启动类上要加上@EnableFeignClients嗷！！！</li>
<li>客户端的Service接口上要加上@FeignClient</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813093800.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813092248.png" alt="image-20210813092248411"></p>
<p>@Component和@FeignClient不要忘了嗷！</p>
<h3 id="规则持久化："><a href="#规则持久化：" class="headerlink" title="规则持久化："></a>规则持久化：</h3><ul>
<li><p>重启Sentinel服务或业务类，规则就消失了orz，裂开来！！！</p>
</li>
<li><p>可以将Sentinel配置进Nacos来实现持久化嗷！！！</p>
</li>
<li><p>步骤（以8401为例子）：</p>
<ul>
<li>加入sentinel-datasource-nacos依赖</li>
<li>yaml中添加数据源的配置：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">  <span class="attr">ds1:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">      <span class="attr">dataId:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">      <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">      <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">      <span class="attr">rule-type:</span> <span class="string">flow</span></span><br></pre></td></tr></table></figure>

<ul>
<li>添加Nacos的配置：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813095717.png" alt="image-20210813095716810"></p>
</li>
</ul>
<p>JSON中的参数含义：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813095852.png" alt="image-20210813095851897"></p>
<ul>
<li>启动8401之后，发现就有流控规则嗷！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813100239.png" alt="image-20210813100238836"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813100344.png" alt="image-20210813100343838"></p>
<ul>
<li>就是由于上面这个的配置，让sentinel会去nacos取出对应配置名的项作为流控规则啊！！！</li>
<li>重启8401发现，流控规则还是存在的嗷！！！！！说白了就是将配置规则写入Nacos，间接写入Mysql，然后Sentinel每次从Nacos中去取出来呗！！！</li>
</ul>
<h1 id="Seata分布式事务："><a href="#Seata分布式事务：" class="headerlink" title="Seata分布式事务："></a>Seata分布式事务：</h1><ul>
<li>多数据源，多中心，跨数据库处理。要处理全局事务一致性问题嗷！！！</li>
<li>专业术语：</li>
<li>1+3：</li>
<li>1<ul>
<li>Transaction ID XID，全局唯一的ID</li>
</ul>
</li>
<li>3<ul>
<li>TC (Transaction Coordinator) - 事务协调者，维护全局和分支事务的状态，驱动全局事务提交或回滚。</li>
<li>TM (Transaction Manager) - 事务管理器，定义全局事务的范围：开始全局事务、提交或回滚全局事务。<ul>
<li>RM (Resource Manager) - 资源管理器，管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
</li>
</ul>
</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813111722.png" alt="image-20210813111713201"></li>
</ul>
<h2 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h2><ul>
<li>进入seata官网，找到对应的github页面，进入releases，下载seata-server（第二排看戏原则）</li>
<li>修改原始的file.conf文件（良好习惯，先备份，后修改嗷！！！）</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210813153356.png" alt="image-20210813153355897"></p>
<p>建立的数据库是需要脚本的嗷！！！看课程，并且在官网的scripts中找到mysql的脚本，在mysql中初始化对应的表才能够连的上嗷！！！</p>
<ul>
<li>1.4.2新版本的配置文件分开了，file.conf和registery.conf各自拥有一部分的配置。</li>
<li>file.conf需要修改数据库的连接（前提是数据库已经完成了相应的初始化）</li>
<li>registry.conf里面有关于config和registry的配置。registry改成nacos，我们使用nacos来操作嗷！！！</li>
</ul>
<h2 id="实践：-3"><a href="#实践：-3" class="headerlink" title="实践："></a>实践：</h2><ul>
<li>创建三个微服务：<ul>
<li>订单</li>
<li>库存</li>
<li>账户</li>
</ul>
</li>
<li>下订单 —&gt; 减余额 —&gt; 扣库存 —&gt; 改订单</li>
<li>要为三个微服务创建自己对应的微服务和微服务中的表嗷！！！</li>
<li>注意：电脑上下载了0.9.0和1.4.2两个版本，这两个版本有很大的问题，配置上非常多的不一样，这里记录一下自己踩的坑。</li>
</ul>
<h3 id="天坑："><a href="#天坑：" class="headerlink" title="天坑："></a>天坑：</h3><p>0.9.0：</p>
<ul>
<li>由于0.9.0的Lib中的mysql-connector的版本是5.x，我本机使用的是8.x，所以要手动移除5.x的jar包，添加8.x的jar包。</li>
<li>注意Mysql的8.x，在工程中使用的依赖是com.mysql.cj.jdbc.Driver，要引入这个Jar包嗷（默认就在connector依赖里面有这个Jar包）</li>
<li>1.4.2版本建立的表（官网给的）和0.9.0的Seata数据库的建表语句是<strong>不一样的</strong>！！！debug了整整一个上午，就是因为表不一样，找不到某个字段，把表重新建立一次就好。</li>
<li>不管是0.9.0还是1.4.2，启动的时候都会报Logback异常，这个没有关系，对于系统的运行没有影响。</li>
<li>一定要先启动Nacos，再启动Logback。</li>
<li>1.4.2和0.9.0相比，少了很多字段，具体缺了哪些，该怎么用，下去还要自己多看看官方文档学习嗷！！！</li>
<li>遇到了socket异常的问题，还有紧接着seata异常的问题，不知道怎么解决，晚上重启电脑之后自己好了？？？？注意嗷！！！重启是可以解决问题的嗷！！！</li>
<li>@GlobalTransaction帮助我们撤销微服务有问题的操作嗷！！！保证整个微服务系统的一致性！！！</li>
<li>这一章很难，很多细节，复习建议看看代码和网课嗷！！！</li>
</ul>
<h2 id="Seata原理（面试加分项）："><a href="#Seata原理（面试加分项）：" class="headerlink" title="Seata原理（面试加分项）："></a>Seata原理（面试加分项）：</h2><ol>
<li>Seata：</li>
</ol>
<ul>
<li>1.0版本及以上才支持集群嗷！！！工作以上就要使用使用1.0版本及以上的Seata啦！！！</li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18E411x7eT?p=148">多看视频嗷！！！，这个讲的很好嗷！！！</a></li>
<li><a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/dev/mode/at-mode.html">官网介绍，涉及AT模式原理</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/24/Spring-Cloud-Spring-Cloud-Alibaba/" data-id="cl6gepmg50043e0jq8zur6zdt" data-title="Spring Cloud + Spring Cloud Alibaba" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Springboot2-x" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/13/Springboot2-x/" class="article-date">
  <time class="dt-published" datetime="2021-07-13T01:32:16.000Z" itemprop="datePublished">2021-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/13/Springboot2-x/">SpringBoot2-x</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="针对于Boot2的新特性，有了这一期的学习，连着两次学习boot，刚好巩固基础了嗷！！！尚硅谷还是香哇！！！"><a href="#针对于Boot2的新特性，有了这一期的学习，连着两次学习boot，刚好巩固基础了嗷！！！尚硅谷还是香哇！！！" class="headerlink" title="针对于Boot2的新特性，有了这一期的学习，连着两次学习boot，刚好巩固基础了嗷！！！尚硅谷还是香哇！！！"></a>针对于Boot2的新特性，有了这一期的学习，连着两次学习boot，刚好巩固基础了嗷！！！尚硅谷还是香哇！！！</h1><h1 id="基础使用篇："><a href="#基础使用篇：" class="headerlink" title="基础使用篇："></a>基础使用篇：</h1><h2 id="Boot的升级："><a href="#Boot的升级：" class="headerlink" title="Boot的升级："></a>Boot的升级：</h2><ul>
<li>响应式编程：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713090303.png" alt="image-20210713090303630"></p>
<ul>
<li>接口中方法有默认实现，就不用把接口中的所有方法都写出来了，都有默认实现的，只用覆写我们要覆写的方法即可。（Java底层语法的升级，导致Adapter失效了，每个接口类中的抽象方法现在都是自带默认实现的嗷！！！我们直接对于需要覆写的方法进行覆写就可以啦！！！）</li>
</ul>
<h2 id="一些补充："><a href="#一些补充：" class="headerlink" title="一些补充："></a>一些补充：</h2><p><code>@RestController = @Controller + @ResponseBody</code></p>
<ul>
<li><p>@ResponseBody是将相应的内容直接以字符串的形式写到浏览器中嗷！！！就不会发生页面跳转啦！！！</p>
</li>
<li><p>相应的资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.yuque.com/atguigu/springboot">SpringBoot2课程笔记</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT/?p=4&spm_id_from=pageDriver">boot官方文档怎么使用</a></li>
<li><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-boot">SpringBoot官网</a></li>
</ul>
</li>
<li><p>自定义版本号：</p>
</li>
</ul>
<p>1、查看spring-boot-dependencies里面规定当前依赖的版本 用的 key。 </p>
<p>2、在当前项目里面重写配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&lt;properties&gt;</span></span><br><span class="line">    <span class="attr">&lt;mysql.version&gt;5.1.43&lt;/mysql.version&gt;</span></span><br><span class="line"><span class="attr">&lt;/properties&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>boot中的默认包结构配置：<ul>
<li>自动配好SpringMVC<ul>
<li>引入SpringMVC全套组件</li>
<li>自动配好SpringMVC常用组件（功能）</li>
</ul>
</li>
<li>自动配好Web常见功能，如：字符编码问题<ul>
<li>SpringBoot帮我们配置好了所有web开发的常见场景</li>
</ul>
</li>
<li>默认的包结构<ul>
<li>主程序所在包及其下面的所有子包里面的组件都会被默认扫描进来</li>
</ul>
</li>
<li>无需以前的包扫描配置</li>
<li>想要改变扫描路径，@SpringBootApplication(scanBasePackages&#x3D;<strong>“com.tuzi”</strong>)<ul>
<li>或者@ComponentScan 指定扫描路径</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line">等同于</span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.atguigu.boot&quot;)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>AutoConfigurer就是我们核心的自动配置包，只有引入对应的场景，对应的自动配置类才会生效嗷！！！</li>
</ul>
<h2 id="注解使用："><a href="#注解使用：" class="headerlink" title="注解使用："></a>注解使用：</h2><h3 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h3><ul>
<li>这个配置类就相当于原来的xml配置文件，这个就告诉Boot这是一个配置类。</li>
<li>原来的配置类（xml）是配置好了，Spring自动给你创建好对象。现在你用配置类来配置，那当然也要手动去创建对象然后加入到容器中去啊！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#############################Configuration使用示例######################################################</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、配置类里面使用<span class="doctag">@Bean</span>标注在方法上给容器注册组件，默认也是单实例的</span></span><br><span class="line"><span class="comment"> * 2、配置类本身也是组件</span></span><br><span class="line"><span class="comment"> * 3、proxyBeanMethods：代理bean的方法</span></span><br><span class="line"><span class="comment"> *      Full(proxyBeanMethods = true)、【保证每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是单实例的】</span></span><br><span class="line"><span class="comment"> *      Lite(proxyBeanMethods = false)【每个<span class="doctag">@Bean</span>方法被调用多少次返回的组件都是新创建的】</span></span><br><span class="line"><span class="comment"> *      组件依赖必须使用Full模式默认。其他默认是否Lite模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span> <span class="comment">//告诉SpringBoot这是一个配置类 == 配置文件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Full:外部无论对配置类中的这个组件注册方法调用多少次获取的都是之前注册容器中的单实例对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">//给容器中添加组件。以方法名作为组件的id。返回类型就是组件类型。返回的值，就是组件在容器中的实例</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">user01</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">zhangsan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="comment">//user组件依赖了Pet组件</span></span><br><span class="line">        <span class="comment">//但是如果标注了false的话，调用tomcatPet就会新建一个tomcatPet，而不是使用容器中的tomcatPet</span></span><br><span class="line">        zhangsan.setPet(tomcatPet());</span><br><span class="line">        <span class="keyword">return</span> zhangsan;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;tom&quot;)</span> <span class="comment">//tom可以给我们添加到容器中的组件命名嗷！！！</span></span><br><span class="line">    <span class="keyword">public</span> Pet <span class="title function_">tomcatPet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Pet</span>(<span class="string">&quot;tomcat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以前是指定&lt;bean id&#x3D;”…” class&#x3D;”…”&gt;，然后里面设置属性，现在就是手动去构造这个类，然后通过@Bean注解将我们构造的这个对象（返回值），来添加到容器中嗷！！！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">################################<span class="meta">@Configuration</span>测试代码如下########################################</span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.atguigu.boot&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//1、返回我们IOC容器</span></span><br><span class="line">        <span class="type">ConfigurableApplicationContext</span> <span class="variable">run</span> <span class="operator">=</span> SpringApplication.run(MainApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、查看容器里面的组件</span></span><br><span class="line">        String[] names = run.getBeanDefinitionNames();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            System.out.println(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、从容器中获取组件</span></span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom01</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom02</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;组件：&quot;</span>+(tom01 == tom02));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4、com.atguigu.boot.config.MyConfig$$EnhancerBySpringCGLIB$$51f1e1ca@1654a892</span></span><br><span class="line">        <span class="type">MyConfig</span> <span class="variable">bean</span> <span class="operator">=</span> run.getBean(MyConfig.class);</span><br><span class="line">        System.out.println(bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果@Configuration(proxyBeanMethods = true)代理对象调用方法。SpringBoot总会检查这个组件是否在容器中有。</span></span><br><span class="line">        <span class="comment">//保持组件单实例</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> bean.user01();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> bean.user01();</span><br><span class="line">        System.out.println(user == user1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user01</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;user01&quot;</span>, User.class);</span><br><span class="line">        <span class="type">Pet</span> <span class="variable">tom</span> <span class="operator">=</span> run.getBean(<span class="string">&quot;tom&quot;</span>, Pet.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;用户的宠物：&quot;</span>+(user01.getPet() == tom));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>true又叫做lite模式，如果容器中有，就从容器中将对应的对象拿出来，就可能会产生依赖关系。false的话又被称为full模式，每一次都会生成一个新的对象，就不会产生依赖关系。</li>
</ul>
<h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><ul>
<li>可以使用在自定的MyConfig文件或其他能被扫描到的位置都可以嗷</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713192105.png" alt="image-20210713192105621"></p>
<ul>
<li><p>@Import导入的默认组件的名字是全类名嗷！！！</p>
</li>
<li><p>主方法中可以通过下面的代码进行测试：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713192351.png" alt="image-20210713192350950"></p>
<ul>
<li>第一个是获取获取特定类型的所有组件，第二个是获取对应类型的特定组件。</li>
</ul>
<h3 id="Conditional"><a href="#Conditional" class="headerlink" title="@Conditional"></a>@Conditional</h3><ul>
<li><p>条件装配</p>
</li>
<li><p>满足条件的时候，才能够引入其后面跟着的类嗷！！！</p>
</li>
<li><p>它和儿子们：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713192708.png" alt="image-20210713192708656"></p>
<p>上面这些都是@Conditional和它延申出来的实现类嗷！！！</p>
<ul>
<li>例如OnBean，有某个组件的时候，才干什么行为。</li>
<li>run.containsBean()能够判断容器中是否有某个组件，根据组件名字去获取，返回值是boolean嗷！！！</li>
<li><code>@ConditionalOnBean(name = &quot;tom&quot;)</code>这种形式是用来扫描容器中是否有名字为tom的组件。注解可以注释到某个方法或某个类上，只有判断成立，类中或者方法中相应的配置才会生效嗷！！！</li>
<li>@Bean这个始终要有的哈，没有@Bean，就算条件装配也救不了你嗷！！！</li>
</ul>
<h3 id="ImportResource"><a href="#ImportResource" class="headerlink" title="@ImportResource"></a>@ImportResource</h3><ul>
<li>导入对应的资源配置。（@ImportResource(“classpath: beans.xml”)）</li>
<li>这个注解还允许我们使用之前的xml配置，导入了对应的路径之后，这个配置就生效了嗷！！！就能够根据我们的xml以之前的形式生成对应bean，这个注解放在扫描类的最外面注解就行啦！！！</li>
</ul>
<h3 id="属性自动配置（-ComfigurationProperties）："><a href="#属性自动配置（-ComfigurationProperties）：" class="headerlink" title="属性自动配置（@ComfigurationProperties）："></a>属性自动配置（@ComfigurationProperties）：</h3><h4 id="Component-ConfigurationProperties"><a href="#Component-ConfigurationProperties" class="headerlink" title="@Component + @ConfigurationProperties"></a>@Component + @ConfigurationProperties</h4><ul>
<li><p>如果单独使用@ConfigurationProperites的话，要和@Component捆绑使用嗷！！！</p>
</li>
<li><p>使用场景是我们之前的配置文件绑定到对应的对象，我们当时要写一个类。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">getProperties</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException, IOException &#123;</span><br><span class="line">         <span class="type">Properties</span> <span class="variable">pps</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">         pps.load(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;a.properties&quot;</span>));</span><br><span class="line">         <span class="type">Enumeration</span> <span class="variable">enum1</span> <span class="operator">=</span> pps.propertyNames();<span class="comment">//得到配置文件的名字</span></span><br><span class="line">         <span class="keyword">while</span>(enum1.hasMoreElements()) &#123;</span><br><span class="line">             <span class="type">String</span> <span class="variable">strKey</span> <span class="operator">=</span> (String) enum1.nextElement();</span><br><span class="line">             <span class="type">String</span> <span class="variable">strValue</span> <span class="operator">=</span> pps.getProperty(strKey);</span><br><span class="line">             System.out.println(strKey + <span class="string">&quot;=&quot;</span> + strValue);</span><br><span class="line">             <span class="comment">//封装到JavaBean。</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面这个就是我们之前写的，需要自己去解析配置文件，然后对应好相应的属性，封装到JavaBean中嗷！！！（有点复杂）</li>
<li>ConfigurationProperties就是帮你完成这个的嗷！！！ConfigurationProperties的例子嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 只有在容器中的组件，才会拥有SpringBoot提供的强大功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mycar&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String brand;</span><br><span class="line">    <span class="keyword">private</span> Integer price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getBrand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBrand</span><span class="params">(String brand)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.brand = brand;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPrice</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrice</span><span class="params">(Integer price)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Car&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;brand=&#x27;&quot;</span> + brand + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, price=&quot;</span> + price +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>标注了Prefix之后，这个类的配置就和我们的application.properties(.yml)绑定上了嗷！！！我们就可以通过在配置文件中配置相应的属性，来对于对应的类进行配置。</li>
<li>application.properities中：</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mycar.brand</span>=<span class="string">tesla</span></span><br><span class="line"><span class="attr">mycar.price</span>=<span class="string">300000</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意，由于@Component，这个时候组件已经在容器中了。是可以通过@Autowired来获取对应的组件的嗷！！！</li>
</ul>
<h4 id="EnableConfigurationProperties-ConfigurationProperties"><a href="#EnableConfigurationProperties-ConfigurationProperties" class="headerlink" title="@EnableConfigurationProperties + @ConfigurationProperties"></a>@EnableConfigurationProperties + @ConfigurationProperties</h4><ul>
<li>必须在配置类中写或者在启动类中写</li>
<li>@EnableConfigurationProperties（Car.class）<ul>
<li>它的作用：<ul>
<li>开启Car的属性配置功能</li>
<li>并且把Car这个组件自动注册到容器中（这个时候就不用在对应的类上写@Component啦！！！）：<ul>
<li>解决了有的时候，别人的类是第三方写好的，上面改不了，加不了@Component注解这个问题嗷！！！</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="自动配置原理："><a href="#自动配置原理：" class="headerlink" title="自动配置原理："></a>自动配置原理：</h2><ul>
<li>一顶三（三个核心注解）：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713201014.png" alt="image-20210713201014773"></p>
<h3 id="SpringBootConfiguration"><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration:"></a>@SpringBootConfiguration:</h3><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713201128.png" alt="image-20210713201128058"></p>
<ul>
<li>本质上就是一个@Configuration，代表当前类是一个配置类。</li>
</ul>
<h3 id="EnableAutoConfiguration-最重要"><a href="#EnableAutoConfiguration-最重要" class="headerlink" title="@EnableAutoConfiguration(最重要)"></a>@EnableAutoConfiguration(最重要)</h3><ul>
<li>由下面两个注解合成：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>@AutoConfigurationPackage:</p>
<ul>
<li>由下面的@组成：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(AutoConfigurationPackages.Registrar.class)</span>  <span class="comment">//给容器中导入一个组件</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//利用Registrar给容器中导入一系列组件</span></span><br><span class="line"><span class="comment">//将指定的一个包下的所有组件导入进来？MainApplication 所在包下。</span></span><br></pre></td></tr></table></figure>

<ul>
<li>自动配置包</li>
<li>利用Registrar给容器中导入一系列组件(这里体现了，为什么主启动类同一层级所在的包和子包都能够被Boot识别和导入嗷！！！)</li>
<li>由于ACP -&gt; EAC -&gt; SBC，因此，SBC即主配置类即AutoConfigurationPackage真正标注的地方，这个地方才导向到了我们所谓的“主配置所在层级的包，以及这个包以下的子包！！！”</li>
</ul>
</li>
<li><p>@Import({AutoConfigurationImportSelector.class})：</p>
<ul>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713220500.png" alt="image-20210713220500529"></p>
</li>
<li><p>上面的AutoConfigurationImportSelector的核心方法selectImports中的核心方法orz。</p>
</li>
<li><p>&#96;&#96;&#96;java<br>1、利用getAutoConfigurationEntry(annotationMetadata);给容器中批量导入一些组件<br>2、调用List<String> configurations &#x3D; getCandidateConfigurations(annotationMetadata, attributes)获取到所有需要导入到容器中的配置类<br>3、利用工厂加载 Map&lt;String, List<String>&gt; loadSpringFactories(@Nullable ClassLoader classLoader)；得到所有的组件<br>4、从META-INF&#x2F;spring.factories位置来加载一个文件。<br>默认扫描我们当前系统里面所有META-INF&#x2F;spring.factories位置的文件<br>spring-boot-autoconfigure-2.3.4.RELEASE.jar包里面也有META-INF&#x2F;spring.factories</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- getCandidateConfigurations这个方法很重要，获得了我们的configurations，如下图所示嗷：![image-20210713220752294](https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210713220752.png)</span><br><span class="line"></span><br><span class="line">- ```xml</span><br><span class="line">  文件里面写死了spring-boot一启动就要给容器中加载的所有配置类</span><br><span class="line">  spring-boot-autoconfigure-2.3.4.RELEASE.jar/META-INF/spring.factories</span><br><span class="line">  # Auto Configure</span><br><span class="line">  org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">  org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.elasticsearch.ReactiveElasticsearchRestClientAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.solr.SolrRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.r2dbc.R2dbcDataAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.r2dbc.R2dbcRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.r2dbc.R2dbcTransactionManagerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchRestClientAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.availability.ApplicationAvailabilityAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.r2dbc.R2dbcAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.rsocket.RSocketMessagingAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.rsocket.RSocketRequesterAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.rsocket.RSocketServerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.rsocket.RSocketStrategiesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.rsocket.RSocketSecurityAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.saml2.Saml2RelyingPartyAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.session.SessionAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.oauth2.client.servlet.OAuth2ClientAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.oauth2.client.reactive.ReactiveOAuth2ClientAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.reactive.function.client.ClientHttpConnectorAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration,\</span><br><span class="line">  org.springframework.boot.autoconfigure.webservices.client.WebServiceTemplateAutoConfiguration</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>开启自动配置项：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">虽然我们<span class="number">127</span>个场景的所有自动配置启动的时候默认全部加载。xxxxAutoConfiguration</span><br><span class="line">按照条件装配规则（<span class="meta">@Conditional</span>），最终会按需配置。</span><br></pre></td></tr></table></figure>

<ul>
<li>所以，启动先加载所有的所有的配置到Configuration变量中，最终生效是由条件配置来决定的嗷！！！</li>
</ul>
<h3 id="ComponentScan-“com-tuzi-boot”"><a href="#ComponentScan-“com-tuzi-boot”" class="headerlink" title="@ComponentScan(“com.tuzi.boot”)"></a>@ComponentScan(“com.tuzi.boot”)</h3><ul>
<li>对于扫描父包路径进行指定！！！（指定扫描某些package），从中获取Bean（类似于MyConfig类中的组件），记得这个是Scan to get Components！！！</li>
</ul>
<h3 id="Skills："><a href="#Skills：" class="headerlink" title="Skills："></a>Skills：</h3><ul>
<li>回头看配置类是否能够生效，找到对应的包下的autoconfigurer文件夹，找到对应的功能（例如cache）和其对应的自动配置类（例如CacheAutoConfiguration），然后去看起的了作用不？</li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT?p=15&spm_id_from=pageDriver">这一课讲的非常好，探索底层嗷！！！</a></li>
<li>特殊语法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(MultipartResolver.class)</span>  <span class="comment">//容器中有这个类型组件</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span> <span class="comment">//容器中没有这个名字 multipartResolver 的组件</span></span><br><span class="line"><span class="keyword">public</span> MultipartResolver <span class="title function_">multipartResolver</span><span class="params">(MultipartResolver resolver)</span> &#123;</span><br><span class="line">    <span class="comment">//给@Bean标注的方法传入了对象参数，这个参数的值就会从容器中找。</span></span><br><span class="line">    <span class="comment">//SpringMVC multipartResolver。防止有些用户配置的文件上传解析器不符合规范</span></span><br><span class="line">    <span class="comment">// Detect if the user has created a MultipartResolver but named it incorrectly</span></span><br><span class="line">    <span class="keyword">return</span> resolver;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//给容器中加入了文件上传解析器，相当于更名嗷！！！</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>设计模式：</p>
<ul>
<li>通过@ConditionalOnMissingBean这种方式，来实现会在底层配好所有的组件，但是如果用户自己配置了的话，以用户的优先。</li>
<li>那用户怎么配置呢？那简单啊，你在用户的配置类中（标注有@Confuration），使用@Bean来向容器中加入我自己配置的组件，容器就不会配置默认的组件了嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="keyword">public</span> CharacterEncodingFilter <span class="title function_">characterEncodingFilter</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




</li>
<li><p>总结：</p>
<ul>
<li>SpringBoot先加载所有的自动配置类  xxxxxAutoConfiguration</li>
<li>每个自动配置类按照条件进行生效，默认都会绑定配置文件指定的值。xxxxProperties里面拿。xxxProperties和配置文件进行了绑定</li>
<li>生效的配置类就会给容器中装配很多组件</li>
<li>只要容器中有这些组件，相当于这些功能就有了</li>
<li>定制化配置：<ul>
<li>用户直接自己@Bean替换底层的组件</li>
<li>用户去看这个组件是获取的配置文件什么值就去修改。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>xxxxxAutoConfiguration —&gt; 组件  —&gt;</strong> <strong>xxxxProperties里面拿值  —-&gt; application.properties</strong></p>
<p>两个很有意思的东西：</p>
<ul>
<li>想换掉源码中底层给你配置的某个默认配置类，使用@Bean自己写一个就完了嘛。</li>
<li>在Properties中使用绑定配置，所以可以在xxxProperties配置中找到你需要的值，然后在配置文件中去改嗷！！！</li>
</ul>
<h2 id="大彻大悟！！！上面讲的这一串太好了！！！"><a href="#大彻大悟！！！上面讲的这一串太好了！！！" class="headerlink" title="大彻大悟！！！上面讲的这一串太好了！！！"></a>大彻大悟！！！上面讲的这一串太好了！！！</h2><h2 id="最佳实践："><a href="#最佳实践：" class="headerlink" title="最佳实践："></a>最佳实践：</h2><ul>
<li><p>引入场景依赖</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter">https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter</a></li>
</ul>
</li>
<li><p>查看自动配置了哪些（选做）</p>
<ul>
<li>自己分析，引入场景对应的自动配置一般都生效了</li>
<li>配置文件中debug&#x3D;true开启自动配置报告。Negative（不生效）\Positive（生效）</li>
</ul>
</li>
<li><p>是否需要修改</p>
<ul>
<li>参照文档修改配置项<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties">https://docs.spring.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#common-application-properties</a></li>
<li>自己分析。xxxxProperties绑定了配置文件的哪些。</li>
</ul>
</li>
</ul>
</li>
<li><p>自定义加入或者替换组件</p>
<ul>
<li>@Bean、@Component……（用户配置优先）</li>
</ul>
</li>
<li><p>自定义器  <strong>XXXXXCustomizer</strong>；</p>
</li>
<li><p>……</p>
</li>
</ul>
<h1 id="开发小技巧："><a href="#开发小技巧：" class="headerlink" title="开发小技巧："></a>开发小技巧：</h1><h2 id="Lombok："><a href="#Lombok：" class="headerlink" title="Lombok："></a>Lombok：</h2><ul>
<li>简化JavaBean的开发：<ul>
<li>getter and setter</li>
<li>constructor</li>
<li>tostring</li>
<li>麻烦子！！！</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--idea中搜索安装lombok插件--&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编译的时候会自动生成对应的setter和getter方法嗷！！！</li>
<li>引入了对应的插件之后，@Data这个注解就会自动帮忙在编译的时候生成getter和setter方法嗷。</li>
<li>当引入@Data时，原本灰色的属性编程紫色了，说明这个注解引入成功了嗷！！！</li>
<li>同理，@ToString就能够帮助我们在编译的时候自动生成ToString方法</li>
<li>总结，引入了Maven并且安装了lombok插件后，有如下可用的注解：<ul>
<li>@Data：getter and setter</li>
<li>@ToString：toString method</li>
<li>@NoArgsConstructor：无参构造器</li>
<li>@AllArgsConstructor：全参构造器</li>
<li>@EqualsAndHashCode：哈希码方法</li>
<li>@Slf4j：日志构造器，就可以直接使用日志啦！！！</li>
</ul>
</li>
<li>根据情况使用，比如全参不好用，那我们就不注解，除此之外，我们仍然可以定制自己的构造器嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">===============================简化JavaBean开发===================================</span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="comment">//@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Pet pet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String name,Integer age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">================================简化日志开发===================================</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handle01</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span>&#123;</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;请求进来了....&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, Spring Boot 2!&quot;</span>+<span class="string">&quot;你好：&quot;</span>+name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="dev-tools："><a href="#dev-tools：" class="headerlink" title="dev-tools："></a>dev-tools：</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>Ctrl+F9</code>就能够快速实现“热更新”（本质上如果时动态文件就重启，静态页面就刷新嗷！！！）</li>
</ul>
<h2 id="Spring-Initializer："><a href="#Spring-Initializer：" class="headerlink" title="Spring Initializer："></a>Spring Initializer：</h2><ul>
<li>这个我就熟啦，不介绍啦，经常用嗷！！！</li>
<li>引入依赖，创建好了我们的项目结构嗷之类的嗷！！！</li>
</ul>
<h1 id="核心功能篇："><a href="#核心功能篇：" class="headerlink" title="核心功能篇："></a>核心功能篇：</h1><h2 id="Yaml："><a href="#Yaml：" class="headerlink" title="Yaml："></a>Yaml：</h2><ul>
<li><p>语法：</p>
<h3 id="1-2-3、数据类型"><a href="#1-2-3、数据类型" class="headerlink" title="1.2.3、数据类型"></a>1.2.3、数据类型</h3><ul>
<li>字面量：单个的、不可再分的值。date、boolean、string、number、null</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">k:</span> <span class="string">v</span></span><br></pre></td></tr></table></figure>

<ul>
<li>对象：键值对的集合。map、hash、set、object</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">行内写法：</span>  <span class="attr">k:</span> &#123;<span class="string">k1:v1</span>,<span class="string">k2:v2</span>,<span class="string">k3:v3</span>&#125;</span><br><span class="line"><span class="comment">#或</span></span><br><span class="line"><span class="attr">k:</span> </span><br><span class="line">  <span class="attr">k1:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">k2:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">k3:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure>

<ul>
<li>数组：一组按次序排列的值。array、list、queue</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">行内写法：</span>  <span class="attr">k:</span> [<span class="string">v1</span>,<span class="string">v2</span>,<span class="string">v3</span>]</span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line"><span class="attr">k:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">v1</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">v2</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>示例：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperities(prefix=&quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String userName;</span><br><span class="line">	<span class="keyword">private</span> Boolean boss;</span><br><span class="line">	<span class="keyword">private</span> Date birth;</span><br><span class="line">	<span class="keyword">private</span> Integer age;</span><br><span class="line">	<span class="keyword">private</span> Pet pet;</span><br><span class="line">	<span class="keyword">private</span> String[] interests;</span><br><span class="line">	<span class="keyword">private</span> List&lt;String&gt; animal;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; score;</span><br><span class="line">	<span class="keyword">private</span> Set&lt;Double&gt; salarys;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, List&lt;Pet&gt;&gt; allPets;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pet</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> Double weight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>yaml和properties配置文件都存在的情况下会同时生效嗷！！！</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yaml表示以上对象</span></span><br><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">userName:</span> <span class="string">zhangsan</span></span><br><span class="line">  <span class="attr">boss:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">birth:</span> <span class="number">2019</span><span class="string">/12/12</span> <span class="number">20</span><span class="string">:12:33</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">  <span class="attr">pet:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">weight:</span> <span class="number">23.4</span></span><br><span class="line">  <span class="attr">interests:</span> [<span class="string">篮球</span>,<span class="string">游泳</span>]</span><br><span class="line">  <span class="attr">animal:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">jerry</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mario</span></span><br><span class="line">  <span class="attr">score:</span></span><br><span class="line">    <span class="attr">english:</span> </span><br><span class="line">      <span class="attr">first:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">second:</span> <span class="number">40</span></span><br><span class="line">      <span class="attr">third:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">math:</span> [<span class="number">131</span>,<span class="number">140</span>,<span class="number">148</span>]</span><br><span class="line">    <span class="attr">chinese:</span> &#123;<span class="attr">first:</span> <span class="number">128</span>,<span class="attr">second:</span> <span class="number">136</span>&#125;</span><br><span class="line">  <span class="attr">salarys:</span> [<span class="number">3999</span>,<span class="number">4999.98</span>,<span class="number">5999.99</span>]</span><br><span class="line">  <span class="attr">allPets:</span></span><br><span class="line">    <span class="attr">sick:</span></span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">tom</span>&#125;</span><br><span class="line">      <span class="bullet">-</span> &#123;<span class="attr">name:</span> <span class="string">jerry</span>,<span class="attr">weight:</span> <span class="number">47</span>&#125;</span><br><span class="line">    <span class="attr">health:</span> [&#123;<span class="attr">name:</span> <span class="string">mario</span>,<span class="attr">weight:</span> <span class="number">47</span>&#125;]</span><br></pre></td></tr></table></figure>

<ul>
<li>List和String[]和Set在yaml中的配置都是一样的嗷，有行内写法和数组写法两种嗷！！！</li>
<li>测试是否书写正确：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210714110023.png" alt="image-20210714110023281"></p>
<ul>
<li>yaml中不用加单双引号，加了也没事儿，都是字符串嗷！！！但是有\n之类的，双引号就会转义为换行。单引号就不会转义而是选择作为字符串正常输出，有点像shell编程嗷！！！</li>
</ul>
<h2 id="注释处理器："><a href="#注释处理器：" class="headerlink" title="注释处理器："></a>注释处理器：</h2><ul>
<li><p>我们自己写的prefix没有提示，就很容易出问题嗷！！！自定义的类和配置文件绑定一般没有提示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>导入之后：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210714111433.png" alt="image-20210714111433692"></p>
<p>把项目重新跑一次，跑完之后生成了对应的meta能用了嗷！！！</p>
<ul>
<li>运行然后停止，再一次在yaml中输入对应的内容的时候，就有提示啦！！！如下图所示：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210714111749.png" alt="image-20210714111748902"></p>
<ul>
<li>这个功能和业务无关，开发好用，部署不用。所以打包的时候将其排除在外，所以才有了下面那一段的配置，打包的时候排除了这个提示的类嗷！！！</li>
</ul>
<h2 id="Web开发："><a href="#Web开发：" class="headerlink" title="Web开发："></a>Web开发：</h2><h3 id="1、SpringMVC自动配置概览"><a href="#1、SpringMVC自动配置概览" class="headerlink" title="1、SpringMVC自动配置概览"></a>1、SpringMVC自动配置概览</h3><p>Spring Boot provides auto-configuration for Spring MVC that <strong>works well with most applications.(大多场景我们都无需自定义配置)</strong></p>
<p>The auto-configuration adds the following features on top of Spring’s defaults:</p>
<ul>
<li><p>Inclusion of <code>ContentNegotiatingViewResolver</code> and <code>BeanNameViewResolver</code> beans.</p>
<ul>
<li>内容协商视图解析器和BeanName视图解析器</li>
</ul>
</li>
<li><p>Support for serving static resources, including support for WebJars (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-static-content">later in this document</a>)).</p>
<ul>
<li>静态资源（包括webjars）</li>
</ul>
</li>
<li><p>Automatic registration of <code>Converter</code>, <code>GenericConverter</code>, and <code>Formatter</code> beans.</p>
<ul>
<li>自动注册 <code>Converter，GenericConverter，Formatter </code></li>
</ul>
</li>
<li><p>Support for <code>HttpMessageConverters</code> (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-message-converters">later in this document</a>).</p>
<ul>
<li>支持 <code>HttpMessageConverters</code> （后来我们配合内容协商理解原理）</li>
</ul>
</li>
<li><p>Automatic registration of <code>MessageCodesResolver</code> (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-message-codes">later in this document</a>).</p>
<ul>
<li>自动注册 <code>MessageCodesResolver</code> （国际化用）</li>
</ul>
</li>
<li><p>Static <code>index.html</code> support.</p>
<ul>
<li>静态index.html 页支持</li>
</ul>
</li>
<li><p>Custom <code>Favicon</code> support (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-favicon">later in this document</a>).</p>
<ul>
<li>自定义 <code>Favicon</code></li>
</ul>
</li>
<li><p>Automatic use of a <code>ConfigurableWebBindingInitializer</code> bean (covered <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-spring-mvc-web-binding-initializer">later in this document</a>).</p>
<ul>
<li>自动使用 <code>ConfigurableWebBindingInitializer</code> ，（DataBinder负责将请求数据绑定到JavaBean上）</li>
</ul>
</li>
</ul>
<h4 id="Boot提供的自动配置方法："><a href="#Boot提供的自动配置方法：" class="headerlink" title="Boot提供的自动配置方法："></a>Boot提供的自动配置方法：</h4><blockquote>
<p>If you want to keep those Spring Boot MVC customizations and make more <a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/5.2.9.RELEASE/spring-framework-reference/web.html#mvc">MVC customizations</a> (interceptors, formatters, view controllers, and other features), you can add your own <code>@Configuration</code> class of type <code>WebMvcConfigurer</code> but <strong>without</strong> <code>@EnableWebMvc</code>.</p>
</blockquote>
<p><strong>不用@EnableWebMvc注解。使用</strong> <code>**@Configuration**</code> <strong>+</strong> <code>**WebMvcConfigurer**</code> <strong>自定义规则</strong></p>
<blockquote>
<p>If you want to provide custom instances of <code>RequestMappingHandlerMapping</code>, <code>RequestMappingHandlerAdapter</code>, or <code>ExceptionHandlerExceptionResolver</code>, and still keep the Spring Boot MVC customizations, you can declare a bean of type <code>WebMvcRegistrations</code> and use it to provide custom instances of those components.</p>
</blockquote>
<p><strong>声明</strong> <code>**WebMvcRegistrations**</code> <strong>改变默认底层组件</strong></p>
<blockquote>
<p>If you want to take complete control of Spring MVC, you can add your own <code>@Configuration</code> annotated with <code>@EnableWebMvc</code>, or alternatively add your own <code>@Configuration</code>-annotated <code>DelegatingWebMvcConfiguration</code> as described in the Javadoc of <code>@EnableWebMvc</code>.</p>
</blockquote>
<p><strong>使用</strong> <code>**@EnableWebMvc+@Configuration+DelegatingWebMvcConfiguration 全面接管SpringMVC**</code></p>
<h3 id="2、简单功能分析"><a href="#2、简单功能分析" class="headerlink" title="2、简单功能分析"></a>2、简单功能分析</h3><h4 id="2-1、静态资源访问"><a href="#2-1、静态资源访问" class="headerlink" title="2.1、静态资源访问"></a>2.1、静态资源访问</h4><h5 id="1、静态资源目录"><a href="#1、静态资源目录" class="headerlink" title="1、静态资源目录"></a>1、静态资源目录</h5><p>只要静态资源放在类路径下： called <code>/static</code> (or <code>/public</code> or <code>/resources</code> or <code>/META-INF/resources</code></p>
<p>浏览器访问 ： 当前项目根路径&#x2F; + 静态资源名 </p>
<p>原理： 静态映射&#x2F;**。</p>
<p>请求进来，先去找<strong>Controller</strong>看能不能处理。不能处理的所有请求又都交给<strong>静态资源处理器</strong>。静态资源也找不到则响应404页面。（先动态处理，后静态处理，找不到就404）</p>
<p>改变默认的静态资源路径：解决拦截器会拦截所有页面的问题，可以通过前缀的这种方式来放行对于静态资源的请求嗷！！！</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/res/**</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">static-locations:</span> [<span class="string">classpath:/haha/</span>]</span><br></pre></td></tr></table></figure>



<h5 id="2、静态资源访问前缀"><a href="#2、静态资源访问前缀" class="headerlink" title="2、静态资源访问前缀"></a>2、静态资源访问前缀</h5><p>默认无前缀</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/res/**</span></span><br></pre></td></tr></table></figure>

<p>当前项目 + static-path-pattern + 静态资源名 &#x3D; 静态资源文件夹下找对应的静态文件嗷！！！</p>
<h5 id="3、静态资源访问位置修改"><a href="#3、静态资源访问位置修改" class="headerlink" title="3、静态资源访问位置修改"></a>3、静态资源访问位置修改</h5><p>默认就是上面那一些，但是可以修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">static-locations:</span> [<span class="string">classpath:/haha/</span>]</span><br></pre></td></tr></table></figure>





<h5 id="4、webjar（使用位置）"><a href="#4、webjar（使用位置）" class="headerlink" title="4、webjar（使用位置）"></a>4、webjar（使用位置）</h5><ul>
<li>将css和js打成了jar包方便使用，例如jquery哇，就是webjar嗷！！！（提供了一些配置好的样式和行为之类的嗷！！！）</li>
<li>这一类的内容都是从专门的webjars官网上扒相关的依赖扒出来的，这种jar包有自己独特的结构。boot整合了这些jar包，并且能够访问这种结构下的静态资源，就是我们现在所见到的webjars</li>
<li>引入了新的依赖，我们需要重新加载项目进行加载嗷！！！</li>
</ul>
<p>自动映射 &#x2F;<a target="_blank" rel="noopener" href="http://localhost:8080/webjars/jquery/3.5.1/jquery.js">webjars</a>&#x2F;**</p>
<p><a target="_blank" rel="noopener" href="https://www.webjars.org/">https://www.webjars.org/</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.webjars<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jquery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/webjars/jquery/3.5.1/jquery.js">http://localhost:8080/webjars/<strong>jquery&#x2F;3.5.1&#x2F;jquery.js</strong></a>   后面地址要按照依赖里面的包路径</p>
<h4 id="2-2、欢迎页支持"><a href="#2-2、欢迎页支持" class="headerlink" title="2.2、欢迎页支持"></a>2.2、欢迎页支持</h4><ul>
<li>静态资源路径下  index.html<ul>
<li>可以配置静态资源路径</li>
<li>但是不可以配置静态资源的访问前缀。否则导致 index.html不能被默认访问</li>
</ul>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#  mvc:</span></span><br><span class="line"><span class="comment">#    static-path-pattern: /res/**   这个会导致welcome page功能失效</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">static-locations:</span> [<span class="string">classpath:/haha/</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>controller能处理&#x2F;index</li>
</ul>
<h4 id="2-3、自定义-Favicon"><a href="#2-3、自定义-Favicon" class="headerlink" title="2.3、自定义 Favicon"></a>2.3、自定义 <code>Favicon</code></h4><p>favicon.ico 放在静态资源目录下即可。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#  mvc:</span></span><br><span class="line"><span class="comment">#    static-path-pattern: /res/**   这个会导致 Favicon 功能失效</span></span><br></pre></td></tr></table></figure>





<h4 id="2-4、静态资源配置原理"><a href="#2-4、静态资源配置原理" class="headerlink" title="2.4、静态资源配置原理"></a>2.4、静态资源配置原理</h4><ul>
<li>SpringBoot启动默认加载  xxxAutoConfiguration 类（自动配置类）</li>
<li>SpringMVC功能的自动配置类 WebMvcAutoConfiguration，生效</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; Servlet.class, DispatcherServlet.class, WebMvcConfigurer.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; DispatcherServletAutoConfiguration.class, TaskExecutionAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">		ValidationAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcAutoConfiguration</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>给容器中配了什么。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Import(EnableWebMvcConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123; WebMvcProperties.class, ResourceProperties.class &#125;)</span></span><br><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WebMvcAutoConfigurationAdapter</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置文件的相关属性和xxx进行了绑定。WebMvcProperties=&#x3D;<strong>spring.mvc</strong>、ResourceProperties=&#x3D;<strong>spring.resources</strong></li>
</ul>
<h5 id="1、配置类只有一个有参构造器"><a href="#1、配置类只有一个有参构造器" class="headerlink" title="1、配置类只有一个有参构造器"></a>1、配置类只有一个有参构造器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">//有参构造器所有参数的值都会从容器中确定</span></span><br><span class="line"><span class="comment">//ResourceProperties resourceProperties；获取和spring.resources绑定的所有的值的对象</span></span><br><span class="line"><span class="comment">//WebMvcProperties mvcProperties 获取和spring.mvc绑定的所有的值的对象</span></span><br><span class="line"><span class="comment">//ListableBeanFactory beanFactory Spring的beanFactory</span></span><br><span class="line"><span class="comment">//HttpMessageConverters 找到所有的HttpMessageConverters</span></span><br><span class="line"><span class="comment">//ResourceHandlerRegistrationCustomizer 找到 资源处理器的自定义器。=========</span></span><br><span class="line"><span class="comment">//DispatcherServletPath  </span></span><br><span class="line"><span class="comment">//ServletRegistrationBean   给应用注册Servlet、Filter....</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">WebMvcAutoConfigurationAdapter</span><span class="params">(ResourceProperties resourceProperties, WebMvcProperties mvcProperties,</span></span><br><span class="line"><span class="params">                                      ListableBeanFactory beanFactory, ObjectProvider&lt;HttpMessageConverters&gt; messageConvertersProvider,</span></span><br><span class="line"><span class="params">                                      ObjectProvider&lt;ResourceHandlerRegistrationCustomizer&gt; resourceHandlerRegistrationCustomizerProvider,</span></span><br><span class="line"><span class="params">                                      ObjectProvider&lt;DispatcherServletPath&gt; dispatcherServletPath,</span></span><br><span class="line"><span class="params">                                      ObjectProvider&lt;ServletRegistrationBean&lt;?&gt;&gt; servletRegistrations)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.resourceProperties = resourceProperties;</span><br><span class="line">    <span class="built_in">this</span>.mvcProperties = mvcProperties;</span><br><span class="line">    <span class="built_in">this</span>.beanFactory = beanFactory;</span><br><span class="line">    <span class="built_in">this</span>.messageConvertersProvider = messageConvertersProvider;</span><br><span class="line">    <span class="built_in">this</span>.resourceHandlerRegistrationCustomizer = resourceHandlerRegistrationCustomizerProvider.getIfAvailable();</span><br><span class="line">    <span class="built_in">this</span>.dispatcherServletPath = dispatcherServletPath;</span><br><span class="line">    <span class="built_in">this</span>.servletRegistrations = servletRegistrations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h5 id="2、资源处理的默认规则"><a href="#2、资源处理的默认规则" class="headerlink" title="2、资源处理的默认规则"></a>2、资源处理的默认规则</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">    <span class="comment">//resourceProperties是从容器中拿的，静态资源访问的配置。</span></span><br><span class="line">    <span class="comment">//如果这里整成false，往下走不了，后面所有的静态资源都生效不了嗷！！！</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">this</span>.resourceProperties.isAddMappings()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Default resource handling disabled&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Duration</span> <span class="variable">cachePeriod</span> <span class="operator">=</span> <span class="built_in">this</span>.resourceProperties.getCache().getPeriod();</span><br><span class="line">    <span class="type">CacheControl</span> <span class="variable">cacheControl</span> <span class="operator">=</span> <span class="built_in">this</span>.resourceProperties.getCache().getCachecontrol().toHttpCacheControl();</span><br><span class="line">    <span class="comment">//webjars的规则</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.hasMappingForPattern(<span class="string">&quot;/webjars/**&quot;</span>)) &#123;</span><br><span class="line">        customizeResourceHandlerRegistration(registry.addResourceHandler(<span class="string">&quot;/webjars/**&quot;</span>)</span><br><span class="line">     .addResourceLocations(<span class="string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>)</span><br><span class="line">                                             .setCachePeriod(getSeconds(cachePeriod)).setCacheControl(cacheControl));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">staticPathPattern</span> <span class="operator">=</span> <span class="built_in">this</span>.mvcProperties.getStaticPathPattern();</span><br><span class="line">    <span class="keyword">if</span> (!registry.hasMappingForPattern(staticPathPattern)) &#123;</span><br><span class="line">        customizeResourceHandlerRegistration(registry.addResourceHandler(staticPathPattern)</span><br><span class="line">                                             .addResourceLocations(getResourceLocations(<span class="built_in">this</span>.resourceProperties.getStaticLocations()))</span><br><span class="line">                                             .setCachePeriod(getSeconds(cachePeriod)).setCacheControl(cacheControl));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="comment">#  mvc:</span></span><br><span class="line"><span class="comment">#    static-path-pattern: /res/**</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment"># 禁用所有静态资源规则</span></span><br><span class="line"><span class="string">@ConfigurationProperties(prefix</span> <span class="string">=</span> <span class="string">&quot;spring.resources&quot;</span><span class="string">,</span> <span class="string">ignoreUnknownFields</span> <span class="string">=</span> <span class="literal">false</span><span class="string">)</span></span><br><span class="line"><span class="string">public</span> <span class="string">class</span> <span class="string">ResourceProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="string">private</span> <span class="string">static</span> <span class="string">final</span> <span class="string">String</span>[] <span class="string">CLASSPATH_RESOURCE_LOCATIONS</span> <span class="string">=</span> &#123; <span class="string">&quot;classpath:/META-INF/resources/&quot;</span>,</span><br><span class="line">			<span class="string">&quot;classpath:/resources/&quot;</span>, <span class="string">&quot;classpath:/static/&quot;</span>, <span class="string">&quot;classpath:/public/&quot;</span> &#125;<span class="string">;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">/**</span></span><br><span class="line">	 <span class="string">*</span> <span class="string">Locations</span> <span class="string">of</span> <span class="string">static</span> <span class="string">resources.</span> <span class="string">Defaults</span> <span class="string">to</span> <span class="string">classpath:</span>[<span class="string">/META-INF/resources/</span>,</span><br><span class="line">	 <span class="string">*</span> <span class="string">/resources/</span>, <span class="string">/static/</span>, <span class="string">/public/</span>]<span class="string">.</span></span><br><span class="line">	 <span class="string">*/</span></span><br><span class="line">	<span class="string">//private</span> <span class="string">String</span>[] <span class="string">staticLocations</span> <span class="string">=</span> <span class="string">CLASSPATH_RESOURCE_LOCATIONS;</span></span><br></pre></td></tr></table></figure>



<h5 id="3、欢迎页的处理规则"><a href="#3、欢迎页的处理规则" class="headerlink" title="3、欢迎页的处理规则"></a>3、欢迎页的处理规则</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HandlerMapping：处理器映射。保存了每一个Handler能处理哪些请求。（非常重要的组件，用不同的处理方法处理不同的请求）	</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="comment">//下面参数中的这些东西都是从容器中拿出来嗷！！！</span></span><br><span class="line"><span class="keyword">public</span> WelcomePageHandlerMapping <span class="title function_">welcomePageHandlerMapping</span><span class="params">(ApplicationContext applicationContext,</span></span><br><span class="line"><span class="params">FormattingConversionService mvcConversionService, ResourceUrlProvider mvcResourceUrlProvider)</span> &#123;</span><br><span class="line">    <span class="type">WelcomePageHandlerMapping</span> <span class="variable">welcomePageHandlerMapping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WelcomePageHandlerMapping</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TemplateAvailabilityProviders</span>(applicationContext), applicationContext, getWelcomePage(),</span><br><span class="line">    <span class="built_in">this</span>.mvcProperties.getStaticPathPattern());</span><br><span class="line">    welcomePageHandlerMapping.setInterceptors(getInterceptors(mvcConversionService, mvcResourceUrlProvider));</span><br><span class="line">    welcomePageHandlerMapping.setCorsConfigurations(getCorsConfigurations());</span><br><span class="line">    <span class="keyword">return</span> welcomePageHandlerMapping;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WelcomePageHandlerMapping(TemplateAvailabilityProviders templateAvailabilityProviders,</span><br><span class="line">ApplicationContext applicationContext, Optional&lt;Resource&gt; welcomePage, String staticPathPattern) &#123;</span><br><span class="line">    <span class="keyword">if</span> (welcomePage.isPresent() &amp;&amp; <span class="string">&quot;/**&quot;</span>.equals(staticPathPattern)) &#123;</span><br><span class="line">    <span class="comment">//要用欢迎页功能，必须是/**</span></span><br><span class="line">    logger.info(<span class="string">&quot;Adding welcome page: &quot;</span> + welcomePage.get());</span><br><span class="line">    setRootViewName(<span class="string">&quot;forward:index.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (welcomeTemplateExists(templateAvailabilityProviders, applicationContext)) &#123;</span><br><span class="line">    <span class="comment">// 调用Controller  /index</span></span><br><span class="line">    logger.info(<span class="string">&quot;Adding welcome page template: index&quot;</span>);</span><br><span class="line">    setRootViewName(<span class="string">&quot;index&quot;</span>);S</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="4、favicon"><a href="#4、favicon" class="headerlink" title="4、favicon"></a>4、favicon</h5><h3 id="3、请求参数处理"><a href="#3、请求参数处理" class="headerlink" title="3、请求参数处理"></a>3、请求参数处理</h3><h4 id="0、请求映射"><a href="#0、请求映射" class="headerlink" title="0、请求映射"></a>0、请求映射</h4><h5 id="0-1、rest使用与原理"><a href="#0-1、rest使用与原理" class="headerlink" title="0.1、rest使用与原理"></a>0.1、rest使用与原理</h5><ul>
<li>@xxxMapping；<ul>
<li>Rest风格支持（<em>使用<strong>HTTP</strong>请求方式动词来表示对资源的操作</em>）</li>
<li><em>以前：</em><em>&#x2F;getUser</em>  <em>获取用户</em>    <em>&#x2F;deleteUser</em> <em>删除用户</em>   <em>&#x2F;editUser</em>  <em>修改用户</em>      <em>&#x2F;saveUser</em> <em>保存用户</em></li>
<li><em>现在： &#x2F;user</em>    *GET-*<em>获取用户</em>    *DELETE-*<em>删除用户</em>     *PUT-*<em>修改用户</em>      *POST-*<em>保存用户</em></li>
<li>核心Filter；HiddenHttpMethodFilter<ul>
<li>用法： 表单method&#x3D;post，隐藏域 _method&#x3D;put</li>
<li>SpringBoot中手动开启</li>
</ul>
</li>
<li>扩展：如何把_method 这个名字换成我们自己喜欢的。</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getUser</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;GET-张三&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">saveUser</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;POST-张三&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.PUT)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">putUser</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;PUT-张三&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.DELETE)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">deleteUser</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;DELETE-张三&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>	</span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(HiddenHttpMethodFilter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.mvc.hiddenmethod.filter&quot;, name = &quot;enabled&quot;, matchIfMissing = false)</span></span><br><span class="line"><span class="keyword">public</span> OrderedHiddenHttpMethodFilter <span class="title function_">hiddenHttpMethodFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OrderedHiddenHttpMethodFilter</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义filter(主要是_method的解析，将自己写的加入到配置类中去从而加入到容器中去，而不用容器为我们生成嗷！！！注意，这里自己定义的容器，可以参照默认的容器来改嗷！！！)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> HiddenHttpMethodFilter <span class="title function_">hiddenHttpMethodFilter</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">HiddenHttpMethodFilter</span> <span class="variable">methodFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HiddenHttpMethodFilter</span>();</span><br><span class="line">    <span class="comment">//这里新建一个Filter，然后改变里面这个Filter的的MethodParam嗷！！！</span></span><br><span class="line">    methodFilter.setMethodParam(<span class="string">&quot;_m&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> methodFilter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Rest原理（表单提交要使用REST的时候）</p>
<ul>
<li>表单提交会带上**_method&#x3D;PUT**</li>
<li><strong>请求过来被</strong>HiddenHttpMethodFilter拦截<ul>
<li>请求是否正常，并且是POST:<ul>
<li>获取到**_method**的值。</li>
<li>兼容以下请求；<strong>PUT</strong>.<strong>DELETE</strong>.<strong>PATCH</strong></li>
<li><strong>原生request（post），包装模式requesWrapper重写了getMethod方法，返回的是传入的值。</strong></li>
<li><strong>过滤器链放行的时候用wrapper（原request的包装类，主要是重写了getMethod方法）。以后的方法调用getMethod是调用requesWrapper的。</strong></li>
</ul>
</li>
</ul>
</li>
<li>本质上就是Filter传入参数（原request和request带有的_method的值），重新构造一个“带有_method方法的request”，作为包装后的request嗷！！！</li>
</ul>
<p><strong>Rest使用客户端工具，</strong></p>
<ul>
<li>如PostMan直接发送Put、delete等方式请求，无需Filter。（表单的Http层只有Get和Post，因此需要Filter的处理。而PostMan等客户端可以直接在Http层发送类似于Put这样的请求，因此就不需要Filter的处理了嗷！！！）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">hiddenmethod:</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span>   <span class="comment">#开启页面表单的Rest功能</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>上面这一段是可以根据<code>OrderedHiddenHttpMethodFilter</code>的源码看到的嗷，只有配置了以上的配置，才能够使得我们Rest风格生效嗷！！！</p>
</li>
<li><p>前后端分离，Rest风格必须要掌握嗷！！！</p>
</li>
<li><p>新的东西嗷！！！</p>
<ul>
<li>@GetMapping</li>
<li>@PostMapping</li>
<li>@PutMapping</li>
<li>@DeleteMapping</li>
</ul>
</li>
</ul>
<h5 id="0-2、请求映射原理"><a href="#0-2、请求映射原理" class="headerlink" title="0.2、请求映射原理"></a>0.2、请求映射原理</h5><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603181171918-b8acfb93-4914-4208-9943-b37610e93864.png" alt="img"></p>
<p>SpringMVC功能分析都从 org.springframework.web.servlet.DispatcherServlet     -&gt;doDispatch（）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">processedRequest</span> <span class="operator">=</span> request;</span><br><span class="line">    <span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">multipartRequestParsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">WebAsyncManager</span> <span class="variable">asyncManager</span> <span class="operator">=</span> WebAsyncUtils.getAsyncManager(request);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">dispatchException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        processedRequest = checkMultipart(request);</span><br><span class="line">        multipartRequestParsed = (processedRequest != request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到当前请求使用哪个Handler（Controller的方法）处理，Handler其实就是我们编写的Controller，对应的方法嗷！！！</span></span><br><span class="line">        mappedHandler = getHandler(processedRequest);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//HandlerMapping：处理器映射。/xxx-&gt;&gt;xxxx</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603181460034-ba25f3c0-9cfd-4432-8949-3d1dd88d8b12.png" alt="img"></p>
<p><strong>RequestMappingHandlerMapping</strong>：保存了所有@RequestMapping 和handler的映射规则。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603181662070-9e526de8-fd78-4a02-9410-728f059d6aef.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>所有的请求映射都在HandlerMapping中（SpringBoot默人的和我们配置的都有嗷！！！）</p>
<ul>
<li><p>SpringBoot自动配置欢迎页的 WelcomePageHandlerMapping 。访问 &#x2F;能访问到index.html；</p>
</li>
<li><p>SpringBoot自动配置了默认 的 RequestMappingHandlerMapping</p>
</li>
<li><p>请求进来，挨个尝试所有的HandlerMapping看是否有请求信息。</p>
</li>
<li><p>如果有就找到这个请求对应的handler</p>
</li>
<li><p>如果没有就是下一个 HandlerMapping</p>
</li>
<li><p>我们需要一些自定义的映射处理，我们也可以自己给容器中放<strong>HandlerMapping</strong>。自定义 <strong>HandlerMapping</strong>（使用场景比如：不同版本情况下，大量的配置规则需要更改。这个时候我们就可以自定义HandlerMapping来指定处理的请求和其对应的Handler）</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> HandlerExecutionChain <span class="title function_">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.handlerMappings != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (HandlerMapping mapping : <span class="built_in">this</span>.handlerMappings) &#123;</span><br><span class="line">            <span class="comment">//这个getHandler就直接帮助我们找到了对应的Controller，就很有意思</span></span><br><span class="line">			<span class="type">HandlerExecutionChain</span> <span class="variable">handler</span> <span class="operator">=</span> mapping.getHandler(request);</span><br><span class="line">			<span class="keyword">if</span> (handler != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> handler;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="1、普通参数与基本注解"><a href="#1、普通参数与基本注解" class="headerlink" title="1、普通参数与基本注解"></a>1、普通参数与基本注解</h4><h5 id="1-1、注解："><a href="#1-1、注解：" class="headerlink" title="1.1、注解："></a>1.1、注解：</h5><p>@PathVariable、@RequestHeader、@ModelAttribute、@RequestParam、@MatrixVariable、@CookieValue、@RequestBody、@RequestAttribute</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParameterTestController</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//下面这些都是rest风格中常用的嗷！！！</span></span><br><span class="line">    <span class="comment">//car/2/owner/zhangsan</span></span><br><span class="line">    <span class="comment">//注意Map的用法嗷，可以一次把所有的路径变量都提取出来嗷！！！</span></span><br><span class="line">    <span class="comment">//请求头的用法和其他的感觉都是一样的嗷！！！</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/car/&#123;id&#125;/owner/&#123;username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title function_">getCar</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@PathVariable(&quot;username&quot;)</span> String name,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@PathVariable</span> Map&lt;String,String&gt; pv,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@RequestHeader(&quot;User-Agent&quot;)</span> String userAgent,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@RequestHeader</span> Map&lt;String,String&gt; header,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@RequestParam(&quot;age&quot;)</span> Integer age,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@RequestParam(&quot;inters&quot;)</span> List&lt;String&gt; inters,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@RequestParam</span> Map&lt;String,String&gt; params,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@CookieValue(&quot;_ga&quot;)</span> String _ga,</span></span><br><span class="line"><span class="params">                                     <span class="meta">@CookieValue(&quot;_ga&quot;)</span> Cookie cookie)</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        map.put(&quot;id&quot;,id);</span></span><br><span class="line"><span class="comment">//        map.put(&quot;name&quot;,name);</span></span><br><span class="line"><span class="comment">//        map.put(&quot;pv&quot;,pv);</span></span><br><span class="line"><span class="comment">//        map.put(&quot;userAgent&quot;,userAgent);</span></span><br><span class="line"><span class="comment">//        map.put(&quot;headers&quot;,header);</span></span><br><span class="line">        map.put(<span class="string">&quot;age&quot;</span>,age);</span><br><span class="line">        map.put(<span class="string">&quot;inters&quot;</span>,inters);</span><br><span class="line">        map.put(<span class="string">&quot;params&quot;</span>,params);</span><br><span class="line">        map.put(<span class="string">&quot;_ga&quot;</span>,_ga);</span><br><span class="line">        System.out.println(cookie.getName()+<span class="string">&quot;===&gt;&quot;</span>+cookie.getValue());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这里直接获得请求体中的数据嗷！！！</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">postMethod</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;content&quot;</span>,content);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、语法： 请求路径：/cars/sell;low=34;brand=byd,audi,yd</span></span><br><span class="line">    <span class="comment">//2、SpringBoot默认是禁用了矩阵变量的功能</span></span><br><span class="line">    <span class="comment">//手动开启：原理。对于路径的处理UrlPathHelper进行解析。</span></span><br><span class="line">    <span class="comment">//removeSemicolonContent（移除分号内容）支持矩阵变量的</span></span><br><span class="line">    <span class="comment">//3、矩阵变量必须有url路径变量才能被解析,从获取到的路径来看，矩阵变量并不算url的一部分！！！</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/cars/&#123;path&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">carsSell</span><span class="params">(<span class="meta">@MatrixVariable(&quot;low&quot;)</span> Integer low,</span></span><br><span class="line"><span class="params">                        <span class="meta">@MatrixVariable(&quot;brand&quot;)</span> List&lt;String&gt; brand,</span></span><br><span class="line"><span class="params">                        <span class="meta">@PathVariable(&quot;path&quot;)</span> String path)</span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;low&quot;</span>,low);</span><br><span class="line">        map.put(<span class="string">&quot;brand&quot;</span>,brand);</span><br><span class="line">        map.put(<span class="string">&quot;path&quot;</span>,path);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// /boss/1;age=20/2;age=10</span></span><br><span class="line">	<span class="comment">// 有两个路径变量，同时matrix中也有两个嗷！！！因此可以通过不同的pathVar来获得不同的值嗷！！！不指定的话，默认获取的都是第一个的值嗷！！！</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/boss/&#123;bossId&#125;/&#123;empId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">boss</span><span class="params">(<span class="meta">@MatrixVariable(value = &quot;age&quot;,pathVar = &quot;bossId&quot;)</span> Integer bossAge,</span></span><br><span class="line"><span class="params">                    <span class="meta">@MatrixVariable(value = &quot;age&quot;,pathVar = &quot;empId&quot;)</span> Integer empAge)</span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;bossAge&quot;</span>,bossAge);</span><br><span class="line">        map.put(<span class="string">&quot;empAge&quot;</span>,empAge);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>@RequestAttribute一般用在页面跳转的时候，request.set之后，forward到不同的页面，然后request.get拿出来对应的属性进行处理。这个时候，就可以用到@RequestAttribute直接以参数的形式拿到对应的参数，方便进一步进行处理嗷！！！</li>
<li>矩阵变量：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210715102235.png" alt="image-20210715102235551"></p>
<ul>
<li><p>由于我们的boot自动关闭了这个功能，我们需要重写底层的一些东西来打开矩阵处理对应的功能嗷！！！</p>
</li>
<li><p>手动开启Matrix的两种方式：</p>
</li>
</ul>
<ol>
<li>使用@Bean向容器中放上一个WebMvcConfigurer类型的组件：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210715104704.png" alt="image-20210715104704788"></p>
<ol start="2">
<li>让配置类实现WebMvcConfigurer接口，修改我们要修改的方法即可：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210715104535.png" alt="image-20210715104535073"></p>
<ul>
<li><p>上面两个的本质是一样的嗷！！！都是向容器中加了一个WebMvcConfigurer组件而已，一个是通过继承加上@Configuration添加的。另外一个是在@Configuration下的@Bean中添加的嗷！！！</p>
</li>
<li><p>原理讲解都是从dispatcherServlet的doDispatch方法开始的嗷，我们一定要注意嗷！！！这个才是核心方法嗷！！！</p>
</li>
</ul>
<h5 id="1-2、Servlet-API："><a href="#1-2、Servlet-API：" class="headerlink" title="1.2、Servlet API："></a>1.2、Servlet API：</h5><p>WebRequest、ServletRequest、MultipartRequest、 HttpSession、javax.servlet.http.PushBuilder、Principal、InputStream、Reader、HttpMethod、Locale、TimeZone、ZoneId</p>
<p><strong>ServletRequestMethodArgumentResolver  以上的部分参数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsParameter</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">		Class&lt;?&gt; paramType = parameter.getParameterType();</span><br><span class="line">		<span class="keyword">return</span> (WebRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">				ServletRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">				MultipartRequest.class.isAssignableFrom(paramType) ||</span><br><span class="line">				HttpSession.class.isAssignableFrom(paramType) ||</span><br><span class="line">				(pushBuilder != <span class="literal">null</span> &amp;&amp; pushBuilder.isAssignableFrom(paramType)) ||</span><br><span class="line">				Principal.class.isAssignableFrom(paramType) ||</span><br><span class="line">				InputStream.class.isAssignableFrom(paramType) ||</span><br><span class="line">				Reader.class.isAssignableFrom(paramType) ||</span><br><span class="line">				HttpMethod.class == paramType ||</span><br><span class="line">				Locale.class == paramType ||</span><br><span class="line">				TimeZone.class == paramType ||</span><br><span class="line">				ZoneId.class == paramType);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h5 id="1-3、复杂参数："><a href="#1-3、复杂参数：" class="headerlink" title="1.3、复杂参数："></a>1.3、复杂参数：</h5><ul>
<li><p>Model很重要，Model可以设置全局的值，model中设置的值最终会被放到request的请求域中嗷！！！</p>
</li>
<li><p><strong>Map</strong>、<strong>Model（map、model里面的数据会被放在request的请求域  request.setAttribute）、</strong>Errors&#x2F;BindingResult、<strong>RedirectAttributes（ 重定向携带数据）</strong>、<strong>ServletResponse（response）</strong>、SessionStatus、UriComponentsBuilder、ServletUriComponentsBuilder</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt; map,  Model model, HttpServletRequest request 都是可以给request域中放数据，</span><br><span class="line">request.getAttribute();</span><br></pre></td></tr></table></figure>

<p><strong>Map、Model类型的参数</strong>，会返回 mavContainer.getModel（）；—&gt; BindingAwareModelMap 是Model 也是Map</p>
<ul>
<li>Map和Model的底层本质上都是调用的<strong>mavContainer</strong>.getModel(); 获取到值的</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603271442869-63b4c3c7-c721-4074-987d-cbe5999273ae.png" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603271678813-d8e1a1e5-94fa-412c-a7f1-6f27174fd127.png" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603271813894-037be041-92a5-49af-a49c-c350b3dd587a.png" alt="img"></p>
<ul>
<li>所有的数据都放在了ModelAndView中嗷，操作都是对于ModelAndView的更新</li>
</ul>
<h5 id="1-4、自定义对象参数："><a href="#1-4、自定义对象参数：" class="headerlink" title="1.4、自定义对象参数："></a>1.4、自定义对象参数：</h5><p>可以自动类型转换与格式化，可以级联封装。</p>
<ul>
<li>使用级联封装，Boot可以帮助我们直接进行对象的封装，封装好的对象作为参数传入到对应的Controller方法中！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *     姓名： &lt;input name=&quot;userName&quot;/&gt; &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *     年龄： &lt;input name=&quot;age&quot;/&gt; &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *     生日： &lt;input name=&quot;birth&quot;/&gt; &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *     宠物姓名：&lt;input name=&quot;pet.name&quot;/&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *     宠物年龄：&lt;input name=&quot;pet.age&quot;/&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line">    <span class="keyword">private</span> Pet pet;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result</span><br></pre></td></tr></table></figure>



<h4 id="2、POJO封装过程"><a href="#2、POJO封装过程" class="headerlink" title="2、POJO封装过程"></a>2、POJO封装过程</h4><ul>
<li><p><strong>ServletModelAttributeMethodProcessor</strong></p>
</li>
<li><p>查看3.5.3嗷！！！</p>
</li>
</ul>
<h4 id="3、参数处理原理"><a href="#3、参数处理原理" class="headerlink" title="3、参数处理原理"></a>3、参数处理原理</h4><ul>
<li><p>DispatcherServlet和其中的doDispatch方法很重要嗷！！！</p>
</li>
<li><p>HandlerMapping中找到能处理请求的Handler（Controller.method()）</p>
</li>
<li><p>为当前Handler 找一个适配器 HandlerAdapter； <strong>RequestMappingHandlerAdapter</strong></p>
</li>
<li><p>适配器执行目标方法并确定方法参数的每一个值</p>
</li>
</ul>
<h5 id="3-1、HandlerAdapter"><a href="#3-1、HandlerAdapter" class="headerlink" title="3.1、HandlerAdapter"></a>3.1、HandlerAdapter</h5><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603262942726-107353bd-f8b7-44f6-93cf-2a3cad4093cf.png" alt="img"></p>
<p>0 - 支持方法上标注@RequestMapping </p>
<p>1 - 支持函数式编程的</p>
<p>xxxxxx</p>
<h5 id="3-2、执行目标方法"><a href="#3-2、执行目标方法" class="headerlink" title="3.2、执行目标方法"></a>3.2、执行目标方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Actually invoke the handler.</span></span><br><span class="line"><span class="comment">//DispatcherServlet -- doDispatch</span></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">mav = invokeHandlerMethod(request, response, handlerMethod); <span class="comment">//执行目标方法</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ServletInvocableHandlerMethod</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">returnValue</span> <span class="operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line"><span class="comment">//获取方法的参数值</span></span><br><span class="line">Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br></pre></td></tr></table></figure>

<h5 id="3-3、参数解析器-HandlerMethodArgumentResolver"><a href="#3-3、参数解析器-HandlerMethodArgumentResolver" class="headerlink" title="3.3、参数解析器-HandlerMethodArgumentResolver"></a>3.3、参数解析器-HandlerMethodArgumentResolver</h5><p>确定将要执行的目标方法的每一个参数的值是什么;</p>
<p>SpringMVC目标方法能写多少种参数类型。取决于参数解析器。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603263283504-85bbd4d5-a9af-4dbf-b6a2-30b409868774.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603263394724-33122714-9d06-42ec-bf45-e440e8b49c05.png" alt="img"></p>
<ul>
<li>当前解析器是否支持解析这种参数</li>
<li>支持就调用 resolveArgument</li>
</ul>
<h5 id="3-4、返回值处理器"><a href="#3-4、返回值处理器" class="headerlink" title="3.4、返回值处理器"></a>3.4、返回值处理器</h5><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603263524227-386da4be-43b1-4b17-a2cc-8cf886346af9.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h5 id="3-5、如何确定目标方法每一个参数的值"><a href="#3-5、如何确定目标方法每一个参数的值" class="headerlink" title="3.5、如何确定目标方法每一个参数的值"></a>3.5、如何确定目标方法每一个参数的值</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">============InvocableHandlerMethod==========================</span><br><span class="line"><span class="keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span><br><span class="line">			Object... providedArgs) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		MethodParameter[] parameters = getMethodParameters();</span><br><span class="line">		<span class="keyword">if</span> (ObjectUtils.isEmpty(parameters)) &#123;</span><br><span class="line">			<span class="keyword">return</span> EMPTY_ARGS;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[parameters.length];</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">			<span class="type">MethodParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> parameters[i];</span><br><span class="line">			parameter.initParameterNameDiscovery(<span class="built_in">this</span>.parameterNameDiscoverer);</span><br><span class="line">			args[i] = findProvidedArgument(parameter, providedArgs);</span><br><span class="line">			<span class="keyword">if</span> (args[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">this</span>.resolvers.supportsParameter(parameter)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(formatArgumentError(parameter, <span class="string">&quot;No suitable resolver&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				args[i] = <span class="built_in">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="built_in">this</span>.dataBinderFactory);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">				<span class="comment">// Leave stack trace for later, exception may actually be resolved and handled...</span></span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					<span class="type">String</span> <span class="variable">exMsg</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">					<span class="keyword">if</span> (exMsg != <span class="literal">null</span> &amp;&amp; !exMsg.contains(parameter.getExecutable().toGenericString())) &#123;</span><br><span class="line">						logger.debug(formatArgumentError(parameter, exMsg));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> args;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h6 id="3-5-1、挨个判断所有参数解析器那个支持解析这个参数"><a href="#3-5-1、挨个判断所有参数解析器那个支持解析这个参数" class="headerlink" title="3.5.1、挨个判断所有参数解析器那个支持解析这个参数"></a>3.5.1、挨个判断所有参数解析器那个支持解析这个参数</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> HandlerMethodArgumentResolver <span class="title function_">getArgumentResolver</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">    <span class="type">HandlerMethodArgumentResolver</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.argumentResolverCache.get(parameter);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (HandlerMethodArgumentResolver resolver : <span class="built_in">this</span>.argumentResolvers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolver.supportsParameter(parameter)) &#123;</span><br><span class="line">                result = resolver;</span><br><span class="line">                <span class="built_in">this</span>.argumentResolverCache.put(parameter, result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="3-5-2、解析这个参数的值"><a href="#3-5-2、解析这个参数的值" class="headerlink" title="3.5.2、解析这个参数的值"></a>3.5.2、解析这个参数的值</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">调用各自 HandlerMethodArgumentResolver 的 resolveArgument 方法即可</span><br></pre></td></tr></table></figure>

<h6 id="3-5-3、自定义类型参数-封装POJO"><a href="#3-5-3、自定义类型参数-封装POJO" class="headerlink" title="3.5.3、自定义类型参数 封装POJO"></a>3.5.3、自定义类型参数 封装POJO</h6><p><strong>ServletModelAttributeMethodProcessor  这个参数处理器支持</strong></p>
<p> <strong>是否为简单类型。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isSimpleValueType</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (Void.class != type &amp;&amp; <span class="keyword">void</span>.class != type &amp;&amp;</span><br><span class="line">				(ClassUtils.isPrimitiveOrWrapper(type) ||</span><br><span class="line">				Enum.class.isAssignableFrom(type) ||</span><br><span class="line">				CharSequence.class.isAssignableFrom(type) ||</span><br><span class="line">				Number.class.isAssignableFrom(type) ||</span><br><span class="line">				Date.class.isAssignableFrom(type) ||</span><br><span class="line">				Temporal.class.isAssignableFrom(type) ||</span><br><span class="line">				URI.class == type ||</span><br><span class="line">				URL.class == type ||</span><br><span class="line">				Locale.class == type ||</span><br><span class="line">				Class.class == type));</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span><br><span class="line"><span class="params">                                    NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    Assert.state(mavContainer != <span class="literal">null</span>, <span class="string">&quot;ModelAttributeMethodProcessor requires ModelAndViewContainer&quot;</span>);</span><br><span class="line">    Assert.state(binderFactory != <span class="literal">null</span>, <span class="string">&quot;ModelAttributeMethodProcessor requires WebDataBinderFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> ModelFactory.getNameForParameter(parameter);</span><br><span class="line">    <span class="type">ModelAttribute</span> <span class="variable">ann</span> <span class="operator">=</span> parameter.getParameterAnnotation(ModelAttribute.class);</span><br><span class="line">    <span class="keyword">if</span> (ann != <span class="literal">null</span>) &#123;</span><br><span class="line">        mavContainer.setBinding(name, ann.binding());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">attribute</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">BindingResult</span> <span class="variable">bindingResult</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mavContainer.containsAttribute(name)) &#123;</span><br><span class="line">        attribute = mavContainer.getModel().get(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Create attribute instance</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            attribute = createAttribute(name, parameter, binderFactory, webRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (BindException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isBindExceptionRequired(parameter)) &#123;</span><br><span class="line">                <span class="comment">// No BindingResult parameter -&gt; fail with BindException</span></span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Otherwise, expose null/empty value and associated BindingResult</span></span><br><span class="line">            <span class="keyword">if</span> (parameter.getParameterType() == Optional.class) &#123;</span><br><span class="line">                attribute = Optional.empty();</span><br><span class="line">            &#125;</span><br><span class="line">            bindingResult = ex.getBindingResult();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bindingResult == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Bean property binding and validation;</span></span><br><span class="line">        <span class="comment">// skipped in case of binding failure on construction.</span></span><br><span class="line">        <span class="type">WebDataBinder</span> <span class="variable">binder</span> <span class="operator">=</span> binderFactory.createBinder(webRequest, attribute, name);</span><br><span class="line">        <span class="keyword">if</span> (binder.getTarget() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mavContainer.isBindingDisabled(name)) &#123;</span><br><span class="line">                bindRequestParameters(binder, webRequest);</span><br><span class="line">            &#125;</span><br><span class="line">            validateIfApplicable(binder, parameter);</span><br><span class="line">            <span class="keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BindException</span>(binder.getBindingResult());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Value type adaptation, also covering java.util.Optional</span></span><br><span class="line">        <span class="keyword">if</span> (!parameter.getParameterType().isInstance(attribute)) &#123;</span><br><span class="line">            attribute = binder.convertIfNecessary(binder.getTarget(), parameter.getParameterType(), parameter);</span><br><span class="line">        &#125;</span><br><span class="line">        bindingResult = binder.getBindingResult();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add resolved attribute and BindingResult at the end of the model</span></span><br><span class="line">    Map&lt;String, Object&gt; bindingResultModel = bindingResult.getModel();</span><br><span class="line">    mavContainer.removeAttributes(bindingResultModel);</span><br><span class="line">    mavContainer.addAllAttributes(bindingResultModel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> attribute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>WebDataBinder binder &#x3D; binderFactory.createBinder(webRequest, attribute, name);</strong></p>
<p><strong>WebDataBinder :web数据绑定器，将请求参数的值绑定到指定的JavaBean里面</strong></p>
<p><strong>WebDataBinder 利用它里面的 Converters 将请求数据转成指定的数据类型。再次封装到JavaBean中</strong></p>
<p><strong>GenericConversionService：在设置每一个值的时候，找它里面的所有converter那个可以将这个数据类型（request带来参数的字符串）转换到指定的类型（JavaBean – Integer）</strong></p>
<p><strong>byte – &gt; file</strong></p>
<p>@FunctionalInterface<strong>public interface</strong> Converter&lt;S, T&gt;</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603337871521-25fc1aa1-133a-4ce0-a146-d565633d7658.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603338486441-9bbd22a9-813f-49bd-b51b-e66c7f4b8598.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>未来我们可以给WebDataBinder里面放自己的Converter；</p>
<p><strong>private static final class</strong> StringToNumber&lt;T **extends** Number&gt; <strong>implements</strong> Converter&lt;String, T&gt;</p>
<p>自定义 Converter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、WebMvcConfigurer定制化SpringMVC的功能</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configurePathMatch</span><span class="params">(PathMatchConfigurer configurer)</span> &#123;</span><br><span class="line">            <span class="type">UrlPathHelper</span> <span class="variable">urlPathHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlPathHelper</span>();</span><br><span class="line">            <span class="comment">// 不移除；后面的内容。矩阵变量功能就可以生效</span></span><br><span class="line">            urlPathHelper.setRemoveSemicolonContent(<span class="literal">false</span>);</span><br><span class="line">            configurer.setUrlPathHelper(urlPathHelper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFormatters</span><span class="params">(FormatterRegistry registry)</span> &#123;</span><br><span class="line">            registry.addConverter(<span class="keyword">new</span> <span class="title class_">Converter</span>&lt;String, Pet&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Pet <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">                    <span class="comment">// 啊猫,3</span></span><br><span class="line">                    <span class="keyword">if</span>(!StringUtils.isEmpty(source))&#123;</span><br><span class="line">                        <span class="type">Pet</span> <span class="variable">pet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pet</span>();</span><br><span class="line">                        String[] split = source.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                        pet.setName(split[<span class="number">0</span>]);</span><br><span class="line">                        pet.setAge(Integer.parseInt(split[<span class="number">1</span>]));</span><br><span class="line">                        <span class="keyword">return</span> pet;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT/?p=36&spm_id_from=pageDriver">POJO的Converter的定制视频嗷！！！</a></li>
</ul>
<h5 id="3-6、目标方法执行完成"><a href="#3-6、目标方法执行完成" class="headerlink" title="3.6、目标方法执行完成"></a>3.6、目标方法执行完成</h5><p>将所有的数据都放在 <strong>ModelAndViewContainer</strong>；包含要去的页面地址View。还包含Model数据。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1603272018605-1bce3142-bdd9-4834-a028-c753e91c52ac.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h5 id="3-7、处理派发结果"><a href="#3-7、处理派发结果" class="headerlink" title="3.7、处理派发结果"></a>3.7、处理派发结果</h5><p><strong>processDispatchResult</strong>(processedRequest, response, mappedHandler, mv, dispatchException);</p>
<p>renderMergedOutputModel(mergedModel, getRequestToExpose(request), response);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">InternalResourceView：</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">renderMergedOutputModel</span><span class="params">(</span></span><br><span class="line"><span class="params">			Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Expose the model object as request attributes.</span></span><br><span class="line">		exposeModelAsRequestAttributes(model, request);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Expose helpers as request attributes, if any.</span></span><br><span class="line">		exposeHelpers(request);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Determine the path for the request dispatcher.</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">dispatcherPath</span> <span class="operator">=</span> prepareForRendering(request, response);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Obtain a RequestDispatcher for the target resource (typically a JSP).</span></span><br><span class="line">		<span class="type">RequestDispatcher</span> <span class="variable">rd</span> <span class="operator">=</span> getRequestDispatcher(request, dispatcherPath);</span><br><span class="line">		<span class="keyword">if</span> (rd == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Could not get RequestDispatcher for [&quot;</span> + getUrl() +</span><br><span class="line">					<span class="string">&quot;]: Check that the corresponding file exists within your web application archive!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If already included or response already committed, perform include, else forward.</span></span><br><span class="line">		<span class="keyword">if</span> (useInclude(request, response)) &#123;</span><br><span class="line">			response.setContentType(getContentType());</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Including [&quot;</span> + getUrl() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			rd.include(request, response);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Note: The forwarded resource is supposed to determine the content type itself.</span></span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Forwarding to [&quot;</span> + getUrl() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			rd.forward(request, response);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//暴露模型作为请求域属性</span></span><br><span class="line"><span class="comment">// Expose the model object as request attributes.</span></span><br><span class="line">		exposeModelAsRequestAttributes(model, request);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">exposeModelAsRequestAttributes</span><span class="params">(Map&lt;String, Object&gt; model,</span></span><br><span class="line"><span class="params">			HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//model中的所有数据遍历挨个放在请求域中</span></span><br><span class="line">		model.forEach((name, value) -&gt; &#123;</span><br><span class="line">			<span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">				request.setAttribute(name, value);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				request.removeAttribute(name);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>





<h3 id="4、数据响应与内容协商"><a href="#4、数据响应与内容协商" class="headerlink" title="4、数据响应与内容协商"></a>4、数据响应与内容协商</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606043749073-2573e24a-9ea9-459e-ad94-a433e1082624.png" alt="img"></p>
<h4 id="1、响应JSON"><a href="#1、响应JSON" class="headerlink" title="1、响应JSON"></a>1、响应JSON</h4><h5 id="1-1、jackson-jar-ResponseBody"><a href="#1-1、jackson-jar-ResponseBody" class="headerlink" title="1.1、jackson.jar+@ResponseBody"></a>1.1、jackson.jar+@ResponseBody</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--web场景自动引入了json场景--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605151090728-f7c60e6f-d0c0-4541-bfa3-8cc805dfd5d6.png" alt="img"></p>
<p>给前端自动返回json数据；</p>
<h6 id="1-1-1、返回值解析器"><a href="#1-1-1、返回值解析器" class="headerlink" title="1.1.1、返回值解析器"></a>1.1.1、返回值解析器</h6><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605151359370-01cd1fbe-628a-4eea-9430-d79a78f59125.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ul>
<li>上面这个和参数解析器类似，对于返回值进行分析的嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line">        returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">                              ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">HandlerMethodReturnValueHandler</span> <span class="variable">handler</span> <span class="operator">=</span> selectHandler(returnValue, returnType);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());</span><br><span class="line">    &#125;</span><br><span class="line">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">&#125;</span><br><span class="line">RequestResponseBodyMethodProcessor  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType,</span></span><br><span class="line"><span class="params">                                  ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ServletServerHttpRequest</span> <span class="variable">inputMessage</span> <span class="operator">=</span> createInputMessage(webRequest);</span><br><span class="line">    <span class="type">ServletServerHttpResponse</span> <span class="variable">outputMessage</span> <span class="operator">=</span> createOutputMessage(webRequest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try even with null return value. ResponseBodyAdvice could get involved.</span></span><br><span class="line">    <span class="comment">// 使用消息转换器进行写出操作</span></span><br><span class="line">    writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="1-1-2、返回值解析器原理"><a href="#1-1-2、返回值解析器原理" class="headerlink" title="1.1.2、返回值解析器原理"></a>1.1.2、返回值解析器原理</h6><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605151728659-68c8ce8a-1b2b-4ab0-b86d-c3a875184672.png" alt="img"></p>
<ul>
<li><p>1、返回值处理器判断是否支持这种类型返回值 supportsReturnType</p>
</li>
<li><p>2、返回值处理器调用 handleReturnValue 进行处理</p>
</li>
<li><p>3、RequestResponseBodyMethodProcessor 可以处理返回值标了@ResponseBody 注解的：</p>
<ul>
<li><ol>
<li>利用 MessageConverters 进行处理，将数据写为json：<ul>
<li>1、内容协商（浏览器默认会以请求头的方式告诉服务器他能接受什么样的内容类型）</li>
<li>2、服务器最终根据自己自身的能力，决定服务器能生产出什么样内容类型的数据，</li>
<li>3、SpringMVC会挨个遍历所有容器底层的 HttpMessageConverter ，看谁能处理？<ul>
<li>1、得到MappingJackson2HttpMessageConverter可以将对象写为json</li>
<li>2、利用MappingJackson2HttpMessageConverter将对象转为json再写出去。</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605163005521-a20d1d8e-0494-43d0-8135-308e7a22e896.png" alt="img"></p>
<h5 id="1-2、SpringMVC到底支持哪些返回值"><a href="#1-2、SpringMVC到底支持哪些返回值" class="headerlink" title="1.2、SpringMVC到底支持哪些返回值"></a>1.2、SpringMVC到底支持哪些返回值</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ModelAndView</span><br><span class="line">Model</span><br><span class="line">View</span><br><span class="line">ResponseEntity </span><br><span class="line">ResponseBodyEmitter</span><br><span class="line">StreamingResponseBody</span><br><span class="line">HttpEntity</span><br><span class="line">HttpHeaders</span><br><span class="line">Callable</span><br><span class="line">DeferredResult</span><br><span class="line">ListenableFuture</span><br><span class="line">CompletionStage</span><br><span class="line">WebAsyncTask</span><br><span class="line">有 <span class="meta">@ModelAttribute</span> 且为对象类型的</span><br><span class="line"><span class="meta">@ResponseBody</span> 注解 ---&gt; RequestResponseBodyMethodProcessor；</span><br></pre></td></tr></table></figure>

<h5 id="1-3、HTTPMessageConverter原理"><a href="#1-3、HTTPMessageConverter原理" class="headerlink" title="1.3、HTTPMessageConverter原理"></a>1.3、HTTPMessageConverter原理</h5><h6 id="1-3-1、MessageConverter规范"><a href="#1-3-1、MessageConverter规范" class="headerlink" title="1.3.1、MessageConverter规范"></a>1.3.1、MessageConverter规范</h6><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605163447900-e2748217-0f31-4abb-9cce-546b4d790d0b.png" alt="img"></p>
<p>HttpMessageConverter: 看是否支持将此 Class类型的对象，转为MediaType类型的数据。</p>
<p>例子：Person对象转为JSON。或者 JSON转为Person</p>
<h6 id="1-3-2、默认的MessageConverter"><a href="#1-3-2、默认的MessageConverter" class="headerlink" title="1.3.2、默认的MessageConverter"></a>1.3.2、默认的MessageConverter</h6><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605163584708-e19770d6-6b35-4caa-bf21-266b73cb1ef1.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>0 - 只支持Byte类型的</p>
<p>1 - String</p>
<p>2 - String</p>
<p>3 - Resource</p>
<p>4 - ResourceRegion</p>
<p>5 - DOMSource.class \SAXSource.class) \ StAXSource.class \StreamSource.class \Source.class</p>
<p>6 - MultiValueMap</p>
<p><strong>7 - true</strong> </p>
<p>8 - true</p>
<p>9 - 支持注解方式xml处理的。</p>
<p>最终 MappingJackson2HttpMessageConverter  把对象转为JSON（利用底层的jackson的objectMapper转换的）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605164243168-1a31e9af-54a4-463e-b65a-c28ca7a8a2fa.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="2、内容协商"><a href="#2、内容协商" class="headerlink" title="2、内容协商"></a>2、内容协商</h4><ul>
<li>根据客户端接收能力不同，返回不同媒体类型的数据。(比如这里我们引入xml，就能够相应xml依赖啦！！！)</li>
</ul>
<h5 id="2-1、引入xml依赖"><a href="#2-1、引入xml依赖" class="headerlink" title="2.1、引入xml依赖"></a>2.1、引入xml依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2、postman分别测试返回json和xml"><a href="#2-2、postman分别测试返回json和xml" class="headerlink" title="2.2、postman分别测试返回json和xml"></a>2.2、postman分别测试返回json和xml</h5><p>只需要改变请求头中Accept字段。Http协议中规定的，告诉服务器本客户端可以接收的数据类型。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605173127653-8a06cd0f-b8e1-4e22-9728-069b942eba3f.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h5 id="2-3、开启浏览器参数方式内容协商功能"><a href="#2-3、开启浏览器参数方式内容协商功能" class="headerlink" title="2.3、开启浏览器参数方式内容协商功能"></a>2.3、开启浏览器参数方式内容协商功能</h5><ul>
<li>这个主要就能够实现，我想给浏览器写json，而不是xml，这个时候就需要开启额外的功能（不像Postman，浏览器发送的请求头不好改Content-type的嗷！！！）</li>
</ul>
<p>为了方便内容协商，开启基于请求参数的内容协商功能。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">contentnegotiation:</span></span><br><span class="line">      <span class="attr">favor-parameter:</span> <span class="literal">true</span>  <span class="comment">#开启请求参数内容协商模式</span></span><br></pre></td></tr></table></figure>

<p>发请求： <a target="_blank" rel="noopener" href="http://localhost:8080/test/person?format=json">http://localhost:8080/test/person?format=json</a> </p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/test/person?format=xml">http://localhost:8080/test/person?format=xml</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605230907471-b0ed34bc-6782-40e7-84b7-615726312f01.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>确定客户端接收什么样的内容类型；</p>
<p>1、Parameter策略优先确定是要返回json数据（获取请求头中的format的值）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605231074299-25f5b062-2de1-4a09-91bf-11e018d6ec0e.png" alt="img"></p>
<p>2、最终进行内容协商返回给客户端json即可。</p>
<p>3、多个策略中，按照优先级排序，获得第一个不是*&#x2F;*的就返回。如果获得的是*&#x2F;*，那就继续循环去遍历下一个策略。如果策略遍历一遍之后，都是*&#x2F;*，那我们就直接只能返回这个了嗷。</p>
<h5 id="2-4、内容协商原理"><a href="#2-4、内容协商原理" class="headerlink" title="2.4、内容协商原理"></a>2.4、内容协商原理</h5><ul>
<li><p>1、判断当前响应头中是否已经有确定的媒体类型。MediaType</p>
</li>
<li><p><strong>2、获取客户端（PostMan、浏览器）支持接收的内容类型。（获取客户端Accept请求头字段）【application&#x2F;xml】</strong></p>
<ul>
<li><p><strong>contentNegotiationManager 内容协商管理器 默认使用基于请求头的策略</strong></p>
</li>
<li><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605230462280-ef98de47-6717-4e27-b4ec-3eb0690b55d0.png" alt="img"></p>
</li>
<li><p><strong>HeaderContentNegotiationStrategy  确定客户端可以接收的内容类型</strong> </p>
</li>
<li><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605230546376-65dcf657-7653-4a58-837a-f5657778201a.png" alt="img"></p>
</li>
</ul>
</li>
<li><p>3、遍历循环所有当前系统的 <strong>MessageConverter</strong>，看谁<strong>支持操作这个对象</strong>（Person）</p>
</li>
<li><p>4、找到支持操作Person的converter，把converter支持的媒体类型统计出来。</p>
</li>
<li><p>5、客户端需要【application&#x2F;xml】。服务端处理总能力【一共10种，包括json、xml在内，还需要循环遍历再排除来得到真正能够处理这个对象的东西！！！】</p>
</li>
<li><p>选择出来能够真正处理这个对象的如下统计所示：<img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605173876646-f63575e2-50c8-44d5-9603-c2d11a78adae.png" alt="img"></p>
</li>
<li><p>6、上面只是能够处理指定对象而已，和我们的浏览器的要求匹配吗？不一定吧。所以下面就是把我们找出来能够处理的对象，和我们浏览器的要求进行匹配。进行内容协商的最佳匹配媒体类型。（最佳匹配，找出服务端能够提供的，同时满足客户端需求的方式。有可能有多个，还需要对于这些进行排序，然后得到最佳的那一个对象提供服务。<strong>最终选中的永远只有一个！！！</strong>）</p>
</li>
<li><p>7、用支持将对象转为最佳匹配媒体类型 的converter。调用它进行转化 。</p>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605173657818-73331882-6086-490c-973b-af46ccf07b32.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>导入了jackson处理xml的包，xml的converter就会自动进来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebMvcConfigurationSupport</span></span><br><span class="line"><span class="variable">jackson2XmlPresent</span> <span class="operator">=</span> ClassUtils.isPresent(<span class="string">&quot;com.fasterxml.jackson.dataformat.xml.XmlMapper&quot;</span>, classLoader);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (jackson2XmlPresent) &#123;</span><br><span class="line">			<span class="type">Jackson2ObjectMapperBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Jackson2ObjectMapperBuilder.xml();</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.applicationContext != <span class="literal">null</span>) &#123;</span><br><span class="line">				builder.applicationContext(<span class="built_in">this</span>.applicationContext);</span><br><span class="line">			&#125;</span><br><span class="line">			messageConverters.add(<span class="keyword">new</span> <span class="title class_">MappingJackson2XmlHttpMessageConverter</span>(builder.build()));</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>







<h5 id="2-5、自定义-MessageConverter"><a href="#2-5、自定义-MessageConverter" class="headerlink" title="2.5、自定义 MessageConverter"></a>2.5、自定义 MessageConverter</h5><p><strong>实现多协议数据兼容。json、xml、x-guigu</strong></p>
<p>0、@ResponseBody 响应数据出去 调用 <strong>RequestResponseBodyMethodProcessor</strong> 处理</p>
<p>1、Processor 处理方法返回值。通过 <strong>MessageConverter</strong> 处理</p>
<p>2、所有 <strong>MessageConverter</strong> 合起来可以支持各种媒体类型数据的操作（读、写）</p>
<p>3、内容协商找到最终的 <strong>messageConverter</strong>；</p>
<p>SpringMVC的什么功能。一个入口给容器中添加一个  WebMvcConfigurer。</p>
<ul>
<li>下面这一段代码就是在配置文件MyConfig中，对于Configurer的扩写，添加了我们自定义的GuiguMessageConverter</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebMvcConfigurer <span class="title function_">webMvcConfigurer</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcConfigurer</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">			convert.add(<span class="keyword">new</span> <span class="title class_">GuiguMessageConverter</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605260623995-8b1f7cec-9713-4f94-9cf1-8dbc496bd245.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605261062877-0a27cc41-51cb-4018-a9af-4e0338a247cd.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ul>
<li>自定义功能的添加（一个是解析浏览器参数策略，另外一个是本地服务器处理功能的添加）：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210716201441.png" alt="image-20210716201259824"></p>
<ul>
<li><strong>有可能我们添加的自定义的功能会覆盖默认很多功能，比如默认方法添加的一些东西，会导致一些默认的功能失效。因此我们还需要查看源码，看看源码中某些类型是如何进行配置的嗷！！！</strong></li>
</ul>
<p>大家考虑，上述功能除了我们完全自定义外？SpringBoot有没有为我们提供基于配置文件的快速修改媒体类型功能？怎么配置呢？【提示：参照SpringBoot官方文档web开发内容协商章节】</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT?p=41&spm_id_from=pageDriver">自定义MessageConverter的教程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT?p=42&spm_id_from=pageDriver">Converter课后作业的教程</a></li>
</ul>
<h3 id="5、视图解析与模板引擎"><a href="#5、视图解析与模板引擎" class="headerlink" title="5、视图解析与模板引擎"></a>5、视图解析与模板引擎</h3><p>视图解析：<strong>SpringBoot默认不支持 JSP，需要引入第三方模板引擎技术实现页面渲染。</strong></p>
<h4 id="1、视图解析"><a href="#1、视图解析" class="headerlink" title="1、视图解析"></a>1、视图解析</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606043749039-cefbf687-4feb-441d-bad8-c6d933248d3c.png" alt="img"></p>
<h5 id="1、视图解析原理流程"><a href="#1、视图解析原理流程" class="headerlink" title="1、视图解析原理流程"></a>1、视图解析原理流程</h5><p>1、目标方法处理的过程中，所有数据都会被放在 <strong>ModelAndViewContainer 里面。包括数据和视图地址</strong></p>
<p><strong>2、方法的参数是一个自定义类型对象（从请求参数中确定的），把他重新放在</strong> <strong>ModelAndViewContainer</strong> </p>
<p><strong>3、任何目标方法执行完成以后都会返回 ModelAndView</strong>（<strong>数据和视图地址</strong>）。</p>
<p><strong>4、processDispatchResult  处理派发结果（页面该如何响应）</strong></p>
<ul>
<li>1、<strong>render</strong>(<strong>mv</strong>, request, response); 进行页面渲染逻辑<ul>
<li><p>1、根据方法的String返回值得到 <strong>View</strong> 对象【定义了页面的渲染逻辑】</p>
<ul>
<li><p>1、所有的视图解析器尝试是否能根据当前返回值得到<strong>View</strong>对象</p>
</li>
<li><p>2、得到了  <strong>redirect:&#x2F;main.html</strong> –&gt; Thymeleaf new <strong>RedirectView</strong>()</p>
</li>
<li><p>3、ContentNegotiationViewResolver 里面包含了下面所有的视图解析器，内部还是利用下面所有视图解析器得到视图对象。</p>
</li>
<li><p>4、view.render(mv.getModelInternal(), request, response);   视图对象调用自定义的render进行页面渲染工作</p>
<ul>
<li><p><strong>RedirectView 如何渲染【重定向到一个页面】</strong></p>
</li>
<li><p><strong>1、获取目标url地址</strong></p>
</li>
<li><p><strong>2、response.sendRedirect(encodedURL);</strong></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>视图解析：</strong></p>
<ul>
<li><p><strong>返回值以 forward: 开始： new InternalResourceView(forwardUrl); –&gt;  转发</strong>request.getRequestDispatcher(path).forward(request, response);</p>
</li>
<li><p><strong>返回值以</strong> <strong>redirect: 开始：</strong> <strong>new RedirectView() –》 render就是重定向</strong> </p>
</li>
<li><p><strong>返回值是普通字符串： new ThymeleafView（）—&gt;</strong> 自定义视图解析器+自定义视图；</p>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605680247945-088b0f17-185c-490b-8889-103e8b4d8c07.png" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605679959020-54b96fe7-f2fc-4b4d-a392-426e1d5413de.png" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605679471537-7db702dc-b165-4dc6-b64a-26459ee5fd6c.png" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605679913592-151a616a-c754-4da3-a2c1-91dc0230a48d.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="2、模板引擎-Thymeleaf"><a href="#2、模板引擎-Thymeleaf" class="headerlink" title="2、模板引擎-Thymeleaf"></a>2、模板引擎-Thymeleaf</h4><h5 id="1、thymeleaf简介"><a href="#1、thymeleaf简介" class="headerlink" title="1、thymeleaf简介"></a>1、thymeleaf简介</h5><p>Thymeleaf is a modern server-side Java template engine for both web and standalone environments, capable of processing HTML, XML, JavaScript, CSS and even plain text.</p>
<p><strong>现代化、服务端Java模板引擎</strong></p>
<h5 id="2、基本语法"><a href="#2、基本语法" class="headerlink" title="2、基本语法"></a>2、基本语法</h5><h6 id="1、表达式"><a href="#1、表达式" class="headerlink" title="1、表达式"></a>1、表达式</h6><table>
<thead>
<tr>
<th>表达式名字</th>
<th>语法</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>变量取值</td>
<td>${…}</td>
<td>获取请求域、session域、对象等值</td>
</tr>
<tr>
<td>选择变量</td>
<td>*{…}</td>
<td>获取上下文对象值</td>
</tr>
<tr>
<td>消息</td>
<td>#{…}</td>
<td>获取国际化等值</td>
</tr>
<tr>
<td>链接</td>
<td>@{…}</td>
<td>生成链接</td>
</tr>
<tr>
<td>片段表达式</td>
<td>~{…}</td>
<td>jsp:include 作用，引入公共页面片段</td>
</tr>
</tbody></table>
<h6 id="2、字面量"><a href="#2、字面量" class="headerlink" title="2、字面量"></a>2、字面量</h6><p>文本值: <strong>‘one text’</strong> <strong>,</strong> <strong>‘Another one!’</strong> <strong>,…</strong>数字: <strong>0</strong> <strong>,</strong> <strong>34</strong> <strong>,</strong> <strong>3.0</strong> <strong>,</strong> <strong>12.3</strong> <strong>,…</strong>布尔值: <strong>true</strong> <strong>,</strong> <strong>false</strong></p>
<p>空值: <strong>null</strong></p>
<p>变量： one，two，…. 变量不能有空格</p>
<h6 id="3、文本操作"><a href="#3、文本操作" class="headerlink" title="3、文本操作"></a>3、文本操作</h6><p>字符串拼接: <strong>+</strong></p>
<p>变量替换: <strong>|The name is ${name}|</strong> </p>
<h6 id="4、数学运算"><a href="#4、数学运算" class="headerlink" title="4、数学运算"></a>4、数学运算</h6><p>运算符: + , - , * , &#x2F; , %</p>
<h6 id="5、布尔运算"><a href="#5、布尔运算" class="headerlink" title="5、布尔运算"></a>5、布尔运算</h6><p>运算符:  <strong>and</strong> <strong>,</strong> <strong>or</strong></p>
<p>一元运算: <strong>!</strong> <strong>,</strong> <strong>not</strong> </p>
<h6 id="6、比较运算"><a href="#6、比较运算" class="headerlink" title="6、比较运算"></a>6、比较运算</h6><p>比较: <strong>&gt;</strong> <strong>,</strong> <strong>&lt;** **,** **&gt;&#x3D;</strong> <strong>,</strong> <strong>&lt;&#x3D;</strong> <strong>(</strong> <strong>gt</strong> <strong>,</strong> <strong>lt</strong> <strong>,</strong> <strong>ge</strong> <strong>,</strong> <strong>le</strong> **)**等式: <strong>&#x3D;&#x3D;</strong> <strong>,</strong> <strong>!&#x3D;</strong> <strong>(</strong> <strong>eq</strong> <strong>,</strong> <strong>ne</strong> <strong>)</strong> </p>
<h6 id="7、条件运算"><a href="#7、条件运算" class="headerlink" title="7、条件运算"></a>7、条件运算</h6><p>If-then: <strong>(if) ? (then)</strong></p>
<p>If-then-else: <strong>(if) ? (then) : (else)</strong></p>
<p>Default: (value) <strong>?: (defaultvalue)</strong> </p>
<h6 id="8、特殊操作"><a href="#8、特殊操作" class="headerlink" title="8、特殊操作"></a>8、特殊操作</h6><p>无操作： _</p>
<h5 id="3、设置属性值-th-attr"><a href="#3、设置属性值-th-attr" class="headerlink" title="3、设置属性值-th:attr"></a>3、设置属性值-th:attr</h5><p>设置单个值</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;subscribe.html&quot;</span> <span class="attr">th:attr</span>=<span class="string">&quot;action=@&#123;/subscribe&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">fieldset</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Subscribe!&quot;</span> <span class="attr">th:attr</span>=<span class="string">&quot;value=#&#123;subscribe.submit&#125;&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">fieldset</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>设置多个值</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;../../images/gtvglogo.png&quot;</span>  <span class="attr">th:attr</span>=<span class="string">&quot;src=@&#123;/images/gtvglogo.png&#125;,title=#&#123;logo&#125;,alt=#&#123;logo&#125;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上两个的代替写法 th:xxxx</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Subscribe!&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;#&#123;subscribe.submit&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;subscribe.html&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/subscribe&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>所有h5兼容的标签写法</p>
<p><a target="_blank" rel="noopener" href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#setting-value-to-specific-attributes">https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#setting-value-to-specific-attributes</a></p>
<h5 id="4、迭代"><a href="#4、迭代" class="headerlink" title="4、迭代"></a>4、迭代</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;prod : $&#123;prods&#125;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;prod.name&#125;&quot;</span>&gt;</span>Onions<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;prod.price&#125;&quot;</span>&gt;</span>2.41<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;prod.inStock&#125;? #&#123;true&#125; : #&#123;false&#125;&quot;</span>&gt;</span>yes<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;prod,iterStat : $&#123;prods&#125;&quot;</span> <span class="attr">th:class</span>=<span class="string">&quot;$&#123;iterStat.odd&#125;? &#x27;odd&#x27;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;prod.name&#125;&quot;</span>&gt;</span>Onions<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;prod.price&#125;&quot;</span>&gt;</span>2.41<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;prod.inStock&#125;? #&#123;true&#125; : #&#123;false&#125;&quot;</span>&gt;</span>yes<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="5、条件运算"><a href="#5、条件运算" class="headerlink" title="5、条件运算"></a>5、条件运算</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;comments.html&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">th:href</span>=<span class="string">&quot;@&#123;/product/comments(prodId=$&#123;prod.id&#125;)&#125;&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">th:if</span>=<span class="string">&quot;$&#123;not #lists.isEmpty(prod.comments)&#125;&quot;</span>&gt;</span>view<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:switch</span>=<span class="string">&quot;$&#123;user.role&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;&#x27;admin&#x27;&quot;</span>&gt;</span>User is an administrator<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;#&#123;roles.manager&#125;&quot;</span>&gt;</span>User is a manager<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">th:case</span>=<span class="string">&quot;*&quot;</span>&gt;</span>User is some other thing<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="6、属性优先级"><a href="#6、属性优先级" class="headerlink" title="6、属性优先级"></a>6、属性优先级</h5><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605498132699-4fae6085-a207-456c-89fa-e571ff1663da.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="3、thymeleaf使用"><a href="#3、thymeleaf使用" class="headerlink" title="3、thymeleaf使用"></a>3、thymeleaf使用</h4><h5 id="1、引入Starter"><a href="#1、引入Starter" class="headerlink" title="1、引入Starter"></a>1、引入Starter</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2、自动配置好了thymeleaf"><a href="#2、自动配置好了thymeleaf" class="headerlink" title="2、自动配置好了thymeleaf"></a>2、自动配置好了thymeleaf</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ThymeleafProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; TemplateMode.class, SpringTemplateEngine.class &#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; WebMvcAutoConfiguration.class, WebFluxAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThymeleafAutoConfiguration</span> &#123; &#125;</span><br></pre></td></tr></table></figure>



<p>自动配好的策略</p>
<ul>
<li><p>1、所有thymeleaf的配置值都在 ThymeleafProperties</p>
</li>
<li><p>2、配置好了 <strong>SpringTemplateEngine</strong> </p>
</li>
<li><p><strong>3、配好了</strong> <strong>ThymeleafViewResolver</strong> </p>
</li>
<li><p>4、我们只需要直接开发页面</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;classpath:/templates/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;.html&quot;</span>;  <span class="comment">//xxx.html</span></span><br></pre></td></tr></table></figure>

<h5 id="3、页面开发"><a href="#3、页面开发" class="headerlink" title="3、页面开发"></a>3、页面开发</h5><ul>
<li>学的教训：记得要加名称空间啊啊啊啊orz。</li>
<li>所有的域中的取值，都是${}这种方式来进行的嗷！！！</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;msg&#125;&quot;</span>&gt;</span>哈哈<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;www.atguigu.com&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;$&#123;link&#125;&quot;</span>&gt;</span>去百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span>  <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;www.atguigu.com&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;link&#125;&quot;</span>&gt;</span>去百度2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>@{}中填充的就是真正的连接，不能够是变量嗷！！！默认的起始地址就是当前的项目的地址嗷！！！</li>
</ul>
<h4 id="4、构建后台管理系统"><a href="#4、构建后台管理系统" class="headerlink" title="4、构建后台管理系统"></a>4、构建后台管理系统</h4><h5 id="1、项目创建"><a href="#1、项目创建" class="headerlink" title="1、项目创建"></a>1、项目创建</h5><p>thymeleaf、web-starter、devtools、lombok</p>
<h5 id="2、静态资源处理"><a href="#2、静态资源处理" class="headerlink" title="2、静态资源处理"></a>2、静态资源处理</h5><p>自动配置好，我们只需要把所有静态资源放到 static 文件夹下</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210716213802.png" alt="image-20210716213802653"></p>
<h5 id="3、路径构建"><a href="#3、路径构建" class="headerlink" title="3、路径构建"></a>3、路径构建</h5><ul>
<li>注意，加入到form的action才有意义嗷！！！</li>
</ul>
<p>th:action&#x3D;”@{&#x2F;login}”</p>
<h5 id="4、模板抽取"><a href="#4、模板抽取" class="headerlink" title="4、模板抽取"></a>4、模板抽取</h5><ul>
<li>前后加上div标签最好啦，div比较保险嗷，include , insert , replace三者有所不同，注意康康嗷！！！</li>
<li>replace感觉用到的最多，直接拿公共抽取部分来整个替换原有的div，感觉非常方便嗷！！！</li>
<li>使用公共模板之后，相当于导航的功能的页面跳转，只需要在公共页面中修改即可嗷！！！</li>
<li>注意，有的时候bug的出现很有可能是抽取的公共页面中引入了某些资源，原本的代码中也引入了某些资源导致了冲突嗷！！！</li>
</ul>
<p>th:insert&#x2F;replace&#x2F;include</p>
<h5 id="5、页面跳转"><a href="#5、页面跳转" class="headerlink" title="5、页面跳转"></a>5、页面跳转</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">main</span><span class="params">(User user, HttpSession session, Model model)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.hasLength(user.getUserName()) &amp;&amp; <span class="string">&quot;123456&quot;</span>.equals(user.getPassword()))&#123;</span><br><span class="line">        <span class="comment">//把登陆成功的用户保存起来</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;loginUser&quot;</span>,user);</span><br><span class="line">        <span class="comment">//登录成功重定向到main.html;  重定向防止表单重复提交</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/main.html&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;账号密码错误&quot;</span>);</span><br><span class="line">        <span class="comment">//回到登录页面</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="6、数据渲染"><a href="#6、数据渲染" class="headerlink" title="6、数据渲染"></a>6、数据渲染</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/dynamic_table&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">dynamic_table</span><span class="params">(Model model)</span>&#123;</span><br><span class="line"><span class="comment">//表格内容的遍历</span></span><br><span class="line">List&lt;User&gt; users = Arrays.asList(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;123456&quot;</span>),</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;lisi&quot;</span>, <span class="string">&quot;123444&quot;</span>),</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;haha&quot;</span>, <span class="string">&quot;aaaaa&quot;</span>),</span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;hehe &quot;</span>, <span class="string">&quot;aaddd&quot;</span>));</span><br><span class="line">	model.addAttribute(<span class="string">&quot;users&quot;</span>,users);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;table/dynamic_table&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;display table table-bordered&quot;</span> <span class="attr">id</span>=<span class="string">&quot;hidden-table-info&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">th</span>&gt;</span>#<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">th</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">th</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span> <span class="attr">class</span>=<span class="string">&quot;gradeX&quot;</span> <span class="attr">th:each</span>=<span class="string">&quot;user,stats:$&#123;users&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;stats.count&#125;&quot;</span>&gt;</span>Trident<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.userName&#125;&quot;</span>&gt;</span>Internet<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span> &gt;</span>[[$&#123;user.password&#125;]]<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="7、工程问题"><a href="#7、工程问题" class="headerlink" title="7、工程问题"></a>7、工程问题</h5><ul>
<li><p>刷新页面表单重复提交比较耗费资源咋办呢？</p>
<ul>
<li>使用重定向，这样做的目的是重定向到某一个页面，并且使得网页的url发生了改变。这个时候再次刷新页面本质上就不会再次提交表单，而是请求静态资源（通过另外一个Controller来处理），就会快嗷！！！</li>
<li>第一次登录过程中使用重定向之后，后续刷新页面相当于直接请求资源！！！</li>
</ul>
</li>
<li><p>就像上面所说，如果获得了登录页面的绝对地址，访问就能登录，显然非常不合理，那这该怎么办捏？</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理登录提交的表单，并且控制跳转到main页面</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> user 页面表单封装对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> session 存储登录的用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> model 添加request域的数据，例如登录失败等信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">main</span><span class="params">(User user, HttpSession session, Model model)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(user.getUserName()) &amp;&amp; StringUtils.hasLength(user.getPassword()))&#123;</span><br><span class="line">        <span class="comment">//把登录成功的用户保存起来</span></span><br><span class="line">        session.setAttribute(<span class="string">&quot;loginUser&quot;</span>,user);</span><br><span class="line">        <span class="comment">//重定向到main亚目</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/main.html&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//用户名密码不符合要求嗷！！！</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;账号密码错误，请重新登录&quot;</span>);</span><br><span class="line">        <span class="comment">//回到登录页面</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 和上面的重定向搭配使用，解决了页面刷新过程中，表单重复提交的问题嗷！！！</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> session 获取用户Session判断是否登录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> model 向request全局变量添加信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回具体页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/main.html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">mainPage</span><span class="params">(HttpSession session, Model model)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否登录，登录了才能访问对应的页面</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">loginUser</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;loginUser&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (loginUser != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;main&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//回到登录页</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;未登录系统，请重新登录&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面两个搭配使用，完成登录的验证功能。</p>
<p>并且session作为全局作用域，后续保存的数据（例如封装的用户名和密码等用户数据），还能在后续的页面中取出来，继续发挥作用嗷！！！例如<code>[[$&#123;session.loginUser.userName&#125;]]</code></p>
<ul>
<li>正式退出的时候，还要对于Session等进行处理嗷！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210717115242.png" alt="image-20210717115241895"></li>
</ul>
<p>可以通过status作为变量参数去取出一些类似于count，index这样的属性，方便我们遍历的时候使用嗷！！！</p>
<h3 id="6、拦截器"><a href="#6、拦截器" class="headerlink" title="6、拦截器"></a>6、拦截器</h3><h4 id="1、HandlerInterceptor-接口"><a href="#1、HandlerInterceptor-接口" class="headerlink" title="1、HandlerInterceptor 接口"></a>1、HandlerInterceptor 接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录检查</span></span><br><span class="line"><span class="comment"> * 1、配置好拦截器要拦截哪些请求</span></span><br><span class="line"><span class="comment"> * 2、把这些配置放在容器中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 目标方法执行之前</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;preHandle拦截的请求路径是&#123;&#125;&quot;</span>,requestURI);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录检查逻辑</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">loginUser</span> <span class="operator">=</span> session.getAttribute(<span class="string">&quot;loginUser&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(loginUser != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//拦截住。未登录。跳转到登录页</span></span><br><span class="line">        request.setAttribute(<span class="string">&quot;msg&quot;</span>,<span class="string">&quot;请先登录&quot;</span>);</span><br><span class="line"><span class="comment">//        re.sendRedirect(&quot;/&quot;);</span></span><br><span class="line">        request.getRequestDispatcher(<span class="string">&quot;/&quot;</span>).forward(request,response);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 目标方法执行完成以后</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modelAndView</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;postHandle执行&#123;&#125;&quot;</span>,modelAndView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页面渲染以后</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;afterCompletion执行异常&#123;&#125;&quot;</span>,ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2、配置拦截器"><a href="#2、配置拦截器" class="headerlink" title="2、配置拦截器"></a>2、配置拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、编写一个拦截器实现HandlerInterceptor接口</span></span><br><span class="line"><span class="comment"> * 2、拦截器注册到容器中（实现WebMvcConfigurer的addInterceptors）</span></span><br><span class="line"><span class="comment"> * 3、指定拦截规则【如果是拦截所有，静态资源也会被拦截】</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdminWebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)  <span class="comment">//所有请求都被拦截包括静态资源</span></span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/images/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>); <span class="comment">//放行的请求</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一开始为了方便测试在Controller中设置的拦截器要撤掉嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210717165415.png" alt="image-20210717165414903"></p>
<ul>
<li>存放信息处理：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210717165810.png" alt="image-20210717165810843"></p>
<p>这里和前端一样，只能从request中将相应的值取出来。sendRedirect这个时候是不可以的嗷，因为sendRedirect本质上是让客户端发送第二次请求。第二次请求就不会带有我们设置的信息了，所以这里应该使用forward（也可以是我们上面这种写法），将请求转发给”&#x2F;“处理，传入我们现在的request和response，方便我们我们页面渲染的时候进行处理。</p>
<ul>
<li>Log.info()可以打印输出对应位置的某些信息到控制台，方便我们debug或研究程序的执行顺序嗷！！！</li>
</ul>
<h4 id="3、拦截器原理"><a href="#3、拦截器原理" class="headerlink" title="3、拦截器原理"></a>3、拦截器原理</h4><p>1、根据当前请求，找到<strong>HandlerExecutionChain【</strong>可以处理请求的handler以及handler的所有 拦截器】</p>
<p>2、先来<strong>顺序执行</strong> 所有拦截器的 preHandle方法</p>
<ul>
<li>1、如果当前拦截器prehandler返回为true。则执行下一个拦截器的preHandle</li>
<li>2、如果当前拦截器返回为false。直接    倒序执行所有已经执行了的拦截器的  afterCompletion；</li>
</ul>
<p><strong>3、如果任何一个拦截器返回false。直接跳出不执行目标方法</strong></p>
<p><strong>4、所有拦截器都返回True。执行目标方法</strong></p>
<p><strong>5、倒序执行所有拦截器的postHandle方法。</strong></p>
<p><strong>6、前面的步骤有任何异常都会直接倒序触发</strong> afterCompletion</p>
<p>7、页面成功渲染完成以后，也会倒序触发 afterCompletion</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605764129365-5b31a748-1541-4bee-9692-1917b3364bc6.png" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605765121071-64cfc649-4892-49a3-ac08-88b52fb4286f.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h3 id="7、文件上传"><a href="#7、文件上传" class="headerlink" title="7、文件上传"></a>7、文件上传</h3><h4 id="1、页面表单"><a href="#1、页面表单" class="headerlink" title="1、页面表单"></a>1、页面表单</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/upload&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="2、文件上传代码"><a href="#2、文件上传代码" class="headerlink" title="2、文件上传代码"></a>2、文件上传代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MultipartFile 自动封装上传过来的文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> email</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headerImg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> photos</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;email&quot;)</span> String email,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestParam(&quot;username&quot;)</span> String username,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestPart(&quot;headerImg&quot;)</span> MultipartFile headerImg,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestPart(&quot;photos&quot;)</span> MultipartFile[] photos)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;上传的信息：email=&#123;&#125;，username=&#123;&#125;，headerImg=&#123;&#125;，photos=&#123;&#125;&quot;</span>,</span><br><span class="line">             email,username,headerImg.getSize(),photos.length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!headerImg.isEmpty())&#123;</span><br><span class="line">        <span class="comment">//保存到文件服务器，OSS服务器</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> headerImg.getOriginalFilename();</span><br><span class="line">        headerImg.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;H:\\cache\\&quot;</span>+originalFilename));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(photos.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//这里无非是进行遍历而已嘛！！！</span></span><br><span class="line">        <span class="keyword">for</span> (MultipartFile photo : photos) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!photo.isEmpty())&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> photo.getOriginalFilename();</span><br><span class="line">                <span class="comment">//下面这里保存了文件嗷！！！</span></span><br><span class="line">                photo.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;H:\\cache\\&quot;</span>+originalFilename));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;main&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、自动配置原理"><a href="#3、自动配置原理" class="headerlink" title="3、自动配置原理"></a>3、自动配置原理</h4><p><strong>文件上传自动配置类-MultipartAutoConfiguration—–MultipartProperties</strong></p>
<ul>
<li><p>自动配置好了 <strong>StandardServletMultipartResolver   【文件上传解析器】</strong></p>
</li>
<li><p><strong>原理步骤</strong></p>
<ul>
<li><p><strong>1、请求进来使用文件上传解析器判断（</strong>isMultipart<strong>）并封装（</strong>resolveMultipart，<strong>返回</strong>MultipartHttpServletRequest<strong>）文件上传请求</strong></p>
</li>
<li><p><strong>2、参数解析器来解析请求中的文件内容封装成MultipartFile</strong></p>
</li>
<li><p><strong>3、将request中文件信息封装为一个Map；</strong>MultiValueMap&lt;String, MultipartFile&gt;</p>
</li>
</ul>
</li>
</ul>
<p><strong>FileCopyUtils</strong>。实现文件流的拷贝</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;email&quot;)</span> String email,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestParam(&quot;username&quot;)</span> String username,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestPart(&quot;headerImg&quot;)</span> MultipartFile headerImg,</span></span><br><span class="line"><span class="params">                     <span class="meta">@RequestPart(&quot;photos&quot;)</span> MultipartFile[] photos)</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1605847414866-32b6cc9c-5191-4052-92eb-069d652dfbf9.png" alt="img"></p>
<h3 id="8、异常处理"><a href="#8、异常处理" class="headerlink" title="8、异常处理"></a>8、异常处理</h3><h4 id="1、错误处理"><a href="#1、错误处理" class="headerlink" title="1、错误处理"></a>1、错误处理</h4><h5 id="1、默认规则"><a href="#1、默认规则" class="headerlink" title="1、默认规则"></a>1、默认规则</h5><ul>
<li>默认情况下，Spring Boot提供<code>/error</code>处理所有错误的映射</li>
<li>对于机器客户端，它将生成JSON响应，其中包含错误，HTTP状态和异常消息的详细信息。对于浏览器客户端，响应一个“ whitelabel”错误视图，以HTML格式呈现相同的数据</li>
<li><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606024421363-77083c34-0b0e-4698-bb72-42da351d3944.png" alt="img"></li>
<li>上面的JSON中附带的默认对象，其实都是可以在模板引擎中当作变量来获取的嗷！！！</li>
<li><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606024616835-bc491bf0-c3b1-4ac3-b886-d4ff3c9874ce.png" alt="img"></li>
<li><strong>要对其进行自定义，添加</strong><code>**View**</code><strong>解析为</strong><code>**error**``** **</code></li>
<li>要完全替换默认行为，可以实现 <code>ErrorController </code>并注册该类型的Bean定义，或添加<code>ErrorAttributes类型的组件</code>以使用现有机制但替换其内容。</li>
<li>error&#x2F;下的4xx，5xx页面会被自动解析；</li>
<li><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606024592756-d4ab8a6b-ec37-426b-8b39-010463603d57.png" alt="img"></li>
</ul>
<h4 id="2、定制错误处理逻辑"><a href="#2、定制错误处理逻辑" class="headerlink" title="2、定制错误处理逻辑"></a>2、定制错误处理逻辑</h4><ul>
<li><p>自定义错误页</p>
<ul>
<li>error&#x2F;404.html   error&#x2F;5xx.html；有精确的错误状态码页面就匹配精确，没有就找 4xx.html；如果都没有就触发白页</li>
</ul>
</li>
<li><p>@ControllerAdvice+@ExceptionHandler处理全局异常；底层是 <strong>ExceptionHandlerExceptionResolver 支持的</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(&#123;ArithmeticException.class,NullPointerException.class&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handlerArithException</span><span class="params">(Exception e)</span>&#123;</span><br><span class="line"></span><br><span class="line">        log.error(<span class="string">&quot;异常是:&#123;&#125;&quot;</span>,e);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>; <span class="comment">//视图地址</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@ResponseStatus+自定义异常 ；底层是 <strong>ResponseStatusExceptionResolver ，把responsestatus注解的信息底层调用</strong> <strong>response.sendError(statusCode, resolvedReason)；tomcat发送的&#x2F;error</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseStatus(value = HttpStatus.FORBIDDEN,reason = &quot;用户数量太多&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTooManyException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserTooManyException</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserTooManyException</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Spring底层的异常，如 参数类型转换异常；<strong>DefaultHandlerExceptionResolver 处理框架底层的异常。</strong></p>
</li>
<li><p>response.sendError(HttpServletResponse.<strong>SC_BAD_REQUEST</strong>, ex.getMessage()); </p>
</li>
<li><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606114118010-f4aaf5ee-2747-4402-bc82-08321b2490ed.png" alt="img"></p>
</li>
<li><p>自定义实现 HandlerExceptionResolver 处理异常；可以作为默认的全局异常处理规则</p>
<ul>
<li><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606114688649-e6502134-88b3-48db-a463-04c23eddedc7.png" alt="img"></p>
</li>
<li><p>&#96;&#96;&#96;java<br>package com.tuzi.exception;</p>
<p>import org.springframework.core.Ordered;<br>import org.springframework.core.annotation.Order;<br>import org.springframework.stereotype.Component;<br>import org.springframework.web.servlet.HandlerExceptionResolver;<br>import org.springframework.web.servlet.ModelAndView;</p>
<p>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;<br>import java.io.IOException;</p>
<p>&#x2F;&#x2F;自定义异常处理<br>@Order(value &#x3D; Ordered.HIGHEST_PRECEDENCE) &#x2F;&#x2F;优先级最高<br>@Component<br>public class CustomerHandlerExceptionResolver implements HandlerExceptionResolver {<br>@Override<br>public ModelAndView resolveException(HttpServletRequest httpServletRequest,<br>                                     HttpServletResponse httpServletResponse,<br>                                     Object o,<br>                                     Exception e) {<br>    try {<br>        httpServletResponse.sendError(511,”我喜欢的错误嗷！！！”);<br>    } catch (IOException ioException) {<br>        ioException.printStackTrace();<br>    }<br><br>    return new ModelAndView();<br>}<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- **ErrorViewResolver**  实现自定义处理异常；</span><br><span class="line"></span><br><span class="line">  - response.sendError 。error请求就会转给controller</span><br><span class="line">  - 你的异常没有任何人能处理。tomcat底层 response.sendError。error请求就会转给controller</span><br><span class="line">  - **basicErrorController 要去的页面地址是** **ErrorViewResolver**  ；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 3、异常处理自动配置原理</span><br><span class="line"></span><br><span class="line">- **ErrorMvcAutoConfiguration  自动配置异常处理规则**</span><br><span class="line">  - **容器中的组件：类型：DefaultErrorAttributes -&gt;** **id：errorAttributes**</span><br><span class="line"></span><br><span class="line">    - **public class** **DefaultErrorAttributes** **implements** **ErrorAttributes**, **HandlerExceptionResolver**</span><br><span class="line">    - **DefaultErrorAttributes**：定义错误页面中可以包含哪些数据。</span><br><span class="line"></span><br><span class="line">    - ![img](https://cdn.nlark.com/yuque/0/2020/png/1354552/1606044430037-8d599e30-1679-407c-96b7-4df345848fa4.png)</span><br><span class="line">    - ![img](https://cdn.nlark.com/yuque/0/2020/png/1354552/1606044487738-8cb1dcda-08c5-4104-a634-b2468512e60f.png)</span><br><span class="line">  - **容器中的组件：类型：**BasicErrorController --&gt; id：basicErrorController（json+白页 适配响应）**</span><br><span class="line">    - **处理默认** **/error 路径的请求；页面响应** **new** ModelAndView(**&quot;error&quot;**, model)；</span><br><span class="line">    - **容器中有组件 View**-&gt;**id是error**；（响应默认错误页）</span><br><span class="line"></span><br><span class="line">    - 容器中放组件 **BeanNameViewResolver（视图解析器）；按照返回的视图名作为组件的id去容器中找View对象。**</span><br><span class="line"></span><br><span class="line">  - **容器中的组件：**类型：**DefaultErrorViewResolver -&gt; id：**conventionErrorViewResolver</span><br><span class="line"></span><br><span class="line">    - 如果发生错误，会以HTTP的状态码 作为视图页地址（viewName），找到真正的页面</span><br><span class="line">    - error/404、5xx.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 如果想要返回页面；就会找error视图【**StaticView**】。(默认是一个白页)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">![img](https://cdn.nlark.com/yuque/0/2020/png/1354552/1606043870164-3770e116-344f-448e-8bff-8f32438edc9a.png)写出去json</span><br><span class="line"></span><br><span class="line">![img](https://cdn.nlark.com/yuque/0/2020/png/1354552/1606043904074-50b7f088-2d2b-4da5-85e2-0a756da74dca.png) 错误页</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 4、异常处理步骤流程</span><br><span class="line"></span><br><span class="line">1、执行目标方法，目标方法运行期间有任何异常都会被catch、而且标志当前请求结束；并且用 **dispatchException** 进行封装</span><br><span class="line"></span><br><span class="line">2、进入视图解析流程（页面渲染？） </span><br><span class="line"></span><br><span class="line">processDispatchResult(processedRequest, response, mappedHandler, **mv**, **dispatchException**);</span><br><span class="line"></span><br><span class="line">3、**mv** = **processHandlerException**；处理handler发生的异常，处理完成返回ModelAndView；</span><br><span class="line"></span><br><span class="line">- 1、遍历所有的 **handlerExceptionResolvers，看谁能处理当前异常【HandlerExceptionResolver处理器异常解析器】**</span><br><span class="line">- ![img](https://cdn.nlark.com/yuque/0/2020/png/1354552/1606047252166-ce71c3a1-0e0e-4499-90f4-6d80014ca19f.png)</span><br><span class="line">- **2、系统默认的  异常解析器；**</span><br><span class="line">- ![img](https://cdn.nlark.com/yuque/0/2020/png/1354552/1606047109161-c68a46c1-202a-4db1-bbeb-23fcae49bbe9.png)</span><br><span class="line"></span><br><span class="line">  - **1、DefaultErrorAttributes先来处理异常。把异常信息保存到request域，并且返回null；**</span><br><span class="line">  - **2、默认没有任何人能处理异常，所以异常会被抛出**</span><br><span class="line"></span><br><span class="line">    - **1、如果没有任何人能处理最终底层就会发送 /error 请求。会被底层的BasicErrorController处理**</span><br><span class="line">    - **2、解析错误视图；遍历所有的**  **ErrorViewResolver  看谁能解析。**</span><br><span class="line">    - ![img](https://cdn.nlark.com/yuque/0/2020/png/1354552/1606047900473-e31c1dc3-7a5f-4f70-97de-5203429781fa.png)</span><br><span class="line">    - **3、默认的** **DefaultErrorViewResolver ,作用是把响应状态码作为错误页的地址，error/500.html** </span><br><span class="line">    - **4、模板引擎最终响应这个页面** **error/500.html** </span><br><span class="line">- 总结：出了错误的时候，系统会先去找有没有什么方法是能够处理异常的（如果自己没写的话，就找不到，返回null），处理不了的话，当然就得告诉用户出了问题了嗷orz。系统就会默认发送/error的请求，通过ErrorViewResolver，返回对应的出错的视图给用户展示。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 9、Web原生组件注入（Servlet、Filter、Listener）</span><br><span class="line"></span><br><span class="line">#### 1、使用Servlet API</span><br><span class="line"></span><br><span class="line">@ServletComponentScan(basePackages = **&quot;com.atguigu.admin&quot;**) :指定原生Servlet组件都放在那里(位于主配置类中)</span><br><span class="line"></span><br><span class="line">@WebServlet(urlPatterns = **&quot;/my&quot;**)：效果：直接响应，**没有经过Spring的拦截器？**（位于编写的Servlet的相应类中，这个Servlet应该继承HttpServlet嗷！！！）</span><br><span class="line"></span><br><span class="line">@WebFilter(urlPatterns=&#123;**&quot;/css/\*&quot;**,**&quot;/images/\*&quot;**&#125;)</span><br><span class="line"></span><br><span class="line">@WebListener</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">package com.tuzi.servlet;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import javax.servlet.ServletException;</span><br><span class="line">import javax.servlet.annotation.WebServlet;</span><br><span class="line">import javax.servlet.http.HttpServlet;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import javax.servlet.http.HttpServletResponse;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">@WebServlet(urlPatterns = &quot;/my&quot;)</span><br><span class="line">public class MyServlet extends HttpServlet &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123;</span><br><span class="line">        resp.getWriter().write(&quot;这是兔兔的测试嗷！！！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContextEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContextListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyListener</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyListener监听到项目初始化完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyListener监听到项目销毁&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@WebFilter(urlPatterns = &#123;&quot;/css/*&quot;,&quot;/images/*&quot;&#125;)</span> <span class="comment">//拦截的对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyFilter初始化完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyFilter销毁&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyFilter工作&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>推荐可以这种方式；</p>
</li>
<li><p>注意：Servlet下的写法是单星，Spring中的写法是双星</p>
</li>
</ul>
<p>扩展：DispatchServlet 如何注册进来</p>
<ul>
<li><p>容器中自动配置了  DispatcherServlet  属性绑定到 WebMvcProperties；对应的配置文件配置项是 <strong>spring.mvc。</strong></p>
</li>
<li><p><strong>通过</strong> <strong>ServletRegistrationBean</strong><DispatcherServlet> 把 DispatcherServlet  配置进来。</p>
</li>
<li><p>默认映射的是 &#x2F; 路径。</p>
</li>
</ul>
<p><code>spring.mvc.servlet.path=/mvc/</code></p>
<ul>
<li>可以通过上面这种方式来配置对应的路径嗷！！！（DispatcherServlet对应的拦截的路径嗷！！！）</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606284869220-8b63d54b-39c4-40f6-b226-f5f095ef9304.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>Tomcat-Servlet；</p>
<p>多个Servlet都能处理到同一层路径，精确优选原则(有点像计算机网络中学习到的最长前缀匹配原则。)</p>
<p>A： &#x2F;my&#x2F;</p>
<p>B： &#x2F;my&#x2F;1</p>
<h4 id="2、使用RegistrationBean"><a href="#2、使用RegistrationBean" class="headerlink" title="2、使用RegistrationBean"></a>2、使用RegistrationBean</h4><ul>
<li>就相当于不用注解啦，直接再构造一个类，将我们写好的Servlet加入到容器中就可以生效了嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">`ServletRegistrationBean`, `FilterRegistrationBean`, and `ServletListenerRegistrationBean</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRegistConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServletRegistrationBean <span class="title function_">myServlet</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MyServlet</span> <span class="variable">myServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyServlet</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletRegistrationBean</span>(myServlet,<span class="string">&quot;/my&quot;</span>,<span class="string">&quot;/my02&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FilterRegistrationBean <span class="title function_">myFilter</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MyFilter</span> <span class="variable">myFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyFilter</span>();</span><br><span class="line"><span class="comment">//        return new FilterRegistrationBean(myFilter,myServlet());这就默认拦截和myServlet一样的路径嗷！</span></span><br><span class="line">        <span class="type">FilterRegistrationBean</span> <span class="variable">filterRegistrationBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>(myFilter);</span><br><span class="line">        filterRegistrationBean.setUrlPatterns(Arrays.asList(<span class="string">&quot;/my&quot;</span>,<span class="string">&quot;/css/*&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServletListenerRegistrationBean <span class="title function_">myListener</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MySwervletContextListener</span> <span class="variable">mySwervletContextListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySwervletContextListener</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServletListenerRegistrationBean</span>(mySwervletContextListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>一定要记得@Bean，@Bean才是把对应返回的组件放到容器中来。</li>
<li>这里用单实例的最好嗷，一个就够了，不然可能会有很多杂的东西在容器里面嗷！！！</li>
</ul>
<h3 id="10、嵌入式Servlet容器"><a href="#10、嵌入式Servlet容器" class="headerlink" title="10、嵌入式Servlet容器"></a>10、嵌入式Servlet容器</h3><h4 id="1、切换嵌入式Servlet容器"><a href="#1、切换嵌入式Servlet容器" class="headerlink" title="1、切换嵌入式Servlet容器"></a>1、切换嵌入式Servlet容器</h4><ul>
<li><p>默认支持的webServer</p>
<ul>
<li><code>Tomcat</code>, <code>Jetty</code>, or <code>Undertow</code></li>
<li><code>ServletWebServerApplicationContext 容器启动寻找ServletWebServerFactory 并引导创建服务器</code></li>
</ul>
</li>
<li><p>切换服务器</p>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606280937533-504d0889-b893-4a01-af68-2fc31ffce9fc.png" alt="img"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<ul>
<li>原理<ul>
<li>SpringBoot应用启动发现当前是Web应用。web场景包-导入tomcat</li>
<li>web应用会创建一个web版的ioc容器 <code>ServletWebServerApplicationContext</code> </li>
<li><code>ServletWebServerApplicationContext</code> 启动的时候寻找 <code>**ServletWebServerFactory**``（Servlet 的web服务器工厂---&gt; Servlet 的web服务器）</code> </li>
<li>SpringBoot底层默认有很多的WebServer工厂；<code>TomcatServletWebServerFactory</code>, <code>JettyServletWebServerFactory</code>, or <code>UndertowServletWebServerFactory</code></li>
<li><code>底层直接会有一个自动配置类。ServletWebServerFactoryAutoConfiguration</code></li>
<li><code>ServletWebServerFactoryAutoConfiguration导入了ServletWebServerFactoryConfiguration（配置类）</code></li>
<li><code>ServletWebServerFactoryConfiguration 配置类 根据动态判断系统中到底导入了哪个Web服务器的包。（默认是web-starter导入tomcat包），容器中就有 TomcatServletWebServerFactory</code></li>
<li><code>TomcatServletWebServerFactory 创建出Tomcat服务器并启动；TomcatWebServer 的构造器拥有初始化方法initialize---this.tomcat.start();</code></li>
<li><code>内嵌服务器，就是手动把启动服务器的代码调用（tomcat核心jar包存在）</code></li>
<li>&#96;&#96;</li>
</ul>
</li>
</ul>
<h4 id="2、定制Servlet容器"><a href="#2、定制Servlet容器" class="headerlink" title="2、定制Servlet容器"></a>2、定制Servlet容器</h4><ul>
<li><p>实现  **WebServerFactoryCustomizer&lt;ConfigurableServletWebServerFactory&gt; **</p>
<ul>
<li>把配置文件的值和<strong>ServletWebServerFactory 进行绑定</strong></li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210718160633.png" alt="image-20210718160633431"></li>
</ul>
</li>
<li><p>修改配置文件 <strong>server.xxx</strong></p>
</li>
<li><p>直接自定义 <strong>ConfigurableServletWebServerFactory</strong> ：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210718160407.png" alt="image-20210718160406922"></p>
<p><strong>xxxxxCustomizer</strong>：定制化器，可以改变xxxx的默认规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.web.server.WebServerFactoryCustomizer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.server.ConfigurableServletWebServerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomizationBean</span> <span class="keyword">implements</span> <span class="title class_">WebServerFactoryCustomizer</span>&lt;ConfigurableServletWebServerFactory&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(ConfigurableServletWebServerFactory server)</span> &#123;</span><br><span class="line">        server.setPort(<span class="number">9000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="11、定制化原理"><a href="#11、定制化原理" class="headerlink" title="11、定制化原理"></a>11、定制化原理</h3><h4 id="1、定制化的常见方式"><a href="#1、定制化的常见方式" class="headerlink" title="1、定制化的常见方式"></a>1、定制化的常见方式</h4><ul>
<li><p>修改配置文件；</p>
</li>
<li><p><strong>xxxxxCustomizer；</strong></p>
</li>
<li><p><strong>编写自定义的配置类   xxxConfiguration；+</strong> <strong>@Bean替换、增加容器中默认组件；视图解析器</strong> </p>
</li>
<li><p><strong>Web应用 编写一个配置类实现</strong> <strong>WebMvcConfigurer 即可定制化web功能；+ @Bean给容器中再扩展一些组件</strong>(一个类，搞定所有问题，可以加入@Bean拓展组件，也可以覆盖某些方法，加入自己写的组件嗷！！！)</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210718162702.png" alt="image-20210718162631570"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdminWebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span></span><br></pre></td></tr></table></figure>

<p>上面这两个就是例子，可以使用实现WebMvcConfigurer加上@Configuration的方式，覆盖一些函数加入某些功能或者是在对应的类中通过@Bean将我们需要的组件放入到容器中来。</p>
<ul>
<li>@EnableWebMvc + WebMvcConfigurer —— @Bean  可以全面接管SpringMVC，所有规则全部自己重新配置； 实现定制和扩展功能<ul>
<li>原理</li>
<li>1、WebMvcAutoConfiguration  默认的SpringMVC的自动配置功能类。静态资源、欢迎页…..</li>
<li>2、一旦使用 @EnableWebMvc 。会 @Import(DelegatingWebMvcConfiguration.<strong>class</strong>)</li>
<li>3、<strong>DelegatingWebMvcConfiguration</strong> 的 作用，只保证SpringMVC最基本的使用<ul>
<li>把所有系统中的 WebMvcConfigurer 拿过来。所有功能的定制都是这些 WebMvcConfigurer  合起来一起生效</li>
<li>自动配置了一些非常底层的组件。<strong>RequestMappingHandlerMapping</strong>、这些组件依赖的组件都是从容器中获取</li>
<li><strong>public class</strong> DelegatingWebMvcConfiguration <strong>extends</strong> <strong>WebMvcConfigurationSupport</strong></li>
</ul>
</li>
<li>4、<strong>WebMvcAutoConfiguration</strong> 里面的配置要能生效 必须  @ConditionalOnMissingBean(<strong>WebMvcConfigurationSupport</strong>.<strong>class</strong>)</li>
<li>5、@EnableWebMvc  导致了 <strong>WebMvcAutoConfiguration  没有生效。</strong></li>
<li>… …</li>
</ul>
</li>
</ul>
<h4 id="2、原理分析套路"><a href="#2、原理分析套路" class="headerlink" title="2、原理分析套路"></a>2、原理分析套路</h4><p><strong>场景starter</strong> <strong>- xxxxAutoConfiguration - 导入xxx组件 - 绑定xxxProperties –</strong> <strong>绑定配置文件项</strong> </p>
<h2 id="数据访问："><a href="#数据访问：" class="headerlink" title="数据访问："></a>数据访问：</h2><h3 id="1、SQL"><a href="#1、SQL" class="headerlink" title="1、SQL"></a>1、SQL</h3><h4 id="1、数据源的自动配置-HikariDataSource"><a href="#1、数据源的自动配置-HikariDataSource" class="headerlink" title="1、数据源的自动配置-HikariDataSource"></a>1、数据源的自动配置-<strong>HikariDataSource</strong></h4><h5 id="1、导入JDBC场景"><a href="#1、导入JDBC场景" class="headerlink" title="1、导入JDBC场景"></a>1、导入JDBC场景</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>导入的starter中包含了以下的内容：</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606366100317-5e0199fa-6709-4d32-bce3-bb262e2e5e6a.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<ul>
<li>数据库驱动？</li>
</ul>
<p>为什么导入JDBC场景，官方不导入驱动？官方不知道我们接下要操作什么数据库。如果我们使用的是MySql，我们还要引入如下的MySQL驱动：</p>
<p>数据库版本要和驱动版本对应</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">默认版本：</span><br><span class="line"><span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.22<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;version&gt;5.1.49&lt;/version&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">想要修改版本</span><br><span class="line">1、直接依赖引入具体版本（maven的就近依赖原则）</span><br><span class="line">2、重新声明版本（maven的属性的就近优先原则）</span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.49<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210719162954.png" alt="image-20210719162954595"></p>
<h4 id="2、分析自动配置"><a href="#2、分析自动配置" class="headerlink" title="2、分析自动配置"></a>2、分析自动配置</h4><h5 id="1、自动配置的类"><a href="#1、自动配置的类" class="headerlink" title="1、自动配置的类"></a>1、自动配置的类</h5><ul>
<li>DataSourceAutoConfiguration ： 数据源的自动配置<ul>
<li>修改数据源相关的配置：<strong>spring.datasource</strong></li>
<li><strong>数据库连接池的配置，是自己容器中没有DataSource才自动配置的</strong></li>
<li>底层配置好的连接池是：<strong>HikariDataSource</strong></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Conditional(PooledDataSourceCondition.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span></span><br><span class="line"><span class="meta">		DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.OracleUcp.class,</span></span><br><span class="line"><span class="meta">		DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PooledDataSourceConfiguration</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>DataSourceTransactionManagerAutoConfiguration： 事务管理器的自动配置</p>
</li>
<li><p>JdbcTemplateAutoConfiguration： <strong>JdbcTemplate的自动配置，可以来对数据库进行crud</strong></p>
<ul>
<li>可以修改这个配置项@ConfigurationProperties(prefix &#x3D; <strong>“spring.jdbc”</strong>) 来修改JdbcTemplate</li>
<li>@Bean@Primary    JdbcTemplate；容器中有这个组件</li>
</ul>
</li>
<li><p>JndiDataSourceAutoConfiguration： jndi的自动配置</p>
</li>
<li><p>XADataSourceAutoConfiguration： 分布式事务相关的</p>
</li>
</ul>
<h4 id="3、修改配置项"><a href="#3、修改配置项" class="headerlink" title="3、修改配置项"></a>3、修改配置项</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db_account</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br></pre></td></tr></table></figure>



<h4 id="4、测试"><a href="#4、测试" class="headerlink" title="4、测试"></a>4、测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Boot05WebAdminApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        jdbcTemplate.queryForObject(&quot;select * from account_tbl&quot;)</span></span><br><span class="line"><span class="comment">//        jdbcTemplate.queryForList(&quot;select * from account_tbl&quot;,)</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">aLong</span> <span class="operator">=</span> jdbcTemplate.queryForObject(<span class="string">&quot;select count(*) from account_tbl&quot;</span>, Long.class);</span><br><span class="line">        log.info(<span class="string">&quot;记录总数：&#123;&#125;&quot;</span>,aLong);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、使用Druid数据源"><a href="#2、使用Druid数据源" class="headerlink" title="2、使用Druid数据源"></a>2、使用Druid数据源</h3><h4 id="1、druid官方github地址"><a href="#1、druid官方github地址" class="headerlink" title="1、druid官方github地址"></a>1、druid官方github地址</h4><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid">https://github.com/alibaba/druid</a></p>
<p>整合第三方技术的两种方式</p>
<ul>
<li>自定义</li>
<li>找starter</li>
</ul>
<h4 id="2、自定义方式"><a href="#2、自定义方式" class="headerlink" title="2、自定义方式"></a>2、自定义方式</h4><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT/?p=61&spm_id_from=pageDriver">这一课讲的十分好，如何把druid手动整合。如何通过官方的Spring文档来导入到SpringBoot中嗷！！！</a></p>
<h5 id="1、创建数据源"><a href="#1、创建数据源" class="headerlink" title="1、创建数据源"></a>1、创建数据源</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//下面是Spring中常见的Druid配置，在boot中，我们通过配置类的方式来对于数据源进行配置嗷！！！</span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxWait&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;timeBetweenEvictionRunsMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;60000&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;minEvictableIdleTimeMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;300000&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testWhileIdle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnBorrow&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;testOnReturn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;poolPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxOpenPreparedStatements&quot;</span> <span class="attr">value</span>=<span class="string">&quot;20&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>官网给的所有的配置文件，都是可以通过配置类以及配置类的相关方法进行配置的嗷！！！可以去看druid的官方文档嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210719170200.png" alt="image-20210719170200031"></p>
<ul>
<li>如果我们这里使用了@ConfigurationProperities，这些属性也可以通过在配置文件中进行配置来进行自动的绑定嗷！！！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210719170434.png" alt="image-20210719170433151"></p>
<ul>
<li>官方文档中对于什么Servlet的配置啊之类的，我们只需要翻译成boot中对应的内容，类似于ServletRegistrationBean，将对应的组件加入到容器中即可嗷！！！</li>
</ul>
<h5 id="2、StatViewServlet"><a href="#2、StatViewServlet" class="headerlink" title="2、StatViewServlet"></a>2、StatViewServlet</h5><p>StatViewServlet的用途包括：</p>
<ul>
<li>提供监控信息展示的html页面</li>
<li>提供监控信息的JSON API</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.alibaba.druid.support.http.StatViewServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DruidStatView<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/druid/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="3、StatFilter"><a href="#3、StatFilter" class="headerlink" title="3、StatFilter"></a>3、StatFilter</h5><p>用于统计监控信息；如SQL监控、URI监控</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">需要给数据源中配置如下属性；可以允许多个filter，多个用，分割；如：</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;filters&quot;</span> <span class="attr">value</span>=<span class="string">&quot;stat,slf4j&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>系统中所有filter：</p>
<table>
<thead>
<tr>
<th>别名</th>
<th>Filter类名</th>
</tr>
</thead>
<tbody><tr>
<td>default</td>
<td>com.alibaba.druid.filter.stat.StatFilter</td>
</tr>
<tr>
<td>stat</td>
<td>com.alibaba.druid.filter.stat.StatFilter</td>
</tr>
<tr>
<td>mergeStat</td>
<td>com.alibaba.druid.filter.stat.MergeStatFilter</td>
</tr>
<tr>
<td>encoding</td>
<td>com.alibaba.druid.filter.encoding.EncodingConvertFilter</td>
</tr>
<tr>
<td>log4j</td>
<td>com.alibaba.druid.filter.logging.Log4jFilter</td>
</tr>
<tr>
<td>log4j2</td>
<td>com.alibaba.druid.filter.logging.Log4j2Filter</td>
</tr>
<tr>
<td>slf4j</td>
<td>com.alibaba.druid.filter.logging.Slf4jLogFilter</td>
</tr>
<tr>
<td>commonlogging</td>
<td>com.alibaba.druid.filter.logging.CommonsLogFilter</td>
</tr>
</tbody></table>
<p><strong>慢SQL记录配置</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;stat-filter&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.filter.stat.StatFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;slowSqlMillis&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;logSlowSql&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">使用 slowSqlMillis 定义慢SQL的时长</span><br></pre></td></tr></table></figure>









<h4 id="3、使用官方starter方式"><a href="#3、使用官方starter方式" class="headerlink" title="3、使用官方starter方式"></a>3、使用官方starter方式</h4><h5 id="1、引入druid-starter"><a href="#1、引入druid-starter" class="headerlink" title="1、引入druid-starter"></a>1、引入druid-starter</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="2、分析自动配置-1"><a href="#2、分析自动配置-1" class="headerlink" title="2、分析自动配置"></a>2、分析自动配置</h5><ul>
<li><p>扩展配置项 <strong>spring.datasource.druid</strong></p>
</li>
<li><p>DruidSpringAopConfiguration.<strong>class</strong>,   监控SpringBean的；配置项：<strong>spring.datasource.druid.aop-patterns</strong></p>
</li>
<li><p>DruidStatViewServletConfiguration.<strong>class</strong>, 监控页的配置：<strong>spring.datasource.druid.stat-view-servlet；默认开启</strong></p>
</li>
<li><p>DruidWebStatFilterConfiguration.<strong>class</strong>, web监控配置；<strong>spring.datasource.druid.web-stat-filter；默认开启</strong></p>
</li>
<li><p>DruidFilterConfiguration.<strong>class</strong>}) 所有Druid自己filter的配置</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_STAT_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.stat&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_CONFIG_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.config&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_ENCODING_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.encoding&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_SLF4J_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.slf4j&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_LOG4J_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.log4j&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_LOG4J2_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.log4j2&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_COMMONS_LOG_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.commons-log&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_WALL_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.datasource.druid.filter.wall&quot;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面这些是官方已经为我们配置好了的，我们只需要在配置文件中对于其进行配置即可嗷！！！</li>
</ul>
<h5 id="3、配置示例"><a href="#3、配置示例" class="headerlink" title="3、配置示例"></a>3、配置示例</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/db_account</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">aop-patterns:</span> <span class="string">com.atguigu.admin.*</span>  <span class="comment">#监控SpringBean</span></span><br><span class="line">      <span class="attr">filters:</span> <span class="string">stat,wall</span>     <span class="comment"># 底层开启功能，stat（sql监控），wall（防火墙）</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">stat-view-servlet:</span>   <span class="comment"># 配置监控页功能</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">login-username:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">login-password:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">resetEnable:</span> <span class="literal">false</span> <span class="comment">#这个就是重置按钮</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">web-stat-filter:</span>  <span class="comment"># 监控web</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">urlPattern:</span> <span class="string">/*</span></span><br><span class="line">        <span class="attr">exclusions:</span> <span class="string">&#x27;*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">stat:</span>    <span class="comment"># 对上面filters里面的stat的详细配置</span></span><br><span class="line">          <span class="attr">slow-sql-millis:</span> <span class="number">1000</span></span><br><span class="line">          <span class="attr">logSlowSql:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">wall:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">config:</span></span><br><span class="line">            <span class="attr">drop-table-allow:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>SpringBoot配置示例</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a></p>
<p>配置项列表<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/DruidDataSource%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8">https://github.com/alibaba/druid/wiki/DruidDataSource%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8</a></p>
<h3 id="3、整合MyBatis操作"><a href="#3、整合MyBatis操作" class="headerlink" title="3、整合MyBatis操作"></a>3、整合MyBatis操作</h3><p><a target="_blank" rel="noopener" href="https://github.com/mybatis">https://github.com/mybatis</a></p>
<p>starter</p>
<p>SpringBoot官方的Starter：spring-boot-starter-*</p>
<p>第三方的： *-spring-boot-starter</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606704096118-53001250-a04a-4210-80ee-6de6a370be2e.png" alt="img"></p>
<h4 id="1、配置模式"><a href="#1、配置模式" class="headerlink" title="1、配置模式"></a>1、配置模式</h4><ul>
<li><p>全局配置文件</p>
</li>
<li><p>SqlSessionFactory: 自动配置好了</p>
</li>
<li><p>SqlSession：自动配置了 <strong>SqlSessionTemplate 组合了SqlSession</strong></p>
</li>
<li><p>@Import(<strong>AutoConfiguredMapperScannerRegistrar</strong>.<strong>class</strong>）；</p>
</li>
<li><p>Mapper： 只要我们写的操作MyBatis的接口标准了 <strong>@Mapper 就会被自动扫描进来</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(MybatisProperties.class)</span> ： MyBatis配置项绑定类。</span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; DataSourceAutoConfiguration.class, MybatisLanguageDriverAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisAutoConfiguration</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mybatis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisProperties</span></span><br></pre></td></tr></table></figure>

<p>可以修改配置文件中 mybatis 开始的所有；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置mybatis规则</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis/mybatis-config.xml</span>  <span class="comment">#全局配置文件位置</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mybatis/mapper/*.xml</span>  <span class="comment">#sql映射文件位置</span></span><br></pre></td></tr></table></figure>
<ul>
<li>上面是配置文件，下面是和以前的MyBatis用法一样的Mapper映射文件，需要搭配mapper抽象类接口一起使用嗷！！！</li>
<li>注意，以下配置文件不是我们所说的全局配置文件，全局配置文件可以上官方文档中拷贝出来嗷！！！</li>
<li>注意Mapper抽象类上面要加上@Mapper注解。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Mapper接口---&gt;绑定Xml</span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.atguigu.admin.mapper.AccountMapper&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    public Account getAcct(Long id); --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAcct&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.atguigu.admin.bean.Account&quot;</span>&gt;</span></span><br><span class="line">        select * from  account_tbl where  id=#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ul>
<li>全局配置文件：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210719203602.png" alt="image-20210719203601908"></p>
<p>可以在配置文件中开启对应的驼峰命名规则。同理，xml太麻烦，在我们的配置文件中有没有默认绑定上对应的规则呢？如下所示嗷！！！</p>
<p>配置 <strong>private</strong> Configuration <strong>configuration</strong>; mybatis.<strong>configuration下面的所有，就是相当于改mybatis全局配置文件中的值</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置mybatis规则</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line"><span class="comment">#  config-location: classpath:mybatis/mybatis-config.xml</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mybatis/mapper/*.xml</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#可以不写全局；配置文件，所有全局配置文件的配置都放在configuration配置项中即可</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>下面的配置，和我们上面指定的全局配置文件不能够同时存在嗷！！！</p>
</li>
<li><p>MyBatis使用规则：</p>
<ul>
<li><p>导入mybatis官方starter</p>
</li>
<li><p>编写mapper接口。标准@Mapper注解</p>
</li>
<li><p>编写sql映射文件并绑定mapper接口</p>
</li>
<li><p>在application.yaml中指定Mapper配置文件的位置，以及指定全局配置文件的信息 （建议；<strong>配置在mybatis.configuration</strong>中，不用全局配置文件嗷，太麻烦啦！！！）</p>
</li>
</ul>
</li>
</ul>
<h4 id="2、纯注解模式"><a href="#2、纯注解模式" class="headerlink" title="2、纯注解模式"></a>2、纯注解模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CityMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from city where id=#&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> City <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(City city)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="3、混合模式"><a href="#3、混合模式" class="headerlink" title="3、混合模式"></a>3、混合模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CityMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from city where id=#&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> City <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(City city)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>复杂的专门放在对应的Mapper文件中即可。</p>
</li>
<li><p>拿到对应的Id：</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210719205324.png" alt="image-20210719205324303"></p>
<p>可以通过注解的形式来拿到对应的id嗷！！！并且可以把拿到的id放入对应的City的属性中。</p>
<ul>
<li>这个例子在MyBatis的官方文档中的spring-boot-starter的Quick Start中嗷！！！</li>
</ul>
<p><strong>最佳实战：</strong></p>
<ul>
<li><p>引入mybatis-starter</p>
</li>
<li><p><strong>配置application.yaml中，指定mapper-location位置即可</strong></p>
</li>
<li><p>编写Mapper接口并标注@Mapper注解</p>
</li>
<li><p>简单方法直接注解方式</p>
</li>
<li><p>复杂方法编写mapper.xml进行绑定映射</p>
</li>
<li><p><em>@MapperScan(“com.atguigu.admin.mapper”) 简化，其他的接口就可以不用标注@Mapper注解</em>（专门整一个mapper的包出来，里面全放对应的文件，就可以不在每个类上面标注mapper了，只用扫描整个包就好了。建议还是用Mapper来标注上嗷！！！）</p>
</li>
</ul>
<h3 id="4、整合-MyBatis-Plus-完成CRUD"><a href="#4、整合-MyBatis-Plus-完成CRUD" class="headerlink" title="4、整合 MyBatis-Plus 完成CRUD"></a>4、整合 MyBatis-Plus 完成CRUD</h3><h4 id="1、什么是MyBatis-Plus"><a href="#1、什么是MyBatis-Plus" class="headerlink" title="1、什么是MyBatis-Plus"></a>1、什么是MyBatis-Plus</h4><p><a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus">MyBatis-Plus</a>（简称 MP）是一个 <a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/">MyBatis</a> 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p>
<p><a target="_blank" rel="noopener" href="https://baomidou.com/">mybatis plus 官网</a></p>
<p>建议安装 <strong>MybatisX</strong> 插件 </p>
<h4 id="2、整合MyBatis-Plus"><a href="#2、整合MyBatis-Plus" class="headerlink" title="2、整合MyBatis-Plus"></a>2、整合MyBatis-Plus</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>自动配置</p>
<ul>
<li><p>MybatisPlusAutoConfiguration 配置类，MybatisPlusProperties 配置项绑定。<strong>mybatis-plus：xxx 就是对****mybatis-plus的定制</strong></p>
</li>
<li><p><strong>SqlSessionFactory 自动配置好。底层是容器中默认的数据源</strong></p>
</li>
<li><p><strong>mapperLocations 自动配置好的。有默认值。</strong>classpath*:&#x2F;mapper&#x2F;**&#x2F;*.xml；任意包的类路径下的所有mapper文件夹下任意路径下的所有xml都是sql映射文件。  建议以后sql映射文件，放在 mapper下。</p>
</li>
<li><p><strong>容器中也自动配置好了</strong> <strong>SqlSessionTemplate</strong></p>
</li>
<li><p><strong>@Mapper 标注的接口也会被自动扫描；建议直接</strong> @MapperScan(<strong>“com.tuzi.mapper”</strong>) 批量扫描就行</p>
</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>只需要我们的Mapper继承 <strong>BaseMapper</strong> 就可以拥有crud能力</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720155244.png" alt="image-20210720155244605"></p>
<ul>
<li>相当于上面这样就直接写好了orz</li>
</ul>
<h4 id="3、CRUD功能"><a href="#3、CRUD功能" class="headerlink" title="3、CRUD功能"></a>3、CRUD功能</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@GetMapping(&quot;/user/delete/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id,</span></span><br><span class="line"><span class="params">                             <span class="meta">@RequestParam(value = &quot;pn&quot;,defaultValue = &quot;1&quot;)</span>Integer pn,</span></span><br><span class="line"><span class="params">                             RedirectAttributes ra)</span>&#123;</span><br><span class="line"></span><br><span class="line">        userService.removeById(id);</span><br><span class="line"></span><br><span class="line">        ra.addAttribute(<span class="string">&quot;pn&quot;</span>,pn);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/dynamic_table&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/dynamic_table&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">dynamic_table</span><span class="params">(<span class="meta">@RequestParam(value=&quot;pn&quot;,defaultValue = &quot;1&quot;)</span> Integer pn,Model model)</span>&#123;</span><br><span class="line">        <span class="comment">//表格内容的遍历</span></span><br><span class="line"><span class="comment">//        response.sendError</span></span><br><span class="line"><span class="comment">//     List&lt;User&gt; users = Arrays.asList(new User(&quot;zhangsan&quot;, &quot;123456&quot;),</span></span><br><span class="line"><span class="comment">//                new User(&quot;lisi&quot;, &quot;123444&quot;),</span></span><br><span class="line"><span class="comment">//                new User(&quot;haha&quot;, &quot;aaaaa&quot;),</span></span><br><span class="line"><span class="comment">//                new User(&quot;hehe &quot;, &quot;aaddd&quot;));</span></span><br><span class="line"><span class="comment">//        model.addAttribute(&quot;users&quot;,users);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        if(users.size()&gt;3)&#123;</span></span><br><span class="line"><span class="comment">//            throw new UserTooManyException();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">//从数据库中查出user表中的用户进行展示</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造分页参数</span></span><br><span class="line">        Page&lt;User&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pn, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//调用page进行分页</span></span><br><span class="line">        Page&lt;User&gt; userPage = userService.page(page, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        userPage.getRecords()</span></span><br><span class="line"><span class="comment">//        userPage.getCurrent()</span></span><br><span class="line"><span class="comment">//        userPage.getPages()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">&quot;users&quot;</span>,userPage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;table/dynamic_table&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper,User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4、工程问题"><a href="#4、工程问题" class="headerlink" title="4、工程问题"></a>4、工程问题</h4><ul>
<li>代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面是用户登录的字段</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有属性都应该在数据库中嗷！！！</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下是数据库的字段</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String s1, String s)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userName = s1;</span><br><span class="line">        <span class="built_in">this</span>.password = s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//不在表中的属性可以使用plus的注解来注标记嗷！！！</span></span><br></pre></td></tr></table></figure>



<ul>
<li>属性：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这种写法默认是去数据库种寻找同名的User表，如果表的名字和这个类的名字不一样，就要采用注解来注释，帮助MyBatisPlus找到这种表：</p>
<p><code>@TableName(&quot;user_tbl&quot;)</code>，这个注解是添加在User这个类上，而不是Mapper类上嗷！！！</p>
<ul>
<li>Controller -&gt; Service -&gt; Mapper(Dao层)，先有接口，后有实现类，注入接口来进行编写的嗷！！！（对于Service层来说的嗷！！！）</li>
<li><code>ctrl + alt + l</code>可以格式化html文件格式嗷</li>
<li>Service层结构：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.bean.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对应的Impl的代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.bean.User;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.tuzi.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面这个Impl就是结合之前的Mapper和User等一起使用的嗷，默认也有很多功能。而且@Service了之后，就可以在Controller中自动注入来使用了嗷！！！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/dynamic_table&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">dynamic_table</span><span class="params">(Model model)</span>&#123;</span><br><span class="line">	List&lt;User&gt; list = userService.list(); <span class="comment">//上面的抽象类和实现并未自己实现方法，但是可以使用默认的方法来实现功能嗷！！！</span></span><br><span class="line">	model.addAttribute(<span class="string">&quot;users&quot;</span>,list);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;table/dynamic_table&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>原理一样的，Mapper(Dao层)先打好（继承BasePackage，传入Bean，就有默认的Dao层方法），然后处理Service层业务（可以是空的接口继承IService传入Bean，实现类则继承ServiceImpl，传入Mapper和对应的Bean，实现类要@Service，然后在Controller中就可以通过自动注入的方式，调用Service层的功能实现服务嗷！！！）</li>
<li>实例后续：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720165749.png" alt="image-20210720165749288"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720165822.png" alt="image-20210720165822715"></p>
<p>总的来说就是分页条是通过JavaScript来实现的，我们可以把相应的JS注释掉，从我们的HTML中审查元素手动取出我们的分页条，然后添加到我们的页面中，利用后端的数据库传入的数据再次来实现分页条。</p>
<ul>
<li>分页数据查询：<code>userService.Page()</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720172721.png" alt="image-20210720172714217"></p>
<p>系统内部设置好了，多少页，每页多少条数据。拿到Page之后，Page中还有其他的属性嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720172918.png" alt="image-20210720172918768"></p>
<ul>
<li><p>直接把上面得到的Page对象放入Model中就好了嗷！！！</p>
</li>
<li><p>流程：用户点击第几页 -&gt; 后端收到之后传入对应的参数 -&gt; 返回page对象 -&gt; 前端拿到Page对象取值进行渲染。</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720203340.png" alt="image-20210720203340544"></p>
</li>
<li><p>上面这个东西在thymeleaf文档中都有嗷！！！这里就是在路径上添加变量的方法嗷！！！</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720203523.png" alt="image-20210720203523780"></p>
<h4 id="5、带翻页的列表展示功能"><a href="#5、带翻页的列表展示功能" class="headerlink" title="5、带翻页的列表展示功能"></a>5、带翻页的列表展示功能</h4><ul>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720192137.png" alt="image-20210720192137023">注释掉前端JS实现的翻页功能。</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720192211.png" alt="image-20210720192211048">从JS文件渲染的页面中，提取出我们要的翻页的组件，并将其加入到我们的页面中来。</li>
<li>放入对应的page全局变量，方便我们后续取值：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720192049.png" alt="image-20210720192049444"></p>
<ul>
<li>修改我们的HTML页面：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720192235.png" alt="image-20210720192235319"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720192312.png" alt="image-20210720192312200"></p>
<ul>
<li>除此之外，我们还需要引入对应的插件：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tuzi.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 最新版</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 设置请求的页面大于最大页后操作， true调回到首页，false 继续请求  默认false</span></span><br><span class="line">        <span class="comment">// paginationInterceptor.setOverflow(false);</span></span><br><span class="line">        <span class="comment">// 设置最大单页限制数量，默认 500 条，-1 不受限制</span></span><br><span class="line">        <span class="comment">// paginationInterceptor.setLimit(500);</span></span><br><span class="line">        <span class="comment">// 开启 count 的 join 优化,只针对部分 left join</span></span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//这是分页拦截器</span></span><br><span class="line">        <span class="type">PaginationInnerInterceptor</span> <span class="variable">paginationInnerInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>();</span><br><span class="line">        paginationInnerInterceptor.setOverflow(<span class="literal">true</span>);</span><br><span class="line">        paginationInnerInterceptor.setMaxLimit(<span class="number">500L</span>);</span><br><span class="line"></span><br><span class="line">        interceptor.addInnerInterceptor(paginationInnerInterceptor);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	<span class="comment">//一定要记得加上@Configuration</span></span><br></pre></td></tr></table></figure>

<ul>
<li>接着对于页面逻辑进行进一步的修改：</li>
</ul>
<h3 id="5、NoSQL"><a href="#5、NoSQL" class="headerlink" title="5、NoSQL"></a>5、NoSQL</h3><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、<strong>缓存</strong>和消息中间件。 它支持多种类型的数据结构，如 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#strings">字符串（strings）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#hashes">散列（hashes）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#lists">列表（lists）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#sets">集合（sets）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#sorted-sets">有序集合（sorted sets）</a> 与范围查询， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#bitmaps">bitmaps</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/data-types-intro.html#hyperloglogs">hyperloglogs</a> 和 <a target="_blank" rel="noopener" href="http://www.redis.cn/commands/geoadd.html">地理空间（geospatial）</a> 索引半径查询。 Redis 内置了 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/replication.html">复制（replication）</a>，<a target="_blank" rel="noopener" href="http://www.redis.cn/commands/eval.html">LUA脚本（Lua scripting）</a>， <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/lru-cache.html">LRU驱动事件（LRU eviction）</a>，<a target="_blank" rel="noopener" href="http://www.redis.cn/topics/transactions.html">事务（transactions）</a> 和不同级别的 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/persistence.html">磁盘持久化（persistence）</a>， 并通过 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/sentinel.html">Redis哨兵（Sentinel）</a>和自动 <a target="_blank" rel="noopener" href="http://www.redis.cn/topics/cluster-tutorial.html">分区（Cluster）</a>提供高可用性（high availability）。</p>
<h4 id="1、Redis自动配置"><a href="#1、Redis自动配置" class="headerlink" title="1、Redis自动配置"></a>1、Redis自动配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606745732785-17d1227a-75b9-4f00-a3f1-7fc4137b5113.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p>自动配置：</p>
<ul>
<li><p>RedisAutoConfiguration 自动配置类。RedisProperties 属性类 –&gt; <strong>spring.redis.xxx是对redis的配置</strong></p>
</li>
<li><p>连接工厂是准备好的。<strong>Lettuce</strong>ConnectionConfiguration、<strong>Jedis</strong>ConnectionConfiguration</p>
</li>
<li><p><strong>自动注入了RedisTemplate</strong>&lt;**Object**, **Object**&gt; ： xxxTemplate；</p>
</li>
<li><p><strong>自动注入了StringRedisTemplate；k：v都是String</strong></p>
</li>
<li><p><strong>key：value</strong></p>
</li>
<li><p><strong>底层只要我们使用</strong> <strong>StringRedisTemplate、</strong>RedisTemplate就可以操作redis</p>
</li>
</ul>
<p><strong>redis环境搭建</strong></p>
<p><strong>1、阿里云按量付费redis。经典网络</strong></p>
<p><strong>2、申请redis的公网连接地址</strong></p>
<p><strong>3、修改白名单  允许0.0.0.0&#x2F;0 访问</strong></p>
<h4 id="2、RedisTemplate与Lettuce"><a href="#2、RedisTemplate与Lettuce" class="headerlink" title="2、RedisTemplate与Lettuce"></a>2、RedisTemplate与Lettuce</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testRedis</span><span class="params">()</span>&#123;</span><br><span class="line">    ValueOperations&lt;String, String&gt; operations = redisTemplate.opsForValue();</span><br><span class="line"></span><br><span class="line">    operations.set(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;world&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> operations.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    System.out.println(hello);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h4 id="3、切换至jedis"><a href="#3、切换至jedis" class="headerlink" title="3、切换至jedis"></a>3、切换至jedis</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--导入jedis--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">r-bp1nc7reqesxisgxpipd.redis.rds.aliyuncs.com</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">lfy:Lfy123456</span></span><br><span class="line">      <span class="attr">client-type:</span> <span class="string">jedis</span></span><br><span class="line">      <span class="attr">jedis:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>



<ul>
<li>二者区别：<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720211243.png" alt="image-20210720211242900"></li>
<li>计数功能的实现：</li>
</ul>
<ol>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720211446.png" alt="image-20210720211446266"></li>
<li>和以前一样直接在对应的Config中new出我们写的上面这个拦截器并且加入到容器中可以吗？不可以，因为我们自己new的，里面的@AutoWired没法用啊orz，只有容器中的组件，Spring才会操作注解。那怎么办？</li>
<li>你自动注入啊，这个配置类本身就是@Component，你先在对应的Config类中，自动注入我们放入容器中的这个Interceptor，再用registry注册给对应的管理器就行啦！！！</li>
<li><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210720212207.png" alt="image-20210720212207022"></li>
</ol>
<p>自动注入对应的redisTemplate，然后使用对应的方法取出对应的值之后，放入model中，即可以被前端页面获取到。</p>
<h2 id="单元测试："><a href="#单元测试：" class="headerlink" title="单元测试："></a>单元测试：</h2><p><a target="_blank" rel="noopener" href="https://doczhcn.gitbook.io/junit5/">JUnit5官方文档</a></p>
<h3 id="1、JUnit5-的变化"><a href="#1、JUnit5-的变化" class="headerlink" title="1、JUnit5 的变化"></a>1、JUnit5 的变化</h3><p>Spring Boot 2.2.0 版本开始引入 JUnit 5 作为单元测试默认库</p>
<p>作为最新版本的JUnit框架，JUnit5与之前版本的Junit框架有很大的不同。由三个不同子项目的几个不同模块组成。</p>
<p>JUnit 5 &#x3D; JUnit Platform + JUnit Jupiter + JUnit Vintage</p>
<p>JUnit Platform: Junit Platform是在JVM上启动测试框架的基础，不仅支持Junit自制的测试引擎，其他测试引擎也都可以接入。</p>
<p>JUnit Jupiter: JUnit Jupiter提供了JUnit5的新的编程模型，是JUnit5新特性的核心。内部 包含了一个测试引擎，用于在Junit Platform上运行。</p>
<p>JUnit Vintage: 由于JUint已经发展多年，为了照顾老的项目，JUnit Vintage提供了兼容JUnit4.x,Junit3.x的测试引擎。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606796395719-eb57ab48-ae44-45e5-8d2e-c4d507aff49a.png?x-oss-process=image/resize,w_683" alt="img"></p>
<p>注意：</p>
<p>SpringBoot 2.4 以上版本移除了默认对 Vintage 的依赖。如果需要兼容junit4需要自行引入（不能使用junit4的功能 @Test）</p>
<p><strong>JUnit 5’s Vintage Engine Removed from spring-boot-starter-test,如果需要继续兼容junit4需要自行引入vintage</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>







<p>orgjunit.jupiterjunit-jupiter:5.7.0test)</p>
<p>iorgjunitjupiterjunit-jupiterapi5.7.0(</p>
<p>org.apiguardian:apiguardian-ap1.1.0</p>
<p>org.opentest4i:opentest4j:1.2.0(test)</p>
<p>orgjunit.platfommjunit-platform-commons1.7.0()</p>
<p>orgjunitjupiterjuiit-jupiter-params5.7.0(est)</p>
<p>dorgjunit.jupiterjunit-jupiterengine.7.()</p>
<p>org.apiguardian:apiguadinai.1.mitdoulicate)</p>
<p>lorgjunit.platformjunit-platform-engine;1.7.0(test)</p>
<p>org.apiguardianapiguardianapi.1.1.0(tsomittedforduplic</p>
<p>org.opentest4iopentes41.2.0ioduica)</p>
<p>org.junit.platfomjuitlafomcommo.</p>
<p>org.junitjupiterjunituitapi..duic</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606797616337-e73010e9-9cac-496d-a177-64b677af5a3d.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="image.png"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在版本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Boot05WebAdminApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>以前：</p>
<p>@SpringBootTest + @RunWith(SpringTest.class)</p>
<p>SpringBoot整合Junit以后：</p>
<ul>
<li><p>编写测试方法：@Test标注（注意需要使用junit5版本的注解）</p>
</li>
<li><p>Junit类具有Spring的功能，@Autowired、比如 @Transactional 标注测试方法，测试完成后自动回滚</p>
</li>
</ul>
<h3 id="2、JUnit5常用注解"><a href="#2、JUnit5常用注解" class="headerlink" title="2、JUnit5常用注解"></a>2、JUnit5常用注解</h3><ul>
<li>有官方文档嗷！！！</li>
<li>如果需要SpringBoot中的功能，例如自动注入功能，就需要@SpringBootTest注解嗷！！！</li>
</ul>
<p>JUnit5的注解与JUnit4的注解有所变化</p>
<p><a target="_blank" rel="noopener" href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations">https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations</a></p>
<ul>
<li><p>@Test :表示方法是测试方法。但是与JUnit4的@Test不同，他的职责非常单一不能声明任何属性，拓展的测试将会由Jupiter提供额外测试</p>
</li>
<li><p>@ParameterizedTest :表示方法是参数化测试，下方会有详细介绍</p>
</li>
<li><p>@RepeatedTest :表示方法可重复执行，下方会有详细介绍</p>
</li>
<li><p>@DisplayName :为测试类或者测试方法设置展示名称</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721154738.png" alt="image-20210721154738122"></p>
<ul>
<li><p>@BeforeEach :表示在每个单元测试之前执行</p>
</li>
<li><p>@AfterEach :表示在每个单元测试之后执行</p>
</li>
<li><p>@BeforeAll :表示在所有单元测试之前执行</p>
</li>
<li><p>@AfterAll :表示在所有单元测试之后执行</p>
</li>
</ul>
<p>上面这个就类似于我们软件测试中学习到的方法的升级版本嗷！！！</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721155156.png" alt="image-20210721155156226"></p>
<ul>
<li><p>@Tag :表示单元测试类别，类似于JUnit4中的@Categories</p>
</li>
<li><p>@Disabled :表示测试类或测试方法不执行，类似于JUnit4中的@Ignore</p>
</li>
<li><p>@Timeout :表示测试方法运行如果超过了指定时间将会返回错误</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721155459.png" alt="image-20210721155459034"></p>
<ul>
<li>@ExtendWith :为测试类或测试方法提供扩展类引用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test; <span class="comment">//注意这里使用的是jupiter的Test注解！！</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="meta">@DisplayName(&quot;第一次测试&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">firstTest</span><span class="params">()</span> &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@RepeatedTest，重复测试，可以设置这个方法重复测试的次数：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721155812.png" alt="image-20210721155811853"></p>
<h3 id="3、断言（assertions）"><a href="#3、断言（assertions）" class="headerlink" title="3、断言（assertions）"></a>3、断言（assertions）</h3><p>断言（assertions）是测试方法中的核心部分，用来对测试需要满足的条件进行验证。这些断言方法都是 org.junit.jupiter.api.Assertions 的静态方法。JUnit 5 内置的断言可以分成如下几个类别：</p>
<p>检查业务逻辑返回的数据是否合理。</p>
<p>所有的测试运行结束以后，会有一个详细的测试报告；</p>
<h4 id="3-1、简单断言"><a href="#3-1、简单断言" class="headerlink" title="3.1、简单断言"></a>3.1、简单断言</h4><p>用来对单个值进行简单的验证。如：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>assertEquals</td>
<td>判断两个对象或两个原始类型是否相等</td>
</tr>
<tr>
<td>assertNotEquals</td>
<td>判断两个对象或两个原始类型是否不相等</td>
</tr>
<tr>
<td>assertSame</td>
<td>判断两个对象引用是否指向同一个对象</td>
</tr>
<tr>
<td>assertNotSame</td>
<td>判断两个对象引用是否指向不同的对象</td>
</tr>
<tr>
<td>assertTrue</td>
<td>判断给定的布尔值是否为 true</td>
</tr>
<tr>
<td>assertFalse</td>
<td>判断给定的布尔值是否为 false</td>
</tr>
<tr>
<td>assertNull</td>
<td>判断给定的对象引用是否为 null</td>
</tr>
<tr>
<td>assertNotNull</td>
<td>判断给定的对象引用是否不为 null</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;simple assertion&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">simple</span><span class="params">()</span> &#123;</span><br><span class="line">     assertEquals(<span class="number">3</span>, <span class="number">1</span> + <span class="number">2</span>, <span class="string">&quot;simple math&quot;</span>);  <span class="comment">//最后一个参数是自定义的错误参数嗷！！！</span></span><br><span class="line">     assertNotEquals(<span class="number">3</span>, <span class="number">1</span> + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">     assertNotSame(<span class="keyword">new</span> <span class="title class_">Object</span>(), <span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">     <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">     assertSame(obj, obj);</span><br><span class="line"></span><br><span class="line">     assertFalse(<span class="number">1</span> &gt; <span class="number">2</span>);</span><br><span class="line">     assertTrue(<span class="number">1</span> &lt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">     assertNull(<span class="literal">null</span>);</span><br><span class="line">     assertNotNull(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2、数组断言"><a href="#3-2、数组断言" class="headerlink" title="3.2、数组断言"></a>3.2、数组断言</h4><p>通过 assertArrayEquals 方法来判断两个对象或原始类型的数组是否相等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;array assertion&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">array</span><span class="params">()</span> &#123;</span><br><span class="line">    assertArrayEquals(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>&#125;, <span class="keyword">new</span> <span class="title class_">int</span>[] &#123;<span class="number">1</span>, <span class="number">2</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-3、组合断言"><a href="#3-3、组合断言" class="headerlink" title="3.3、组合断言"></a>3.3、组合断言</h4><p>assertAll 方法接受多个 org.junit.jupiter.api.Executable 函数式接口的实例作为要验证的断言，可以通过 lambda 表达式很容易的提供这些断言</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;assert all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">all</span><span class="params">()</span> &#123;</span><br><span class="line"> assertAll(<span class="string">&quot;Math&quot;</span>,</span><br><span class="line">    	() -&gt; assertEquals(<span class="number">2</span>, <span class="number">1</span> + <span class="number">1</span>),</span><br><span class="line">    	() -&gt; assertTrue(<span class="number">1</span> &gt; <span class="number">0</span>)</span><br><span class="line"> 	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-4、异常断言"><a href="#3-4、异常断言" class="headerlink" title="3.4、异常断言"></a>3.4、异常断言</h4><p>在JUnit4时期，想要测试方法的异常情况时，需要用@Rule注解的ExpectedException变量还是比较麻烦的。而JUnit5提供了一种新的断言方式Assertions.assertThrows() ,配合函数式编程就可以进行使用。(断定业务逻辑一定会出现某些异常，如果正常执行则会报错嗷！！！)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;异常测试&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ArithmeticException</span> <span class="variable">exception</span> <span class="operator">=</span> Assertions.assertThrows(</span><br><span class="line">           <span class="comment">//扔出断言异常</span></span><br><span class="line">            ArithmeticException.class, () -&gt; System.out.println(<span class="number">1</span> % <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-5、超时断言"><a href="#3-5、超时断言" class="headerlink" title="3.5、超时断言"></a>3.5、超时断言</h4><p>Junit5还提供了Assertions.assertTimeout() 为测试方法设置了超时时间</p>
<ul>
<li>断定业务逻辑一定在我指定的时间内完成</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;超时测试&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">timeoutTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//如果测试方法时间超过1s将会异常</span></span><br><span class="line">    Assertions.assertTimeout(Duration.ofMillis(<span class="number">1000</span>), () -&gt; Thread.sleep(<span class="number">500</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-6、快速失败"><a href="#3-6、快速失败" class="headerlink" title="3.6、快速失败"></a>3.6、快速失败</h4><p>通过 fail 方法直接使得测试失败</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;fail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shouldFail</span><span class="params">()</span> &#123;</span><br><span class="line">    fail(<span class="string">&quot;This should fail&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="4、前置条件（assumptions）"><a href="#4、前置条件（assumptions）" class="headerlink" title="4、前置条件（assumptions）"></a>4、前置条件（assumptions）</h3><p>JUnit 5 中的前置条件（assumptions【假设】）类似于断言，不同之处在于不满足的断言会使得测试方法失败，而不满足的前置条件只会使得测试方法的执行终止。前置条件可以看成是测试方法执行的前提，当该前提不满足时，就没有继续执行的必要。（即跳过当前的方法不执行剩下的代码嗷！！！）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;前置条件&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AssumptionsTest</span> &#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="string">&quot;DEV&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="meta">@DisplayName(&quot;simple&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">simpleAssume</span><span class="params">()</span> &#123;</span><br><span class="line">    assumeTrue(Objects.equals(<span class="built_in">this</span>.environment, <span class="string">&quot;DEV&quot;</span>));</span><br><span class="line">    assumeFalse(() -&gt; Objects.equals(<span class="built_in">this</span>.environment, <span class="string">&quot;PROD&quot;</span>));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="meta">@DisplayName(&quot;assume then do&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">assumeThenDo</span><span class="params">()</span> &#123;</span><br><span class="line">    assumingThat(</span><br><span class="line">       Objects.equals(<span class="built_in">this</span>.environment, <span class="string">&quot;DEV&quot;</span>),</span><br><span class="line">       () -&gt; System.out.println(<span class="string">&quot;In DEV&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>assumeTrue 和 assumFalse 确保给定的条件为 true 或 false，不满足条件会使得测试执行终止。assumingThat 的参数是表示条件的布尔值和对应的 Executable 接口的实现对象。只有条件满足时，Executable 对象才会被执行；当条件不满足时，测试执行并不会终止。</p>
<h3 id="5、嵌套测试"><a href="#5、嵌套测试" class="headerlink" title="5、嵌套测试"></a>5、嵌套测试</h3><p>JUnit 5 可以通过 Java 中的内部类和@Nested 注解实现嵌套测试，从而可以更好的把相关的测试方法组织在一起。在内部类中可以使用@BeforeEach 和@AfterEach 注解，而且嵌套的层次没有限制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;A stack&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestingAStackDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    Stack&lt;Object&gt; stack;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@DisplayName(&quot;is instantiated with new Stack()&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">isInstantiatedWithNew</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nested</span></span><br><span class="line">    <span class="meta">@DisplayName(&quot;when new&quot;)</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">WhenNew</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@BeforeEach</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">createNewStack</span><span class="params">()</span> &#123;</span><br><span class="line">            stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;is empty&quot;)</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">            assertTrue(stack.isEmpty());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;throws EmptyStackException when popped&quot;)</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">throwsExceptionWhenPopped</span><span class="params">()</span> &#123;</span><br><span class="line">            assertThrows(EmptyStackException.class, stack::pop);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Test</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;throws EmptyStackException when peeked&quot;)</span></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">throwsExceptionWhenPeeked</span><span class="params">()</span> &#123;</span><br><span class="line">            assertThrows(EmptyStackException.class, stack::peek);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Nested</span></span><br><span class="line">        <span class="meta">@DisplayName(&quot;after pushing an element&quot;)</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">AfterPushing</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">anElement</span> <span class="operator">=</span> <span class="string">&quot;an element&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@BeforeEach</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">pushAnElement</span><span class="params">()</span> &#123;</span><br><span class="line">                stack.push(anElement);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Test</span></span><br><span class="line">            <span class="meta">@DisplayName(&quot;it is no longer empty&quot;)</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">isNotEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">                assertFalse(stack.isEmpty());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Test</span></span><br><span class="line">            <span class="meta">@DisplayName(&quot;returns the element when popped and is empty&quot;)</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">returnElementWhenPopped</span><span class="params">()</span> &#123;</span><br><span class="line">                assertEquals(anElement, stack.pop());</span><br><span class="line">                assertTrue(stack.isEmpty());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Test</span></span><br><span class="line">            <span class="meta">@DisplayName(&quot;returns the element when peeked but remains not empty&quot;)</span></span><br><span class="line">            <span class="keyword">void</span> <span class="title function_">returnElementWhenPeeked</span><span class="params">()</span> &#123;</span><br><span class="line">                assertEquals(anElement, stack.peek());</span><br><span class="line">                assertFalse(stack.isEmpty());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721165618.png" alt="image-20210721165618766"></p>
<ul>
<li>栈的驱动的规则：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721165828.png" alt="image-20210721165828334"></p>
<ul>
<li>明显的层级关系：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721165947.png" alt="image-20210721165946971"></p>
<h3 id="6、参数化测试"><a href="#6、参数化测试" class="headerlink" title="6、参数化测试"></a>6、参数化测试</h3><p>参数化测试是JUnit5很重要的一个新特性，它使得用不同的参数多次运行测试成为了可能，也为我们的单元测试带来许多便利。</p>
<p>利用@ValueSource等注解，指定入参，我们将可以使用不同的参数进行多次单元测试，而不需要每新增一个参数就新增一个单元测试，省去了很多冗余代码。</p>
<p>@ValueSource: 为参数化测试指定入参来源，支持八大基础类以及String类型,Class类型</p>
<p>@NullSource: 表示为参数化测试提供一个null的入参</p>
<p>@EnumSource: 表示为参数化测试提供一个枚举入参</p>
<p>@CsvFileSource：表示读取指定CSV文件内容作为参数化测试入参</p>
<p>@MethodSource：表示读取指定方法的返回值作为参数化测试入参(注意方法返回需要是一个流)</p>
<p>当然如果参数化测试仅仅只能做到指定普通的入参还达不到让我觉得惊艳的地步。让我真正感到他的强大之处的地方在于他可以支持外部的各类入参。如:CSV,YML,JSON 文件甚至方法的返回值也可以作为入参。只需要去实现ArgumentsProvider接口，任何外部文件都可以作为它的入参。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@ValueSource(strings = &#123;&quot;one&quot;, &quot;two&quot;, &quot;three&quot;&#125;)</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;参数化测试1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parameterizedTest1</span><span class="params">(String string)</span> &#123;</span><br><span class="line">    System.out.println(string);</span><br><span class="line">    Assertions.assertTrue(StringUtils.isNotBlank(string));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@ParameterizedTest</span></span><br><span class="line"><span class="meta">@MethodSource(&quot;method&quot;)</span>    <span class="comment">//指定方法名</span></span><br><span class="line"><span class="meta">@DisplayName(&quot;方法来源参数&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testWithExplicitLocalMethodSource</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    Assertions.assertNotNull(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Stream&lt;String&gt; <span class="title function_">method</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Stream.of(<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7、迁移指南"><a href="#7、迁移指南" class="headerlink" title="7、迁移指南"></a>7、迁移指南</h3><p>在进行迁移的时候需要注意如下的变化：</p>
<ul>
<li><p>注解在 org.junit.jupiter.api 包中，断言在 org.junit.jupiter.api.Assertions 类中，前置条件在 org.junit.jupiter.api.Assumptions 类中。</p>
</li>
<li><p>把@Before 和@After 替换成@BeforeEach 和@AfterEach。</p>
</li>
<li><p>把@BeforeClass 和@AfterClass 替换成@BeforeAll 和@AfterAll。</p>
</li>
<li><p>把@Ignore 替换成@Disabled。</p>
</li>
<li><p>把@Category 替换成@Tag。</p>
</li>
<li><p>把@RunWith、@Rule 和@ClassRule 替换成@ExtendWith。</p>
</li>
</ul>
<h2 id="指标监控："><a href="#指标监控：" class="headerlink" title="指标监控："></a>指标监控：</h2><h3 id="1、SpringBoot-Actuator"><a href="#1、SpringBoot-Actuator" class="headerlink" title="1、SpringBoot Actuator"></a>1、SpringBoot Actuator</h3><h4 id="1、简介"><a href="#1、简介" class="headerlink" title="1、简介"></a>1、简介</h4><p>未来每一个微服务在云上部署以后，我们都需要对其进行监控、追踪、审计、控制等。SpringBoot就抽取了Actuator场景，使得我们每个微服务快速引用即可获得生产级别的应用监控、审计等功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606886483335-697ee1c1-2f69-43ab-bddc-3a038382319c.png" alt="img"></p>
<ul>
<li>加入了对应的配置之后，我们需要对应配置文件中，关于web暴露的EndPoints进行配置，才能够更加方便的使用嗷！！！</li>
<li>使用步骤：<ul>
<li>引入依赖</li>
<li>配置文件中暴露出来嗷！！！</li>
</ul>
</li>
</ul>
<h4 id="2、1-x与2-x的不同"><a href="#2、1-x与2-x的不同" class="headerlink" title="2、1.x与2.x的不同"></a>2、1.x与2.x的不同</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606884394162-ac7f2d8e-7abb-44df-9998-fb0f2705f238.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_14,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<h4 id="3、如何使用"><a href="#3、如何使用" class="headerlink" title="3、如何使用"></a>3、如何使用</h4><ul>
<li><p>引入场景</p>
</li>
<li><p>访问 <a target="_blank" rel="noopener" href="http://localhost:8080/actuator/">http://localhost:8080/actuator/</a>**</p>
</li>
<li><p>暴露所有监控信息为HTTP</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">enabled-by-default:</span> <span class="literal">true</span> <span class="comment">#暴露所有端点信息</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span>  <span class="comment">#以web方式暴露</span></span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/actuator/beans">http://localhost:8080/actuator/beans</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/actuator/configprops">http://localhost:8080/actuator/configprops</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/actuator/metrics">http://localhost:8080/actuator/metrics</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/actuator/metrics/jvm.gc.pause">http://localhost:8080/actuator/metrics/jvm.gc.pause</a></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/actuator/metrics">http://localhost:8080/actuator/</a>endpointName&#x2F;detailPath<br>。。。。。。</p>
<h4 id="4、可视化"><a href="#4、可视化" class="headerlink" title="4、可视化"></a>4、可视化</h4><p><a target="_blank" rel="noopener" href="https://github.com/codecentric/spring-boot-admin">https://github.com/codecentric/spring-boot-admin</a></p>
<ul>
<li>打开官方文档，根据Quick Start中新建一个项目，引入对应的依赖和注解之后，就可以学怎么使用了嗷！！！</li>
</ul>
<h3 id="2、Actuator-Endpoint"><a href="#2、Actuator-Endpoint" class="headerlink" title="2、Actuator Endpoint"></a>2、Actuator Endpoint</h3><h4 id="1、最常使用的端点"><a href="#1、最常使用的端点" class="headerlink" title="1、最常使用的端点"></a>1、最常使用的端点</h4><table>
<thead>
<tr>
<th>ID</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>auditevents</code></td>
<td>暴露当前应用程序的审核事件信息。需要一个<code>AuditEventRepository组件</code>。</td>
</tr>
<tr>
<td><code>beans</code></td>
<td>显示应用程序中所有Spring Bean的完整列表。</td>
</tr>
<tr>
<td><code>caches</code></td>
<td>暴露可用的缓存。</td>
</tr>
<tr>
<td><code>conditions</code></td>
<td>显示自动配置的所有条件信息，包括匹配或不匹配的原因。</td>
</tr>
<tr>
<td><code>configprops</code></td>
<td>显示所有<code>@ConfigurationProperties</code>。</td>
</tr>
<tr>
<td><code>env</code></td>
<td>暴露Spring的属性<code>ConfigurableEnvironment</code></td>
</tr>
<tr>
<td><code>flyway</code></td>
<td>显示已应用的所有Flyway数据库迁移。 需要一个或多个<code>Flyway</code>组件。</td>
</tr>
<tr>
<td><code>health</code></td>
<td>显示应用程序运行状况信息。</td>
</tr>
<tr>
<td><code>httptrace</code></td>
<td>显示HTTP跟踪信息（默认情况下，最近100个HTTP请求-响应）。需要一个<code>HttpTraceRepository</code>组件。</td>
</tr>
<tr>
<td><code>info</code></td>
<td>显示应用程序信息。</td>
</tr>
<tr>
<td><code>integrationgraph</code></td>
<td>显示Spring <code>integrationgraph</code> 。需要依赖<code>spring-integration-core</code>。</td>
</tr>
<tr>
<td><code>loggers</code></td>
<td>显示和修改应用程序中日志的配置。</td>
</tr>
<tr>
<td><code>liquibase</code></td>
<td>显示已应用的所有Liquibase数据库迁移。需要一个或多个<code>Liquibase</code>组件。</td>
</tr>
<tr>
<td><code>metrics</code></td>
<td>显示当前应用程序的“指标”信息。</td>
</tr>
<tr>
<td><code>mappings</code></td>
<td>显示所有<code>@RequestMapping</code>路径列表。</td>
</tr>
<tr>
<td><code>scheduledtasks</code></td>
<td>显示应用程序中的计划任务。</td>
</tr>
<tr>
<td><code>sessions</code></td>
<td>允许从Spring Session支持的会话存储中检索和删除用户会话。需要使用Spring Session的基于Servlet的Web应用程序。</td>
</tr>
<tr>
<td><code>shutdown</code></td>
<td>使应用程序正常关闭。默认禁用。</td>
</tr>
<tr>
<td><code>startup</code></td>
<td>显示由<code>ApplicationStartup</code>收集的启动步骤数据。需要使用<code>SpringApplication</code>进行配置<code>BufferingApplicationStartup</code>。</td>
</tr>
<tr>
<td><code>threaddump</code></td>
<td>执行线程转储。</td>
</tr>
</tbody></table>
<p>如果您的应用程序是Web应用程序（Spring MVC，Spring WebFlux或Jersey），则可以使用以下附加端点：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>heapdump</code></td>
<td>返回<code>hprof</code>堆转储文件。</td>
</tr>
<tr>
<td><code>jolokia</code></td>
<td>通过HTTP暴露JMX bean（需要引入Jolokia，不适用于WebFlux）。需要引入依赖<code>jolokia-core</code>。</td>
</tr>
<tr>
<td><code>logfile</code></td>
<td>返回日志文件的内容（如果已设置<code>logging.file.name</code>或<code>logging.file.path</code>属性）。支持使用HTTP<code>Range</code>标头来检索部分日志文件的内容。</td>
</tr>
<tr>
<td><code>prometheus</code></td>
<td>以Prometheus服务器可以抓取的格式公开指标。需要依赖<code>micrometer-registry-prometheus</code>。</td>
</tr>
</tbody></table>
<p>最常用的Endpoint</p>
<ul>
<li><p><strong>Health：监控状况</strong></p>
</li>
<li><p><strong>Metrics：运行时指标</strong></p>
</li>
<li><p><strong>Loggers：日志记录</strong></p>
</li>
<li><p>默认show-details都是关闭的，需要手动设为开启的，方便我们查看内部的详细信息。<img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721224151.png" alt="image-20210721224151384"></p>
</li>
</ul>
<h4 id="2、Health-Endpoint"><a href="#2、Health-Endpoint" class="headerlink" title="2、Health Endpoint"></a>2、Health Endpoint</h4><p>健康检查端点，我们一般用于在云平台，平台会定时的检查应用的健康状况，我们就需要Health Endpoint可以为平台返回当前应用的一系列组件健康状况的集合。</p>
<p>重要的几点：</p>
<ul>
<li><p>health endpoint返回的结果，应该是一系列健康检查后的一个汇总报告</p>
</li>
<li><p>很多的健康检查默认已经自动配置好了，比如：数据库、redis等</p>
</li>
<li><p>可以很容易的添加自定义的健康检查机制</p>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606908975702-4f9a3208-15ca-4a78-9f76-939ef986db7e.png" alt="img"></p>
<h4 id="3、Metrics-Endpoint"><a href="#3、Metrics-Endpoint" class="headerlink" title="3、Metrics Endpoint"></a>3、Metrics Endpoint</h4><p>提供详细的、层级的、空间指标信息，这些信息可以被pull（主动推送）或者push（被动获取）方式得到；</p>
<ul>
<li><p>通过Metrics对接多种监控系统</p>
</li>
<li><p>简化核心Metrics开发</p>
</li>
<li><p>添加自定义Metrics或者扩展已有Metrics</p>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606909073222-c6e77ca3-4b1c-4f38-a1c6-8614dec4f7bc.png" alt="img"></p>
<h4 id="4、管理Endpoints"><a href="#4、管理Endpoints" class="headerlink" title="4、管理Endpoints"></a>4、管理Endpoints</h4><h5 id="1、开启与禁用Endpoints"><a href="#1、开启与禁用Endpoints" class="headerlink" title="1、开启与禁用Endpoints"></a>1、开启与禁用Endpoints</h5><ul>
<li>默认所有的Endpoint除过shutdown都是开启的。</li>
<li>需要开启或者禁用某个Endpoint。配置模式为  <strong>management.endpoint.&lt;endpointName&gt;.enabled &#x3D; true</strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">beans:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>或者禁用所有的Endpoint然后手动开启指定的Endpoint</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">enabled-by-default:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">beans:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>





<h5 id="2、暴露Endpoints"><a href="#2、暴露Endpoints" class="headerlink" title="2、暴露Endpoints"></a>2、暴露Endpoints</h5><p>支持的暴露方式</p>
<ul>
<li><p>HTTP：默认只暴露<strong>health</strong>和<strong>info</strong> Endpoint</p>
</li>
<li><p><strong>JMX</strong>：默认暴露所有Endpoint</p>
</li>
<li><p>除过health和info，剩下的Endpoint都应该进行保护访问。如果引入SpringSecurity，则会默认配置安全访问规则</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>ID</th>
<th>JMX</th>
<th>Web</th>
</tr>
</thead>
<tbody><tr>
<td><code>auditevents</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>beans</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>caches</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>conditions</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>configprops</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>env</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>flyway</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>health</code></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><code>heapdump</code></td>
<td>N&#x2F;A</td>
<td>No</td>
</tr>
<tr>
<td><code>httptrace</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>info</code></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><code>integrationgraph</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>jolokia</code></td>
<td>N&#x2F;A</td>
<td>No</td>
</tr>
<tr>
<td><code>logfile</code></td>
<td>N&#x2F;A</td>
<td>No</td>
</tr>
<tr>
<td><code>loggers</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>liquibase</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>metrics</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>mappings</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>prometheus</code></td>
<td>N&#x2F;A</td>
<td>No</td>
</tr>
<tr>
<td><code>scheduledtasks</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>sessions</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>shutdown</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>startup</code></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><code>threaddump</code></td>
<td>Yes</td>
<td>No</td>
</tr>
</tbody></table>
<p>手动配置暴露Web端口的对应的EndPoints，方便前后端的交互：</p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210721223231.png" alt="image-20210721223231643"></p>
<h3 id="3、定制-Endpoint"><a href="#3、定制-Endpoint" class="headerlink" title="3、定制 Endpoint"></a>3、定制 Endpoint</h3><h4 id="1、定制-Health-信息"><a href="#1、定制-Health-信息" class="headerlink" title="1、定制 Health 信息"></a>1、定制 Health 信息</h4><ul>
<li>实现接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.health.Health;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.health.HealthIndicator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHealthIndicator</span> <span class="keyword">implements</span> <span class="title class_">HealthIndicator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Health <span class="title function_">health</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">errorCode</span> <span class="operator">=</span> check(); <span class="comment">// perform some specific health check</span></span><br><span class="line">        <span class="keyword">if</span> (errorCode != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Health.down().withDetail(<span class="string">&quot;Error Code&quot;</span>, errorCode).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Health.up().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">构建Health</span><br><span class="line"><span class="type">Health</span> <span class="variable">build</span> <span class="operator">=</span> Health.down()</span><br><span class="line">                .withDetail(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;error service&quot;</span>)</span><br><span class="line">                .withDetail(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;500&quot;</span>)</span><br><span class="line">                .withException(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>())</span><br><span class="line">                .build();</span><br><span class="line">management:</span><br><span class="line">    health:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      show-details: always #总是显示详细信息。可显示每个模块的状态信息</span><br></pre></td></tr></table></figure>



<ul>
<li>继承抽象类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyComHealthIndicator</span> <span class="keyword">extends</span> <span class="title class_">AbstractHealthIndicator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 真实的检查方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doHealthCheck</span><span class="params">(Health.Builder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//mongodb。  获取连接进行测试</span></span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 检查完成</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="number">1</span> == <span class="number">2</span>)&#123;</span><br><span class="line"><span class="comment">//            builder.up(); //健康</span></span><br><span class="line">            builder.status(Status.UP);</span><br><span class="line">            map.put(<span class="string">&quot;count&quot;</span>,<span class="number">1</span>);</span><br><span class="line">            map.put(<span class="string">&quot;ms&quot;</span>,<span class="number">100</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//            builder.down();</span></span><br><span class="line">            builder.status(Status.OUT_OF_SERVICE);</span><br><span class="line">            map.put(<span class="string">&quot;err&quot;</span>,<span class="string">&quot;连接超时&quot;</span>);</span><br><span class="line">            map.put(<span class="string">&quot;ms&quot;</span>,<span class="number">3000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        builder.withDetail(<span class="string">&quot;code&quot;</span>,<span class="number">100</span>)</span><br><span class="line">                .withDetails(map);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210722160510.png" alt="image-20210722160510274"></p>
<h4 id="2、定制info信息"><a href="#2、定制info信息" class="headerlink" title="2、定制info信息"></a>2、定制info信息</h4><p>常用两种方式：</p>
<h5 id="1、编写配置文件"><a href="#1、编写配置文件" class="headerlink" title="1、编写配置文件"></a>1、编写配置文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">appName:</span> <span class="string">boot-admin</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">mavenProjectName:</span> <span class="string">@project.artifactId@</span>  <span class="comment">#使用@@可以获取maven的pom文件值</span></span><br><span class="line">  <span class="attr">mavenProjectVersion:</span> <span class="string">@project.version@</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210722160756.png" alt="image-20210722160756108"></p>
<ul>
<li>如果要去父类中的信息也可以取到的，<code>@project.parent.Information@</code>这种形式就可以取到嗷！！！</li>
</ul>
<h5 id="2、编写InfoContributor"><a href="#2、编写InfoContributor" class="headerlink" title="2、编写InfoContributor"></a>2、编写InfoContributor</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.info.Info;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.actuate.info.InfoContributor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleInfoContributor</span> <span class="keyword">implements</span> <span class="title class_">InfoContributor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contribute</span><span class="params">(Info.Builder builder)</span> &#123;</span><br><span class="line">        builder.withDetail(<span class="string">&quot;example&quot;</span>,</span><br><span class="line">                Collections.singletonMap(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210722161322.png" alt="image-20210722161321910"></p>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/actuator/info">http://localhost:8080/actuator/info</a> 会输出以上方式返回的所有info信息</p>
<h4 id="3、定制Metrics信息"><a href="#3、定制Metrics信息" class="headerlink" title="3、定制Metrics信息"></a>3、定制Metrics信息</h4><h5 id="1、SpringBoot支持自动适配的Metrics"><a href="#1、SpringBoot支持自动适配的Metrics" class="headerlink" title="1、SpringBoot支持自动适配的Metrics"></a>1、SpringBoot支持自动适配的Metrics</h5><ul>
<li><p>JVM metrics, report utilization of:</p>
<ul>
<li>Various memory and buffer pools</li>
<li>Statistics related to garbage collection</li>
<li>Threads utilization</li>
<li>Number of classes loaded&#x2F;unloaded</li>
</ul>
</li>
<li><p>CPU metrics</p>
</li>
<li><p>File descriptor metrics</p>
</li>
<li><p>Kafka consumer and producer metrics</p>
</li>
<li><p>Log4j2 metrics: record the number of events logged to Log4j2 at each level</p>
</li>
<li><p>Logback metrics: record the number of events logged to Logback at each level</p>
</li>
<li><p>Uptime metrics: report a gauge for uptime and a fixed gauge representing the application’s absolute start time</p>
</li>
<li><p>Tomcat metrics (<code>server.tomcat.mbeanregistry.enabled</code> must be set to <code>true</code> for all Tomcat metrics to be registered)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-integration/docs/5.4.1/reference/html/system-management.html#micrometer-integration">Spring Integration</a> metrics</p>
</li>
</ul>
<h5 id="2、增加定制Metrics"><a href="#2、增加定制Metrics" class="headerlink" title="2、增加定制Metrics"></a>2、增加定制Metrics</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyService</span>&#123;</span><br><span class="line">    Counter counter;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyService</span><span class="params">(MeterRegistry meterRegistry)</span>&#123;</span><br><span class="line">         counter = meterRegistry.counter(<span class="string">&quot;myservice.method.running.counter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        counter.increment();</span><br><span class="line">        <span class="comment">//统计hello被调用的次数，每次被调用就加一</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//也可以使用下面的方式</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">MeterBinder <span class="title function_">queueSize</span><span class="params">(Queue queue)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (registry) -&gt; Gauge.builder(<span class="string">&quot;queueSize&quot;</span>, queue::size).register(registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="4、定制Endpoint"><a href="#4、定制Endpoint" class="headerlink" title="4、定制Endpoint"></a>4、定制Endpoint</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Endpoint(id = &quot;myservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DockerEndpoint</span> &#123;</span><br><span class="line">    <span class="meta">@ReadOperation</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">getDockerInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonMap(<span class="string">&quot;info&quot;</span>,<span class="string">&quot;docker started...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@WriteOperation</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">restartDocker</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;docker restarted....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景：开发<strong>ReadinessEndpoint</strong>来管理程序是否就绪，或者<strong>Liveness****Endpoint</strong>来管理程序是否存活；</p>
<ul>
<li>可以结合ConfigurationProperties开启对应的配置功能。</li>
</ul>
<p>当然，这个也可以直接使用 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-kubernetes-probes">https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-kubernetes-probes</a></p>
<h2 id="原理解析"><a href="#原理解析" class="headerlink" title="原理解析"></a>原理解析</h2><h3 id="1、Profile功能"><a href="#1、Profile功能" class="headerlink" title="1、Profile功能"></a>1、Profile功能</h3><p>为了方便多环境适配，springboot简化了profile功能。</p>
<h4 id="1、application-profile功能"><a href="#1、application-profile功能" class="headerlink" title="1、application-profile功能"></a>1、application-profile功能</h4><ul>
<li><p>默认配置文件  application.yaml；任何时候都会加载</p>
</li>
<li><p>指定环境配置文件  application-{env}.yaml</p>
</li>
<li><p>激活指定环境</p>
<ul>
<li>配置文件激活</li>
<li>命令行激活：java -jar xxx.jar –<strong>spring.profiles.active&#x3D;prod  –person.name&#x3D;haha</strong><ul>
<li><strong>修改配置文件的任意值，命令行优先</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>默认配置与环境配置同时生效</p>
</li>
<li><p>同名配置项，profile配置优先</p>
</li>
</ul>
<h4 id="2、-Profile条件装配功能"><a href="#2、-Profile条件装配功能" class="headerlink" title="2、@Profile条件装配功能"></a>2、@Profile条件装配功能</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@Profile(&quot;production&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductionConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>production环境下下面的才生效嗷，比较常用在@Bean上面，在对应的Profile下，相应的配置才会生效（有点像ConditionOnBean的那种感觉，现在是ConditionalOnProfile）。可以标注在方法上或者是类上。</p>
</li>
<li><p>@Profile可以设置值为一个list，里面可以加上“default”，就是默认情况下后面的配置会生效。</p>
</li>
</ul>
<h4 id="3、profile分组"><a href="#3、profile分组" class="headerlink" title="3、profile分组"></a>3、profile分组</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.profiles.group.production[0]</span>=<span class="string">proddb</span></span><br><span class="line"><span class="attr">spring.profiles.group.production[1]</span>=<span class="string">prodmq</span></span><br><span class="line"></span><br><span class="line"><span class="attr">使用：--spring.profiles.active</span>=<span class="string">production  激活</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面这个会加载production整个组，这个组中实际对应的application-proddb&#x2F;-prodmq这两个配置文件嗷！！！（本质就是分组嘛！！！）</li>
</ul>
<h4 id="4、小例子："><a href="#4、小例子：" class="headerlink" title="4、小例子："></a>4、小例子：</h4><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210722192435.png" alt="image-20210722192435511"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210722192905.png" alt="image-20210722192905058"></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210722193108.png" alt="image-20210722193108097"></p>
<h3 id="2、外部化配置"><a href="#2、外部化配置" class="headerlink" title="2、外部化配置"></a>2、外部化配置</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config">https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-external-config</a></p>
<ol>
<li><p>Default properties (specified by setting <code>SpringApplication.setDefaultProperties</code>).</p>
</li>
<li><p><code>@PropertySource</code> annotations on your <code>@Configuration</code> classes. Please note that such property sources are not added to the <code>Environment</code> until the application context is being refreshed. This is too late to configure certain properties such as <code>logging.*</code> and <code>spring.main.*</code> which are read before refresh begins.</p>
</li>
<li><p><strong>Config data (such as</strong> <code>**application.properties**</code> <strong>files)</strong></p>
</li>
<li><p>A <code>RandomValuePropertySource</code> that has properties only in <code>random.*</code>.</p>
</li>
<li><p>OS environment variables.</p>
</li>
<li><p>Java System properties (<code>System.getProperties()</code>).</p>
</li>
<li><p>JNDI attributes from <code>java:comp/env</code>.</p>
</li>
<li><p><code>ServletContext</code> init parameters.</p>
</li>
<li><p><code>ServletConfig</code> init parameters.</p>
</li>
<li><p>Properties from <code>SPRING_APPLICATION_JSON</code> (inline JSON embedded in an environment variable or system property).</p>
</li>
<li><p>Command line arguments.</p>
</li>
<li><p><code>properties</code> attribute on your tests. Available on <code>@SpringBootTest</code> and the <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-testing-spring-boot-applications-testing-autoconfigured-tests">test annotations for testing a particular slice of your application</a>.</p>
</li>
<li><p><code>@TestPropertySource</code> annotations on your tests.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-devtools-globalsettings">Devtools global settings properties</a> in the <code>$HOME/.config/spring-boot</code> directory when devtools is active.</p>
</li>
</ol>
<h4 id="1、外部配置源"><a href="#1、外部配置源" class="headerlink" title="1、外部配置源"></a>1、外部配置源</h4><p>常用：<strong>Java属性文件</strong>、<strong>YAML文件</strong>、<strong>环境变量</strong>、<strong>命令行参数</strong>；</p>
<h4 id="2、配置文件查找位置"><a href="#2、配置文件查找位置" class="headerlink" title="2、配置文件查找位置"></a>2、配置文件查找位置</h4><p>(1) classpath 根路径</p>
<p>(2) classpath 根路径下config目录</p>
<p>(3) jar包当前目录</p>
<p>(4) jar包当前目录的config目录</p>
<p>(5) &#x2F;config子目录的直接子目录</p>
<ul>
<li>优先级越往下越高嗷！！！！！</li>
</ul>
<h4 id="3、配置文件加载顺序："><a href="#3、配置文件加载顺序：" class="headerlink" title="3、配置文件加载顺序："></a>3、配置文件加载顺序：</h4><ol>
<li>　当前jar包内部的application.properties和application.yml</li>
<li>　当前jar包内部的application-{profile}.properties 和 application-{profile}.yml</li>
<li>　引用的外部jar包的application.properties和application.yml</li>
<li>　引用的外部jar包的application-{profile}.properties 和 application-{profile}.yml</li>
</ol>
<ul>
<li>优先级越往下越高嗷！！！！！</li>
</ul>
<h4 id="4、指定环境优先，外部优先，后面的可以覆盖前面的同名配置项"><a href="#4、指定环境优先，外部优先，后面的可以覆盖前面的同名配置项" class="headerlink" title="4、指定环境优先，外部优先，后面的可以覆盖前面的同名配置项"></a>4、指定环境优先，外部优先，后面的可以覆盖前面的同名配置项</h4><h3 id="3、自定义starter"><a href="#3、自定义starter" class="headerlink" title="3、自定义starter"></a>3、自定义starter</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19K4y1L7MT?p=83&spm_id_from=pageDriver">这个自定义的starter太强了！！！</a></p>
<h4 id="1、starter启动原理"><a href="#1、starter启动原理" class="headerlink" title="1、starter启动原理"></a>1、starter启动原理</h4><ul>
<li>starter-pom引入 autoconfigurer 包</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1606995919308-b2c7ccaa-e720-4cc5-9801-2e170b3102e1.png" alt="img"></p>
<ul>
<li><p>autoconfigure包中配置使用 <strong>META-INF&#x2F;spring.factories</strong> 中 <strong>EnableAutoConfiguration 的值，使得项目启动加载指定的自动配置类</strong></p>
</li>
<li><p><strong>编写自动配置类 xxxAutoConfiguration -&gt; xxxxProperties</strong></p>
</li>
<li><p><strong>@Configuration</strong></p>
</li>
<li><p><strong>@Conditional</strong></p>
</li>
<li><p><strong>@EnableConfigurationProperties</strong></p>
</li>
<li><p><strong>@Bean</strong></p>
</li>
<li><p>……</p>
</li>
</ul>
<p><strong>引入starter</strong> <strong>— xxxAutoConfiguration — 容器中放入组件 —- 绑定xxxProperties —-</strong> <strong>配置项</strong></p>
<h4 id="2、自定义starter"><a href="#2、自定义starter" class="headerlink" title="2、自定义starter"></a>2、自定义starter</h4><p><strong>atguigu-hello-spring-boot-starter（启动器）</strong></p>
<p><strong>atguigu-hello-spring-boot-starter-autoconfigure（自动配置包）</strong></p>
<h3 id="4、SpringBoot原理"><a href="#4、SpringBoot原理" class="headerlink" title="4、SpringBoot原理"></a>4、SpringBoot原理</h3><p>Spring原理【<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gW411W7wy?p=1">Spring注解</a>】、<strong>SpringMVC</strong>原理、<strong>自动配置原理</strong>、SpringBoot原理</p>
<h4 id="1、SpringBoot启动过程"><a href="#1、SpringBoot启动过程" class="headerlink" title="1、SpringBoot启动过程"></a>1、SpringBoot启动过程</h4><ul>
<li><p>创建 <strong>SpringApplication</strong></p>
<ul>
<li><p>保存一些信息。</p>
</li>
<li><p>判定当前应用的类型。ClassUtils。Servlet</p>
</li>
<li><p><strong>bootstrappers****：初始启动引导器（</strong>List<Bootstrapper><strong>）：去spring.factories文件中找</strong> org.springframework.boot.<strong>Bootstrapper</strong></p>
</li>
<li><p>找 <strong>ApplicationContextInitializer</strong>；去<strong>spring.factories找ApplicationContextInitializer</strong></p>
<ul>
<li>List&lt;ApplicationContextInitializer&lt;?&gt;&gt; <strong>initializers</strong></li>
</ul>
</li>
<li><p><strong>找</strong> <strong>ApplicationListener  ；应用监听器。</strong>去<strong>spring.factories****找</strong> <strong>ApplicationListener</strong></p>
<ul>
<li>List&lt;ApplicationListener&lt;?&gt;&gt; <strong>listeners</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>运行 <strong>SpringApplication</strong></p>
<ul>
<li><p><strong>StopWatch</strong>：用于监控整个应用的启停的嗷！！！</p>
</li>
<li><p><strong>记录应用的启动时间</strong></p>
</li>
<li><p><strong>创建引导上下文（Context环境）</strong>createBootstrapContext()</p>
<ul>
<li>获取到所有之前的 <strong>bootstrappers（这个上面有哦！！！） 挨个执行</strong> intitialize() 来完成对引导启动器上下文环境设置</li>
</ul>
</li>
<li><p>让当前应用进入<strong>headless</strong>模式。<strong>java.awt.headless</strong></p>
</li>
<li><p><strong>获取所有</strong> <strong>RunListener</strong>（运行监听器）【为了方便所有Listener进行事件感知】</p>
<ul>
<li>getSpringFactoriesInstances 去<strong>spring.factories</strong>中找<strong>SpringApplicationRunListener</strong>. </li>
<li>遍历 <strong>SpringApplicationRunListener 调用 starting 方法；</strong></li>
<li><strong>相当于通知所有感兴趣系统正在启动过程的人，项目正在 starting。</strong></li>
</ul>
</li>
<li><p>保存命令行参数；ApplicationArguments</p>
</li>
<li><p>准备环境 prepareEnvironment（）;</p>
<ul>
<li><p>返回或者创建基础环境信息对象。<strong>StandardServletEnvironment</strong></p>
</li>
<li><p><strong>配置环境信息对象。</strong></p>
<ul>
<li><strong>读取所有的配置源的配置属性值。</strong></li>
</ul>
</li>
<li><p>绑定环境信息</p>
</li>
<li><p>监听器调用 listener.environmentPrepared()；通知所有的监听器当前环境准备完成</p>
</li>
</ul>
</li>
<li><p>创建IOC容器（createApplicationContext（））</p>
<ul>
<li>根据项目类型（Servlet）创建容器，</li>
<li>当前会创建 <strong>AnnotationConfigServletWebServerApplicationContext</strong></li>
</ul>
</li>
<li><p><strong>准备ApplicationContext IOC容器的基本信息</strong>  <strong>prepareContext()</strong></p>
<ul>
<li><p>保存环境信息</p>
</li>
<li><p>IOC容器的后置处理流程。</p>
</li>
<li><p>应用初始化器；applyInitializers；</p>
<ul>
<li>遍历所有的 <strong>ApplicationContextInitializer 。调用</strong> <strong>initialize.。来对ioc容器进行初始化扩展功能</strong></li>
<li>遍历所有的 listener 调用 <strong>contextPrepared。EventPublishRunListenr；通知所有的监听器****contextPrepared</strong></li>
</ul>
</li>
<li><p><strong>所有的监听器 调用</strong> <strong>contextLoaded。通知所有的监听器</strong> <strong>contextLoaded；</strong></p>
</li>
</ul>
</li>
<li><p><strong>刷新IOC容器。</strong>refreshContext</p>
<ul>
<li>创建容器中的所有组件（Spring注解）</li>
</ul>
</li>
<li><p>容器刷新完成后工作？afterRefresh</p>
</li>
<li><p>所有监听器调用 listeners.<strong>started</strong>(context); <strong>通知所有的监听器</strong> <strong>started</strong></p>
</li>
<li><p>调用所有runners；callRunners()</p>
<ul>
<li><p><strong>获取容器中的</strong> <strong>ApplicationRunner</strong> </p>
</li>
<li><p><strong>获取容器中的</strong>  <strong>CommandLineRunner</strong></p>
</li>
<li><p><strong>合并所有runner并且按照@Order进行排序</strong></p>
</li>
<li><p><strong>遍历所有的runner。调用 run</strong> <strong>方法</strong></p>
</li>
</ul>
</li>
<li><p><strong>如果以上有异常，</strong></p>
<ul>
<li><strong>调用Listener 的 failed</strong></li>
</ul>
</li>
<li><p><strong>调用所有监听器的 running 方法</strong>  listeners.running(context); <strong>通知所有的监听器</strong> <strong>running</strong> </p>
</li>
<li><p>running如果有问题。继续通知 failed 。调用所有 Listener 的failed；通知所有的监听器failed</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Bootstrapper</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Initialize the given &#123;<span class="doctag">@link</span> BootstrapRegistry&#125; with any required registrations.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registry the registry to initialize</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">intitialize</span><span class="params">(BootstrapRegistry registry)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1607005958877-bf152e3e-4d2d-42b6-a08c-ceef9870f3b6.png" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1607004823889-8373cea4-6305-40c1-af3b-921b071a28a8.png?x-oss-process=image/watermark,type_d3F5LW1pY3JvaGVp,size_10,text_YXRndWlndS5jb20g5bCa56GF6LC3,color_FFFFFF,shadow_50,t_80,g_se,x_10,y_10" alt="img"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/1354552/1607006112013-6ed5c0a0-3e02-4bf1-bdb7-423e0a0b3f3c.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback used to run the bean.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args incoming application arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception on error</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback used to run the bean.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args incoming main method arguments</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception on error</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2、Application-Events-and-Listeners"><a href="#2、Application-Events-and-Listeners" class="headerlink" title="2、Application Events and Listeners"></a>2、Application Events and Listeners</h4><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-application-events-and-listeners">https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-application-events-and-listeners</a></p>
<p><strong>ApplicationContextInitializer</strong></p>
<p><strong>ApplicationListener</strong></p>
<p><strong>SpringApplicationRunListener</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724161055.png" alt="image-20210724161047849"></p>
<h4 id="3、ApplicationRunner-与-CommandLineRunner"><a href="#3、ApplicationRunner-与-CommandLineRunner" class="headerlink" title="3、ApplicationRunner 与 CommandLineRunner"></a>3、ApplicationRunner 与 CommandLineRunner</h4><ul>
<li><p>放入容器中，就能够得到嗷！！！</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/alexanderliu-creator/cloudimg/img/20210724161802.png" alt="image-20210724161802363"></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/13/Springboot2-x/" data-id="cl6gepmg50047e0jq67bg5b62" data-title="SpringBoot2-x" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/2021%E5%B9%B4%E7%BE%8E%E8%B5%9B/">2021年美赛</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/2021%E5%B9%B4%E7%BE%8E%E8%B5%9B/Python/">Python</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A8%E5%8A%9B%E7%BB%93%E7%82%B9%E5%90%8E%E7%AB%AF/">动力结点后端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A8%E5%8A%9B%E7%BB%93%E7%82%B9%E5%90%8E%E7%AB%AF%E8%AF%BE%E7%A8%8B/">动力结点后端课程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%87%AA%E5%AD%A6%E5%86%85%E5%AE%B9%E6%88%96%E8%AF%BE%E7%A8%8B%E4%BD%9C%E4%B8%9A/">自学内容或课程作业</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/" rel="tag">Database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Skills/" rel="tag">Skills</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/introduction/" rel="tag">introduction</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/" rel="tag">云服务器与项目部署</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E4%B8%80%E5%AD%A6%E4%B9%A0/" rel="tag">大一学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E4%B8%89%E8%87%AA%E5%AD%A6/" rel="tag">大三自学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E4%BA%8C%E8%87%AA%E5%AD%A6/" rel="tag">大二自学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BE%8E%E8%B5%9B/" rel="tag">美赛</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/" rel="tag">论文精读</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E5%88%86%E4%BA%AB/" rel="tag">读书分享</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B5%84%E6%BA%90%E7%A6%8F%E5%88%A9%EF%BC%81%EF%BC%81%EF%BC%81/" rel="tag">资源福利！！！</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Database/" style="font-size: 12.22px;">Database</a> <a href="/tags/Python/" style="font-size: 16.67px;">Python</a> <a href="/tags/Skills/" style="font-size: 10px;">Skills</a> <a href="/tags/introduction/" style="font-size: 11.11px;">introduction</a> <a href="/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/" style="font-size: 12.22px;">云服务器与项目部署</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15.56px;">前端</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 18.89px;">后端</a> <a href="/tags/%E5%A4%A7%E4%B8%80%E5%AD%A6%E4%B9%A0/" style="font-size: 14.44px;">大一学习</a> <a href="/tags/%E5%A4%A7%E4%B8%89%E8%87%AA%E5%AD%A6/" style="font-size: 17.78px;">大三自学</a> <a href="/tags/%E5%A4%A7%E4%BA%8C%E8%87%AA%E5%AD%A6/" style="font-size: 15.56px;">大二自学</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 11.11px;">机器学习</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BE%8E%E8%B5%9B/" style="font-size: 20px;">美赛</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 13.33px;">计算机网络</a> <a href="/tags/%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/" style="font-size: 10px;">论文精读</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E5%88%86%E4%BA%AB/" style="font-size: 10px;">读书分享</a> <a href="/tags/%E8%B5%84%E6%BA%90%E7%A6%8F%E5%88%A9%EF%BC%81%EF%BC%81%EF%BC%81/" style="font-size: 10px;">资源福利！！！</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/01/16/ML%E5%85%A5%E9%97%A8/">ML入门</a>
          </li>
        
          <li>
            <a href="/2021/12/28/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E4%B8%8E%E6%99%BA%E8%83%BD%E8%AE%A1%E7%AE%97%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A03/">大数据分析与智能计算期末复习3</a>
          </li>
        
          <li>
            <a href="/2021/12/24/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E4%B8%8E%E6%99%BA%E8%83%BD%E8%AE%A1%E7%AE%97%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A02/">大数据分析与智能计算期末复习2</a>
          </li>
        
          <li>
            <a href="/2021/12/20/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E4%B8%8E%E6%99%BA%E8%83%BD%E8%AE%A1%E7%AE%97%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0/">大数据分析与智能计算期末复习</a>
          </li>
        
          <li>
            <a href="/2021/12/13/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AF%BE%E7%A8%8B%E6%9C%9F%E6%9C%AB%E5%A4%8D%E4%B9%A0/">系统架构课程期末复习</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>